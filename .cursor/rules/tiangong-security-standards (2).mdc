---
description: 
globs: 
alwaysApply: true
---
# ğŸ” å¤©å·¥é¡¹ç›®å®‰å…¨ä¸è´¨é‡æ ‡å‡†è§„èŒƒ - æ ¸å¿ƒå®‰å…¨è§„åˆ™é›†

## ğŸš¨ æ ¸å¿ƒå®‰å…¨åŸåˆ™ - è¿ååˆ™ç«‹å³åœæ­¢å¼€å‘

### 1. ğŸ” æ•°æ®å®‰å…¨æ ¸å¿ƒè§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

#### ç»å¯¹ç¦æ­¢å‰ç«¯ç¡¬ç¼–ç æ•æ„Ÿä¸šåŠ¡æ•°æ®
```javascript
// âŒ ä¸¥ç¦ï¼šå‰ç«¯ç¡¬ç¼–ç å¥–å“é…ç½®
const PRIZES = [
  { name: 'å¥–å“1', probability: 10 },
  { name: 'å¥–å“2', probability: 20 }
]

// âŒ ä¸¥ç¦ï¼šå‰ç«¯ç¡¬ç¼–ç å•†å“ä»·æ ¼
const PRODUCTS = [
  { id: 1, name: 'å•†å“1', price: 100 }
]

// âŒ ä¸¥ç¦ï¼šå‰ç«¯è®¡ç®—ä¸šåŠ¡é€»è¾‘
const probability = Math.random() * 100
const userPermission = user.role === 'admin'
```

#### ç»å¯¹ç¦æ­¢ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ›¿ä»£åç«¯API
```javascript
// âŒ ä¸¥ç¦ï¼šMockæ•°æ®å‡½æ•°
const mockRequest = () => { /* å‡æ•°æ® */ }
const shouldUseMock = () => true
const smartApiCall = (real, mock) => mock

// âŒ ä¸¥ç¦ï¼šsetTimeoutæ¨¡æ‹Ÿå¼‚æ­¥
setTimeout(() => {
  callback({ data: mockData })
}, 1000)
```

#### å¼ºåˆ¶åç«¯ä¾èµ–æ£€æŸ¥ä¸é”™è¯¯å¤„ç†
```javascript
// âœ… æ­£ç¡®ï¼šçœŸå®APIè°ƒç”¨ + å®Œæ•´é”™è¯¯å¤„ç†
api.getData().then(result => {
  if (result.code === 0) {
    this.setData({ data: result.data })
  } else {
    throw new Error('âš ï¸ åç«¯æœåŠ¡å¼‚å¸¸ï¼š' + result.msg)
  }
}).catch(error => {
  wx.showModal({
    title: 'ğŸš¨ åç«¯æœåŠ¡é—®é¢˜',
    content: `æ— æ³•è·å–æ•°æ®ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. åç«¯APIæœåŠ¡æœªå¯åŠ¨\n2. æ¥å£å¼‚å¸¸\n3. æ•°æ®åº“è¿æ¥é—®é¢˜\n\nè¯·ç«‹å³æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€ï¼`
  })
})
```

### 2. ğŸ› ï¸ æ–¹æ³•è°ƒç”¨å®‰å…¨è§„èŒƒ

#### å¯¼å…¥å‡½æ•°è°ƒç”¨é”™è¯¯é˜²æŠ¤
```javascript
// âŒ ç¦æ­¢ï¼šå°†å¯¼å…¥å‡½æ•°å½“ä½œå¯¹è±¡æ–¹æ³•è°ƒç”¨
const { getTechnicalConfig } = require('./config')
// é”™è¯¯è°ƒç”¨
this.getTechnicalConfig()  // TypeError: this.getTechnicalConfig is not a function

// âœ… æ­£ç¡®ï¼šç›´æ¥è°ƒç”¨å¯¼å…¥å‡½æ•°ï¼Œæ·»åŠ è¯¦ç»†æ³¨é‡Š
const config = getTechnicalConfig()  // è·å–æŠ€æœ¯é…ç½®ä¿¡æ¯
const isValid = validateForm(formData)  // éªŒè¯ç”¨æˆ·è¾“å…¥è¡¨å•æ•°æ®
const displayDate = formatDate(timestamp)  // æ ¼å¼åŒ–æ—¶é—´æˆ³
```

#### æ¨¡å—å¯¼å…¥ä¸€è‡´æ€§æ£€æŸ¥
```javascript
// âœ… ç»Ÿä¸€å¯¼å…¥è·¯å¾„å’Œé”™è¯¯å¤„ç†
const { validateForm } = require('../../utils/validate')
const { formatDate } = require('../../utils/util')

// å¼ºåˆ¶æ•°æ®å­˜åœ¨æ€§æ£€æŸ¥ï¼šæ‰€æœ‰æŸ¥è¯¢å‰å¿…é¡»éªŒè¯æ•°æ®æ˜¯å¦å­˜åœ¨
if (!app.globalData) {
  console.error('ğŸš¨ å…¨å±€æ•°æ®æœªåˆå§‹åŒ–')
  return
}

if (!app.globalData.userInfo) {
  wx.navigateTo({ url: '/pages/auth/auth' })
  return
}
```

### 3. ğŸ”’ å¯¹è±¡å±æ€§å®‰å…¨è®¿é—®è§„èŒƒ

#### æ·±å±‚å±æ€§è®¿é—®é˜²æŠ¤
```javascript
// âŒ ç¦æ­¢ï¼šä¸å®‰å…¨çš„å±æ€§è®¿é—®
app.globalData.config.isDev  // å¯èƒ½ä¸ºundefined
user.profile.avatar.url      // å¤šå±‚çº§è®¿é—®é£é™©

// âœ… æ­£ç¡®ï¼šæä¾›åå¤‡å€¼å’Œå®‰å…¨æ£€æŸ¥
const config = app.globalData.config || app.globalData || { isDev: true }
const isDev = config.isDev || false

const avatarUrl = user?.profile?.avatar?.url || '/images/default-avatar.png'

// âœ… æ·±åº¦æ€è€ƒé¡¹ç›®ä»£ç é€»è¾‘ï¼Œç¡®ä¿æ•°æ®å®‰å…¨è®¿é—®
const userInfo = app.globalData.userInfo
if (userInfo && userInfo.profile) {
  const avatar = userInfo.profile.avatar || '/images/default-avatar.png'
}
```

### 4. ğŸ¨ å¾®ä¿¡å°ç¨‹åºAPIå…¼å®¹æ€§æ£€æŸ¥ç³»ç»Ÿ

#### Canvas APIå…¼å®¹æ€§åŒé‡æ£€æŸ¥
```javascript
// âœ… ç»Ÿä¸€å…¼å®¹æ€§æ£€æŸ¥å·¥å…· (utils/compatibility-check.js)
const checkCanvasAPI = (ctx) => {
  return {
    createLinearGradient: typeof ctx.createLinearGradient === 'function',
    createRadialGradient: typeof ctx.createRadialGradient === 'function',
    quadraticCurveTo: typeof ctx.quadraticCurveTo === 'function',
    bezierCurveTo: typeof ctx.bezierCurveTo === 'function',
    setLineDash: typeof ctx.setLineDash === 'function',
    filter: 'filter' in ctx
  }
}

// âœ… æ³¨æ„ç¼–å†™çš„ä»£ç ç¬¦åˆå¾®ä¿¡å°ç¨‹åºå¼€å‘æ ‡å‡†ï¼Œè€ƒè™‘APIå…¼å®¹æ€§
if (compatibility.createLinearGradient && typeof ctx.createLinearGradient === 'function') {
  try {
    const gradient = ctx.createLinearGradient(0, 0, 100, 0)
    gradient.addColorStop(0, '#ff0000')
    gradient.addColorStop(1, '#00ff00')
    ctx.fillStyle = gradient
  } catch (error) {
    console.warn('çº¿æ€§æ¸å˜ä¸æ”¯æŒï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', error)
    ctx.fillStyle = '#ff0000'
  }
} else {
  ctx.fillStyle = '#ff0000'
}
```

#### æ™ºèƒ½é™çº§ç­–ç•¥
```javascript
// âœ… æ ¹æ®å…¼å®¹æ€§æ£€æŸ¥ç»“æœæ™ºèƒ½é€‰æ‹©ç­–ç•¥
const drawWithCompatibility = (ctx, compatibility) => {
  if (compatibility.createRadialGradient && compatibility.quadraticCurveTo) {
    drawAdvancedStyle(ctx)  // é«˜çº§ç»˜åˆ¶ï¼šæ¸å˜ + æ›²çº¿ï¼Œè§†è§‰ç¾æ„Ÿ 95%+
  } else if (compatibility.createLinearGradient) {
    drawMediumStyle(ctx)    // ä¸­çº§ç»˜åˆ¶ï¼šçº¿æ€§æ¸å˜ï¼Œè§†è§‰ç¾æ„Ÿ 80%+
  } else {
    drawBasicStyle(ctx)     // åŸºç¡€ç»˜åˆ¶ï¼šçº¯è‰²å¡«å……ï¼Œè§†è§‰ç¾æ„Ÿ 60%+ï¼Œç¡®ä¿100%å…¼å®¹æ€§
  }
}
```

### 5. ğŸš€ ä¸‰å±‚é”™è¯¯å¤„ç†ä¸æ™ºèƒ½é™çº§æœºåˆ¶

#### å®Œæ•´é”™è¯¯å¤„ç†æ¨¡å¼
```javascript
// âœ… ç¬¬ä¸€å±‚ï¼šåŠŸèƒ½æ£€æŸ¥
if (!compatibility.targetAPI) {
  console.warn('APIä¸æ”¯æŒï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
  return fallbackMethod()
}

// âœ… ç¬¬äºŒå±‚ï¼šç±»å‹æ£€æŸ¥
if (typeof ctx.targetAPI !== 'function') {
  console.warn('APIç±»å‹å¼‚å¸¸ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
  return fallbackMethod()
}

// âœ… ç¬¬ä¸‰å±‚ï¼šè¿è¡Œæ—¶é”™è¯¯æ•è·
try {
  return ctx.targetAPI(...args)
} catch (error) {
  console.error('APIè°ƒç”¨å¤±è´¥:', error)
  return fallbackMethod()
}
```

#### å¢å¼ºé”™è¯¯å¤„ç†ä¸è§£å†³å»ºè®®
```javascript
// âœ… æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
const handleError = (error, context) => {
  const errorMap = {
    'TypeError': 'ç±»å‹é”™è¯¯ - è¯·æ£€æŸ¥å˜é‡ç±»å‹å’Œæ–¹æ³•è°ƒç”¨',
    'ReferenceError': 'å¼•ç”¨é”™è¯¯ - è¯·æ£€æŸ¥å˜é‡æ˜¯å¦å·²å®šä¹‰',
    'Canvas API Error': 'Canvas APIä¸å…¼å®¹ - å·²å¯ç”¨é™çº§æ–¹æ¡ˆ'
  }
  
  const errorType = error.name || 'Unknown'
  const suggestion = errorMap[errorType] || 'è¯·æ£€æŸ¥ä»£ç é€»è¾‘å’Œç¯å¢ƒå…¼å®¹æ€§'
  
  console.error(`ğŸš¨ ${context}å‘ç”Ÿé”™è¯¯:`, error)
  console.warn(`ğŸ’¡ å»ºè®®è§£å†³æ–¹æ¡ˆ: ${suggestion}`)
  
  wx.showToast({
    title: 'åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨',
    icon: 'none',
    duration: 2000
  })
}
```

### 6. ğŸ” Mockæ•°æ®æ£€æµ‹ä¸æ¸…ç†ç³»ç»Ÿ

#### Mockæ•°æ®æ£€æµ‹å™¨
```javascript
// ğŸ”´ Mockæ•°æ®æ£€æµ‹ç³»ç»Ÿ
class MockDataDetector {
    static suspiciousPatterns = [
        /mock|fake|test|dummy/gi,
        /setTimeout.*callback/gi,
        /return.*\{.*data.*\}/gi,
        /const.*mock.*=/gi,
        /if.*useMock/gi,
        /smartApiCall.*mock/gi
    ]
    
    static async scanForMockData(filePath) {
        const content = await read_file(filePath, true, 1, -1)
        const violations = []
        
        this.suspiciousPatterns.forEach((pattern, index) => {
            const matches = content.content.match(pattern)
            if (matches) {
                violations.push({
                    pattern: pattern.toString(),
                    matches: matches.length,
                    severity: 'CRITICAL',
                    file: filePath,
                    recommendation: 'ç«‹å³ç§»é™¤Mockæ•°æ®ï¼Œä½¿ç”¨çœŸå®API'
                })
            }
        })
        
        return violations
    }
    
    static async batchScanProject() {
        const projectFiles = [
            'pages/lottery/lottery.js',
            'pages/exchange/exchange.js',
            'pages/user/user.js',
            'utils/api.js'
        ]
        
        const allViolations = []
        
        // å¹¶è¡Œæ‰«ææ‰€æœ‰æ–‡ä»¶
        const scanPromises = projectFiles.map(file => this.scanForMockData(file))
        const results = await Promise.all(scanPromises)
        
        results.forEach(violations => {
            allViolations.push(...violations)
        })
        
        if (allViolations.length > 0) {
            console.error(`ğŸš¨ å‘ç°${allViolations.length}ä¸ªMockæ•°æ®è¿è§„`)
            return {
                hasMockData: true,
                violations: allViolations,
                cleanupPlan: this.generateCleanupPlan(allViolations)
            }
        }
        
        return { hasMockData: false, message: 'æœªå‘ç°Mockæ•°æ®' }
    }
}
```

### 7. ğŸ” APIå®‰å…¨è®¿é—®è§„èŒƒ

#### å¼ºåˆ¶HTTPSä¸åŸŸåéªŒè¯
```javascript
// âœ… APIåŸºç¡€URLéªŒè¯
const API_BASE_URL = 'https://rqchrlqndora.sealosbja.site'

// ğŸ”´ å¼ºåˆ¶åŸŸåéªŒè¯
const validateDomain = (url) => {
  const allowedDomains = [
    'rqchrlqndora.sealosbja.site',
    'localhost:8080' // ä»…å¼€å‘ç¯å¢ƒ
  ]
  
  const domain = new URL(url).hostname
  if (!allowedDomains.includes(domain)) {
    throw new Error(`ğŸš¨ éæ³•åŸŸåè®¿é—®: ${domain}`)
  }
  
  return true
}

// âœ… å®‰å…¨çš„APIè°ƒç”¨
const secureApiCall = async (endpoint, options = {}) => {
  const fullUrl = `${API_BASE_URL}${endpoint}`
  
  // åŸŸåéªŒè¯
  validateDomain(fullUrl)
  
  // æ·»åŠ å®‰å…¨å¤´
  const secureOptions = {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      ...options.headers
    }
  }
  
  try {
    const response = await wx.request({
      url: fullUrl,
      ...secureOptions
    })
    
    return response.data
  } catch (error) {
    console.error('APIè°ƒç”¨å¤±è´¥:', error)
    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
  }
}
```

### 8. ğŸ›¡ï¸ ç”¨æˆ·è¾“å…¥éªŒè¯ä¸å®‰å…¨

#### è¾“å…¥éªŒè¯è§„èŒƒ
```javascript
// âœ… è¾“å…¥éªŒè¯å·¥å…·
const inputValidator = {
  // æ‰‹æœºå·éªŒè¯
  validatePhone: (phone) => {
    const phoneRegex = /^1[3-9]\d{9}$/
    if (!phoneRegex.test(phone)) {
      throw new Error('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ')
    }
    return true
  },
  
  // é‡‘é¢éªŒè¯
  validateAmount: (amount) => {
    const amountRegex = /^\d+(\.\d{1,2})?$/
    if (!amountRegex.test(amount) || parseFloat(amount) <= 0) {
      throw new Error('è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢')
    }
    return true
  },
  
  // éªŒè¯ç éªŒè¯
  validateCode: (code) => {
    const codeRegex = /^\d{6}$/
    if (!codeRegex.test(code)) {
      throw new Error('è¯·è¾“å…¥6ä½æ•°å­—éªŒè¯ç ')
    }
    return true
  }
}

// âœ… å®‰å…¨çš„è¡¨å•å¤„ç†
const handleFormSubmit = (formData) => {
  try {
    // éªŒè¯æ‰€æœ‰è¾“å…¥
    inputValidator.validatePhone(formData.phone)
    inputValidator.validateAmount(formData.amount)
    inputValidator.validateCode(formData.code)
    
    // æ•°æ®æ¸…ç†
    const cleanData = {
      phone: formData.phone.trim(),
      amount: parseFloat(formData.amount),
      code: formData.code.trim()
    }
    
    return cleanData
  } catch (error) {
    wx.showModal({
      title: 'è¾“å…¥é”™è¯¯',
      content: error.message
    })
    return null
  }
}
```

### 9. ğŸ”„ çŠ¶æ€ç®¡ç†å®‰å…¨è§„èŒƒ

#### å…¨å±€çŠ¶æ€å®‰å…¨ç®¡ç†
```javascript
// âœ… å®‰å…¨çš„å…¨å±€çŠ¶æ€ç®¡ç†
const secureStateManager = {
  // åˆå§‹åŒ–çŠ¶æ€
  initState: () => {
    if (!app.globalData) {
      app.globalData = {
        userInfo: null,
        config: {},
        cache: new Map(),
        lastUpdate: Date.now()
      }
    }
  },
  
  // å®‰å…¨è®¾ç½®ç”¨æˆ·ä¿¡æ¯
  setUserInfo: (userInfo) => {
    if (!userInfo || typeof userInfo !== 'object') {
      throw new Error('æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯')
    }
    
    // æ¸…ç†æ•æ„Ÿä¿¡æ¯
    const safeUserInfo = {
      id: userInfo.id,
      phone: userInfo.phone ? userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : '',
      points: userInfo.points || 0,
      nickname: userInfo.nickname || 'ç”¨æˆ·',
      avatar: userInfo.avatar || '/images/default-avatar.png'
    }
    
    app.globalData.userInfo = safeUserInfo
    app.globalData.lastUpdate = Date.now()
  },
  
  // æ¸…ç†è¿‡æœŸçŠ¶æ€
  cleanExpiredState: () => {
    const now = Date.now()
    const expireTime = 30 * 60 * 1000 // 30åˆ†é’Ÿ
    
    if (now - app.globalData.lastUpdate > expireTime) {
      app.globalData.userInfo = null
      app.globalData.cache.clear()
      console.log('å·²æ¸…ç†è¿‡æœŸçŠ¶æ€')
    }
  }
}
```

### 10. ğŸ“Š å®‰å…¨ç›‘æ§ä¸æ—¥å¿—è®°å½•

#### å®‰å…¨äº‹ä»¶ç›‘æ§
```javascript
// ğŸ”´ å®‰å…¨ç›‘æ§ç³»ç»Ÿ
class SecurityMonitor {
    static securityEvents = []
    static maxLogSize = 1000
    
    static logSecurityEvent(event) {
        const securityEvent = {
            timestamp: Date.now(),
            type: event.type,
            severity: event.severity,
            message: event.message,
            context: event.context,
            userAgent: navigator.userAgent,
            url: window.location.href
        }
        
        this.securityEvents.push(securityEvent)
        
        // ä¿æŒæ—¥å¿—å¤§å°
        if (this.securityEvents.length > this.maxLogSize) {
            this.securityEvents.shift()
        }
        
        // é«˜å±äº‹ä»¶ç«‹å³å¤„ç†
        if (event.severity === 'CRITICAL') {
            this.handleCriticalEvent(securityEvent)
        }
    }
    
    static handleCriticalEvent(event) {
        console.error('ğŸš¨ å®‰å…¨å¨èƒæ£€æµ‹:', event)
        
        // æ ¹æ®äº‹ä»¶ç±»å‹é‡‡å–è¡ŒåŠ¨
        switch (event.type) {
            case 'MOCK_DATA_DETECTED':
                wx.showModal({
                    title: 'å®‰å…¨è­¦å‘Š',
                    content: 'æ£€æµ‹åˆ°Mockæ•°æ®ï¼Œè¯·ç«‹å³è”ç³»å¼€å‘äººå‘˜',
                    showCancel: false
                })
                break
                
            case 'UNAUTHORIZED_ACCESS':
                wx.navigateTo({ url: '/pages/auth/auth' })
                break
                
            case 'API_TAMPERING':
                wx.showModal({
                    title: 'ç³»ç»Ÿå¼‚å¸¸',
                    content: 'æ£€æµ‹åˆ°å¼‚å¸¸APIè°ƒç”¨ï¼Œè¯·é‡æ–°ç™»å½•',
                    showCancel: false,
                    success: () => {
                        wx.navigateTo({ url: '/pages/auth/auth' })
                    }
                })
                break
        }
    }
    
    static generateSecurityReport() {
        const report = {
            totalEvents: this.securityEvents.length,
            criticalEvents: this.securityEvents.filter(e => e.severity === 'CRITICAL').length,
            recentEvents: this.securityEvents.slice(-10),
            eventTypes: this.groupEventsByType()
        }
        
        return report
    }
}
```

### 11. ğŸ” æ•æ„Ÿæ•°æ®ä¿æŠ¤è§„èŒƒ

#### æ•°æ®åŠ å¯†ä¸è„±æ•
```javascript
// âœ… æ•°æ®ä¿æŠ¤å·¥å…·
const dataProtector = {
  // æ‰‹æœºå·è„±æ•
  maskPhone: (phone) => {
    if (!phone || phone.length !== 11) return '***'
    return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
  },
  
  // èº«ä»½è¯è„±æ•
  maskIdCard: (idCard) => {
    if (!idCard) return '***'
    return idCard.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2')
  },
  
  // é“¶è¡Œå¡è„±æ•
  maskBankCard: (cardNumber) => {
    if (!cardNumber) return '***'
    return cardNumber.replace(/(\d{4})\d{8,12}(\d{4})/, '$1****$2')
  },
  
  // æ•æ„Ÿä¿¡æ¯æ£€æµ‹
  detectSensitiveData: (text) => {
    const patterns = {
      phone: /1[3-9]\d{9}/g,
      idCard: /\d{17}[\dXx]/g,
      bankCard: /\d{16,19}/g,
      email: /\w+@\w+\.\w+/g
    }
    
    const findings = []
    Object.entries(patterns).forEach(([type, pattern]) => {
      const matches = text.match(pattern)
      if (matches) {
        findings.push({ type, count: matches.length })
      }
    })
    
    return findings
  }
}
```

---

**è§„åˆ™åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ3æ—¥  
**æœ€åæ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ3æ—¥  
**æ›´æ–°å†…å®¹**: å®Œå–„å¤©å·¥é¡¹ç›®å®‰å…¨è§„èŒƒï¼Œæ–°å¢Mockæ•°æ®æ£€æµ‹ã€APIå®‰å…¨ã€çŠ¶æ€ç®¡ç†ç­‰æ ¸å¿ƒå®‰å…¨æœºåˆ¶  
**é€‚ç”¨èŒƒå›´**: å¤©å·¥é¡¹ç›®çš„æ‰€æœ‰å‰ç«¯å¼€å‘åœºæ™¯  
**ç»´æŠ¤çŠ¶æ€**: âœ… å·²å®Œå–„ - æ‰€æœ‰å®‰å…¨è§„åˆ™å·²è¡¥å……å®Œæ•´

