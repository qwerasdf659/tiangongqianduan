# 前后端对接需求文档 - 积分显示问题修复

## 📋 文档信息

- **项目名称**: 餐厅积分抽奖系统
- **文档类型**: 前后端对接需求文档
- **创建时间**: 2024年12月
- **问题编号**: ISSUE-001
- **优先级**: 高
- **负责人**: 前端开发团队

## 🔍 问题背景

### 问题描述
用户账号 `13612227930` 反映：今天没有审核通过照片，但是"今日获得"和"今日消费"仍然显示有积分数据。

### 问题原因
经前端代码分析发现，`pages/user/user.js` 的 `calculateTodayTrend()` 方法使用了硬编码的示例数据：
```javascript
// ❌ 问题代码
calculateTodayTrend() {
    this.safeSetData({
      todayEarned: 150,    // 硬编码示例数据
      todayConsumed: 80    // 硬编码示例数据
    })
}
```

### 前端修复状态
✅ **已完成**：前端代码已修复，改为调用后端API获取真实数据
- 修复文件：`pages/user/user.js`、`utils/api.js`
- 新增API调用：`userAPI.getTodayPointsTrend()`

## 🎯 需要后端程序员提供的信息

### 1. 📡 API接口实现

#### 1.1 接口基本信息
```http
GET /api/user/points/today-trend
```

**请确认**：
- [ ] 接口URL是否正确？
- [ ] 是否需要用户身份认证？
- [ ] 是否已实现此接口？
- [ ] 预计完成时间？

#### 1.2 请求参数
```javascript
// 请求头
{
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}

// 请求参数（如需要）
{
  "user_id": "13612227930",  // 用户ID
  "date": "2024-12-XX"       // 查询日期（可选，默认今天）
}
```

**请确认**：
- [ ] 是否需要传递user_id参数？
- [ ] 是否需要指定查询日期？
- [ ] 还需要其他参数吗？

### 2. 📊 数据返回格式

#### 2.1 期望响应格式
```javascript
{
    "code": 0,
    "msg": "success",
    "data": {
        "today_earned": 150,      // 今日获得积分
        "today_consumed": 80,     // 今日消费积分
        "last_update": "2024-12-XX 15:30:00"  // 最后更新时间
    }
}
```

#### 2.2 错误响应格式
```javascript
{
    "code": 1001,
    "msg": "用户未找到",
    "data": null
}
```

**请确认**：
- [ ] 字段名是否正确？（`today_earned`, `today_consumed`）
- [ ] 数据类型是否为数字？
- [ ] 是否需要添加其他字段？
- [ ] 错误码定义是否正确？

### 3. 🔍 业务逻辑确认

#### 3.1 今日获得积分 (`today_earned`)

**业务规则确认**：
- [ ] 是否只计算今日审核通过的照片获得的积分？
- [ ] 积分计算规则是什么？（例如：1元=10积分）
- [ ] 时间范围：是按自然日（00:00-23:59）计算吗？
- [ ] 是否包括系统奖励积分？
- [ ] 是否包括签到积分？

**特殊情况处理**：
- [ ] 如果今日没有审核通过照片，应该返回0还是null？
- [ ] 如果用户今日没有任何积分变动，如何处理？

#### 3.2 今日消费积分 (`today_consumed`)

**业务规则确认**：
- [ ] 是否包括抽奖消费的积分？
- [ ] 是否包括商品兑换消费的积分？
- [ ] 是否包括其他类型的积分消费？
- [ ] 消费积分是否为负数还是正数？

**特殊情况处理**：
- [ ] 如果今日没有消费积分，应该返回0还是null？
- [ ] 如果发生积分退还，如何计算？

### 4. 🏗️ 数据库设计确认

#### 4.1 相关数据表
**请确认以下表是否存在**：
- [ ] `user_points` - 用户积分表
- [ ] `points_records` - 积分记录表
- [ ] `photo_audit` - 照片审核表
- [ ] `lottery_records` - 抽奖记录表

#### 4.2 关键字段
**请确认以下字段是否存在**：
- [ ] `created_at` - 创建时间
- [ ] `points_change` - 积分变动
- [ ] `change_type` - 变动类型（获得/消费）
- [ ] `audit_status` - 审核状态

### 5. ⚡ 性能要求

#### 5.1 响应时间
- [ ] API响应时间要求：< 500ms
- [ ] 数据库查询优化：是否已添加索引？
- [ ] 缓存策略：是否需要Redis缓存？

#### 5.2 并发处理
- [ ] 同时处理多少个用户请求？
- [ ] 是否需要防刷限制？

### 6. 🔐 安全要求

#### 6.1 权限验证
- [ ] 用户只能查看自己的积分数据
- [ ] 管理员权限是否有特殊处理？
- [ ] Token验证机制是否完善？

#### 6.2 数据保护
- [ ] 是否需要敏感数据加密？
- [ ] 日志记录要求？

### 7. 🧪 测试验证方案

#### 7.1 测试用例
**请提供以下测试场景的数据**：

1. **正常场景**：
   - [ ] 用户今日有审核通过照片，有积分获得
   - [ ] 用户今日有抽奖消费，有积分消费
   - [ ] 用户今日既有获得又有消费

2. **边界场景**：
   - [ ] 用户今日没有任何积分变动
   - [ ] 用户今日只有获得，没有消费
   - [ ] 用户今日只有消费，没有获得

3. **异常场景**：
   - [ ] 用户不存在
   - [ ] Token过期
   - [ ] 数据库连接异常

#### 7.2 测试账号
**请提供测试账号**：
- [ ] 有积分变动的测试账号
- [ ] 没有积分变动的测试账号
- [ ] 管理员权限测试账号

### 8. 📅 时间计划

#### 8.1 开发计划
- [ ] API接口开发完成时间：____年____月____日
- [ ] 单元测试完成时间：____年____月____日
- [ ] 联调测试完成时间：____年____月____日
- [ ] 生产环境部署时间：____年____月____日

#### 8.2 里程碑
- [ ] 第一阶段：基础API实现
- [ ] 第二阶段：业务逻辑完善
- [ ] 第三阶段：性能优化
- [ ] 第四阶段：安全加固

### 9. 📝 其他需要确认的信息

#### 9.1 环境配置
- [ ] 开发环境API地址：
- [ ] 测试环境API地址：
- [ ] 生产环境API地址：

#### 9.2 监控告警
- [ ] 是否需要API监控？
- [ ] 异常告警机制？
- [ ] 日志收集方案？

#### 9.3 文档要求
- [ ] 是否需要提供详细的API文档？
- [ ] 是否需要提供数据库设计文档？
- [ ] 是否需要提供部署文档？

## 📞 联系方式

### 前端负责人
- **姓名**: [前端开发者]
- **联系方式**: [联系方式]
- **工作时间**: 周一至周五 9:00-18:00

### 沟通渠道
- **即时沟通**: [企业微信/钉钉]
- **问题反馈**: [项目管理系统]
- **紧急联系**: [手机号码]

## 📋 确认清单

**请后端程序员在完成后勾选**：

- [ ] 已阅读并理解所有需求
- [ ] 已确认API接口设计
- [ ] 已确认数据返回格式
- [ ] 已确认业务逻辑规则
- [ ] 已确认数据库设计
- [ ] 已确认性能要求
- [ ] 已确认安全要求
- [ ] 已确认测试方案
- [ ] 已确认时间计划
- [ ] 已提供测试账号和数据

**签名确认**：
- 后端负责人：_______________ 日期：_______________
- 项目经理：_______________ 日期：_______________

---

**备注**: 此文档将作为前后端对接的重要依据，请认真填写并及时反馈。如有疑问，请及时沟通。 