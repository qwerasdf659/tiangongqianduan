# ğŸš€ åç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£ - ç¼–å†™æ ‡å‡†ä¸å‡†åˆ™

> **åŸºäºNode.jsçš„åç«¯å¼€å‘æŠ€æœ¯è§„èŒƒ** - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿå®é™…æ¶æ„æ ‡å‡†

## ğŸ“‹ ä¸€ã€æ–‡æ¡£å®šä½ä¸æ ‡å‡†

### 1.1 æ–‡æ¡£å®šä½
- **å”¯ä¸€å—ä¼—**ï¼šåç«¯å¼€å‘å·¥ç¨‹å¸ˆã€DevOpså·¥ç¨‹å¸ˆ
- **æ ¸å¿ƒèŒè´£**ï¼šNode.jsåç«¯æœåŠ¡å¼€å‘è§„èŒƒ
- **æŠ€æœ¯è¾¹ç•Œ**ï¼šä»…æ¶µç›–åç«¯æŠ€æœ¯æ ˆï¼Œä¸åŒ…å«å‰ç«¯UIé€»è¾‘
- **å†…å®¹æ·±åº¦**ï¼šæ·±å…¥åç«¯ä¸“ä¸šé¢†åŸŸï¼Œæä¾›ç”Ÿäº§çº§è§£å†³æ–¹æ¡ˆ
- **æ›´æ–°æ—¶é—´**ï¼š2025å¹´01æœˆ11æ—¥ - åŸºäºæƒé™ç®€åŒ–åçš„å®é™…è¿è¡Œä»£ç å®Œæ•´æ›´æ–°
- **äº§å“å¯¹æ¥**ï¼šå®Œå…¨ç¬¦åˆé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿäº§å“åŠŸèƒ½ç»“æ„æè¿°ï¼Œç¡®ä¿å‰åç«¯æ•°æ®åº“å¯¹æ¥å·¥ä½œ

### 1.2 ğŸš§ å¼€å‘é˜¶æ®µé™åˆ¶è¯´æ˜

> **âš ï¸ é‡è¦æé†’**ï¼šå½“å‰ä¸ºå¼€å‘é˜¶æ®µï¼Œä¸ºä¾¿äºå‰åç«¯æ•°æ®åº“å¯¹æ¥å¼€å‘ï¼Œä»¥ä¸‹åŠŸèƒ½**æš‚åœå¼€å‘**ï¼š

- ğŸ“± **æ‰‹æœºå·ç éªŒè¯åŠŸèƒ½**ï¼šåŒ…æ‹¬çŸ­ä¿¡éªŒè¯ç å‘é€ã€éªŒè¯ç­‰æ‰€æœ‰ç›¸å…³åŠŸèƒ½
- ğŸ” **ç®¡ç†å‘˜äºŒæ¬¡éªŒè¯**ï¼šç®¡ç†å‘˜ç™»å½•æš‚æ—¶è·³è¿‡çŸ­ä¿¡äºŒæ¬¡éªŒè¯æ­¥éª¤
- ğŸ“ **æ‰€æœ‰çŸ­ä¿¡ç›¸å…³æœåŠ¡**ï¼šæš‚æ—¶ä¸æ¥å…¥çŸ­ä¿¡æœåŠ¡å•†API

**åç«¯å¼€å‘æŒ‡å¯¼**ï¼š
- ğŸ’¡ **ç»Ÿä¸€ç™»å½•æ–¹å¼**ï¼šæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰ç»Ÿä¸€ä½¿ç”¨æ‰‹æœºå· + éªŒè¯ç 123456ç™»å½•
- ğŸ’¡ **æƒé™è¯†åˆ«**ï¼šç™»å½•åæ ¹æ®æ•°æ®åº“`is_admin`å­—æ®µåˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜
- ğŸ’¡ **æ•°æ®åº“è®¾è®¡**ï¼šä¿ç•™çŸ­ä¿¡éªŒè¯ç›¸å…³å­—æ®µç»“æ„ï¼Œä½†ä¸å®é™…è°ƒç”¨çŸ­ä¿¡æœåŠ¡
- ğŸ’¡ **æ¥å£é¢„ç•™**ï¼šé¢„ç•™çŸ­ä¿¡éªŒè¯ç›¸å…³æ¥å£ï¼Œä¾¿äºåç»­é›†æˆ

### 1.3 ğŸ”´ æƒé™ç³»ç»Ÿé‡å¤§ç®€åŒ–ï¼ˆv2.2.0 - 2025å¹´01æœˆ11æ—¥ï¼‰

> **âš ï¸ é‡è¦å˜æ›´**ï¼šæƒé™ç³»ç»Ÿå·²ä»ä¸‰çº§æƒé™ç®€åŒ–ä¸ºäºŒçº§æƒé™ï¼Œç¡®ä¿ç³»ç»Ÿæ¶æ„æ¸…æ™°ç®€æ´

#### 1.3.1 æƒé™ç®€åŒ–å‰åå¯¹æ¯”
```javascript
// âŒ æ—§ç‰ˆæƒé™ä½“ç³»ï¼ˆå·²åºŸå¼ƒï¼‰
const OLD_PERMISSION_SYSTEM = {
  roles: ['user', 'merchant', 'admin'],
  permissions: {
    user: ['lottery', 'exchange', 'photo_upload'],
    merchant: ['user_permissions', 'review_photos', 'lottery_config'],
    admin: ['all_permissions', 'user_management', 'system_config']
  }
};

// âœ… æ–°ç‰ˆæƒé™ä½“ç³»ï¼ˆå½“å‰å®ç°ï¼‰
const NEW_PERMISSION_SYSTEM = {
  roles: ['user', 'admin'],
  permissions: {
    user: ['lottery', 'exchange', 'photo_upload', 'profile_management'],
    admin: ['all_user_permissions', 'review_photos', 'lottery_config', 'user_management', 'system_config']
  }
};
```

#### 1.3.2 æ•°æ®åº“å­—æ®µå˜æ›´
```sql
-- âŒ å·²åˆ é™¤çš„å­—æ®µ
-- is_merchant, merchant_status, business_name, business_license, 
-- contact_person, contact_phone, business_address, business_type,
-- apply_time, review_time, reviewer_id, reject_reason

-- âœ… ä¿ç•™çš„æƒé™å­—æ®µ
is_admin BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'ç®¡ç†å‘˜æƒé™ï¼ˆå”¯ä¸€æƒé™æ ‡è¯†ï¼‰'
```

### 1.4 ğŸ”´ å®é™…é¡¹ç›®æŠ€æœ¯æ ˆï¼ˆåŸºäºçœŸå®ä»£ç éªŒè¯ï¼‰

**ğŸ“‹ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶ï¼ˆåŸºäºpackage.json + å®é™…è¿è¡ŒéªŒè¯ï¼‰**

#### 1.4.1 æ ¸å¿ƒæœåŠ¡ç»„ä»¶ï¼ˆâœ… è¿è¡ŒéªŒè¯é€šè¿‡ï¼‰
- âœ… **Node.jsè¿è¡Œæ—¶** - v16.0.0+ï¼ˆé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿåç«¯æœåŠ¡ï¼‰
- âœ… **Express.jsæ¡†æ¶** - v4.18.2ï¼ˆHTTPæœåŠ¡ç«¯å£3000ï¼Œæ”¯æŒCORSè·¨åŸŸå’Œé™æµï¼‰
- âœ… **MySQLæ•°æ®åº“** - v8.0+ï¼ˆè¿æ¥æ± max: 20ï¼Œutf8mb4_unicode_ciç¼–ç ï¼‰
- âœ… **Sequelize ORM** - v6.35.1ï¼ˆ8ä¸ªæ ¸å¿ƒæ¨¡å‹ï¼šUserã€LotteryRecordã€ExchangeOrderã€PhotoReviewã€CommodityPoolã€LotterySettingã€LotteryPityã€PointsRecordï¼‰
- âœ… **WebSocketæœåŠ¡** - ws v8.14.2ï¼ˆå®æ—¶é€šä¿¡ï¼Œè·¯å¾„:/wsï¼ŒJWTè®¤è¯ï¼Œå¿ƒè·³30ç§’é—´éš”ï¼Œè¿æ¥ç»Ÿè®¡ï¼‰
- âœ… **JWTè®¤è¯** - jsonwebtoken v9.0.2ï¼ˆåŒTokenæœºåˆ¶ï¼Œç®€åŒ–æƒé™æ§åˆ¶ï¼‰

#### 1.4.2 å®‰å…¨é˜²æŠ¤ç»„ä»¶ï¼ˆâœ… ä¸­é—´ä»¶åŠ è½½å®Œæˆï¼‰
- âœ… **Helmetå®‰å…¨å¤´** - v7.1.0ï¼ˆè·¨åŸŸèµ„æºç­–ç•¥é…ç½®ï¼‰
- âœ… **CORSè·¨åŸŸ** - v2.8.5ï¼ˆæ”¯æŒå¾®ä¿¡å°ç¨‹åºåŸŸåç™½åå•ï¼Œå¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼‰
- âœ… **é™æµä¿æŠ¤** - express-rate-limit v7.1.5ï¼ˆ15åˆ†é’Ÿ100æ¬¡è¯·æ±‚é™åˆ¶ï¼Œå¼€å‘ç¯å¢ƒ1000æ¬¡ï¼‰
- âœ… **å¯†ç åŠ å¯†** - bcrypt v5.1.1ï¼ˆç®¡ç†å‘˜å¯†ç åŠ å¯†å­˜å‚¨ï¼‰
- âœ… **ç¯å¢ƒå˜é‡** - dotenv v16.3.1ï¼ˆç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶JWTå¯†é’¥æ£€æŸ¥ï¼‰

#### 1.4.3 æ–‡ä»¶å’Œäº‘æœåŠ¡ç»„ä»¶ï¼ˆâœ… å­˜å‚¨æœåŠ¡å°±ç»ªï¼‰
- âœ… **æ–‡ä»¶ä¸Šä¼ ** - multer v1.4.5-lts.1ï¼ˆå›¾ç‰‡ä¸Šä¼ ï¼Œé™åˆ¶5MBï¼‰
- âœ… **å›¾åƒå¤„ç†** - sharp v0.32.6ï¼ˆå›¾ç‰‡å‹ç¼©ï¼Œæ ¼å¼è½¬æ¢ï¼‰
- âœ… **äº‘å­˜å‚¨æœåŠ¡** - aws-sdk v2.1498.0ï¼ˆSealoså­˜å‚¨é›†æˆï¼Œæ”¯æŒå¤´åƒå’Œå®¡æ ¸å›¾ç‰‡ï¼‰
- âœ… **HTTPå®¢æˆ·ç«¯** - axios v1.10.0ï¼ˆç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨ï¼Œè¶…æ—¶é…ç½®ï¼‰

#### 1.4.4 å¼€å‘å’Œç›‘æ§ç»„ä»¶
- âœ… **å¼€å‘çƒ­é‡è½½** - nodemon v3.0.2ï¼ˆå¼€å‘ç¯å¢ƒä»£ç çƒ­æ›´æ–°ï¼‰
- âœ… **å¥åº·æ£€æŸ¥** - è‡ªå®šä¹‰æ¨¡å—ï¼ˆ/healthå’Œ/api/healthåŒç«¯ç‚¹ï¼‰
- âœ… **å”¯ä¸€æ ‡è¯†** - uuid v9.0.1ï¼ˆä¸šåŠ¡IDç”Ÿæˆï¼Œæ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰
- âœ… **é”™è¯¯ç›‘æ§** - å…¨å±€é”™è¯¯å¤„ç†ï¼ˆç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ï¼‰

#### 1.4.5 ä¸šåŠ¡ç‰¹å®šç»„ä»¶ï¼ˆâœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
- âœ… **æŠ½å¥–ç®—æ³•** - è‡ªå®šä¹‰æ¦‚ç‡è®¡ç®—ï¼ˆ10æ¬¡ä¿åº•æœºåˆ¶ï¼Œä¹å…«æŠ˜åˆ¸è§¦å‘ï¼‰
- âœ… **ç§¯åˆ†ç³»ç»Ÿ** - äº‹åŠ¡å®‰å…¨çš„ç§¯åˆ†æ‰£é™¤å’Œå¥–åŠ±ï¼ˆæ–°ç”¨æˆ·1000ç§¯åˆ†ï¼ŒæŠ½å¥–100ç§¯åˆ†/æ¬¡ï¼‰
- âœ… **å®æ—¶é€šçŸ¥** - WebSocketæ¨é€ç§¯åˆ†å˜åŠ¨ã€åº“å­˜æ›´æ–°ã€å®¡æ ¸ç»“æœ
- âœ… **å›¾ç‰‡å®¡æ ¸** - ğŸ”´ é‡å¤§ç®€åŒ–ï¼šç”¨æˆ·ä»…ä¸Šä¼ ç…§ç‰‡ï¼Œç®¡ç†å‘˜å®¡æ ¸æ—¶è®¾ç½®æ¶ˆè´¹é‡‘é¢ï¼Œäººå·¥å®¡æ ¸æµç¨‹ä¼˜åŒ–ï¼ˆpending/approved/rejectedï¼‰
- âœ… **æƒé™ç®¡ç†** - ğŸ”´ ç®€åŒ–æƒé™ï¼šåªåŒºåˆ†ç”¨æˆ·å’Œç®¡ç†å‘˜ä¸¤ç§æƒé™
- âœ… **æ–‡ä»¶å­˜å‚¨** - Sealosäº‘å­˜å‚¨é›†æˆï¼Œå›¾ç‰‡å‹ç¼©å¤„ç†ï¼Œä¸Šä¼ éªŒè¯
- âœ… **ç”¨æˆ·ä½“éªŒä¼˜åŒ–** - ğŸ”´ æ ¸å¿ƒæ”¹è¿›ï¼šç®€åŒ–ç”¨æˆ·æ“ä½œæµç¨‹ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘ç”¨æˆ·è¾“å…¥æ­¥éª¤

### 1.5 æ–‡æ¡£ç»“æ„æ ‡å‡†
```
# Node.jsåç«¯æŠ€æœ¯è§„èŒƒ - æƒé™ç®€åŒ–ç‰ˆæœ¬
â”œâ”€â”€ ğŸ—ï¸ å®é™…æœåŠ¡æ¶æ„è§„èŒƒ
â”œâ”€â”€ ğŸ“ é¡¹ç›®ç»“æ„è§„èŒƒï¼ˆåŸºäºçœŸå®ä»£ç ï¼‰
â”œâ”€â”€ ğŸ”Œ APIè®¾è®¡è§„èŒƒï¼ˆ6ä¸ªæ ¸å¿ƒè·¯ç”±æ¨¡å—ï¼‰
â”œâ”€â”€ ğŸ—„ï¸ æ•°æ®è®¿é—®è§„èŒƒï¼ˆSequelize ORMï¼‰
â”œâ”€â”€ ğŸ” å®‰å…¨é˜²æŠ¤è§„èŒƒï¼ˆJWT + ç®€åŒ–æƒé™ï¼‰
â”œâ”€â”€ ğŸ” æ—¥å¿—ç›‘æ§è§„èŒƒ
â”œâ”€â”€ âš¡ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ
â”œâ”€â”€ ğŸ§ª æµ‹è¯•è§„èŒƒ
â”œâ”€â”€ ğŸš€ éƒ¨ç½²è¿ç»´è§„èŒƒ
â””â”€â”€ ğŸ“Š ç›‘æ§å‘Šè­¦è§„èŒƒ
```

## ğŸ—ï¸ äºŒã€å®é™…æœåŠ¡æ¶æ„è§„èŒƒ

### 2.1 åŸºäºapp.jsçš„å®é™…æœåŠ¡æ¶æ„
```javascript
// ğŸ”´ å®é™…æœåŠ¡åˆ†å±‚æ¶æ„ï¼ˆåŸºäºapp.jsåˆ†æï¼‰
const ACTUAL_SERVICE_ARCHITECTURE = {
  
  // 1. å…¥å£å±‚ (Entry Layer) - app.js (317è¡Œ)
  entry: {
    file: 'app.js',
    responsibilities: [
      'Expressåº”ç”¨åˆå§‹åŒ–',
      'HTTPæœåŠ¡å™¨åˆ›å»º',
      'WebSocketæœåŠ¡é›†æˆ',
      'å…¨å±€ä¸­é—´ä»¶é…ç½®',
      'è·¯ç”±æ³¨å†Œç®¡ç†',
      'å¥åº·æ£€æŸ¥æ¥å£ï¼ˆ/health + /api/healthï¼‰',
      'é”™è¯¯å¤„ç†æœºåˆ¶',
      'ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥ï¼ˆJWTå¯†é’¥å¼ºåˆ¶éªŒè¯ï¼‰'
    ],
    middlewares: [
      'helmet() - å®‰å…¨å¤´ï¼ˆcrossOriginResourcePolicy: cross-originï¼‰',
      'cors() - è·¨åŸŸé…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰æ¥æºï¼Œç”Ÿäº§ç¯å¢ƒç™½åå•ï¼‰',
      'express.json() - JSONè§£æï¼ˆ10MBé™åˆ¶ï¼‰',
      'rateLimit() - è¯·æ±‚é™æµï¼ˆå¼€å‘1000æ¬¡/15åˆ†é’Ÿï¼Œç”Ÿäº§100æ¬¡/15åˆ†é’Ÿï¼‰',
      'requestLogger - è¯·æ±‚æ—¥å¿—',
      'errorHandler - ç»Ÿä¸€é”™è¯¯å¤„ç†'
    ]
  },
  
  // 2. è·¯ç”±å±‚ (Routes Layer) - routes/
  routes: {
    structure: 'routes/',
    modules: [
      'auth.js - è®¤è¯æˆæƒï¼ˆ341è¡Œï¼‰ï¼šğŸš§ ç»Ÿä¸€ç™»å½•æ–¹å¼ - æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç 123456ç™»å½•ã€æƒé™é€šè¿‡is_adminå­—æ®µè¯†åˆ«ã€JWTåŒTokenæœºåˆ¶ã€æ–°ç”¨æˆ·1000ç§¯åˆ†å¥–åŠ±',
      'lottery.js - æŠ½å¥–ç³»ç»Ÿï¼ˆ352è¡Œï¼‰ï¼šæŠ½å¥–é…ç½®è·å–ã€æ¦‚ç‡ç®—æ³•æ‰§è¡Œã€10æ¬¡ä¿åº•ä¹å…«æŠ˜åˆ¸ã€ç§¯åˆ†æ‰£é™¤äº‹åŠ¡ã€WebSocketç»“æœæ¨é€',
      'exchange.js - ç§¯åˆ†å…‘æ¢ï¼ˆ503è¡Œï¼‰ï¼šå•†å“åˆ—è¡¨åˆ†é¡µã€åº“å­˜æ£€æŸ¥ã€å…‘æ¢è®¢å•åˆ›å»ºã€WebSocketåº“å­˜å®æ—¶æ¨é€ã€ç§¯åˆ†äº‹åŠ¡å®‰å…¨',
      'user.js - ç”¨æˆ·ç®¡ç†ï¼ˆ336è¡Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°ã€å¤´åƒä¸Šä¼ Sealoså­˜å‚¨ã€ç§¯åˆ†è®°å½•åˆ†é¡µæŸ¥è¯¢ã€è„±æ•æ•°æ®è¿”å›',
      'photo.js - æ‹ç…§ä¸Šä¼ ï¼ˆ502è¡Œï¼‰ï¼šğŸ”´ é‡å¤§ç®€åŒ– - ç”¨æˆ·ä»…ä¸Šä¼ ç…§ç‰‡æ— éœ€è¾“å…¥é‡‘é¢ã€ç®¡ç†å‘˜å®¡æ ¸æ—¶ç›´æ¥è®¾ç½®æ¶ˆè´¹é‡‘é¢ã€Sealosäº‘å­˜å‚¨é›†æˆã€äººå·¥å®¡æ ¸æµç¨‹ä¼˜åŒ–ã€ç§¯åˆ†å¥–åŠ±è‡ªåŠ¨è®¡ç®—ï¼ˆé‡‘é¢Ã—10ï¼‰',
      'merchant.js - ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆ1062è¡Œï¼‰ï¼šğŸ”´ æƒé™ç®€åŒ– - æ”¹ä¸ºç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½æ¨¡å—ã€å®¡æ ¸ç®¡ç†ç•Œé¢ã€æ‰¹é‡å®¡æ ¸æ“ä½œã€ç®¡ç†å‘˜æƒé™éªŒè¯ã€å®¡æ ¸ç»Ÿè®¡æŠ¥è¡¨'
    ],
    responsibilities: [
      'HTTPè¯·æ±‚è·¯ç”±åˆ†å‘ï¼ˆ6ä¸ªæ ¸å¿ƒè·¯ç”±æ¨¡å—ï¼Œæ”¯æŒ/apiå’Œ/uploadåŒè·¯å¾„å…¼å®¹ï¼‰',
      'è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆæ‰‹æœºå·æ­£åˆ™ã€æ–‡ä»¶å¤§å°5MBã€ç§¯åˆ†ä½™é¢æ£€æŸ¥ã€æƒé™éªŒè¯ï¼‰',
      'ä¸šåŠ¡é€»è¾‘è°ƒç”¨ï¼ˆè°ƒç”¨serviceså±‚æŠ½å¥–ç®—æ³•ã€å­˜å‚¨æœåŠ¡ã€WebSocketæ¨é€ï¼‰',
      'å“åº”æ ¼å¼æ ‡å‡†åŒ–ï¼ˆç»Ÿä¸€{code, msg, data}æ ¼å¼ï¼Œé”™è¯¯ç åˆ†ç±»ï¼‰',
      'JWTè®¤è¯ä¸­é—´ä»¶é›†æˆï¼ˆoptionalAuthå¯é€‰è®¤è¯ï¼ŒauthenticateTokenå¼ºåˆ¶è®¤è¯ï¼‰',
      'WebSocketäº‹ä»¶è§¦å‘ï¼ˆç§¯åˆ†å˜åŠ¨ã€åº“å­˜æ›´æ–°ã€å®¡æ ¸ç»“æœå®æ—¶æ¨é€ï¼‰',
      'å…¼å®¹æ€§è·¯ç”±æ”¯æŒï¼ˆ/uploadã€/api/uploadè·¯å¾„å…¼å®¹å‰ç«¯è°ƒç”¨ï¼‰'
    ]
  },
  
  // 3. æœåŠ¡å±‚ (Services Layer) - services/
  services: {
    structure: 'services/',
    modules: [
      'lotteryService.js - æŠ½å¥–æ ¸å¿ƒç®—æ³•ï¼ˆ726è¡Œï¼‰ï¼šæ¦‚ç‡è®¡ç®—ç®—æ³•ã€10æ¬¡ä¿åº•è§¦å‘æœºåˆ¶ã€ç§¯åˆ†æ‰£é™¤äº‹åŠ¡ã€å¥–å“å‘æ”¾é€»è¾‘ã€ç”¨æˆ·æŠ½å¥–ç»Ÿè®¡ã€ç³»ç»ŸæŠ½å¥–ç»Ÿè®¡',
      'websocket.js - WebSocketæœåŠ¡ï¼ˆ335è¡Œï¼‰ï¼šJWT TokenéªŒè¯ã€è·¯å¾„/wsã€å¿ƒè·³ä¿æ´»æœºåˆ¶ã€å®æ—¶æ¨é€ï¼ˆåº“å­˜/ç§¯åˆ†/å®¡æ ¸ç»“æœï¼‰ã€è¿æ¥ç»Ÿè®¡ç®¡ç†ã€ç®¡ç†å‘˜é€šçŸ¥',
      'sealosStorage.js - æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆ302è¡Œï¼‰ï¼šSealosäº‘å­˜å‚¨é›†æˆã€å›¾ç‰‡å‹ç¼©å¤„ç†ã€ä¸Šä¼ ç»“æœéªŒè¯ã€æ–‡ä»¶URLç”Ÿæˆã€é”™è¯¯é‡è¯•æœºåˆ¶'
    ],
    responsibilities: [
      'æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°ï¼ˆæŠ½å¥–ç®—æ³•calculateProbabilityã€æ¦‚ç‡è®¡ç®—ã€ä¿åº•æœºåˆ¶LotteryPityï¼‰',
      'å¤æ‚ç®—æ³•è®¡ç®—ï¼ˆæ¦‚ç‡åˆ†å¸ƒæƒé‡ã€éšæœºæ•°ç”ŸæˆMath.randomã€ä¿åº•è®¡æ•°incrementDrawï¼‰',
      'ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆï¼ˆSealoså­˜å‚¨uploadToSealosã€WebSocketé€šä¿¡ã€å›¾ç‰‡å¤„ç†sharpï¼‰',
      'ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆç§¯åˆ†ä½™é¢æ£€æŸ¥ã€ä»Šæ—¥æŠ½å¥–æ¬¡æ•°é™åˆ¶ã€æ–‡ä»¶æ ¼å¼éªŒè¯ã€æƒé™éªŒè¯ï¼‰',
      'äº‹åŠ¡ç®¡ç†ï¼ˆæ•°æ®åº“äº‹åŠ¡ç¡®ä¿ç§¯åˆ†æ‰£é™¤å’Œè®°å½•çš„ä¸€è‡´æ€§ã€äº‹åŠ¡å›æ»šæœºåˆ¶ï¼‰',
      'å®æ—¶é€šä¿¡ï¼ˆWebSocketè¿æ¥ç®¡ç†ã€æ¶ˆæ¯æ¨é€notifyPointsUpdateã€notifyAdminsã€å¿ƒè·³æœºåˆ¶30ç§’é—´éš”ï¼‰'
    ]
  },
  
  // 4. æ•°æ®å±‚ (Data Layer) - models/
  data: {
    structure: 'models/',
    orm: 'Sequelize ORM v6.35.1',
    models: [
      'User.js - ç”¨æˆ·æ¨¡å‹ï¼ˆ200è¡Œï¼‰ï¼šğŸ”´ æƒé™ç®€åŒ– - ç®€åŒ–æƒé™å­—æ®µï¼Œä¿ç•™is_adminç®¡ç†å‘˜æƒé™ã€ç”¨æˆ·ä¿¡æ¯ã€ç§¯åˆ†ç®¡ç†ã€æ‰‹æœºå·è„±æ•getMaskedMobileã€ä¸šåŠ¡æ–¹æ³•findOrCreateByMobile',
      'PhotoReview.js - å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰ï¼šå›¾ç‰‡URLã€å®¡æ ¸çŠ¶æ€pending/approved/rejectedã€å®¡æ ¸ç†ç”±ã€çº¯äººå·¥å®¡æ ¸æµç¨‹ã€Sealoså­˜å‚¨é›†æˆã€ç®€åŒ–ç”¨æˆ·æ“ä½œæµç¨‹',
      'CommodityPool.js - å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰ï¼šå•†å“ä¿¡æ¯ã€åº“å­˜ç®¡ç†stockã€åˆ†ç±»ç­›é€‰categoryã€çƒ­é—¨æ ‡è®°is_hotã€å‰ç«¯å­—æ®µæ˜ å°„getFrontendInfo',
      'LotterySetting.js - æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰ï¼šå¥–å“é…ç½®ã€æ¦‚ç‡è®¾ç½®probabilityã€è§’åº¦å®šä½angleã€é¢œè‰²é…ç½®colorã€æ´»åŠ¨å¼€å…³is_activity',
      'LotteryPity.js - ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰ï¼šä¿åº•è®¡æ•°current_countã€è§¦å‘æ¡ä»¶willTriggerPityOnNextã€é‡ç½®æœºåˆ¶resetPityã€10æ¬¡ä¿åº•ä¹å…«æŠ˜åˆ¸',
      'PointsRecord.js - ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰ï¼šç§¯åˆ†å˜åŠ¨è®°å½•ã€ä½™é¢è¿½è¸ªbalance_afterã€æ¥æºåˆ†ç±»sourceã€å…³è”ä¸šåŠ¡ID related_id',
      'LotteryRecord.js - æŠ½å¥–è®°å½•æ¨¡å‹ï¼ˆ142è¡Œï¼‰ï¼šæŠ½å¥–å†å²è®°å½•ã€å¥–å“ä¿¡æ¯prize_nameã€æŠ½å¥–ç±»å‹lottery_type',
      'ExchangeOrder.js - å…‘æ¢è®¢å•æ¨¡å‹ï¼ˆ387è¡Œï¼‰ï¼šå…‘æ¢è®¢å•ç®¡ç†ã€å•†å“å…³è”ã€çŠ¶æ€è·Ÿè¸ª',
      'index.js - æ¨¡å‹ç´¢å¼•ï¼ˆ253è¡Œï¼‰ï¼šæ¨¡å‹å…³è”å…³ç³»å®šä¹‰ã€æ•°æ®åº“åŒæ­¥ã€åˆå§‹åŒ–æ•°æ®ã€å¥åº·æ£€æŸ¥'
    ],
    responsibilities: [
      'æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰ï¼ˆ8ä¸ªæ ¸å¿ƒè¡¨ï¼šusersã€points_recordsã€upload_reviewsã€productsã€lottery_prizesã€lottery_pityã€lottery_recordsã€exchange_ordersï¼‰',
      'æ•°æ®éªŒè¯è§„åˆ™ï¼ˆæ‰‹æœºå·æ­£åˆ™/^1[3-9]\\d{9}$/ã€ç§¯åˆ†èŒƒå›´>=0ã€æ–‡ä»¶å¤§å°<=5MBã€çŠ¶æ€æšä¸¾ä¸¥æ ¼éªŒè¯ï¼‰',
      'æ¨¡å‹å…³è”å…³ç³»ï¼ˆUser.hasMany(PointsRecord)ã€PhotoReview.belongsTo(User)ã€çº§è”åˆ é™¤CASCADEï¼‰',
      'ä¸šåŠ¡æ–¹æ³•å°è£…ï¼ˆè„±æ•æ˜¾ç¤ºgetSafeUserInfoã€å®‰å…¨æŸ¥è¯¢ã€ç§¯åˆ†è®¡ç®—updatePointsã€æƒé™æ£€æŸ¥hasPermissionï¼‰',
      'å‰ç«¯å­—æ®µæ˜ å°„ï¼ˆgetSafeUserInfoè¿‡æ»¤æ•æ„Ÿä¿¡æ¯ã€getFrontendInfoæ ¼å¼åŒ–æ˜¾ç¤ºã€æ‰‹æœºå·è„±æ•138****5678ï¼‰',
      'ç´¢å¼•ä¼˜åŒ–ï¼ˆé¿å…è¶…è¿‡MySQL64ä¸ªç´¢å¼•é™åˆ¶ï¼Œå¤åˆç´¢å¼•idx_user_createdä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢æ€§èƒ½ï¼‰'
    ]
  },
  
  // 5. ä¸­é—´ä»¶å±‚ (Middleware Layer) - middleware/
  middleware: {
    structure: 'middleware/',
    modules: [
      'auth.js - JWTè®¤è¯ä¸­é—´ä»¶ï¼ˆ204è¡Œï¼‰ï¼šğŸ”´ æƒé™ç®€åŒ– - åªæ”¯æŒç”¨æˆ·å’Œç®¡ç†å‘˜æƒé™æ£€æŸ¥ã€ç»Ÿä¸€JWT TokenéªŒè¯ã€ç®€åŒ–çš„æƒé™æ§åˆ¶é€»è¾‘',
      'errorHandler.js - é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼ˆç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ï¼‰'
    ],
    responsibilities: [
      'è¯·æ±‚é¢„å¤„ç†',
      'èº«ä»½éªŒè¯ï¼ˆJWT Tokenè§£æå’ŒéªŒè¯ï¼‰',
      'æƒé™æ§åˆ¶ï¼ˆğŸ”´ ç®€åŒ–ä¸ºç”¨æˆ·æƒé™å’Œç®¡ç†å‘˜æƒé™ä¸¤ç§ï¼‰',
      'é”™è¯¯ç»Ÿä¸€å¤„ç†'
    ]
  }
}
```

### 2.2 é¡¹ç›®ç»“æ„è§„èŒƒï¼ˆå®é™…ä»£ç ç»“æ„ï¼‰
```
// ğŸ”´ å®é™…Node.jsé¡¹ç›®ç»“æ„ï¼ˆåŸºäºä»£ç åˆ†æï¼‰
restaurant-points-backend/
â”œâ”€â”€ app.js                           // ğŸ”´ åº”ç”¨ä¸»å…¥å£ï¼ˆ317è¡Œï¼‰- Express+WebSocketæœåŠ¡
â”œâ”€â”€ package.json                     // ğŸ”´ é¡¹ç›®ä¾èµ–ï¼ˆ65è¡Œï¼‰- 13ä¸ªæ ¸å¿ƒä¾èµ–åŒ…
â”œâ”€â”€ package-lock.json               // ğŸ”´ ä¾èµ–ç‰ˆæœ¬é”å®šï¼ˆ6874è¡Œï¼‰
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.js                 // ğŸ”´ æ•°æ®åº“é…ç½®ï¼ˆ100è¡Œï¼‰- MySQLè¿æ¥æ± 
â”œâ”€â”€ models/                         // ğŸ”´ æ•°æ®æ¨¡å‹å±‚ï¼ˆ8ä¸ªæ ¸å¿ƒæ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ index.js                    // ğŸ”´ æ¨¡å‹ç´¢å¼•ï¼ˆ253è¡Œï¼‰- å…³è”å…³ç³»å®šä¹‰
â”‚   â”œâ”€â”€ User.js                     // ğŸ”´ ç”¨æˆ·æ¨¡å‹ï¼ˆ200è¡Œï¼‰- æƒé™ç®€åŒ–ç‰ˆ
â”‚   â”œâ”€â”€ PointsRecord.js             // ğŸ”´ ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰
â”‚   â”œâ”€â”€ PhotoReview.js              // ğŸ”´ å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰
â”‚   â”œâ”€â”€ CommodityPool.js            // ğŸ”´ å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰
â”‚   â”œâ”€â”€ LotterySetting.js           // ğŸ”´ æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰
â”‚   â”œâ”€â”€ LotteryPity.js              // ğŸ”´ ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰
â”‚   â”œâ”€â”€ LotteryRecord.js            // ğŸ”´ æŠ½å¥–è®°å½•æ¨¡å‹ï¼ˆ142è¡Œï¼‰
â”‚   â””â”€â”€ ExchangeOrder.js            // ğŸ”´ å…‘æ¢è®¢å•æ¨¡å‹ï¼ˆ387è¡Œï¼‰
â”œâ”€â”€ routes/                         // ğŸ”´ APIè·¯ç”±å±‚ï¼ˆ6ä¸ªæ ¸å¿ƒæ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ auth.js                     // ğŸ”´ è®¤è¯æˆæƒï¼ˆ341è¡Œï¼‰- ç»Ÿä¸€ç™»å½•æ–¹å¼
â”‚   â”œâ”€â”€ lottery.js                  // ğŸ”´ æŠ½å¥–ç³»ç»Ÿï¼ˆ352è¡Œï¼‰
â”‚   â”œâ”€â”€ exchange.js                 // ğŸ”´ ç§¯åˆ†å…‘æ¢ï¼ˆ503è¡Œï¼‰
â”‚   â”œâ”€â”€ user.js                     // ğŸ”´ ç”¨æˆ·ç®¡ç†ï¼ˆ336è¡Œï¼‰
â”‚   â”œâ”€â”€ photo.js                    // ğŸ”´ æ‹ç…§ä¸Šä¼ ï¼ˆ502è¡Œï¼‰
â”‚   â””â”€â”€ merchant.js                 // ğŸ”´ ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆ1062è¡Œï¼‰- æƒé™ç®€åŒ–
â”œâ”€â”€ middleware/                     // ğŸ”´ ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ auth.js                     // ğŸ”´ JWTè®¤è¯ï¼ˆ204è¡Œï¼‰- æƒé™ç®€åŒ–ç‰ˆ
â”‚   â””â”€â”€ errorHandler.js             // ğŸ”´ é”™è¯¯å¤„ç†
â”œâ”€â”€ services/                       // ğŸ”´ ä¸šåŠ¡æœåŠ¡å±‚ï¼ˆ3ä¸ªæ ¸å¿ƒæœåŠ¡ï¼‰
â”‚   â”œâ”€â”€ lotteryService.js           // ğŸ”´ æŠ½å¥–ç®—æ³•ï¼ˆ726è¡Œï¼‰
â”‚   â”œâ”€â”€ websocket.js                // ğŸ”´ WebSocketæœåŠ¡ï¼ˆ335è¡Œï¼‰
â”‚   â””â”€â”€ sealosStorage.js            // ğŸ”´ æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆ302è¡Œï¼‰
â”œâ”€â”€ scripts/                        // ğŸ”´ è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ init-database.js            // ğŸ”´ æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ test-db.js                  // ğŸ”´ æ•°æ®åº“æµ‹è¯•
â”‚   â””â”€â”€ test-apis.js                // ğŸ”´ APIæ¥å£æµ‹è¯•
â”œâ”€â”€ uploads/                        // ğŸ”´ æœ¬åœ°æ–‡ä»¶å­˜å‚¨
â”œâ”€â”€ .gitignore                      // ğŸ”´ Gitå¿½ç•¥è§„åˆ™ï¼ˆ63è¡Œï¼‰
â””â”€â”€ README.md                       // ğŸ”´ é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸ” ä¸‰ã€æƒé™ç®¡ç†è§„èŒƒï¼ˆv2.2.0 ç®€åŒ–ç‰ˆï¼‰

### 3.1 æƒé™ä½“ç³»æ¶æ„
```javascript
// ğŸ”´ ç®€åŒ–æƒé™ä½“ç³»ï¼ˆåŸºäºå®é™…ä»£ç ï¼‰
const PERMISSION_SYSTEM = {
  // ç”¨æˆ·è§’è‰²ï¼ˆåªæœ‰ä¸¤ç§ï¼‰
  roles: {
    USER: 'user',           // æ™®é€šç”¨æˆ·
    ADMIN: 'admin'          // ç®¡ç†å‘˜ï¼ˆæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼‰
  },
  
  // æƒé™å®šä¹‰
  permissions: {
    // ç”¨æˆ·æƒé™
    user: [
      'lottery:participate',     // å‚ä¸æŠ½å¥–
      'exchange:submit',         // ç§¯åˆ†å…‘æ¢
      'photo:upload',           // æ‹ç…§ä¸Šä¼ 
      'profile:view',           // æŸ¥çœ‹ä¸ªäººä¿¡æ¯
      'profile:update',         // æ›´æ–°ä¸ªäººä¿¡æ¯
      'points:view',            // æŸ¥çœ‹ç§¯åˆ†è®°å½•
      'orders:view'             // æŸ¥çœ‹è®¢å•è®°å½•
    ],
    
    // ç®¡ç†å‘˜æƒé™ï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·æƒé™ + ç®¡ç†åŠŸèƒ½ï¼‰
    admin: [
      ...this.permissions.user,  // ç»§æ‰¿æ‰€æœ‰ç”¨æˆ·æƒé™
      'photo:review',           // ç…§ç‰‡å®¡æ ¸
      'lottery:config',         // æŠ½å¥–é…ç½®
      'products:manage',        // å•†å“ç®¡ç†
      'users:manage',           // ç”¨æˆ·ç®¡ç†
      'statistics:view',        // ç»Ÿè®¡æŸ¥çœ‹
      'system:config'           // ç³»ç»Ÿé…ç½®
    ]
  }
};
```

### 3.2 JWT Tokenç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
```javascript
// ğŸ”´ ç®€åŒ–JWT Token Payloadï¼ˆåŸºäºmiddleware/auth.jsï¼‰
const JWT_PAYLOAD = {
  user_id: 123,              // ç”¨æˆ·ID
  mobile: "13800138000",     // æ‰‹æœºå·
  is_admin: false,           // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†ï¼ˆç®¡ç†å‘˜ä¸ºtrueï¼‰
  iat: 1640995200,           // ç­¾å‘æ—¶é—´
  exp: 1640998800,           // è¿‡æœŸæ—¶é—´
  iss: 'restaurant-points-system'  // ç­¾å‘è€…
};

// TokenéªŒè¯é€»è¾‘ç®€åŒ–
function verifyPermission(req, res, next) {
  const user = req.user;
  
  // ğŸ”´ æƒé™æ£€æŸ¥ç®€åŒ–ä¸ºæ£€æŸ¥is_adminå­—æ®µ
  if (needsAdminPermission(req.path)) {
    if (!user.is_admin) {
      return res.status(403).json({
        code: 4005,
        msg: 'éœ€è¦ç®¡ç†å‘˜æƒé™',
        data: null
      });
    }
  }
  
  next();
}
```

### 3.3 æƒé™ä¸­é—´ä»¶å®ç°ï¼ˆåŸºäºmiddleware/auth.jsï¼‰
```javascript
// ğŸ”´ å®é™…æƒé™ä¸­é—´ä»¶ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰

/**
 * ç®¡ç†å‘˜æƒé™æ£€æŸ¥ä¸­é—´ä»¶ï¼ˆå”¯ä¸€æƒé™éªŒè¯ï¼‰
 */
const requireAdmin = (req, res, next) => {
  if (!req.user) {
    return res.status(401).json({
      code: 4001,
      msg: 'éœ€è¦ç™»å½•è®¿é—®',
      data: null
    });
  }

  if (!req.user.is_admin) {
    return res.status(403).json({
      code: 4005,
      msg: 'éœ€è¦ç®¡ç†å‘˜æƒé™',
      data: null
    });
  }

  next();
};

/**
 * ç”¨æˆ·èº«ä»½éªŒè¯ä¸­é—´ä»¶ï¼ˆåŸºç¡€è®¤è¯ï¼‰
 */
const requireUser = authenticateToken;

// ğŸ”´ å¯¼å‡ºçš„æƒé™ä¸­é—´ä»¶ï¼ˆç®€åŒ–åï¼‰
module.exports = {
  generateTokens,
  verifyAccessToken,
  verifyRefreshToken,
  authenticateToken,
  optionalAuth,
  requireAdmin,        // ğŸ”´ å”¯ä¸€æƒé™æ£€æŸ¥ä¸­é—´ä»¶
  requireUser,
  requestLogger
};
```

### 3.4 è·¯ç”±æƒé™é…ç½®ï¼ˆåŸºäºå®é™…è·¯ç”±ï¼‰
```javascript
// ğŸ”´ å®é™…è·¯ç”±æƒé™é…ç½®ç¤ºä¾‹ï¼ˆåŸºäºroutes/merchant.jsï¼‰

// ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
router.get('/pending-reviews', authenticateToken, requireAdmin, async (req, res) => {
  // è·å–å¾…å®¡æ ¸åˆ—è¡¨ - åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
});

router.post('/review', authenticateToken, requireAdmin, async (req, res) => {
  // å®¡æ ¸ç…§ç‰‡ - åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ“ä½œ
});

router.get('/statistics', authenticateToken, requireAdmin, async (req, res) => {
  // æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ - åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹
});

// ç”¨æˆ·åŠŸèƒ½ï¼ˆåªéœ€è¦ç™»å½•éªŒè¯ï¼‰
router.get('/profile', authenticateToken, async (req, res) => {
  // æŸ¥çœ‹ä¸ªäººä¿¡æ¯ - æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥
});

router.post('/lottery/draw', authenticateToken, async (req, res) => {
  // å‚ä¸æŠ½å¥– - æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥
});
```

## ğŸ—„ï¸ å››ã€æ•°æ®æ¨¡å‹è§„èŒƒï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 4.1 Useræ¨¡å‹è§„èŒƒï¼ˆåŸºäºmodels/User.jsï¼‰
```javascript
// ğŸ”´ ç®€åŒ–åçš„Useræ¨¡å‹å®šä¹‰
const User = sequelize.define('User', {
  user_id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true,
    comment: 'ç”¨æˆ·ID'
  },
  
  mobile: {
    type: DataTypes.STRING(11),
    allowNull: false,
    unique: true,
    comment: 'æ‰‹æœºå·ç '
  },
  
  nickname: {
    type: DataTypes.STRING(50),
    allowNull: true,
    comment: 'ç”¨æˆ·æ˜µç§°',
    defaultValue: 'æ–°ç”¨æˆ·'
  },
  
  total_points: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 0,
    comment: 'æ€»ç§¯åˆ†'
  },
  
  // ğŸ”´ æƒé™ç®¡ç† - ç®€åŒ–ä¸ºåªæœ‰ç®¡ç†å‘˜æƒé™
  is_admin: {
    type: DataTypes.BOOLEAN,
    allowNull: false,
    defaultValue: false,
    comment: 'æ˜¯å¦ç®¡ç†å‘˜'
  },
  
  status: {
    type: DataTypes.ENUM('active', 'inactive', 'banned'),
    allowNull: false,
    defaultValue: 'active',
    comment: 'ç”¨æˆ·çŠ¶æ€'
  }
  
  // ğŸ”´ æ³¨æ„ï¼šæƒé™å­—æ®µå·²ç®€åŒ–ï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½é€šè¿‡is_adminæ§åˆ¶
// is_merchantç­‰å­—æ®µå·²ç®€åŒ–ï¼Œç»Ÿä¸€ä½¿ç”¨is_adminæƒé™æ§åˆ¶
});

// ğŸ”´ ç”¨æˆ·æƒé™æ£€æŸ¥æ–¹æ³•ï¼ˆç®€åŒ–ç‰ˆï¼‰
User.prototype.hasPermission = function(permission) {
  switch (permission) {
    case 'admin':
      return this.is_admin;
    default:
      return false;  // ä¸å†æ”¯æŒmerchantæƒé™æ£€æŸ¥
  }
};

// ğŸ”´ è·å–å®‰å…¨ç”¨æˆ·ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
User.prototype.getSafeUserInfo = function() {
  return {
    user_id: this.user_id,
    mobile: this.getMaskedMobile(),
    nickname: this.nickname,
    avatar_url: this.avatar_url,
    total_points: this.total_points,
    is_admin: this.is_admin,     // ğŸ”´ å”¯ä¸€æƒé™å­—æ®µ
    status: this.status,
    last_login: this.last_login,
    created_at: this.created_at
    // ğŸ”´ æ³¨æ„ï¼šä¸å†è¿”å›å•†å®¶ç›¸å…³ä¿¡æ¯
  };
};
```

### 4.2 æ•°æ®åº“è¡¨ç»“æ„ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
```sql
-- ğŸ”´ ç®€åŒ–åçš„usersè¡¨ç»“æ„
CREATE TABLE `users` (
  `user_id` INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `mobile` VARCHAR(11) UNIQUE NOT NULL COMMENT 'æ‰‹æœºå·ç ',
  `nickname` VARCHAR(50) DEFAULT 'æ–°ç”¨æˆ·' COMMENT 'ç”¨æˆ·æ˜µç§°',
  `avatar_url` VARCHAR(500) COMMENT 'å¤´åƒURL',
  `total_points` INTEGER NOT NULL DEFAULT 0 COMMENT 'æ€»ç§¯åˆ†',
  
  -- ğŸ”´ æƒé™ç®¡ç† - ç®€åŒ–ä¸ºåªæœ‰ç®¡ç†å‘˜æƒé™
  `is_admin` BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'æ˜¯å¦ç®¡ç†å‘˜',
  
  `status` ENUM('active', 'inactive', 'banned') NOT NULL DEFAULT 'active' COMMENT 'ç”¨æˆ·çŠ¶æ€',
  `last_login` DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `login_count` INTEGER NOT NULL DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- ğŸ”´ ç´¢å¼•è®¾è®¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
  INDEX `idx_mobile` (`mobile`),
  INDEX `idx_admin_status` (`is_admin`, `status`)
  
  -- ğŸ”´ æ³¨æ„ï¼šæƒé™å­—æ®µå·²ç®€åŒ–ï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½é€šè¿‡is_adminç»Ÿä¸€æ§åˆ¶
-- ç®€åŒ–çš„å­—æ®µï¼šis_merchant, merchant_status, business_name, business_license,
  -- contact_person, contact_phone, business_address, business_type,
  -- apply_time, review_time, reviewer_id, reject_reason
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## ğŸ”Œ äº”ã€APIè®¾è®¡è§„èŒƒï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 5.1 è®¤è¯APIè§„èŒƒï¼ˆåŸºäºroutes/auth.jsï¼‰
```javascript
// ğŸ”´ ç»Ÿä¸€ç™»å½•æ¥å£ï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬ç®¡ç†å‘˜éƒ½ä½¿ç”¨æ­¤æ¥å£ï¼‰
POST /api/auth/login
{
  "mobile": "13800138000",
  "code": "123456"        // å¼€å‘ç¯å¢ƒå›ºå®šéªŒè¯ç 
}

// å“åº”æ ¼å¼ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 7200,
    "user_info": {
      "user_id": 123,
      "mobile": "138****8000",
      "nickname": "ç”¨æˆ·001",
      "total_points": 1000,
      "is_admin": false,      // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†
      "status": "active"
      // ğŸ”´ æ³¨æ„ï¼šä¸å†è¿”å›is_merchantã€business_infoç­‰å­—æ®µ
    }
  }
}
```

### 5.2 å•†å®¶ç®¡ç†åŠŸèƒ½APIè§„èŒƒï¼ˆç®¡ç†å‘˜æƒé™æ§åˆ¶ï¼‰
```javascript
// ğŸ” å•†å®¶å®¡æ ¸ç®¡ç†ï¼ˆå®Œå…¨ä¿ç•™ï¼Œä»…éœ€ç®¡ç†å‘˜æƒé™ï¼‰
GET /api/merchant/pending-reviews
Headers: {
  Authorization: "Bearer <admin_token>"  // éœ€è¦ç®¡ç†å‘˜æƒé™
}

// ğŸ”´ å®¡æ ¸ç…§ç‰‡ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
POST /api/merchant/review
Headers: {
  Authorization: "Bearer <admin_token>"  // éœ€è¦ç®¡ç†å‘˜æƒé™
}
Body: {
  "upload_id": "upload_123_1640001234567_abc123",
  "action": "approve",     // approve | reject
  "amount": 58.50,         // ç®¡ç†å‘˜è®¾ç½®çš„æ¶ˆè´¹é‡‘é¢
  "review_reason": "å®¡æ ¸é€šè¿‡"
}

// ğŸ”´ æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
GET /api/merchant/statistics
Headers: {
  Authorization: "Bearer <admin_token>"  // éœ€è¦ç®¡ç†å‘˜æƒé™
}
```

### 5.3 æƒé™éªŒè¯æµç¨‹
```javascript
// ğŸ”´ APIæƒé™éªŒè¯æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
const API_PERMISSION_FLOW = {
  
  // 1. TokenéªŒè¯
  tokenValidation: {
    middleware: 'authenticateToken',
    checks: [
      'Tokenæ ¼å¼éªŒè¯',
      'Tokenç­¾åéªŒè¯',
      'Tokenè¿‡æœŸæ£€æŸ¥',
      'ç”¨æˆ·å­˜åœ¨æ€§éªŒè¯',
      'ç”¨æˆ·çŠ¶æ€æ£€æŸ¥'
    ]
  },
  
  // 2. æƒé™éªŒè¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
  permissionValidation: {
    middleware: 'requireAdmin',
    logic: `
      if (éœ€è¦ç®¡ç†å‘˜æƒé™çš„API) {
        if (!req.user.is_admin) {
          return 403 éœ€è¦ç®¡ç†å‘˜æƒé™;
        }
      }
      // æ™®é€šç”¨æˆ·APIåªéœ€è¦TokenéªŒè¯
    `
  },
  
  // 3. APIè®¿é—®æ§åˆ¶çŸ©é˜µï¼ˆç®€åŒ–ç‰ˆï¼‰
  accessMatrix: {
    '/api/auth/*': 'æ‰€æœ‰ç”¨æˆ·',
    '/api/lottery/*': 'ç™»å½•ç”¨æˆ·',
    '/api/exchange/*': 'ç™»å½•ç”¨æˆ·',
    '/api/photo/upload': 'ç™»å½•ç”¨æˆ·',
    '/api/user/*': 'ç™»å½•ç”¨æˆ·',
    '/api/merchant/*': 'ä»…ç®¡ç†å‘˜',        // ğŸ”´ ç®¡ç†å‘˜ä¸“ç”¨æ¨¡å—
    '/api/health': 'æ‰€æœ‰ç”¨æˆ·'
  }
};
```

## ğŸ“Š å…­ã€ç³»ç»Ÿç›‘æ§è§„èŒƒ

### 6.1 æƒé™ç»Ÿè®¡ç›‘æ§
```javascript
// ğŸ”´ æƒé™ç»Ÿè®¡æ–¹æ³•ï¼ˆåŸºäºUseræ¨¡å‹ï¼‰
User.getPermissionStats = async function() {
  const [total, admins] = await Promise.all([
    this.count({ where: { status: 'active' } }),
    this.count({ where: { is_admin: true, status: 'active' } })
  ]);
  
  return {
    total_users: total,
    normal_users: total - admins,
    admins: admins
    // ğŸ”´ æ³¨æ„ï¼šä¸å†ç»Ÿè®¡å•†å®¶æ•°é‡
  };
};
```

### 6.2 å¥åº·æ£€æŸ¥è§„èŒƒï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
```javascript
// ğŸ”´ å¥åº·æ£€æŸ¥æ¥å£ï¼ˆåŸºäºapp.jsï¼‰
app.get('/health', async (req, res) => {
  try {
    const dbHealth = await healthCheck();
    const wsStats = webSocketService.getConnectionStats();
    const permissionStats = await User.getPermissionStats();  // ğŸ”´ æ–°å¢æƒé™ç»Ÿè®¡
    
    res.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      version: '1.0.0',
      environment: process.env.NODE_ENV,
      database: dbHealth,
      websocket: {
        status: 'running',
        connections: wsStats.total
      },
      permissions: permissionStats,    // ğŸ”´ æƒé™ç»Ÿè®¡ä¿¡æ¯
      uptime: process.uptime()
    });
  } catch (error) {
    res.status(500).json({
      status: 'unhealthy',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
```

## ğŸš€ ä¸ƒã€éƒ¨ç½²å’Œè¿ç»´è§„èŒƒ

### 7.1 ç¯å¢ƒé…ç½®ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
```bash
# ğŸ”´ ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæƒé™ç®€åŒ–ï¼‰
NODE_ENV=production
PORT=3000

# æ•°æ®åº“é…ç½®
DB_HOST=test-db-mysql.ns-br0za7uc.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=mc6r9cgb
DB_NAME=restaurant_points_dev

# JWTé…ç½®
JWT_SECRET=your_secure_jwt_secret_key
JWT_EXPIRES_IN=2h
REFRESH_TOKEN_EXPIRES_IN=7d

# ğŸ”´ å¼€å‘é˜¶æ®µé…ç½®
DEVELOPMENT_MODE=true
SKIP_SMS_VERIFICATION=true     # è·³è¿‡çŸ­ä¿¡éªŒè¯
DEFAULT_VERIFY_CODE=123456     # é»˜è®¤éªŒè¯ç 

# ğŸ”´ æƒé™ç®€åŒ–æ ‡è¯†
PERMISSION_SYSTEM_VERSION=2.2.0
SIMPLIFIED_PERMISSIONS=true    # å¯ç”¨ç®€åŒ–æƒé™æ¨¡å¼
```

### 7.2 æ•°æ®åº“è¿ç§»è§„èŒƒï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
```sql
-- ğŸ”´ æƒé™ç®€åŒ–æ•°æ®åº“è¿ç§»è„šæœ¬
-- è¿ç§»ç‰ˆæœ¬ï¼šv2.2.0

-- åˆ é™¤å•†å®¶ç›¸å…³å­—æ®µ
ALTER TABLE `users` DROP COLUMN IF EXISTS `is_merchant`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `merchant_status`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `business_name`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `business_license`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `contact_person`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `contact_phone`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `business_address`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `business_type`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `apply_time`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `review_time`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `reviewer_id`;
ALTER TABLE `users` DROP COLUMN IF EXISTS `reject_reason`;

-- åˆ é™¤å•†å®¶ç›¸å…³ç´¢å¼•
DROP INDEX IF EXISTS `idx_merchant_status` ON `users`;
DROP INDEX IF EXISTS `idx_is_merchant` ON `users`;

-- åˆ›å»ºç®€åŒ–æƒé™ç´¢å¼•
CREATE INDEX `idx_admin_status` ON `users` (`is_admin`, `status`);

-- æ›´æ–°ç°æœ‰å•†å®¶ç”¨æˆ·ä¸ºç®¡ç†å‘˜
UPDATE `users` SET `is_admin` = true WHERE `is_merchant` = true;
```

### 7.3 éƒ¨ç½²æ£€æŸ¥æ¸…å•ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
```bash
# ğŸ”´ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

## 1. ä»£ç æ£€æŸ¥
- [ ] Useræ¨¡å‹å·²åˆ é™¤æ‰€æœ‰å•†å®¶å­—æ®µ
- [ ] æƒé™ä¸­é—´ä»¶åªä¿ç•™requireAdmin
- [ ] JWT TokenåªåŒ…å«is_adminå­—æ®µ
- [ ] æ‰€æœ‰APIè·¯ç”±æƒé™æ£€æŸ¥å·²æ›´æ–°

## 2. æ•°æ®åº“æ£€æŸ¥
- [ ] usersè¡¨å•†å®¶å­—æ®µå·²åˆ é™¤
- [ ] æƒé™ç›¸å…³ç´¢å¼•å·²æ›´æ–°
- [ ] ç°æœ‰æ•°æ®è¿ç§»å®Œæˆ

## 3. é…ç½®æ£€æŸ¥
- [ ] ç¯å¢ƒå˜é‡å·²æ›´æ–°
- [ ] JWTå¯†é’¥å®‰å…¨é…ç½®
- [ ] æƒé™ç³»ç»Ÿç‰ˆæœ¬æ ‡è¯†æ­£ç¡®

## 4. åŠŸèƒ½æµ‹è¯•
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ç®¡ç†å‘˜æƒé™éªŒè¯æ­£å¸¸
- [ ] APIæƒé™æ§åˆ¶ç”Ÿæ•ˆ
- [ ] WebSocketæ¨é€æ­£å¸¸

## 5. æ€§èƒ½éªŒè¯
- [ ] æƒé™æ£€æŸ¥æ€§èƒ½è‰¯å¥½
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸
```

## ğŸ“‹ å…«ã€å¼€å‘è§„èŒƒæ€»ç»“

### 8.1 æƒé™ç®€åŒ–æ ¸å¿ƒåŸåˆ™
1. **äºŒçº§æƒé™**ï¼šåªåŒºåˆ†ç”¨æˆ·å’Œç®¡ç†å‘˜ï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½ç”±ç®¡ç†å‘˜ç»Ÿä¸€è´Ÿè´£
2. **ç»Ÿä¸€ç™»å½•**ï¼šæ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç›¸åŒçš„ç™»å½•æ–¹å¼
3. **ç®€åŒ–éªŒè¯**ï¼šæƒé™æ£€æŸ¥åªéœ€éªŒè¯is_adminå­—æ®µ
4. **å‘å‰å…¼å®¹**ï¼šä¿æŒAPIæ¥å£è·¯å¾„ä¸å˜ï¼Œä»…è°ƒæ•´æƒé™é€»è¾‘

### 8.2 å¼€å‘æŒ‡å¯¼åŸåˆ™
1. **æ•°æ®åº“è®¾è®¡**ï¼šç®€åŒ–æƒé™å­—æ®µï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½é€šè¿‡ç®¡ç†å‘˜æƒé™æ§åˆ¶
2. **APIè®¾è®¡**ï¼šä¿æŒç°æœ‰æ¥å£ï¼Œä½†è°ƒæ•´æƒé™éªŒè¯é€»è¾‘
3. **å‰ç«¯é€‚é…**ï¼šæ›´æ–°å‰ç«¯æƒé™åˆ¤æ–­é€»è¾‘ï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½è°ƒæ•´ä¸ºç®¡ç†å‘˜ä¸“ç”¨
4. **æµ‹è¯•è¦†ç›–**ï¼šé‡ç‚¹æµ‹è¯•æƒé™éªŒè¯å’Œç”¨æˆ·ä½“éªŒ

### 8.3 æ³¨æ„äº‹é¡¹
1. **æ•°æ®è¿ç§»**ï¼šè°¨æ…å¤„ç†ç°æœ‰å•†å®¶ç”¨æˆ·æ•°æ®
2. **æ¥å£å…¼å®¹**ï¼šç¡®ä¿å‰ç«¯è°ƒç”¨ä¸ä¼šå‡ºç°é”™è¯¯
3. **æƒé™å®‰å…¨**ï¼šç¡®ä¿ç®¡ç†å‘˜æƒé™æ£€æŸ¥ä¸¥æ ¼æœ‰æ•ˆ
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æƒé™å˜æ›´å’Œè®¿é—®æ—¥å¿—

## ä¹ã€æŠ½å¥–ä¸šåŠ¡é€»è¾‘è§„èŒƒ

### 9.1 æŠ½å¥–ç±»å‹æ˜ å°„å¼ºåˆ¶è§„èŒƒï¼ˆ2025å¹´1æœˆ12æ—¥æ–°å¢ï¼‰

#### é—®é¢˜èƒŒæ™¯
**å®é™…æ•…éšœæ¡ˆä¾‹**ï¼šç®¡ç†å‘˜è´¦å·13612227930å‘ç°æŠ½å¥–åŠŸèƒ½å¼‚å¸¸ï¼š
- åè¿æŠ½åªæ‰£é™¤100ç§¯åˆ†ï¼ˆåº”æ‰£é™¤1000ç§¯åˆ†ï¼‰
- æ¯æ¬¡æŠ½å¥–éƒ½åªä¸­"èŠ±ç”²1ä»½"ï¼ˆåº”æœ‰æ¦‚ç‡åˆ†å¸ƒï¼‰

**æ ¹å› åˆ†æ**ï¼šå‰ç«¯å‘é€`{"draw_type": "åè¿æŠ½"}`ï¼Œä½†åç«¯drawCountsæ˜ å°„ç¼ºå°‘ä¸­æ–‡ç±»å‹ï¼Œå¯¼è‡´`actualCount = 1`

#### ä¿®å¤æªæ–½å’Œé¢„é˜²è§„èŒƒ
```javascript
// ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šæŠ½å¥–ç±»å‹æ˜ å°„å¿…é¡»æ”¯æŒå‰ç«¯æ‰€æœ‰å¯èƒ½çš„ä¼ å€¼
const drawCounts = {
  // è‹±æ–‡ç±»å‹ï¼ˆå…¼å®¹æ€§ä¿æŒï¼‰
  'single': 1, 'triple': 3, 'quintuple': 5,
  'five': 5, 'decade': 10, 'ten': 10,
  
  // ğŸš¨ å¼ºåˆ¶è¦æ±‚ï¼šä¸­æ–‡ç±»å‹ï¼ˆä¿®å¤æ ¸å¿ƒé—®é¢˜ï¼‰
  'å•æŠ½': 1, 'ä¸‰è¿æŠ½': 3, 'äº”è¿æŠ½': 5, 'åè¿æŠ½': 10
};

// ğŸ”´ éªŒè¯é€»è¾‘ï¼šç¡®ä¿æ‰€æœ‰æŠ½å¥–ç±»å‹éƒ½æœ‰å¯¹åº”æ˜ å°„
function validateDrawType(draw_type) {
  const actualCount = drawCounts[draw_type];
  if (!actualCount) {
    console.error(`ğŸš« æœªæ”¯æŒçš„æŠ½å¥–ç±»å‹: ${draw_type}`);
    throw new Error(`ä¸æ”¯æŒçš„æŠ½å¥–ç±»å‹: ${draw_type}`);
  }
  return actualCount;
}
```

#### è´¨é‡ä¿è¯æªæ–½
- **ä»£ç å®¡æŸ¥è¦ç‚¹**ï¼šæ£€æŸ¥æ‰€æœ‰ç”¨æˆ·è¾“å…¥æ˜ å°„æ˜¯å¦å®Œæ•´
- **æµ‹è¯•ç”¨ä¾‹è¦æ±‚**ï¼šè¦†ç›–ä¸­è‹±æ–‡æ‰€æœ‰æŠ½å¥–ç±»å‹
- **ç›‘æ§å‘Šè­¦**ï¼šè®°å½•æœªæ˜ å°„çš„æŠ½å¥–ç±»å‹è°ƒç”¨
- **æ–‡æ¡£åŒæ­¥**ï¼šå‰åç«¯æŠ½å¥–ç±»å‹æ˜ å°„æ–‡æ¡£ä¿æŒä¸€è‡´

---

> **æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£éšä»£ç å®ç°åŒæ­¥æ›´æ–°ï¼Œç¡®ä¿æŠ€æœ¯è§„èŒƒä¸å®é™…ä»£ç 100%ä¸€è‡´ã€‚
> **ç‰ˆæœ¬æ ‡è¯†**ï¼šv2.2.0 - æƒé™ç®€åŒ–ç‰ˆæœ¬
> **æ›´æ–°æ—¶é—´**ï¼š2025å¹´01æœˆ11æ—¥
> **ä½¿ç”¨æ¨¡å‹**ï¼šClaude Sonnet 4