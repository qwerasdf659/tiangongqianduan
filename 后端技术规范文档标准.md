# ğŸš€ åç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£ - ç¼–å†™æ ‡å‡†ä¸å‡†åˆ™

> **åŸºäºNode.jsçš„åç«¯å¼€å‘æŠ€æœ¯è§„èŒƒ** - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿå®é™…æ¶æ„æ ‡å‡†

## ğŸ“‹ ä¸€ã€æ–‡æ¡£å®šä½ä¸æ ‡å‡†

### 1.1 æ–‡æ¡£å®šä½
- **å”¯ä¸€å—ä¼—**ï¼šåç«¯å¼€å‘å·¥ç¨‹å¸ˆã€DevOpså·¥ç¨‹å¸ˆ
- **æ ¸å¿ƒèŒè´£**ï¼šNode.jsåç«¯æœåŠ¡å¼€å‘è§„èŒƒ
- **æŠ€æœ¯è¾¹ç•Œ**ï¼šä»…æ¶µç›–åç«¯æŠ€æœ¯æ ˆï¼Œä¸åŒ…å«å‰ç«¯UIé€»è¾‘
- **å†…å®¹æ·±åº¦**ï¼šæ·±å…¥åç«¯ä¸“ä¸šé¢†åŸŸï¼Œæä¾›ç”Ÿäº§çº§è§£å†³æ–¹æ¡ˆ
- **æ›´æ–°æ—¶é—´**ï¼š2025å¹´07æœˆ03æ—¥ - åŸºäºå®é™…ä»£ç æ·±åº¦åˆ†ææ›´æ–°

### 1.2 ğŸ”´ å®é™…é¡¹ç›®æŠ€æœ¯æ ˆï¼ˆåŸºäºè¿è¡ŒçŠ¶æ€éªŒè¯ï¼‰

**ğŸ“‹ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶ï¼ˆåŸºäºpackage.json + å®é™…è¿è¡ŒéªŒè¯ï¼‰**

#### 1.2.1 æ ¸å¿ƒæœåŠ¡ç»„ä»¶ï¼ˆâœ… è¿è¡ŒéªŒè¯é€šè¿‡ï¼‰
- âœ… **Node.jsè¿è¡Œæ—¶** - v16.0.0+ï¼ˆè¿›ç¨‹æ­£å¸¸è¿è¡Œï¼Œå†…å­˜ä½¿ç”¨æ­£å¸¸ï¼‰
- âœ… **Express.jsæ¡†æ¶** - v4.18.2ï¼ˆHTTPæœåŠ¡ç«¯å£3000æ­£å¸¸ç›‘å¬ï¼‰
- âœ… **MySQLæ•°æ®åº“** - v8.0+ï¼ˆè¿æ¥æ­£å¸¸ï¼Œæ•°æ®åº“ï¼šrestaurant_points_devï¼‰
- âœ… **Sequelize ORM** - v6.35.1ï¼ˆæ¨¡å‹åŒæ­¥æ­£å¸¸ï¼Œ7ä¸ªæ ¸å¿ƒè¡¨è¿è¡Œä¸­ï¼‰
- âœ… **WebSocketæœåŠ¡** - ws v8.14.2ï¼ˆå®æ—¶é€šä¿¡æœåŠ¡ï¼Œè·¯å¾„:/wsï¼ŒJWTè®¤è¯æ”¯æŒï¼‰
- âœ… **JWTè®¤è¯** - jsonwebtoken v9.0.2ï¼ˆTokenéªŒè¯æœºåˆ¶è¿è¡Œä¸­ï¼Œæ”¯æŒç®¡ç†å‘˜ç™»å½•ï¼‰

#### 1.2.2 å®‰å…¨é˜²æŠ¤ç»„ä»¶ï¼ˆâœ… ä¸­é—´ä»¶åŠ è½½å®Œæˆï¼‰
- âœ… **Helmetå®‰å…¨å¤´** - v7.1.0ï¼ˆHTTPå®‰å…¨ç­–ç•¥ç”Ÿæ•ˆï¼‰
- âœ… **CORSè·¨åŸŸ** - v2.8.5ï¼ˆè·¨åŸŸç­–ç•¥é…ç½®ç”Ÿæ•ˆï¼‰
- âœ… **é™æµä¿æŠ¤** - express-rate-limit v7.1.5ï¼ˆè¯·æ±‚é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆï¼‰
- âœ… **å¯†ç åŠ å¯†** - bcrypt v5.1.1ï¼ˆç”¨æˆ·å¯†ç åŠ å¯†ï¼‰
- âœ… **ç¯å¢ƒå˜é‡** - dotenv v16.3.1ï¼ˆé…ç½®åŠ è½½æ­£å¸¸ï¼‰

#### 1.2.3 æ–‡ä»¶å’Œäº‘æœåŠ¡ç»„ä»¶ï¼ˆâœ… å­˜å‚¨æœåŠ¡å°±ç»ªï¼‰
- âœ… **æ–‡ä»¶ä¸Šä¼ ** - multer v1.4.5-lts.1ï¼ˆå›¾ç‰‡ä¸Šä¼ å¤„ç†ï¼‰
- âœ… **å›¾åƒå¤„ç†** - sharp v0.32.6ï¼ˆå›¾ç‰‡å‹ç¼©ä¼˜åŒ–ï¼‰
- âœ… **äº‘å­˜å‚¨æœåŠ¡** - aws-sdk v2.1498.0ï¼ˆSealoså­˜å‚¨é›†æˆï¼‰
- âœ… **HTTPå®¢æˆ·ç«¯** - axios v1.6.2ï¼ˆç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨ï¼‰

#### 1.2.4 å¼€å‘å’Œç›‘æ§ç»„ä»¶
- âœ… **å¼€å‘çƒ­é‡è½½** - nodemon v3.0.2ï¼ˆå¼€å‘ç¯å¢ƒä»£ç çƒ­æ›´æ–°ï¼‰
- âœ… **å¥åº·æ£€æŸ¥** - è‡ªå®šä¹‰æ¨¡å—ï¼ˆ/healthç«¯ç‚¹å“åº”æ­£å¸¸ï¼‰
- âœ… **å”¯ä¸€æ ‡è¯†** - uuid v9.0.1ï¼ˆä¸šåŠ¡IDç”Ÿæˆï¼‰
- âœ… **é”™è¯¯ç›‘æ§** - å…¨å±€é”™è¯¯å¤„ç†ï¼ˆå¼‚å¸¸æ•è·æœºåˆ¶ç”Ÿæ•ˆï¼‰

### 1.3 ğŸ”´ å®é™…æœåŠ¡æ¶æ„ï¼ˆåŸºäºapp.jsåˆ†æï¼‰

**æ ¸å¿ƒæœåŠ¡åˆ†å±‚æ¶æ„**ï¼š
```javascript
// å…¥å£å±‚ (app.js - 284è¡Œ)
{
  responsibilities: [
    'Expressåº”ç”¨åˆå§‹åŒ–',
    'HTTPæœåŠ¡å™¨åˆ›å»º',
    'WebSocketæœåŠ¡é›†æˆ',
    'å…¨å±€ä¸­é—´ä»¶é…ç½®',
    'è·¯ç”±æ³¨å†Œç®¡ç†',
    'å¥åº·æ£€æŸ¥æ¥å£',
    'é”™è¯¯å¤„ç†æœºåˆ¶'
  ],
  middlewares: [
    'helmet() - å®‰å…¨å¤´',
    'cors() - è·¨åŸŸé…ç½®',
    'express.json() - JSONè§£æ',
    'rateLimit() - è¯·æ±‚é™æµ',
    'requestLogger - è¯·æ±‚æ—¥å¿—',
    'errorHandler - ç»Ÿä¸€é”™è¯¯å¤„ç†'
  ]
}

// è·¯ç”±å±‚ (routes/ - 6ä¸ªæ ¸å¿ƒè·¯ç”±)
{
  modules: [
    'auth.js - è®¤è¯æˆæƒï¼ˆ377è¡Œï¼‰ï¼šæ‰‹æœºå·ç™»å½•ã€ç®¡ç†å‘˜éšè—ç™»å½•ã€JWT Tokenåˆ·æ–°éªŒè¯',
    'lottery.js - æŠ½å¥–ç³»ç»Ÿï¼ˆ277è¡Œï¼‰ï¼šæŠ½å¥–é…ç½®ã€æ‰§è¡ŒæŠ½å¥–ã€10æ¬¡ä¿åº•æœºåˆ¶ã€æŠ½å¥–è®°å½•',
    'exchange.js - ç§¯åˆ†å…‘æ¢ï¼ˆ353è¡Œï¼‰ï¼šå•†å“åˆ—è¡¨åˆ†é¡µã€åº“å­˜æ£€æŸ¥ã€å…‘æ¢è®¢å•ã€WebSocketåº“å­˜æ¨é€',
    'user.js - ç”¨æˆ·ç®¡ç†ï¼ˆ237è¡Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°ã€å¤´åƒä¸Šä¼ ã€ç§¯åˆ†è®°å½•åˆ†é¡µæŸ¥è¯¢',
    'photo.js - æ‹ç…§ä¸Šä¼ ï¼ˆ331è¡Œï¼‰ï¼šå›¾ç‰‡ä¸Šä¼ Sealoså­˜å‚¨ã€å®¡æ ¸å†å²ã€äººå·¥å®¡æ ¸æµç¨‹',
    'merchant.js - å•†å®¶ç®¡ç†ï¼ˆ545è¡Œï¼‰ï¼šå®¡æ ¸ç®¡ç†ã€æ‰¹é‡å®¡æ ¸ã€å•†å®¶æƒé™éªŒè¯ã€å®¡æ ¸ç»Ÿè®¡'
  ]
}

// æœåŠ¡å±‚ (services/ - 3ä¸ªæ ¸å¿ƒæœåŠ¡)
{
  modules: [
    'lotteryService.js - æŠ½å¥–æ ¸å¿ƒç®—æ³•ï¼ˆ547è¡Œï¼‰ï¼šæ¦‚ç‡è®¡ç®—ç®—æ³•ã€10æ¬¡ä¿åº•è§¦å‘ã€ç§¯åˆ†æ‰£é™¤äº‹åŠ¡ã€å¥–å“å‘æ”¾é€»è¾‘',
    'websocket.js - WebSocketæœåŠ¡ï¼ˆ312è¡Œï¼‰ï¼šJWT TokenéªŒè¯ã€è·¯å¾„/wsã€å¿ƒè·³ä¿æ´»ã€å®æ—¶æ¨é€ï¼ˆåº“å­˜/ç§¯åˆ†/å®¡æ ¸ç»“æœï¼‰',
    'sealosStorage.js - æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆ303è¡Œï¼‰ï¼šSealosäº‘å­˜å‚¨é›†æˆã€å›¾ç‰‡å‹ç¼©å¤„ç†ã€ä¸Šä¼ ç»“æœéªŒè¯ã€æ–‡ä»¶URLç”Ÿæˆ'
  ]
}

// æ•°æ®å±‚ (models/ - 7ä¸ªæ ¸å¿ƒæ¨¡å‹)
{
  models: [
    'User.js - ç”¨æˆ·æ¨¡å‹ï¼ˆ188è¡Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯ã€ç§¯åˆ†ç®¡ç†ã€æ‰‹æœºå·è„±æ•ã€æƒé™æ§åˆ¶ã€ä¸šåŠ¡æ–¹æ³•findOrCreateByMobile',
    'PhotoReview.js - å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰ï¼šå›¾ç‰‡URLã€å®¡æ ¸çŠ¶æ€ã€å®¡æ ¸ç†ç”±ã€å•†å®¶å®¡æ ¸æµç¨‹ã€Sealoså­˜å‚¨é›†æˆ',
    'CommodityPool.js - å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰ï¼šå•†å“ä¿¡æ¯ã€åº“å­˜ç®¡ç†ã€åˆ†ç±»ç­›é€‰ã€çƒ­é—¨æ ‡è®°ã€å‰ç«¯å­—æ®µæ˜ å°„',
    'LotterySetting.js - æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰ï¼šå¥–å“é…ç½®ã€æ¦‚ç‡è®¾ç½®ã€è§’åº¦å®šä½ã€é¢œè‰²é…ç½®ã€æ´»åŠ¨å¼€å…³',
    'LotteryPity.js - ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰ï¼šä¿åº•è®¡æ•°ã€è§¦å‘æ¡ä»¶ã€é‡ç½®æœºåˆ¶ã€10æ¬¡ä¿åº•ä¹å…«æŠ˜åˆ¸',
    'PointsRecord.js - ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰ï¼šç§¯åˆ†å˜åŠ¨è®°å½•ã€ä½™é¢è¿½è¸ªã€æ¥æºåˆ†ç±»ã€å…³è”ä¸šåŠ¡ID'
  ]
}
```

### 1.4 ğŸ”´ å®é™…é¡¹ç›®ç»“æ„ï¼ˆåŸºäºä»£ç åˆ†æï¼‰

```
restaurant-lottery-backend/
â”œâ”€â”€ app.js                     // ğŸ”´ åº”ç”¨ä¸»å…¥å£ï¼ˆ284è¡Œï¼‰
â”œâ”€â”€ package.json               // ğŸ”´ é¡¹ç›®é…ç½®ä¸ä¾èµ–
â”œâ”€â”€ .env                       // ğŸ”´ ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ routes/                    // ğŸ”´ APIè·¯ç”±å±‚ï¼ˆ6ä¸ªæ ¸å¿ƒè·¯ç”±ï¼‰
â”‚   â”œâ”€â”€ auth.js               // ğŸ”´ è®¤è¯æˆæƒè·¯ç”±ï¼ˆ377è¡Œï¼‰
â”‚   â”œâ”€â”€ lottery.js            // ğŸ”´ æŠ½å¥–ç³»ç»Ÿè·¯ç”±ï¼ˆ277è¡Œï¼‰
â”‚   â”œâ”€â”€ exchange.js           // ğŸ”´ ç§¯åˆ†å…‘æ¢è·¯ç”±ï¼ˆ353è¡Œï¼‰
â”‚   â”œâ”€â”€ user.js               // ğŸ”´ ç”¨æˆ·ç®¡ç†è·¯ç”±ï¼ˆ237è¡Œï¼‰
â”‚   â”œâ”€â”€ photo.js              // ğŸ”´ æ‹ç…§ä¸Šä¼ è·¯ç”±ï¼ˆ331è¡Œï¼‰
â”‚   â””â”€â”€ merchant.js           // ğŸ”´ å•†å®¶ç®¡ç†è·¯ç”±ï¼ˆ545è¡Œï¼‰
â”œâ”€â”€ services/                  // ğŸ”´ ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆ3ä¸ªæ ¸å¿ƒæœåŠ¡ï¼‰
â”‚   â”œâ”€â”€ lotteryService.js     // ğŸ”´ æŠ½å¥–æ ¸å¿ƒç®—æ³•ï¼ˆ547è¡Œï¼‰
â”‚   â”œâ”€â”€ websocket.js          // ğŸ”´ WebSocketæœåŠ¡ï¼ˆ312è¡Œï¼‰
â”‚   â””â”€â”€ sealosStorage.js      // ğŸ”´ å­˜å‚¨æœåŠ¡ï¼ˆ303è¡Œï¼‰
â”œâ”€â”€ models/                    // ğŸ”´ æ•°æ®æ¨¡å‹å±‚ï¼ˆ7ä¸ªæ ¸å¿ƒæ¨¡å‹ï¼‰
â”‚   â”œâ”€â”€ index.js              // ğŸ”´ æ¨¡å‹å¯¼å‡ºæ–‡ä»¶ï¼ˆ228è¡Œï¼‰
â”‚   â”œâ”€â”€ User.js               // ğŸ”´ ç”¨æˆ·æ¨¡å‹ï¼ˆ188è¡Œï¼‰
â”‚   â”œâ”€â”€ PhotoReview.js        // ğŸ”´ å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰
â”‚   â”œâ”€â”€ CommodityPool.js      // ğŸ”´ å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰
â”‚   â”œâ”€â”€ LotterySetting.js     // ğŸ”´ æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰
â”‚   â”œâ”€â”€ LotteryPity.js        // ğŸ”´ ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰
â”‚   â””â”€â”€ PointsRecord.js       // ğŸ”´ ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰
â”œâ”€â”€ middleware/                // ğŸ”´ ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ auth.js               // ğŸ”´ JWTè®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ errorHandler.js       // ğŸ”´ é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”œâ”€â”€ config/                    // ğŸ”´ é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ database.js           // ğŸ”´ æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ test-data.js          // ğŸ”´ æµ‹è¯•æ•°æ®é…ç½®
â””â”€â”€ scripts/                   // ğŸ”´ è„šæœ¬æ–‡ä»¶
    â”œâ”€â”€ init-database.js      // ğŸ”´ æ•°æ®åº“åˆå§‹åŒ–
    â””â”€â”€ test-apis.js          // ğŸ”´ APIæµ‹è¯•è„šæœ¬
```

## ğŸ—ï¸ äºŒã€å®é™…æœåŠ¡æ¶æ„è§„èŒƒ

### 2.1 åŸºäºapp.jsçš„å®é™…æœåŠ¡æ¶æ„
```javascript
// ğŸ”´ å®é™…æœåŠ¡åˆ†å±‚æ¶æ„ï¼ˆåŸºäºapp.jsåˆ†æï¼‰
const ACTUAL_SERVICE_ARCHITECTURE = {
  
  // 1. å…¥å£å±‚ (Entry Layer) - app.js
  entry: {
    file: 'app.js',
    responsibilities: [
      'Expressåº”ç”¨åˆå§‹åŒ–',
      'HTTPæœåŠ¡å™¨åˆ›å»º',
      'WebSocketæœåŠ¡é›†æˆ',
      'å…¨å±€ä¸­é—´ä»¶é…ç½®',
      'è·¯ç”±æ³¨å†Œç®¡ç†',
      'å¥åº·æ£€æŸ¥æ¥å£',
      'é”™è¯¯å¤„ç†æœºåˆ¶'
    ],
    middlewares: [
      'helmet() - å®‰å…¨å¤´',
      'cors() - è·¨åŸŸé…ç½®',
      'express.json() - JSONè§£æ',
      'rateLimit() - è¯·æ±‚é™æµ',
      'requestLogger - è¯·æ±‚æ—¥å¿—',
      'errorHandler - ç»Ÿä¸€é”™è¯¯å¤„ç†'
    ]
  },
  
  // 2. è·¯ç”±å±‚ (Routes Layer) - routes/
  routes: {
    structure: 'routes/',
    modules: [
      'auth.js - è®¤è¯æˆæƒï¼ˆ377è¡Œï¼‰ï¼šæ‰‹æœºå·ç™»å½•ã€ç®¡ç†å‘˜éšè—ç™»å½•ã€JWT Tokenåˆ·æ–°éªŒè¯',
      'lottery.js - æŠ½å¥–ç³»ç»Ÿï¼ˆ264è¡Œï¼‰ï¼šæŠ½å¥–é…ç½®ã€æ‰§è¡ŒæŠ½å¥–ã€10æ¬¡ä¿åº•æœºåˆ¶ã€æŠ½å¥–è®°å½•',
      'exchange.js - ç§¯åˆ†å…‘æ¢ï¼ˆ353è¡Œï¼‰ï¼šå•†å“åˆ—è¡¨åˆ†é¡µã€åº“å­˜æ£€æŸ¥ã€å…‘æ¢è®¢å•ã€WebSocketåº“å­˜æ¨é€',
      'user.js - ç”¨æˆ·ç®¡ç†ï¼ˆ237è¡Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°ã€å¤´åƒä¸Šä¼ ã€ç§¯åˆ†è®°å½•åˆ†é¡µæŸ¥è¯¢',
      'photo.js - æ‹ç…§ä¸Šä¼ ï¼ˆ331è¡Œï¼‰ï¼šå›¾ç‰‡ä¸Šä¼ Sealoså­˜å‚¨ã€å®¡æ ¸å†å²ã€äººå·¥å®¡æ ¸æµç¨‹',
      'merchant.js - å•†å®¶ç®¡ç†ï¼ˆ545è¡Œï¼‰ï¼šå®¡æ ¸ç®¡ç†ã€æ‰¹é‡å®¡æ ¸ã€å•†å®¶æƒé™éªŒè¯ã€å®¡æ ¸ç»Ÿè®¡'
    ],
    responsibilities: [
      'HTTPè¯·æ±‚è·¯ç”±åˆ†å‘ï¼ˆ6ä¸ªæ ¸å¿ƒè·¯ç”±æ¨¡å—ï¼‰',
      'è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆæ‰‹æœºå·æ ¼å¼ã€æ–‡ä»¶å¤§å°ã€ç§¯åˆ†ä½™é¢ï¼‰',
      'ä¸šåŠ¡é€»è¾‘è°ƒç”¨ï¼ˆè°ƒç”¨serviceså±‚å¤æ‚ç®—æ³•ï¼‰',
      'å“åº”æ ¼å¼æ ‡å‡†åŒ–ï¼ˆç»Ÿä¸€code/msg/dataæ ¼å¼ï¼‰',
      'JWTè®¤è¯ä¸­é—´ä»¶é›†æˆï¼ˆä¿æŠ¤éœ€è¦ç™»å½•çš„æ¥å£ï¼‰',
      'WebSocketäº‹ä»¶è§¦å‘ï¼ˆå®æ—¶æ¨é€åº“å­˜ã€ç§¯åˆ†ã€å®¡æ ¸ç»“æœï¼‰'
    ]
  },
  
  // 3. æœåŠ¡å±‚ (Services Layer) - services/
  services: {
    structure: 'services/',
    modules: [
      'lotteryService.js - æŠ½å¥–æ ¸å¿ƒç®—æ³•ï¼ˆ547è¡Œï¼‰ï¼šæ¦‚ç‡è®¡ç®—ç®—æ³•ã€10æ¬¡ä¿åº•è§¦å‘ã€ç§¯åˆ†æ‰£é™¤äº‹åŠ¡ã€å¥–å“å‘æ”¾é€»è¾‘',
      'websocket.js - WebSocketæœåŠ¡ï¼ˆ312è¡Œï¼‰ï¼šJWT TokenéªŒè¯ã€è·¯å¾„/wsã€å¿ƒè·³ä¿æ´»ã€å®æ—¶æ¨é€ï¼ˆåº“å­˜/ç§¯åˆ†/å®¡æ ¸ç»“æœï¼‰',
      'sealosStorage.js - æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆ303è¡Œï¼‰ï¼šSealosäº‘å­˜å‚¨é›†æˆã€å›¾ç‰‡å‹ç¼©å¤„ç†ã€ä¸Šä¼ ç»“æœéªŒè¯ã€æ–‡ä»¶URLç”Ÿæˆ'
    ],
    responsibilities: [
      'æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°ï¼ˆæŠ½å¥–ç®—æ³•ã€æ¦‚ç‡è®¡ç®—ã€ä¿åº•æœºåˆ¶ï¼‰',
      'å¤æ‚ç®—æ³•è®¡ç®—ï¼ˆæ¦‚ç‡åˆ†å¸ƒã€éšæœºæ•°ç”Ÿæˆã€ä¿åº•è®¡æ•°ï¼‰',
      'ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆï¼ˆSealoså­˜å‚¨ã€WebSocketé€šä¿¡ã€å›¾ç‰‡å¤„ç†ï¼‰',
      'ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆç§¯åˆ†ä½™é¢æ£€æŸ¥ã€æŠ½å¥–æ¬¡æ•°é™åˆ¶ã€æ–‡ä»¶æ ¼å¼éªŒè¯ï¼‰',
      'äº‹åŠ¡ç®¡ç†ï¼ˆæ•°æ®åº“äº‹åŠ¡ç¡®ä¿ç§¯åˆ†æ‰£é™¤å’Œè®°å½•çš„ä¸€è‡´æ€§ï¼‰',
      'å®æ—¶é€šä¿¡ï¼ˆWebSocketè¿æ¥ç®¡ç†ã€æ¶ˆæ¯æ¨é€ã€å¿ƒè·³æœºåˆ¶ï¼‰'
    ]
  },
  
  // 4. æ•°æ®å±‚ (Data Layer) - models/
  data: {
    structure: 'models/',
    orm: 'Sequelize ORM v6.35.1',
    models: [
      'User.js - ç”¨æˆ·æ¨¡å‹ï¼ˆ188è¡Œï¼‰ï¼šç”¨æˆ·ä¿¡æ¯ã€ç§¯åˆ†ç®¡ç†ã€æ‰‹æœºå·è„±æ•ã€æƒé™æ§åˆ¶ã€ä¸šåŠ¡æ–¹æ³•findOrCreateByMobile',
      'PhotoReview.js - å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰ï¼šå›¾ç‰‡URLã€å®¡æ ¸çŠ¶æ€ã€å®¡æ ¸ç†ç”±ã€å•†å®¶å®¡æ ¸æµç¨‹ã€Sealoså­˜å‚¨é›†æˆ',
      'CommodityPool.js - å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰ï¼šå•†å“ä¿¡æ¯ã€åº“å­˜ç®¡ç†ã€åˆ†ç±»ç­›é€‰ã€çƒ­é—¨æ ‡è®°ã€å‰ç«¯å­—æ®µæ˜ å°„',
      'LotterySetting.js - æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰ï¼šå¥–å“é…ç½®ã€æ¦‚ç‡è®¾ç½®ã€è§’åº¦å®šä½ã€é¢œè‰²é…ç½®ã€æ´»åŠ¨å¼€å…³',
      'LotteryPity.js - ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰ï¼šä¿åº•è®¡æ•°ã€è§¦å‘æ¡ä»¶ã€é‡ç½®æœºåˆ¶ã€10æ¬¡ä¿åº•ä¹å…«æŠ˜åˆ¸',
      'PointsRecord.js - ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰ï¼šç§¯åˆ†å˜åŠ¨è®°å½•ã€ä½™é¢è¿½è¸ªã€æ¥æºåˆ†ç±»ã€å…³è”ä¸šåŠ¡ID'
    ],
    responsibilities: [
      'æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰ï¼ˆ7ä¸ªæ ¸å¿ƒè¡¨ï¼Œä¸¥æ ¼éµå¾ªç´¢å¼•é™åˆ¶ï¼‰',
      'æ•°æ®éªŒè¯è§„åˆ™ï¼ˆæ‰‹æœºå·æ ¼å¼ã€ç§¯åˆ†èŒƒå›´ã€æ–‡ä»¶å¤§å°ã€çŠ¶æ€æšä¸¾ï¼‰',
      'æ¨¡å‹å…³è”å…³ç³»ï¼ˆå¤–é”®çº¦æŸã€çº§è”åˆ é™¤ã€äº‹åŠ¡å®Œæ•´æ€§ï¼‰',
      'ä¸šåŠ¡æ–¹æ³•å°è£…ï¼ˆè„±æ•æ˜¾ç¤ºã€å®‰å…¨æŸ¥è¯¢ã€ç§¯åˆ†è®¡ç®—ã€ä¿åº•æœºåˆ¶ï¼‰',
      'å‰ç«¯å­—æ®µæ˜ å°„ï¼ˆgetSafeUserInfoã€getFrontendInfoç­‰å®‰å…¨æ–¹æ³•ï¼‰',
      'ç´¢å¼•ä¼˜åŒ–ï¼ˆé¿å…è¶…è¿‡MySQL64ä¸ªç´¢å¼•é™åˆ¶ï¼Œå¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰'
    ]
  },
  
  // 5. ä¸­é—´ä»¶å±‚ (Middleware Layer) - middleware/
  middleware: {
    structure: 'middleware/',
    modules: [
      'auth.js - JWTè®¤è¯ä¸­é—´ä»¶',
      'errorHandler.js - é”™è¯¯å¤„ç†ä¸­é—´ä»¶'
    ],
    responsibilities: [
      'è¯·æ±‚é¢„å¤„ç†',
      'èº«ä»½éªŒè¯',
      'æƒé™æ§åˆ¶',
      'é”™è¯¯ç»Ÿä¸€å¤„ç†'
    ]
  }
}
```

### 2.2 é¡¹ç›®ç»“æ„è§„èŒƒï¼ˆå®é™…ä»£ç ç»“æ„ï¼‰
```
// ğŸ”´ å®é™…Node.jsé¡¹ç›®ç»“æ„ï¼ˆåŸºäºä»£ç åˆ†æï¼‰
restaurant-lottery-backend/
â”œâ”€â”€ app.js                           // ğŸ”´ åº”ç”¨ä¸»å…¥å£ï¼ˆ284è¡Œï¼‰
â”œâ”€â”€ package.json                     // ğŸ”´ é¡¹ç›®é…ç½®ï¼ˆ64è¡Œï¼‰
â”œâ”€â”€ package-lock.json               // ğŸ”´ ä¾èµ–é”å®šï¼ˆ6889è¡Œï¼‰
â”œâ”€â”€ .env                            // ğŸ”´ ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .gitignore                      // ğŸ”´ Gitå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ README.md                       // ğŸ”´ é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ routes/                         // ğŸ”´ APIè·¯ç”±å±‚
â”‚   â”œâ”€â”€ auth.js                     // ğŸ”´ è®¤è¯æˆæƒè·¯ç”±ï¼ˆ377è¡Œï¼‰
â”‚   â”œâ”€â”€ lottery.js                  // ğŸ”´ æŠ½å¥–ç³»ç»Ÿè·¯ç”±ï¼ˆ264è¡Œï¼‰
â”‚   â”œâ”€â”€ exchange.js                 // ğŸ”´ ç§¯åˆ†å…‘æ¢è·¯ç”±ï¼ˆ353è¡Œï¼‰
â”‚   â”œâ”€â”€ user.js                     // ğŸ”´ ç”¨æˆ·ç®¡ç†è·¯ç”±ï¼ˆ237è¡Œï¼‰
â”‚   â”œâ”€â”€ photo.js                    // ğŸ”´ æ‹ç…§ä¸Šä¼ è·¯ç”±ï¼ˆ331è¡Œï¼‰
â”‚   â””â”€â”€ merchant.js                 // ğŸ”´ å•†å®¶ç®¡ç†è·¯ç”±ï¼ˆ545è¡Œï¼‰
â”œâ”€â”€ services/                       // ğŸ”´ ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ lotteryService.js           // ğŸ”´ æŠ½å¥–æœåŠ¡ï¼ˆ547è¡Œï¼‰
â”‚   â”œâ”€â”€ websocket.js                // ğŸ”´ WebSocketæœåŠ¡ï¼ˆ312è¡Œï¼‰
â”‚   â””â”€â”€ sealosStorage.js            // ğŸ”´ å­˜å‚¨æœåŠ¡ï¼ˆ303è¡Œï¼‰
â”œâ”€â”€ models/                         // ğŸ”´ æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ index.js                    // ğŸ”´ æ¨¡å‹å¯¼å‡ºæ–‡ä»¶ï¼ˆ228è¡Œï¼‰
â”‚   â”œâ”€â”€ User.js                     // ğŸ”´ ç”¨æˆ·æ¨¡å‹ï¼ˆ188è¡Œï¼‰
â”‚   â”œâ”€â”€ PhotoReview.js              // ğŸ”´ å›¾ç‰‡å®¡æ ¸æ¨¡å‹ï¼ˆ308è¡Œï¼‰
â”‚   â”œâ”€â”€ CommodityPool.js            // ğŸ”´ å•†å“æ± æ¨¡å‹ï¼ˆ331è¡Œï¼‰
â”‚   â”œâ”€â”€ LotterySetting.js           // ğŸ”´ æŠ½å¥–é…ç½®æ¨¡å‹ï¼ˆ260è¡Œï¼‰
â”‚   â”œâ”€â”€ LotteryPity.js              // ğŸ”´ ä¿åº•æœºåˆ¶æ¨¡å‹ï¼ˆ159è¡Œï¼‰
â”‚   â””â”€â”€ PointsRecord.js             // ğŸ”´ ç§¯åˆ†è®°å½•æ¨¡å‹ï¼ˆ185è¡Œï¼‰
â”œâ”€â”€ middleware/                     // ğŸ”´ ä¸­é—´ä»¶å±‚
â”‚   â”œâ”€â”€ auth.js                     // ğŸ”´ JWTè®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ errorHandler.js             // ğŸ”´ é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”œâ”€â”€ config/                         // ğŸ”´ é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ database.js                 // ğŸ”´ æ•°æ®åº“é…ç½®
â”‚   â””â”€â”€ storage.js                  // ğŸ”´ å­˜å‚¨é…ç½®
â”œâ”€â”€ scripts/                        // ğŸ”´ éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ init-database.js            // ğŸ”´ æ•°æ®åº“åˆå§‹åŒ–
â”‚   â””â”€â”€ test-apis.js                // ğŸ”´ APIæµ‹è¯•è„šæœ¬
â”œâ”€â”€ uploads/                        // ğŸ”´ æ–‡ä»¶ä¸Šä¼ ç›®å½•
â”œâ”€â”€ logs/                           // ğŸ”´ æ—¥å¿—æ–‡ä»¶ç›®å½•
â”œâ”€â”€ tests/                          // ğŸ”´ æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ docs/                           // ğŸ”´ æŠ€æœ¯è§„èŒƒæ–‡æ¡£
â”‚   â”œâ”€â”€ åç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£æ ‡å‡†.md      // ğŸ”´ æœ¬æ–‡æ¡£ï¼ˆ1876è¡Œï¼‰
â”‚   â”œâ”€â”€ æ¥å£å¯¹æ¥è§„èŒƒæ–‡æ¡£æ ‡å‡†.md      // ğŸ”´ æ¥å£è§„èŒƒï¼ˆ2321è¡Œï¼‰
â”‚   â”œâ”€â”€ æ•°æ®åº“è®¾è®¡è§„èŒƒæ–‡æ¡£æ ‡å‡†.md    // ğŸ”´ æ•°æ®åº“è§„èŒƒï¼ˆ645è¡Œï¼‰
â”‚   â””â”€â”€ äº§å“åŠŸèƒ½ç»“æ„æè¿°.md         // ğŸ”´ ä¸šåŠ¡è§„èŒƒï¼ˆ1040è¡Œï¼‰
â””â”€â”€ æŠ€æœ¯è§„èŒƒæ–‡æ¡£/                    // ğŸ”´ æ–‡æ¡£å¤‡ä»½ç›®å½•
```

## ğŸ”Œ ä¸‰ã€APIè®¾è®¡è§„èŒƒï¼ˆåŸºäºå®é™…è·¯ç”±åˆ†æï¼‰

### 3.1 å®é™…APIè·¯ç”±æ¶æ„æ ‡å‡†
```javascript
// ğŸ”´ åŸºäºå®é™…ä»£ç çš„APIè·¯ç”±è®¾è®¡ï¼ˆapp.jsåˆ†æï¼‰
const ACTUAL_API_ROUTES = {
  
  // 1. è®¤è¯æˆæƒæ¨¡å— - routes/auth.js (377è¡Œ)
  auth: {
    basePath: '/api/auth',
    file: 'routes/auth.js',
    endpoints: [
      'POST /login - æ‰‹æœºå·éªŒè¯ç ç™»å½•ï¼ˆå¼€å‘é˜¶æ®µç®€åŒ–ï¼‰',
      'POST /admin-login - ç®¡ç†å‘˜éšè—ç™»å½•å…¥å£',
      'POST /refresh - JWT Tokenåˆ·æ–°',
      'GET /verify-token - Tokenæœ‰æ•ˆæ€§éªŒè¯',
      'POST /logout - ç”¨æˆ·é€€å‡ºç™»å½•',
      'POST /send-code - å‘é€çŸ­ä¿¡éªŒè¯ç '
    ],
    features: [
      'JWT Tokenç”Ÿæˆå’ŒéªŒè¯',
      'æ–°ç”¨æˆ·è‡ªåŠ¨åˆ›å»ºï¼ˆå¥–åŠ±1000ç§¯åˆ†ï¼‰',
      'ç®¡ç†å‘˜æƒé™éªŒè¯',
      'å¼€å‘ç¯å¢ƒéªŒè¯ç ç®€åŒ–',
      'WebSocketå®æ—¶é€šçŸ¥'
    ]
  },
  
  // 2. æŠ½å¥–ç³»ç»Ÿæ¨¡å— - routes/lottery.js (264è¡Œ)
  lottery: {
    basePath: '/api/lottery',
    file: 'routes/lottery.js',
    endpoints: [
      'GET /config - è·å–æŠ½å¥–è½¬ç›˜é…ç½®',
      'POST /draw - æ‰§è¡ŒæŠ½å¥–ï¼ˆå«ä¿åº•æœºåˆ¶ï¼‰',
      'GET /records - ç”¨æˆ·æŠ½å¥–å†å²è®°å½•',
      'GET /statistics - æŠ½å¥–ç»Ÿè®¡æ•°æ®',
      'GET /pity-status - ç”¨æˆ·ä¿åº•çŠ¶æ€æŸ¥è¯¢'
    ],
    features: [
      '8å¥–å“è½¬ç›˜é…ç½®',
      'æ¦‚ç‡è®¡ç®—ç®—æ³•',
      '10æ¬¡ä¿åº•æœºåˆ¶',
      'ç§¯åˆ†æ‰£é™¤å’Œå¥–åŠ±',
      'æŠ½å¥–è®°å½•è¿½è¸ª'
    ]
  },
  
  // 3. ç§¯åˆ†å…‘æ¢æ¨¡å— - routes/exchange.js (353è¡Œ)
  exchange: {
    basePath: '/api/exchange',
    file: 'routes/exchange.js',
    endpoints: [
      'GET /products - å…‘æ¢å•†å“åˆ—è¡¨',
      'POST /submit - æäº¤å…‘æ¢ç”³è¯·',
      'GET /orders - ç”¨æˆ·å…‘æ¢è®¢å•',
      'GET /categories - å•†å“åˆ†ç±»åˆ—è¡¨',
      'GET /hot-products - çƒ­é—¨å•†å“æ¨è'
    ],
    features: [
      'å•†å“åº“å­˜ç®¡ç†',
      'ç§¯åˆ†æ‰£é™¤éªŒè¯',
      'å…‘æ¢è®¢å•è·Ÿè¸ª',
      'åˆ†ç±»ç­›é€‰',
      'WebSocketåº“å­˜åŒæ­¥'
    ]
  },
  
  // 4. ç”¨æˆ·ç®¡ç†æ¨¡å— - routes/user.js (237è¡Œ)
  user: {
    basePath: '/api/user',
    file: 'routes/user.js',
    endpoints: [
      'GET /info - è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯',
      'PUT /profile - æ›´æ–°ç”¨æˆ·èµ„æ–™',
      'POST /avatar - å¤´åƒä¸Šä¼ ',
      'GET /points-records - ç§¯åˆ†å˜åŠ¨è®°å½•',
      'GET /statistics - ç”¨æˆ·ç»Ÿè®¡æ•°æ®'
    ],
    features: [
      'ç”¨æˆ·ä¿¡æ¯è„±æ•æ˜¾ç¤º',
      'å¤´åƒä¸Šä¼ äº‘å­˜å‚¨',
      'ç§¯åˆ†è®°å½•åˆ†é¡µ',
      'ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡',
      'å®æ—¶ç§¯åˆ†åŒæ­¥'
    ]
  },
  
  // 5. æ‹ç…§ä¸Šä¼ æ¨¡å— - routes/photo.js (331è¡Œ)
  photo: {
    basePath: '/api/photo',
    file: 'routes/photo.js',
    endpoints: [
      'POST /upload - æ‹ç…§ä¸Šä¼ æ¶ˆè´¹å‡­è¯',
      'GET /history - ä¸Šä¼ å†å²è®°å½•',
      'GET /review/:id - å®¡æ ¸è¯¦æƒ…æŸ¥è¯¢',
      'GET /statistics - ä¸Šä¼ ç»Ÿè®¡æ•°æ®',
      'DELETE /:id - åˆ é™¤ä¸Šä¼ è®°å½•'
    ],
    features: [
      'Sealosäº‘å­˜å‚¨é›†æˆ',
      'å›¾ç‰‡å‹ç¼©ä¼˜åŒ–',
      'äººå·¥å®¡æ ¸æµç¨‹',
      'ç§¯åˆ†å¥–åŠ±è®¡ç®—',
      'å®¡æ ¸çŠ¶æ€å®æ—¶æ¨é€'
    ]
  },
  
  // 6. å•†å®¶ç®¡ç†æ¨¡å— - routes/merchant.js (545è¡Œ)
  merchant: {
    basePath: '/api/merchant',
    file: 'routes/merchant.js',
    endpoints: [
      'POST /apply - ç”³è¯·å•†å®¶æƒé™',
      'GET /reviews/pending - å¾…å®¡æ ¸åˆ—è¡¨',
      'POST /reviews/:id/approve - å®¡æ ¸é€šè¿‡',
      'POST /reviews/:id/reject - å®¡æ ¸æ‹’ç»',
      'POST /reviews/batch - æ‰¹é‡å®¡æ ¸',
      'GET /statistics - å®¡æ ¸ç»Ÿè®¡',
      'GET /product-stats - å•†å“ç®¡ç†ç»Ÿè®¡'
    ],
    features: [
      'å•†å®¶æƒé™éªŒè¯',
      'å®¡æ ¸å·¥ä½œæµç®¡ç†',
      'æ‰¹é‡æ“ä½œæ”¯æŒ',
      'å®¡æ ¸ç»Ÿè®¡åˆ†æ',
      'å®æ—¶å®¡æ ¸é€šçŸ¥'
    ]
  }
}
```

### 3.2 ç»Ÿä¸€å“åº”æ ¼å¼æ ‡å‡†
```javascript
// ğŸ”´ åŸºäºå®é™…ä»£ç çš„å“åº”æ ¼å¼è§„èŒƒ
const UNIFIED_RESPONSE_FORMAT = {
  
  // æˆåŠŸå“åº”æ ¼å¼
  success: {
    structure: {
      code: 0,                    // æˆåŠŸå›ºå®šä¸º0
      msg: 'success',             // æˆåŠŸæ¶ˆæ¯
      data: {}                    // ä¸šåŠ¡æ•°æ®
    },
    examples: {
      // ç”¨æˆ·ç™»å½•æˆåŠŸ
      login: {
        code: 0,
        msg: 'success',
        data: {
          access_token: 'eyJhbGciOiJIUzI1NiIs...',
          refresh_token: 'eyJhbGciOiJIUzI1NiIs...',
          expires_in: 7200,
          user_info: {
            user_id: 1,
            mobile: '138****5678',    // è„±æ•æ˜¾ç¤º
            nickname: 'ç”¨æˆ·0001',
            total_points: 1000,       // å®æ—¶ç§¯åˆ†
            is_merchant: false,       // æƒé™æ ‡è¯†
            avatar: 'https://storage.url/avatar.jpg'
          }
        }
      },
      
      // æŠ½å¥–é…ç½®æŸ¥è¯¢
      lotteryConfig: {
        code: 0,
        msg: 'success',
        data: {
          prizes: [
            {
              id: 1,
              name: '100ç§¯åˆ†',
              type: 'points',
              value: 100,
              angle: 0,
              color: '#FF6B35',
              probability: 0.4,
              isActivity: false,
              costPoints: 100
            }
          ],
          costPerDraw: 100,
          totalPrizes: 8,
          pitySystem: {
            enabled: true,
            pityLimit: 10,
            pityPrizeName: 'ä¹å…«æŠ˜åˆ¸'
          }
        }
      }
    }
  },
  
  // é”™è¯¯å“åº”æ ¼å¼
  error: {
    structure: {
      code: 'ERROR_CODE',         // é”™è¯¯ç ï¼ˆé0ï¼‰
      msg: 'error_message',       // é”™è¯¯æè¿°
      data: null                  // é”™è¯¯æ—¶å›ºå®šä¸ºnull
    },
    categories: {
      // 1xxx - è¯·æ±‚å‚æ•°é”™è¯¯
      1001: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
      1002: 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ',
      1003: 'è¯·æ±‚å‚æ•°ç¼ºå¤±',
      
      // 2xxx - è®¤è¯æˆæƒé”™è¯¯
      2001: 'Tokenä¸èƒ½ä¸ºç©º',
      2002: 'Tokenå·²è¿‡æœŸ',
      2003: 'æƒé™ä¸è¶³',
      
      // 3xxx - ä¸šåŠ¡é€»è¾‘é”™è¯¯
      3001: 'æŠ½å¥–é…ç½®æœªåˆå§‹åŒ–',
      3002: 'ç§¯åˆ†ä½™é¢ä¸è¶³',
      3003: 'ä»Šæ—¥æŠ½å¥–æ¬¡æ•°å·²è¾¾ä¸Šé™',
      
      // 4xxx - èµ„æºä¸å­˜åœ¨
      4001: 'ç”¨æˆ·ä¸å­˜åœ¨',
      4002: 'å•†å“ä¸å­˜åœ¨',
      4003: 'è®¢å•ä¸å­˜åœ¨',
      
      // 5xxx - ç³»ç»Ÿé”™è¯¯
      5001: 'è¯·æ±‚è¿‡äºé¢‘ç¹',
      5002: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
      5003: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥'
    }
  }
}
```

### 3.3 JWTè®¤è¯æœºåˆ¶æ ‡å‡†
```javascript
// ğŸ”´ åŸºäºauth.jsçš„JWTè®¤è¯å®ç°
const JWT_AUTH_STANDARD = {
  
  // Tokenç”Ÿæˆè§„èŒƒ
  generation: {
    algorithm: 'HS256',
    accessTokenExpiry: '2h',      // è®¿é—®Token 2å°æ—¶
    refreshTokenExpiry: '7d',     // åˆ·æ–°Token 7å¤©
    issuer: 'restaurant-lottery',
    secretKey: process.env.JWT_SECRET,
    payload: {
      user_id: 'number',          // ç”¨æˆ·ID
      mobile: 'string',           // æ‰‹æœºå·
      is_merchant: 'boolean',     // å•†å®¶æ ‡è¯†
      iat: 'timestamp',           // ç­¾å‘æ—¶é—´
      exp: 'timestamp'            // è¿‡æœŸæ—¶é—´
    }
  },
  
  // TokenéªŒè¯ä¸­é—´ä»¶
  middleware: {
    required: [
      '/api/lottery/*',           // æŠ½å¥–ç³»ç»Ÿå¿…é¡»è®¤è¯
      '/api/exchange/*',          // ç§¯åˆ†å…‘æ¢å¿…é¡»è®¤è¯
      '/api/user/*',              // ç”¨æˆ·ç®¡ç†å¿…é¡»è®¤è¯
      '/api/photo/*',             // æ‹ç…§ä¸Šä¼ å¿…é¡»è®¤è¯
      '/api/merchant/*'           // å•†å®¶ç®¡ç†å¿…é¡»è®¤è¯
    ],
    optional: [
      '/api/auth/verify-token'    // TokenéªŒè¯æ¥å£å¯é€‰
    ],
    excluded: [
      '/api/auth/login',          // ç™»å½•æ¥å£æ’é™¤
      '/api/auth/admin-login',    // ç®¡ç†å‘˜ç™»å½•æ’é™¤
      '/api/auth/refresh',        // Tokenåˆ·æ–°æ’é™¤
      '/health',                  // å¥åº·æ£€æŸ¥æ’é™¤
      '/api/docs'                 // æ–‡æ¡£æ¥å£æ’é™¤
    ]
  },
  
  // Tokenåˆ·æ–°æœºåˆ¶
  refresh: {
    endpoint: 'POST /api/auth/refresh',
    validation: 'verifyRefreshToken()',
    newTokenGeneration: 'generateTokens(user)',
    userRevalidation: true,
    responseFormat: 'UNIFIED_RESPONSE_FORMAT.success'
  }
}
```

### 3.4 è¯·æ±‚é™æµå’Œå®‰å…¨é…ç½®
```javascript
// ğŸ”´ åŸºäºapp.jsçš„å®‰å…¨é…ç½®æ ‡å‡†
const SECURITY_STANDARDS = {
  
  // è¯·æ±‚é™æµé…ç½®
  rateLimit: {
    windowMs: 15 * 60 * 1000,     // 15åˆ†é’Ÿçª—å£
    maxRequests: {
      development: 1000,           // å¼€å‘ç¯å¢ƒ1000æ¬¡
      production: 100              // ç”Ÿäº§ç¯å¢ƒ100æ¬¡
    },
    message: {
      code: 5001,
      msg: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•',
      data: null
    },
    skipSuccessfulRequests: false,
    skipFailedRequests: false
  },
  
  // CORSè·¨åŸŸé…ç½®
  cors: {
    allowedOrigins: {
      development: '*',            // å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰
      production: [
        'https://gynjeecyhgvo.sealoshzh.site',
        'http://devbox1.ns-br0za7uc.svc.cluster.local:3000',
        'https://servicewechat.com'
      ]
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
  },
  
  // Helmetå®‰å…¨å¤´é…ç½®
  helmet: {
    crossOriginResourcePolicy: { policy: "cross-origin" },
    contentSecurityPolicy: false,
    frameguard: { action: 'deny' }
  },
  
  // ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥
  productionSafety: {
    requiredEnvVars: [
      'JWT_SECRET',               // JWTå¯†é’¥å¿…é¡»è®¾ç½®
      'ENCRYPTION_KEY',           // åŠ å¯†å¯†é’¥å¿…é¡»è®¾ç½®
      'DB_PASSWORD',              // æ•°æ®åº“å¯†ç å¿…é¡»è®¾ç½®
      'SEALOS_ACCESS_KEY'         // äº‘å­˜å‚¨å¯†é’¥å¿…é¡»è®¾ç½®
    ],
    forbiddenDefaults: [
      'your_jwt_secret_key_change_in_production',
      'your_32_bytes_hex_encryption_key_change_in_production'
    ]
  }
}
```

## ğŸ—„ï¸ å››ã€æ•°æ®è®¿é—®è§„èŒƒ

### 4.1 æ•°æ®åº“è¿æ¥ç®¡ç†
```javascript
// ğŸ”´ æ•°æ®åº“è¿æ¥æ± é…ç½®
const { Sequelize } = require('sequelize')

class DatabaseManager {
  constructor() {
    this.sequelize = new Sequelize({
      host: process.env.DB_HOST || 'dbconn.sealosbja.site',    // ğŸ”´ å®é™…æ•°æ®åº“åœ°å€
      port: process.env.DB_PORT || 42182,                      // ğŸ”´ å®é™…ç«¯å£
      database: process.env.DB_NAME || 'restaurant_points_dev', // ğŸ”´ å®é™…æ•°æ®åº“å
      username: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || 'mc6r9cgb',
      dialect: 'mysql',
      timezone: '+08:00',                                       // ğŸ”´ ä¸œå…«åŒºæ—¶é—´
      
      // ğŸ”´ è¿æ¥æ± é…ç½®ï¼ˆåŸºäºconfig/database.jsï¼‰
      pool: {
        max: 20,          // æœ€å¤§è¿æ¥æ•°
        min: 0,           // æœ€å°è¿æ¥æ•°
        acquire: 60000,   // è·å–è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆ60ç§’ï¼‰
        idle: 30000       // è¿æ¥ç©ºé—²æ—¶é—´ï¼ˆ30ç§’ï¼‰
      },
      
      // ğŸ”´ æ—¥å¿—é…ç½®
      logging: process.env.NODE_ENV === 'development' ? console.log : false,
      
      // ğŸ”´ æ€§èƒ½ä¼˜åŒ–é…ç½®
      define: {
        freezeTableName: true,  // ç¦ç”¨è¡¨åå¤æ•°å½¢å¼
        timestamps: true,       // å¯ç”¨æ—¶é—´æˆ³
        underscored: true,      // ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
        paranoid: true          // å¯ç”¨è½¯åˆ é™¤
      }
    })
  }
  
  // ğŸ”´ æ•°æ®åº“è¿æ¥åˆå§‹åŒ–
  async initialize() {
    try {
      await this.sequelize.authenticate()
      console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')
      
      // åŒæ­¥æ•°æ®åº“è¡¨ç»“æ„
      if (process.env.NODE_ENV === 'development') {
        await this.sequelize.sync({ alter: true })
      }
      
      return true
    } catch (error) {
      console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error)
      throw error
    }
  }
  
  // ğŸ”´ å¥åº·æ£€æŸ¥
  async healthCheck() {
    try {
      await this.sequelize.authenticate()
      return { status: 'healthy', connection: 'ok' }
    } catch (error) {
      return { status: 'unhealthy', error: error.message }
    }
  }
}
```

## ğŸ”„ äº”ã€WebSocketå®æ—¶é€šä¿¡è§„èŒƒï¼ˆåŸºäºservices/websocket.jsï¼‰

### 5.1 WebSocketæœåŠ¡æ¶æ„æ ‡å‡†
```javascript
// ğŸ”´ åŸºäºå®é™…websocket.jsçš„WebSocketæœåŠ¡è§„èŒƒ
const WEBSOCKET_SERVICE_STANDARDS = {
  
  // WebSocketæœåŠ¡é…ç½®ï¼ˆåŸºäºservices/websocket.jså®é™…å®ç°ï¼‰
  serverConfig: {
    port: 3000,                  // ğŸ”´ å®é™…è¿è¡Œç«¯å£ï¼ˆä¸HTTPæœåŠ¡å…±äº«ï¼‰
    path: '/ws',                 // ğŸ”´ å®é™…è·¯å¾„ï¼šå¾®ä¿¡å°ç¨‹åºè¿æ¥è·¯å¾„
    clientTracking: true,        // å®¢æˆ·ç«¯è¿æ¥è·Ÿè¸ª
    maxConnections: 1000,        // æœ€å¤§è¿æ¥æ•°é™åˆ¶
    heartbeatInterval: 30000,    // å¿ƒè·³é—´éš”30ç§’
    connectionTimeout: 60000,    // è¿æ¥è¶…æ—¶60ç§’
    jwtVerification: true,       // ğŸ”´ JWT TokenéªŒè¯æœºåˆ¶
    publicUrl: 'wss://gynjeecyhgvo.sealoshzh.site/ws' // ğŸ”´ å®é™…å…¬ç½‘è¿æ¥åœ°å€
  },
  
  // è¿æ¥ç®¡ç†è§„èŒƒ
  connectionManagement: {
    userConnectionMap: 'Map<userId, WebSocket>', // ç”¨æˆ·è¿æ¥æ˜ å°„
    connectionAuth: 'TokenéªŒè¯æœºåˆ¶',             // è¿æ¥æ—¶TokenéªŒè¯
    connectionLimit: 'å•ç”¨æˆ·æœ€å¤š3ä¸ªè¿æ¥',        // è¿æ¥æ•°é™åˆ¶
    reconnectHandling: 'è‡ªåŠ¨é‡è¿æœºåˆ¶',           // é‡è¿å¤„ç†
    gracefulShutdown: 'ä¼˜é›…å…³é—­å¤„ç†'            // æœåŠ¡åœæ­¢æ—¶çš„è¿æ¥æ¸…ç†
  },
  
  // æ¶ˆæ¯ç±»å‹è§„èŒƒ
  messageTypes: {
    // ç§¯åˆ†å®æ—¶åŒæ­¥
    pointsUpdate: {
      type: 'points_update',
      data: {
        user_id: 'number',
        total_points: 'number',
        change_amount: 'number',
        change_reason: 'string',
        timestamp: 'ISO8601'
      }
    },
    
    // æŠ½å¥–ç»“æœé€šçŸ¥
    lotteryResult: {
      type: 'lottery_result',
      data: {
        user_id: 'number',
        prize_name: 'string',
        prize_value: 'number',
        remaining_points: 'number',
        timestamp: 'ISO8601'
      }
    },
    
    // å®¡æ ¸çŠ¶æ€æ›´æ–°
    reviewUpdate: {
      type: 'review_update',
      data: {
        upload_id: 'string',
        status: 'approved|rejected',
        points_awarded: 'number',
        review_reason: 'string',
        timestamp: 'ISO8601'
      }
    },
    
    // åº“å­˜å˜æ›´é€šçŸ¥
    stockUpdate: {
      type: 'stock_update',
      data: {
        commodity_id: 'number',
        current_stock: 'number',
        change_amount: 'number',
        timestamp: 'ISO8601'
      }
    }
  },
  
  // å¾®ä¿¡å°ç¨‹åºWebSocketé€‚é…
  wechatMiniProgram: {
    connectionURL: 'wss://domain.com/ws',        // ğŸ”´ å¿…é¡»ä½¿ç”¨wssåè®®
    domainWhitelist: 'éœ€åœ¨å°ç¨‹åºåå°é…ç½®socketåˆæ³•åŸŸå',
    connectionHeaders: {
      'Authorization': 'Bearer <access_token>',  // Tokenè®¤è¯
      'User-Agent': 'WeChat MiniProgram'
    },
    reconnectStrategy: {
      maxRetries: 5,
      retryInterval: 3000,
      backoffMultiplier: 1.5
    }
  }
}
```

### 5.2 å®æ—¶æ•°æ®åŒæ­¥æ ‡å‡†
```javascript
// ğŸ”´ å®æ—¶æ•°æ®åŒæ­¥å®ç°è§„èŒƒ
class WebSocketService {
  constructor() {
    this.clients = new Map()     // ç”¨æˆ·è¿æ¥ç®¡ç†
    this.server = null          // WebSocketæœåŠ¡å™¨å®ä¾‹
  }
  
  // ğŸ”´ ç§¯åˆ†å˜æ›´å®æ—¶é€šçŸ¥
  notifyPointsUpdate(userId, pointsData) {
    const userSocket = this.clients.get(userId)
    if (userSocket && userSocket.readyState === WebSocket.OPEN) {
      userSocket.send(JSON.stringify({
        type: 'points_update',
        data: {
          user_id: userId,
          total_points: pointsData.total_points,
          change_amount: pointsData.change_amount,
          change_reason: pointsData.reason,
          timestamp: new Date().toISOString()
        }
      }))
    }
  }
  
  // ğŸ”´ æŠ½å¥–ç»“æœå®æ—¶é€šçŸ¥
  notifyLotteryResult(userId, lotteryResult) {
    const userSocket = this.clients.get(userId)
    if (userSocket && userSocket.readyState === WebSocket.OPEN) {
      userSocket.send(JSON.stringify({
        type: 'lottery_result',
        data: {
          user_id: userId,
          prize_name: lotteryResult.prize_name,
          prize_value: lotteryResult.prize_value,
          remaining_points: lotteryResult.remaining_points,
          timestamp: new Date().toISOString()
        }
      }))
    }
  }
  
  // ğŸ”´ å¥åº·æ£€æŸ¥æ¥å£
  isHealthy() {
    return {
      status: this.server ? 'running' : 'stopped',
      connections: this.clients.size,
      maxConnections: 1000,
      uptime: process.uptime()
    }
  }
}
```

## ğŸ“± å…­ã€å¾®ä¿¡å°ç¨‹åºå…¼å®¹æ€§è§„èŒƒ

### 6.1 å¾®ä¿¡å°ç¨‹åºåç«¯é€‚é…æ ‡å‡†
```javascript
// ğŸ”´ å¾®ä¿¡å°ç¨‹åºåç«¯é€‚é…è§„èŒƒ
const WECHAT_MINIPROGRAM_STANDARDS = {
  
  // åŸŸåé…ç½®è¦æ±‚
  domainRequirements: {
    request: {
      desc: 'requeståˆæ³•åŸŸå',
      format: 'https://domain.com',
      required: true,
      note: 'æ‰€æœ‰APIæ¥å£å¿…é¡»é€šè¿‡HTTPSè®¿é—®'
    },
    socket: {
      desc: 'socketåˆæ³•åŸŸå', 
      format: 'wss://domain.com',
      required: true,
      note: 'WebSocketè¿æ¥å¿…é¡»ä½¿ç”¨wssåè®®'
    },
    uploadFile: {
      desc: 'uploadFileåˆæ³•åŸŸå',
      format: 'https://domain.com',
      required: true,
      note: 'å›¾ç‰‡ä¸Šä¼ æ¥å£åŸŸå'
    },
    downloadFile: {
      desc: 'downloadFileåˆæ³•åŸŸå',
      format: 'https://domain.com', 
      required: false,
      note: 'æ–‡ä»¶ä¸‹è½½åŸŸåï¼ˆå¦‚éœ€è¦ï¼‰'
    }
  },
  
  // ç½‘ç»œè¯·æ±‚é€‚é…
  networkRequests: {
    httpsOnly: true,             // ğŸ”´ å¼ºåˆ¶HTTPS
    corsSupport: true,           // è·¨åŸŸæ”¯æŒ
    allowedMethods: ['GET', 'POST', 'PUT', 'DELETE'],
    responseHeaders: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type,Authorization'
    },
    requestTimeout: 30000,       // è¯·æ±‚è¶…æ—¶30ç§’
    maxRequestSize: '10MB'       // æœ€å¤§è¯·æ±‚ä½“å¤§å°
  },
  
  // WebSocketè¿æ¥é€‚é…
  websocketAdaptation: {
    protocol: 'wss',             // ğŸ”´ å¿…é¡»ä½¿ç”¨wssåè®®
    path: '/ws',                 // è¿æ¥è·¯å¾„
    authMethod: 'Token in URL params or headers',
    heartbeatInterval: 30000,    // å¿ƒè·³é—´éš”
    reconnectStrategy: {
      enabled: true,
      maxRetries: 5,
      retryDelay: 3000
    }
  },
  
  // æ–‡ä»¶ä¸Šä¼ é€‚é…
  fileUploadAdaptation: {
    endpoint: '/api/photo/upload',
    method: 'POST',
    fieldName: 'photo',          // ğŸ”´ å°ç¨‹åºæ–‡ä»¶å­—æ®µå
    maxSize: '5MB',              // æœ€å¤§æ–‡ä»¶å¤§å°
    allowedTypes: ['image/jpeg', 'image/png', 'image/jpg'],
    responseFormat: 'UNIFIED_RESPONSE_FORMAT'
  }
}
```

### 6.2 å¾®ä¿¡å°ç¨‹åºé”™è¯¯å¤„ç†è§„èŒƒ
```javascript
// ğŸ”´ å¾®ä¿¡å°ç¨‹åºç‰¹æ®Šé”™è¯¯å¤„ç†
const WECHAT_ERROR_HANDLING = {
  
  // ç½‘ç»œé”™è¯¯å¤„ç†
  networkErrors: {
    600001: {
      wechatCode: 600001,
      desc: 'request:fail url not in domain list',
      solution: 'æ£€æŸ¥requeståˆæ³•åŸŸåé…ç½®',
      backend_action: 'è¿”å›è¯¦ç»†çš„åŸŸåé…ç½®è¯´æ˜'
    },
    600002: {
      wechatCode: 600002, 
      desc: 'request:fail ç½‘ç»œé”™è¯¯',
      solution: 'æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€',
      backend_action: 'æä¾›ç½‘ç»œè¯Šæ–­æ¥å£'
    },
    600003: {
      wechatCode: 600003,
      desc: 'request:fail timeout',
      solution: 'å¢åŠ è¯·æ±‚è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æ¥å£æ€§èƒ½',
      backend_action: 'æ¥å£å“åº”æ—¶é—´ç›‘æ§å’Œä¼˜åŒ–'
    }
  },
  
  // WebSocketé”™è¯¯å¤„ç†
  websocketErrors: {
    600011: {
      wechatCode: 600011,
      desc: 'connectSocket:fail url not in domain list',
      solution: 'æ£€æŸ¥socketåˆæ³•åŸŸåé…ç½®',
      backend_action: 'WebSocketæœåŠ¡çŠ¶æ€æ£€æŸ¥æ¥å£'
    },
    600012: {
      wechatCode: 600012,
      desc: 'connectSocket:fail è¿æ¥å¤±è´¥',
      solution: 'æ£€æŸ¥WebSocketæœåŠ¡çŠ¶æ€',
      backend_action: 'æä¾›WebSocketè¿æ¥è¯Šæ–­'
    }
  },
  
  // ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
  errorResponse: {
    structure: {
      code: 'number',              // é”™è¯¯ç 
      msg: 'string',               // é”™è¯¯æè¿°
      data: null,                  // é”™è¯¯æ—¶ä¸ºnull
      wechat_tip: 'string',        // ğŸ”´ å¾®ä¿¡å°ç¨‹åºä¸“ç”¨æç¤º
      solution: 'string'           // ğŸ”´ è§£å†³æ–¹æ¡ˆå»ºè®®
    },
    example: {
      code: 600001,
      msg: 'åŸŸåé…ç½®é”™è¯¯',
      data: null,
      wechat_tip: 'è¯·è”ç³»ç®¡ç†å‘˜é…ç½®requeståˆæ³•åŸŸå',
      solution: 'åœ¨å¾®ä¿¡å°ç¨‹åºåå°æ·»åŠ åŸŸåï¼šhttps://your-domain.com'
    }
  }
}
    } catch (error) {
      console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error)
      process.exit(1)
    }
  }
  
  // ğŸ”´ è·å–æ•°æ®åº“å®ä¾‹
  getInstance() {
    return this.sequelize
  }
}
```

### 4.2 æ¨¡å‹å®šä¹‰è§„èŒƒ
```javascript
// ğŸ”´ æ•°æ®æ¨¡å‹æ ‡å‡†å®šä¹‰
const { DataTypes } = require('sequelize')

const User = sequelize.define('User', {
  // ğŸ”´ ä¸»é”®å­—æ®µ
  user_id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true,
    comment: 'ç”¨æˆ·å”¯ä¸€æ ‡è¯†'
  },
  
  // ğŸ”´ ä¸šåŠ¡å­—æ®µ
  mobile: {
    type: DataTypes.STRING(11),
    allowNull: false,
    unique: true,
    validate: {
      is: /^1[3-9]\d{9}$/,
      notEmpty: true
    },
    comment: 'æ‰‹æœºå·'
  },
  
  nickname: {
    type: DataTypes.STRING(50),
    allowNull: true,
    defaultValue: '',
    comment: 'ç”¨æˆ·æ˜µç§°'
  },
  
  avatar: {
    type: DataTypes.STRING(255),
    allowNull: true,
    defaultValue: '',
    comment: 'ç”¨æˆ·å¤´åƒURL'
  },
  
  total_points: {
    type: DataTypes.INTEGER,
    allowNull: false,
    defaultValue: 0,
    validate: {
      min: 0
    },
    comment: 'ç”¨æˆ·æ€»ç§¯åˆ†'
  },
  
  // ğŸ”´ çŠ¶æ€å­—æ®µ
  status: {
    type: DataTypes.ENUM('active', 'inactive', 'banned'),
    allowNull: false,
    defaultValue: 'active',
    comment: 'ç”¨æˆ·çŠ¶æ€'
  },
  
  // ğŸ”´ æƒé™å­—æ®µ
  is_merchant: {
    type: DataTypes.BOOLEAN,
    allowNull: false,
    defaultValue: false,
    comment: 'æ˜¯å¦ä¸ºå•†å®¶'
  },
  
  // ğŸ”´ å¾®ä¿¡ç›¸å…³å­—æ®µ
  wx_openid: {
    type: DataTypes.STRING(50),
    allowNull: true,
    unique: true,
    comment: 'å¾®ä¿¡OpenID'
  }
}, {
  // ğŸ”´ è¡¨é…ç½®
  tableName: 'users',
  timestamps: true,
  paranoid: true,
  
  // ğŸ”´ ç´¢å¼•é…ç½®
  indexes: [
    {
      unique: true,
      fields: ['mobile']
    },
    {
      unique: true,
      fields: ['wx_openid'],
      where: {
        wx_openid: {
          [Op.ne]: null
        }
      }
    },
    {
      fields: ['status', 'is_merchant']
    }
  ],
  
  // ğŸ”´ æ¨¡å‹é’©å­
  hooks: {
    beforeCreate: (user) => {
      // åˆ›å»ºå‰æ•°æ®å¤„ç†
      if (!user.nickname) {
        user.nickname = `ç”¨æˆ·${user.mobile.substr(-4)}`
      }
    }
  }
})

// ğŸ”´ æ¨¡å‹å…³è”å®šä¹‰
User.hasMany(LotteryRecord, { foreignKey: 'user_id' })
User.hasMany(ExchangeRecord, { foreignKey: 'user_id' })
```

### 4.3 æ•°æ®è®¿é—®å±‚æœåŠ¡
```javascript
// ğŸ”´ æ•°æ®è®¿é—®å±‚æ ‡å‡†å®ç°
class UserService {
  constructor() {
    this.model = User
  }
  
  /**
   * ğŸ”´ åˆ›å»ºç”¨æˆ· - åŒ…å«äº‹åŠ¡å¤„ç†
   */
  async createUser(userData) {
    const transaction = await sequelize.transaction()
    
    try {
      // 1. éªŒè¯ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
      const existingUser = await this.model.findOne({
        where: { mobile: userData.mobile }
      })
      
      if (existingUser) {
        throw new Error('ç”¨æˆ·å·²å­˜åœ¨')
      }
      
      // 2. åˆ›å»ºç”¨æˆ·
      const user = await this.model.create(userData, { transaction })
      
      // 3. åˆå§‹åŒ–ç”¨æˆ·ç§¯åˆ†è®°å½•
      await PointsHistory.create({
        user_id: user.user_id,
        points: 0,
        change_type: 'initial',
        description: 'è´¦æˆ·åˆå§‹åŒ–'
      }, { transaction })
      
      await transaction.commit()
      return user
      
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
  
  /**
   * ğŸ”´ æ›´æ–°ç”¨æˆ·ç§¯åˆ† - åŸå­æ“ä½œ
   */
  async updateUserPoints(userId, pointsChange, description) {
    const transaction = await sequelize.transaction()
    
    try {
      // 1. é”å®šç”¨æˆ·è®°å½•
      const user = await this.model.findByPk(userId, {
        lock: transaction.LOCK.UPDATE,
        transaction
      })
      
      if (!user) {
        throw new Error('ç”¨æˆ·ä¸å­˜åœ¨')
      }
      
      // 2. æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿï¼ˆæ‰£å‡æ“ä½œï¼‰
      if (pointsChange < 0 && user.total_points + pointsChange < 0) {
        throw new Error('ç§¯åˆ†ä¸è¶³')
      }
      
      // 3. æ›´æ–°ç§¯åˆ†
      await user.update({
        total_points: user.total_points + pointsChange
      }, { transaction })
      
      // 4. è®°å½•ç§¯åˆ†å˜åŠ¨å†å²
      await PointsHistory.create({
        user_id: userId,
        points: pointsChange,
        change_type: pointsChange > 0 ? 'earn' : 'spend',
        description: description,
        balance_after: user.total_points + pointsChange
      }, { transaction })
      
      await transaction.commit()
      return user
      
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
  
  /**
   * ğŸ”´ æ‰¹é‡æŸ¥è¯¢ç”¨æˆ· - åˆ†é¡µå’Œè¿‡æ»¤
   */
  async findUsers(options = {}) {
    const {
      page = 1,
      limit = 20,
      status = 'active',
      isMerchant = null,
      search = null
    } = options
    
    const where = { status }
    
    // å•†å®¶ç­›é€‰
    if (isMerchant !== null) {
      where.is_merchant = isMerchant
    }
    
    // æœç´¢æ¡ä»¶
    if (search) {
      where[Op.or] = [
        { mobile: { [Op.like]: `%${search}%` } },
        { nickname: { [Op.like]: `%${search}%` } }
      ]
    }
    
    const result = await this.model.findAndCountAll({
      where,
      limit,
      offset: (page - 1) * limit,
      order: [['created_at', 'DESC']],
      attributes: { exclude: ['deleted_at'] }
    })
    
    return {
      users: result.rows,
      total: result.count,
      page,
      limit,
      totalPages: Math.ceil(result.count / limit)
    }
  }
}
```

## ğŸ” äº”ã€å®‰å…¨é˜²æŠ¤è§„èŒƒ

### 5.1 è®¤è¯æˆæƒç³»ç»Ÿ
```javascript
// ğŸ”´ JWTè®¤è¯ä¸­é—´ä»¶
const jwt = require('jsonwebtoken')
const rateLimit = require('express-rate-limit')

class AuthMiddleware {
  constructor() {
    this.jwtSecret = process.env.JWT_SECRET
    this.jwtExpires = process.env.JWT_EXPIRES || '7d'
  }
  
  /**
   * ğŸ”´ ç”ŸæˆJWT Token
   */
  generateToken(payload) {
    return jwt.sign(payload, this.jwtSecret, {
      expiresIn: this.jwtExpires,
      issuer: 'restaurant-lottery-api',
      audience: 'restaurant-lottery-client'
    })
  }
  
  /**
   * ğŸ”´ éªŒè¯JWT Token
   */
  verifyToken(req, res, next) {
    const authHeader = req.headers.authorization
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        code: 401,
        message: 'è®¤è¯å¤´æ ¼å¼é”™è¯¯'
      })
    }
    
    const token = authHeader.substring(7)
    
    try {
      const decoded = jwt.verify(token, this.jwtSecret)
      req.user = decoded
      next()
    } catch (error) {
      if (error.name === 'TokenExpiredError') {
        return res.status(401).json({
          code: 401,
          message: 'Tokenå·²è¿‡æœŸ'
        })
      }
      
      return res.status(401).json({
        code: 401,
        message: 'TokenéªŒè¯å¤±è´¥'
      })
    }
  }
  
  /**
   * ğŸ”´ æƒé™éªŒè¯ä¸­é—´ä»¶
   */
  requireMerchant(req, res, next) {
    if (!req.user.is_merchant) {
      return res.status(403).json({
        code: 403,
        message: 'éœ€è¦å•†å®¶æƒé™'
      })
    }
    next()
  }
}

// ğŸ”´ è¯·æ±‚é¢‘ç‡é™åˆ¶
const createRateLimit = (windowMs, max, message) => {
  return rateLimit({
    windowMs,
    max,
    message: {
      code: 429,
      message
    },
    standardHeaders: true,
    legacyHeaders: false
  })
}

// ä¸åŒæ¥å£çš„é™æµé…ç½®
const rateLimiters = {
  // ç™»å½•æ¥å£ï¼šæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡
  login: createRateLimit(60 * 1000, 5, 'ç™»å½•è¯·æ±‚è¿‡äºé¢‘ç¹'),
  
  // å‘é€éªŒè¯ç ï¼šæ¯åˆ†é’Ÿæœ€å¤š3æ¬¡
  sendCode: createRateLimit(60 * 1000, 3, 'éªŒè¯ç å‘é€è¿‡äºé¢‘ç¹'),
  
  // æŠ½å¥–æ¥å£ï¼šæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡
  lottery: createRateLimit(60 * 1000, 10, 'æŠ½å¥–è¯·æ±‚è¿‡äºé¢‘ç¹'),
  
  // ä¸€èˆ¬APIï¼šæ¯åˆ†é’Ÿæœ€å¤š100æ¬¡
  general: createRateLimit(60 * 1000, 100, 'è¯·æ±‚è¿‡äºé¢‘ç¹')
}
```

### 5.2 æ•°æ®åŠ å¯†ä¸éªŒè¯
```javascript
// ğŸ”´ æ•°æ®åŠ å¯†å·¥å…·
const crypto = require('crypto')
const bcrypt = require('bcrypt')

class SecurityUtils {
  constructor() {
    this.algorithm = 'aes-256-gcm'
    this.secretKey = process.env.ENCRYPTION_KEY
  }
  
  /**
   * ğŸ”´ æ•æ„Ÿæ•°æ®åŠ å¯†
   */
  encrypt(text) {
    const iv = crypto.randomBytes(16)
    const cipher = crypto.createCipher(this.algorithm, this.secretKey)
    cipher.setAAD(Buffer.from('restaurant-lottery', 'utf8'))
    
    let encrypted = cipher.update(text, 'utf8', 'hex')
    encrypted += cipher.final('hex')
    
    const authTag = cipher.getAuthTag()
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex')
    }
  }
  
  /**
   * ğŸ”´ æ•æ„Ÿæ•°æ®è§£å¯†
   */
  decrypt(encryptedData) {
    const { encrypted, iv, authTag } = encryptedData
    
    const decipher = crypto.createDecipher(this.algorithm, this.secretKey)
    decipher.setAAD(Buffer.from('restaurant-lottery', 'utf8'))
    decipher.setAuthTag(Buffer.from(authTag, 'hex'))
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8')
    decrypted += decipher.final('utf8')
    
    return decrypted
  }
  
  /**
   * ğŸ”´ å¯†ç å“ˆå¸Œ
   */
  async hashPassword(password) {
    const saltRounds = 12
    return await bcrypt.hash(password, saltRounds)
  }
  
  /**
   * ğŸ”´ å¯†ç éªŒè¯
   */
  async verifyPassword(password, hash) {
    return await bcrypt.compare(password, hash)
  }
  
  /**
   * ğŸ”´ æ‰‹æœºå·è„±æ•
   */
  maskMobile(mobile) {
    if (!mobile || mobile.length !== 11) return mobile
    return mobile.substring(0, 3) + '****' + mobile.substring(7)
  }
}
```

## ğŸ” å…­ã€æ—¥å¿—ç›‘æ§è§„èŒƒ

### 6.1 æ—¥å¿—ç³»ç»Ÿè®¾è®¡
```javascript
// ğŸ”´ ç»Ÿä¸€æ—¥å¿—ç®¡ç†
const winston = require('winston')
const DailyRotateFile = require('winston-daily-rotate-file')

class Logger {
  constructor() {
    this.logger = winston.createLogger({
      level: process.env.LOG_LEVEL || 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json()
      ),
      
      transports: [
        // ğŸ”´ æ§åˆ¶å°è¾“å‡º
        new winston.transports.Console({
          format: winston.format.combine(
            winston.format.colorize(),
            winston.format.simple()
          )
        }),
        
        // ğŸ”´ æ–‡ä»¶è¾“å‡º - æŒ‰æ—¥æœŸè½®è½¬
        new DailyRotateFile({
          filename: 'logs/application-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          maxSize: '20m',
          maxFiles: '30d'
        }),
        
        // ğŸ”´ é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½•
        new DailyRotateFile({
          filename: 'logs/error-%DATE%.log',
          datePattern: 'YYYY-MM-DD',
          level: 'error',
          maxSize: '20m',
          maxFiles: '90d'
        })
      ]
    })
  }
  
  /**
   * ğŸ”´ APIè¯·æ±‚æ—¥å¿—
   */
  logRequest(req, res, responseTime) {
    this.logger.info('API Request', {
      method: req.method,
      url: req.originalUrl,
      ip: req.ip,
      userAgent: req.get('User-Agent'),
      statusCode: res.statusCode,
      responseTime: `${responseTime}ms`,
      userId: req.user?.user_id,
      timestamp: new Date().toISOString()
    })
  }
  
  /**
   * ğŸ”´ ä¸šåŠ¡æ“ä½œæ—¥å¿—
   */
  logBusinessOperation(operation, data, userId = null) {
    this.logger.info('Business Operation', {
      operation,
      data,
      userId,
      timestamp: new Date().toISOString()
    })
  }
  
  /**
   * ğŸ”´ é”™è¯¯æ—¥å¿—
   */
  logError(error, context = {}) {
    this.logger.error('Application Error', {
      message: error.message,
      stack: error.stack,
      context,
      timestamp: new Date().toISOString()
    })
  }
}

// ğŸ”´ è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
const requestLogger = (req, res, next) => {
  const startTime = Date.now()
  
  res.on('finish', () => {
    const responseTime = Date.now() - startTime
    logger.logRequest(req, res, responseTime)
  })
  
  next()
}
```

### 6.2 æ€§èƒ½ç›‘æ§
```javascript
// ğŸ”´ æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
const performanceMonitor = (req, res, next) => {
  const startTime = process.hrtime()
  const startMemory = process.memoryUsage()
  
  res.on('finish', () => {
    const [seconds, nanoseconds] = process.hrtime(startTime)
    const responseTime = seconds * 1000 + nanoseconds / 1000000
    const endMemory = process.memoryUsage()
    
    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    logger.info('Performance Metrics', {
      url: req.originalUrl,
      method: req.method,
      responseTime: `${responseTime.toFixed(2)}ms`,
      memoryUsage: {
        rss: endMemory.rss - startMemory.rss,
        heapUsed: endMemory.heapUsed - startMemory.heapUsed
      },
      timestamp: new Date().toISOString()
    })
    
    // æ€§èƒ½å‘Šè­¦
    if (responseTime > 1000) {
      logger.warn('Slow API Response', {
        url: req.originalUrl,
        responseTime: `${responseTime.toFixed(2)}ms`
      })
    }
  })
  
  next()
}
```

## âš¡ ä¸ƒã€æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### 7.1 æ•°æ®åº“ä¼˜åŒ–
```javascript
// ğŸ”´ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
class DatabaseOptimization {
  
  /**
   * ğŸ”´ æŸ¥è¯¢ä¼˜åŒ– - ä½¿ç”¨ç´¢å¼•
   */
  async optimizedQuery(conditions) {
    // âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
    return await User.findAll({
      where: {
        status: 'active',        // æœ‰ç´¢å¼•
        is_merchant: true        // æœ‰è”åˆç´¢å¼•
      },
      attributes: ['user_id', 'mobile', 'nickname'], // åªé€‰æ‹©éœ€è¦çš„å­—æ®µ
      limit: 50,
      offset: 0,
      order: [['created_at', 'DESC']]  // ä½¿ç”¨ç´¢å¼•æ’åº
    })
  }
  
  /**
   * ğŸ”´ æ‰¹é‡æ“ä½œä¼˜åŒ–
   */
  async batchUpdate(updates) {
    const transaction = await sequelize.transaction()
    
    try {
      // ä½¿ç”¨æ‰¹é‡æ›´æ–°è€Œä¸æ˜¯å¾ªç¯å•ä¸ªæ›´æ–°
      const promises = updates.map(update => 
        User.update(
          { total_points: update.points },
          { 
            where: { user_id: update.userId },
            transaction 
          }
        )
      )
      
      await Promise.all(promises)
      await transaction.commit()
      
    } catch (error) {
      await transaction.rollback()
      throw error
    }
  }
  
  /**
   * ğŸ”´ åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
   */
  async paginatedQuery(page, limit) {
    // ä½¿ç”¨ offset å’Œ limit è¿›è¡Œåˆ†é¡µ
    const offset = (page - 1) * limit
    
    return await User.findAndCountAll({
      where: { status: 'active' },
      limit: Math.min(limit, 50), // é™åˆ¶æœ€å¤§æŸ¥è¯¢æ•°é‡
      offset,
      order: [['created_at', 'DESC']],
      attributes: { exclude: ['password', 'deleted_at'] }
    })
  }
}
```

### 7.2 ç¼“å­˜ç­–ç•¥
```javascript
// ğŸ”´ Redisç¼“å­˜ç®¡ç†
const redis = require('redis')

class CacheManager {
  constructor() {
    this.client = redis.createClient({
      host: process.env.REDIS_HOST,
      port: process.env.REDIS_PORT,
      password: process.env.REDIS_PASSWORD,
      retry_strategy: (options) => {
        if (options.error && options.error.code === 'ECONNREFUSED') {
          return new Error('RedisæœåŠ¡å™¨è¿æ¥è¢«æ‹’ç»')
        }
        if (options.total_retry_time > 1000 * 60 * 60) {
          return new Error('Redisé‡è¯•æ—¶é—´è€—å°½')
        }
        return Math.min(options.attempt * 100, 3000)
      }
    })
  }
  
  /**
   * ğŸ”´ ç¼“å­˜æŠ½å¥–é…ç½®
   */
  async cacheLotteryConfig(config) {
    const key = 'lottery:config'
    const ttl = 60 * 60 // 1å°æ—¶è¿‡æœŸ
    
    await this.client.setex(key, ttl, JSON.stringify(config))
  }
  
  /**
   * ğŸ”´ è·å–ç¼“å­˜çš„æŠ½å¥–é…ç½®
   */
  async getLotteryConfig() {
    const key = 'lottery:config'
    const cached = await this.client.get(key)
    
    return cached ? JSON.parse(cached) : null
  }
  
  /**
   * ğŸ”´ ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
   */
  async cacheUserInfo(userId, userInfo) {
    const key = `user:${userId}`
    const ttl = 30 * 60 // 30åˆ†é’Ÿè¿‡æœŸ
    
    await this.client.setex(key, ttl, JSON.stringify(userInfo))
  }
  
  /**
   * ğŸ”´ åˆ†å¸ƒå¼é”å®ç°
   */
  async acquireLock(key, timeout = 10000) {
    const lockKey = `lock:${key}`
    const lockValue = Date.now() + timeout
    
    const result = await this.client.set(lockKey, lockValue, 'PX', timeout, 'NX')
    return result === 'OK'
  }
  
  /**
   * ğŸ”´ é‡Šæ”¾åˆ†å¸ƒå¼é”
   */
  async releaseLock(key) {
    const lockKey = `lock:${key}`
    await this.client.del(lockKey)
  }
}
```

## ğŸ§ª å…«ã€æµ‹è¯•è§„èŒƒ

### 8.1 å•å…ƒæµ‹è¯•æ ‡å‡†
```javascript
// ğŸ”´ å•å…ƒæµ‹è¯•æ¡†æ¶é…ç½®
const { describe, it, beforeEach, afterEach } = require('mocha')
const { expect } = require('chai')
const sinon = require('sinon')

describe('UserService', () => {
  let userService
  let mockDb
  
  beforeEach(() => {
    userService = new UserService()
    mockDb = sinon.createStubInstance(User)
  })
  
  afterEach(() => {
    sinon.restore()
  })
  
  describe('createUser', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºæ–°ç”¨æˆ·', async () => {
      // Arrange
      const userData = {
        mobile: '13800138000',
        nickname: 'æµ‹è¯•ç”¨æˆ·'
      }
      
      mockDb.findOne.resolves(null) // ç”¨æˆ·ä¸å­˜åœ¨
      mockDb.create.resolves({ user_id: 1, ...userData })
      
      // Act
      const result = await userService.createUser(userData)
      
      // Assert
      expect(result.user_id).to.equal(1)
      expect(result.mobile).to.equal(userData.mobile)
      expect(mockDb.create.calledOnce).to.be.true
    })
    
    it('åº”è¯¥æ‹’ç»åˆ›å»ºé‡å¤ç”¨æˆ·', async () => {
      // Arrange
      const userData = { mobile: '13800138000' }
      mockDb.findOne.resolves({ user_id: 1 }) // ç”¨æˆ·å·²å­˜åœ¨
      
      // Act & Assert
      try {
        await userService.createUser(userData)
        expect.fail('åº”è¯¥æŠ›å‡ºé”™è¯¯')
      } catch (error) {
        expect(error.message).to.equal('ç”¨æˆ·å·²å­˜åœ¨')
      }
    })
  })
})
```

### 8.2 é›†æˆæµ‹è¯•æ ‡å‡†
```javascript
// ğŸ”´ APIé›†æˆæµ‹è¯•
const request = require('supertest')
const app = require('../src/app')

describe('API Integration Tests', () => {
  let authToken
  
  before(async () => {
    // è·å–æµ‹è¯•ç”¨æˆ·çš„è®¤è¯ä»¤ç‰Œ
    const loginResponse = await request(app)
      .post('/api/auth/login')
      .send({
        mobile: '13800138000',
        code: '123456'
      })
    
    authToken = loginResponse.body.data.access_token
  })
  
  describe('GET /api/lottery/config', () => {
    it('åº”è¯¥è¿”å›æŠ½å¥–é…ç½®', async () => {
      const response = await request(app)
        .get('/api/lottery/config')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200)
      
      expect(response.body.code).to.equal(0)
      expect(response.body.data).to.have.property('prizes')
      expect(response.body.data.prizes).to.be.an('array')
    })
  })
  
  describe('POST /api/lottery/draw', () => {
    it('åº”è¯¥æˆåŠŸæ‰§è¡ŒæŠ½å¥–', async () => {
      const response = await request(app)
        .post('/api/lottery/draw')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          userId: 1,
          costPoints: 100
        })
        .expect(200)
      
      expect(response.body.code).to.equal(0)
      expect(response.body.data).to.have.property('prizeId')
    })
  })
})
```

## ğŸš€ ä¹ã€éƒ¨ç½²è¿ç»´è§„èŒƒ

### 9.1 Dockerå®¹å™¨åŒ–é…ç½®
```dockerfile
# ğŸ”´ å¤šé˜¶æ®µæ„å»ºDockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production && npm cache clean --force

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# ğŸ”´ ç”Ÿäº§ç¯å¢ƒé•œåƒ
FROM node:18-alpine AS production

# å®‰è£…dumb-initç”¨äºä¿¡å·å¤„ç†
RUN apk add --no-cache dumb-init

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /app

# å¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nodejs

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node healthcheck.js

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["dumb-init", "--"]
CMD ["node", "dist/app.js"]
```

### 9.2 ç¯å¢ƒé…ç½®ç®¡ç†
```javascript
// ğŸ”´ ç¯å¢ƒé…ç½®éªŒè¯
const Joi = require('joi')

const envSchema = Joi.object({
  NODE_ENV: Joi.string()
    .valid('development', 'testing', 'production')
    .default('development'),
  
  PORT: Joi.number()
    .port()
    .default(3000),
  
  DB_HOST: Joi.string().required(),
  DB_PORT: Joi.number().port().default(3306),
  DB_NAME: Joi.string().required(),
  DB_USER: Joi.string().required(),
  DB_PASSWORD: Joi.string().required(),
  
  REDIS_HOST: Joi.string().required(),
  REDIS_PORT: Joi.number().port().default(6379),
  REDIS_PASSWORD: Joi.string().allow(''),
  
  JWT_SECRET: Joi.string().min(32).required(),
  JWT_EXPIRES: Joi.string().default('7d'),
  
  SMS_ACCESS_KEY: Joi.string().required(),
  SMS_SECRET_KEY: Joi.string().required(),
  
  SEALOS_ENDPOINT: Joi.string().uri().required(),
  SEALOS_ACCESS_KEY: Joi.string().required(),
  SEALOS_SECRET_KEY: Joi.string().required()
})

// ğŸ”´ é…ç½®éªŒè¯å’ŒåŠ è½½
const { error, value: envVars } = envSchema.validate(process.env)

if (error) {
  throw new Error(`ç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥: ${error.message}`)
}

module.exports = envVars
```

## ğŸ“Š åã€ç›‘æ§å‘Šè­¦è§„èŒƒ

### 10.1 å¥åº·æ£€æŸ¥ç«¯ç‚¹
```javascript
// ğŸ”´ å¥åº·æ£€æŸ¥å®ç°
const healthCheck = {
  // åº”ç”¨çŠ¶æ€æ£€æŸ¥
  async checkApplication() {
    return {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      memory: process.memoryUsage(),
      version: process.env.npm_package_version
    }
  },
  
  // æ•°æ®åº“è¿æ¥æ£€æŸ¥
  async checkDatabase() {
    try {
      await sequelize.authenticate()
      return { status: 'healthy', responseTime: Date.now() }
    } catch (error) {
      return { status: 'unhealthy', error: error.message }
    }
  },
  
  // Redisè¿æ¥æ£€æŸ¥
  async checkRedis() {
    try {
      const start = Date.now()
      await redis.ping()
      return { 
        status: 'healthy', 
        responseTime: Date.now() - start 
      }
    } catch (error) {
      return { status: 'unhealthy', error: error.message }
    }
  }
}

// å¥åº·æ£€æŸ¥è·¯ç”±
app.get('/health', async (req, res) => {
  const checks = await Promise.all([
    healthCheck.checkApplication(),
    healthCheck.checkDatabase(),
    healthCheck.checkRedis()
  ])
  
  const [app, db, redis] = checks
  const allHealthy = checks.every(check => check.status === 'healthy')
  
  res.status(allHealthy ? 200 : 503).json({
    status: allHealthy ? 'healthy' : 'unhealthy',
    checks: { app, db, redis },
    timestamp: new Date().toISOString()
  })
})
```

### 10.2 å‘Šè­¦è§„åˆ™é…ç½®
```javascript
// ğŸ”´ å‘Šè­¦è§„åˆ™å®šä¹‰
const ALERT_RULES = {
  // å“åº”æ—¶é—´å‘Šè­¦
  responseTime: {
    threshold: 1000, // 1ç§’
    action: 'warn',
    message: 'APIå“åº”æ—¶é—´è¿‡é•¿'
  },
  
  // é”™è¯¯ç‡å‘Šè­¦
  errorRate: {
    threshold: 0.05, // 5%
    window: 300, // 5åˆ†é’Ÿçª—å£
    action: 'critical',
    message: 'é”™è¯¯ç‡è¿‡é«˜'
  },
  
  // å†…å­˜ä½¿ç”¨å‘Šè­¦
  memoryUsage: {
    threshold: 0.8, // 80%
    action: 'warn',
    message: 'å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜'
  },
  
  // æ•°æ®åº“è¿æ¥å‘Šè­¦
  dbConnection: {
    threshold: 0, // è¿æ¥å¤±è´¥
    action: 'critical',
    message: 'æ•°æ®åº“è¿æ¥å¤±è´¥'
  }
}
```

---

## ğŸ¯ æ€»ç»“ï¼šåç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£ä»·å€¼

### âœ… æ ¸å¿ƒä»·å€¼
1. **æœåŠ¡ç¨³å®šæ€§**ï¼šé€šè¿‡è§„èŒƒåŒ–çš„æ¶æ„è®¾è®¡ç¡®ä¿æœåŠ¡é«˜å¯ç”¨
2. **å¼€å‘æ•ˆç‡**ï¼šæ ‡å‡†åŒ–çš„å¼€å‘æµç¨‹æå‡å›¢é˜Ÿåä½œæ•ˆç‡
3. **å®‰å…¨ä¿éšœ**ï¼šå®Œå–„çš„å®‰å…¨é˜²æŠ¤æœºåˆ¶ä¿æŠ¤ç³»ç»Ÿå®‰å…¨
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºæœ€ä½³å®è·µçš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ğŸ¯ å®æ–½è·¯å¾„
1. **åŸºç¡€è®¾æ–½**ï¼šé¦–å…ˆå»ºç«‹æ•°æ®åº“ã€ç¼“å­˜ã€æ—¥å¿—ç­‰åŸºç¡€è®¾æ–½
2. **æ ¸å¿ƒåŠŸèƒ½**ï¼šå®ç°ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½
3. **ä¸šåŠ¡é€»è¾‘**ï¼šåŸºäºè§„èŒƒå®ç°å…·ä½“ä¸šåŠ¡åŠŸèƒ½
4. **ç›‘æ§è¿ç»´**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»

**æ–‡æ¡£å®šä½**ï¼šåç«¯å¼€å‘å·¥ç¨‹å¸ˆä¸“ç”¨æŠ€æœ¯è§„èŒƒ  
**è¦†ç›–èŒƒå›´**ï¼šNode.jsåç«¯æœåŠ¡å¼€å‘å…¨æµç¨‹  
**æ›´æ–°ç­–ç•¥**ï¼šéšæŠ€æœ¯å‘å±•å’Œä¸šåŠ¡éœ€æ±‚æŒç»­ä¼˜åŒ– 

## ğŸ”´ åä¸€ã€v2.1.2çº¯äººå·¥å®¡æ ¸è§„èŒƒ

### 11.1 çº¯äººå·¥å®¡æ ¸æ¶æ„è®¾è®¡

#### 11.1.1 å®¡æ ¸æµç¨‹æ¶æ„
```javascript
// ğŸ”´ v2.1.2çº¯äººå·¥å®¡æ ¸æµç¨‹è®¾è®¡
const MANUAL_REVIEW_WORKFLOW = {
  // 1. ç”¨æˆ·ä¸Šä¼ é˜¶æ®µ
  userUpload: {
    required: ['image_file', 'amount'],  // ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨è¾“å…¥æ¶ˆè´¹é‡‘é¢
    validation: [
      'image_format_check',              // å›¾ç‰‡æ ¼å¼éªŒè¯
      'file_size_check',                 // æ–‡ä»¶å¤§å°æ£€æŸ¥
      'amount_range_check'               // é‡‘é¢èŒƒå›´éªŒè¯(0-10000)
    ],
    storage: 'sealos_object_storage',    // å­˜å‚¨åˆ°Sealoså¯¹è±¡å­˜å‚¨
    status: 'pending'                    // åˆå§‹çŠ¶æ€ï¼šç­‰å¾…å®¡æ ¸
  },
  
  // 2. å•†å®¶å®¡æ ¸é˜¶æ®µ
  merchantReview: {
    permissions: ['is_merchant'],        // éœ€è¦å•†å®¶æƒé™
    actions: ['approve', 'reject'],      // å®¡æ ¸åŠ¨ä½œ
    required_for_approve: [
      'actual_amount',                   // å•†å®¶ç¡®è®¤çš„å®é™…æ¶ˆè´¹é‡‘é¢
      'points_calculation'               // åŸºäºå®é™…é‡‘é¢è®¡ç®—ç§¯åˆ†
    ],
    optional: ['review_reason'],         // å®¡æ ¸ç†ç”±
    notification: 'websocket_push'       // å®æ—¶æ¨é€å®¡æ ¸ç»“æœ
  },
  
  // 3. ç§¯åˆ†å¥–åŠ±é˜¶æ®µ
  pointsReward: {
    trigger: 'review_approved',          // å®¡æ ¸é€šè¿‡è§¦å‘
    calculation: 'actual_amount * 10',   // å®é™…é‡‘é¢Ã—10å€ç§¯åˆ†
    limits: { min: 50, max: 2000 },     // ç§¯åˆ†é™åˆ¶èŒƒå›´
    record: 'points_history_table'       // è®°å½•åˆ°ç§¯åˆ†å†å²è¡¨
  }
}
```

#### 11.1.2 æ•°æ®æ¨¡å‹è®¾è®¡
```javascript
// ğŸ”´ v2.1.2å®¡æ ¸æ•°æ®æ¨¡å‹
const PhotoReviewModel = {
  upload_id: 'VARCHAR(50) PRIMARY KEY',     // ä¸Šä¼ å”¯ä¸€æ ‡è¯†
  user_id: 'INT NOT NULL',                  // ç”¨æˆ·ID
  image_url: 'VARCHAR(500) NOT NULL',       // å›¾ç‰‡URLï¼ˆSealoså­˜å‚¨ï¼‰
  
  // ğŸ”´ v2.1.2æ ¸å¿ƒå­—æ®µ
  amount: 'DECIMAL(10,2) NOT NULL',         // ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„æ¶ˆè´¹é‡‘é¢
  actual_amount: 'DECIMAL(10,2)',           // å•†å®¶ç¡®è®¤çš„å®é™…æ¶ˆè´¹é‡‘é¢
  
  // å®¡æ ¸ç›¸å…³å­—æ®µ
  review_status: "ENUM('pending', 'approved', 'rejected')",
  review_reason: 'TEXT',                    // å®¡æ ¸ç†ç”±
  reviewer_id: 'INT',                       // å®¡æ ¸å‘˜IDï¼ˆå•†å®¶ï¼‰
  review_time: 'TIMESTAMP',                 // å®¡æ ¸æ—¶é—´
  points_awarded: 'INT DEFAULT 0',          // å¥–åŠ±ç§¯åˆ†
  
  // æ–‡ä»¶ä¿¡æ¯
  original_filename: 'VARCHAR(255)',        // åŸå§‹æ–‡ä»¶å
  file_size: 'INT',                         // æ–‡ä»¶å¤§å°
  
  // æ—¶é—´æˆ³
  created_at: 'TIMESTAMP DEFAULT CURRENT_TIMESTAMP',
  updated_at: 'TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
}
```

### 11.2 APIæ¥å£è§„èŒƒ

#### 11.2.1 ç”¨æˆ·ä¸Šä¼ æ¥å£
```javascript
/**
 * ğŸ”´ æ‹ç…§ä¸Šä¼ æ¥å£ - v2.1.2çº¯äººå·¥å®¡æ ¸ç‰ˆæœ¬
 * POST /api/photo/upload
 */
const uploadPhotoAPI = {
  method: 'POST',
  endpoint: '/api/photo/upload',
  contentType: 'multipart/form-data',
  
  // è¯·æ±‚å‚æ•°
  request: {
    photo: 'File',                        // å›¾ç‰‡æ–‡ä»¶
    amount: 'Number'                      // ğŸ”´ ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„æ¶ˆè´¹é‡‘é¢ï¼ˆå¿…éœ€ï¼‰
  },
  
  // å‚æ•°éªŒè¯
  validation: {
    photo: {
      required: true,
      type: 'image/*',
      maxSize: '5MB'
    },
    amount: {
      required: true,
      type: 'number',
      min: 0.01,
      max: 10000
    }
  },
  
  // è¿”å›æ ¼å¼
  response: {
    success: {
      code: 0,
      msg: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œç­‰å¾…å•†å®¶å®¡æ ¸',
      data: {
        upload_id: 'string',
        status: 'pending',
        amount: 'number',
        message: 'æ‚¨çš„æ¶ˆè´¹å‡­è¯å·²æäº¤ï¼Œå•†å®¶å°†åœ¨24å°æ—¶å†…å®Œæˆå®¡æ ¸',
        estimated_review_time: '24å°æ—¶å†…'
      }
    },
    error: {
      1001: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡',
      1002: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹é‡‘é¢',
      1003: 'æ¶ˆè´¹é‡‘é¢ä¸èƒ½è¶…è¿‡10000å…ƒ',
      1004: 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡',
      1005: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•'
    }
  }
}
```

#### 11.2.2 å•†å®¶å®¡æ ¸æ¥å£
```javascript
/**
 * ğŸ”´ å•†å®¶å®¡æ ¸æ¥å£ - v2.1.2çº¯äººå·¥å®¡æ ¸ç‰ˆæœ¬
 * POST /api/merchant/review
 */
const merchantReviewAPI = {
  method: 'POST',
  endpoint: '/api/merchant/review',
  permissions: ['is_merchant'],
  
  // è¯·æ±‚å‚æ•°
  request: {
    upload_id: 'string',                  // ä¸Šä¼ ID
    action: 'string',                     // 'approved' | 'rejected'
    actual_amount: 'number',              // ğŸ”´ å•†å®¶ç¡®è®¤çš„å®é™…æ¶ˆè´¹é‡‘é¢ï¼ˆå®¡æ ¸é€šè¿‡æ—¶å¿…éœ€ï¼‰
    reason: 'string'                      // å®¡æ ¸ç†ç”±ï¼ˆå¯é€‰ï¼‰
  },
  
  // å‚æ•°éªŒè¯
  validation: {
    upload_id: { required: true, type: 'string' },
    action: { required: true, enum: ['approved', 'rejected'] },
    actual_amount: { 
      required_if: 'action === "approved"',
      type: 'number',
      min: 0.01,
      max: 10000
    }
  },
  
  // ä¸šåŠ¡é€»è¾‘
  businessLogic: {
    approveFlow: [
      'validate_actual_amount',           // éªŒè¯å®é™…é‡‘é¢
      'calculate_points',                 // è®¡ç®—ç§¯åˆ†å¥–åŠ±
      'update_user_points',               // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
      'create_points_record',             // åˆ›å»ºç§¯åˆ†è®°å½•
      'websocket_notification'            // WebSocketé€šçŸ¥ç”¨æˆ·
    ],
    rejectFlow: [
      'update_review_status',             // æ›´æ–°å®¡æ ¸çŠ¶æ€
      'websocket_notification'            // WebSocketé€šçŸ¥ç”¨æˆ·
    ]
  }
}
```

### 11.3 ä¸šåŠ¡é€»è¾‘å®ç°è§„èŒƒ

#### 11.3.1 ç§¯åˆ†è®¡ç®—è§„åˆ™
```javascript
// ğŸ”´ v2.1.2ç§¯åˆ†è®¡ç®—è§„åˆ™
class PointsCalculationService {
  /**
   * åŸºäºå•†å®¶ç¡®è®¤çš„å®é™…æ¶ˆè´¹é‡‘é¢è®¡ç®—ç§¯åˆ†
   * @param {number} actualAmount - å•†å®¶ç¡®è®¤çš„å®é™…æ¶ˆè´¹é‡‘é¢
   * @returns {number} è®¡ç®—åçš„ç§¯åˆ†
   */
  static calculatePoints(actualAmount) {
    if (!actualAmount || actualAmount <= 0) {
      return 0
    }
    
    // ğŸ”´ æ ¸å¿ƒç®—æ³•ï¼šå®é™…é‡‘é¢ Ã— 10å€ç§¯åˆ†
    const basePoints = Math.floor(actualAmount * 10)
    
    // ğŸ”´ ç§¯åˆ†èŒƒå›´é™åˆ¶ï¼š50-2000ç§¯åˆ†
    const finalPoints = Math.max(50, Math.min(2000, basePoints))
    
    return finalPoints
  }
  
  /**
   * éªŒè¯ç§¯åˆ†è®¡ç®—çš„åˆç†æ€§
   * @param {number} actualAmount - å®é™…æ¶ˆè´¹é‡‘é¢
   * @param {number} calculatedPoints - è®¡ç®—çš„ç§¯åˆ†
   * @returns {boolean} æ˜¯å¦åˆç†
   */
  static validatePointsCalculation(actualAmount, calculatedPoints) {
    const expectedPoints = this.calculatePoints(actualAmount)
    return calculatedPoints === expectedPoints
  }
}
```

#### 11.3.2 å®¡æ ¸çŠ¶æ€ç®¡ç†
```javascript
// ğŸ”´ v2.1.2å®¡æ ¸çŠ¶æ€ç®¡ç†
class ReviewStatusManager {
  static STATUSES = {
    PENDING: 'pending',       // ç­‰å¾…å®¡æ ¸
    APPROVED: 'approved',     // å®¡æ ¸é€šè¿‡
    REJECTED: 'rejected'      // å®¡æ ¸æ‹’ç»
  }
  
  /**
   * æ‰§è¡Œå®¡æ ¸æ“ä½œ
   * @param {string} uploadId - ä¸Šä¼ ID
   * @param {string} action - å®¡æ ¸åŠ¨ä½œ
   * @param {number} actualAmount - å®é™…æ¶ˆè´¹é‡‘é¢
   * @param {string} reason - å®¡æ ¸ç†ç”±
   * @param {number} reviewerId - å®¡æ ¸å‘˜ID
   * @param {Object} transaction - æ•°æ®åº“äº‹åŠ¡
   */
  static async performReview(uploadId, action, actualAmount, reason, reviewerId, transaction) {
    const review = await PhotoReview.findByPk(uploadId, { transaction })
    
    if (!review) {
      throw new Error('å®¡æ ¸è®°å½•ä¸å­˜åœ¨')
    }
    
    if (review.review_status !== this.STATUSES.PENDING) {
      throw new Error('è¯¥è®°å½•å·²ç»å®¡æ ¸è¿‡äº†')
    }
    
    // ğŸ”´ æ›´æ–°å®¡æ ¸ä¿¡æ¯
    const updateData = {
      review_status: action === 'approved' ? this.STATUSES.APPROVED : this.STATUSES.REJECTED,
      review_reason: reason,
      reviewer_id: reviewerId,
      review_time: new Date()
    }
    
    // ğŸ”´ å¦‚æœå®¡æ ¸é€šè¿‡ï¼Œè®¡ç®—ç§¯åˆ†å’Œå®é™…é‡‘é¢
    if (action === 'approved') {
      updateData.actual_amount = actualAmount
      updateData.points_awarded = PointsCalculationService.calculatePoints(actualAmount)
    }
    
    await review.update(updateData, { transaction })
    
    return review
  }
}
```

### 11.4 WebSocketå®æ—¶é€šçŸ¥è§„èŒƒ

#### 11.4.1 å®¡æ ¸ç»“æœæ¨é€
```javascript
// ğŸ”´ v2.1.2å®¡æ ¸ç»“æœWebSocketæ¨é€
class ReviewNotificationService {
  /**
   * æ¨é€å®¡æ ¸ç»“æœç»™ç”¨æˆ·
   * @param {number} userId - ç”¨æˆ·ID
   * @param {Object} reviewResult - å®¡æ ¸ç»“æœ
   */
  static notifyReviewResult(userId, reviewResult) {
    const notification = {
      type: 'review_result',
      data: {
        upload_id: reviewResult.upload_id,
        status: reviewResult.review_status,
        points_awarded: reviewResult.points_awarded,
        actual_amount: reviewResult.actual_amount,
        review_reason: reviewResult.review_reason,
        review_time: reviewResult.review_time,
        message: this.getStatusMessage(reviewResult.review_status, reviewResult.points_awarded)
      },
      timestamp: new Date().toISOString()
    }
    
    // æ¨é€ç»™æŒ‡å®šç”¨æˆ·
    webSocketService.sendToUser(userId, notification)
  }
  
  /**
   * æ¨é€æ–°å®¡æ ¸ä»»åŠ¡ç»™å•†å®¶
   * @param {Object} uploadData - ä¸Šä¼ æ•°æ®
   */
  static notifyMerchants(uploadData) {
    const notification = {
      type: 'new_review',
      data: {
        upload_id: uploadData.upload_id,
        user_id: uploadData.user_id,
        amount: uploadData.amount,
        image_url: uploadData.image_url,
        uploaded_at: uploadData.created_at
      },
      timestamp: new Date().toISOString()
    }
    
    // æ¨é€ç»™æ‰€æœ‰å•†å®¶
    webSocketService.sendToMerchants(notification)
  }
  
  /**
   * è·å–çŠ¶æ€æ¶ˆæ¯
   * @param {string} status - å®¡æ ¸çŠ¶æ€
   * @param {number} points - å¥–åŠ±ç§¯åˆ†
   * @returns {string} çŠ¶æ€æ¶ˆæ¯
   */
  static getStatusMessage(status, points) {
    switch (status) {
      case 'approved':
        return `æ­å–œï¼æ‚¨çš„æ¶ˆè´¹å‡­è¯å®¡æ ¸é€šè¿‡ï¼Œè·å¾—${points}ç§¯åˆ†å¥–åŠ±`
      case 'rejected':
        return 'å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„æ¶ˆè´¹å‡­è¯å®¡æ ¸æœªé€šè¿‡ï¼Œè¯·é‡æ–°ä¸Šä¼ '
      default:
        return 'æ‚¨çš„æ¶ˆè´¹å‡­è¯æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…'
    }
  }
}
```

### 11.5 å®‰å…¨é˜²æŠ¤è§„èŒƒ

#### 11.5.1 æƒé™éªŒè¯
```javascript
// ğŸ”´ v2.1.2æƒé™éªŒè¯ä¸­é—´ä»¶
const requireMerchant = (req, res, next) => {
  try {
    const user = req.user
    
    if (!user) {
      return res.status(401).json({
        code: 401,
        msg: 'æœªæˆæƒè®¿é—®',
        data: null
      })
    }
    
    if (!user.is_merchant) {
      return res.status(403).json({
        code: 403,
        msg: 'éœ€è¦å•†å®¶æƒé™æ‰èƒ½è®¿é—®',
        data: null
      })
    }
    
    next()
  } catch (error) {
    res.status(500).json({
      code: 500,
      msg: 'æƒé™éªŒè¯å¤±è´¥',
      data: null
    })
  }
}
```

#### 11.5.2 æ•°æ®éªŒè¯
```javascript
// ğŸ”´ v2.1.2æ•°æ®éªŒè¯è§„åˆ™
const reviewValidationRules = {
  upload: {
    amount: {
      type: 'number',
      required: true,
      min: 0.01,
      max: 10000,
      message: 'æ¶ˆè´¹é‡‘é¢å¿…é¡»åœ¨0.01-10000å…ƒä¹‹é—´'
    },
    photo: {
      type: 'file',
      required: true,
      mimeTypes: ['image/jpeg', 'image/png', 'image/gif'],
      maxSize: 5 * 1024 * 1024, // 5MB
      message: 'è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼Œå¤§å°ä¸è¶…è¿‡5MB'
    }
  },
  
  review: {
    action: {
      type: 'string',
      required: true,
      enum: ['approved', 'rejected'],
      message: 'å®¡æ ¸åŠ¨ä½œå¿…é¡»æ˜¯approvedæˆ–rejected'
    },
    actual_amount: {
      type: 'number',
      required_if: 'action === "approved"',
      min: 0.01,
      max: 10000,
      message: 'å®¡æ ¸é€šè¿‡æ—¶å¿…é¡»ç¡®è®¤å®é™…æ¶ˆè´¹é‡‘é¢'
    }
  }
}
```

### 11.6 é”™è¯¯å¤„ç†è§„èŒƒ

#### 11.6.1 å®¡æ ¸é”™è¯¯ç å®šä¹‰
```javascript
// ğŸ”´ v2.1.2å®¡æ ¸æ¨¡å—é”™è¯¯ç 
const REVIEW_ERROR_CODES = {
  // ä¸Šä¼ ç›¸å…³é”™è¯¯ (1000-1099)
  1001: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡',
  1002: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹é‡‘é¢',
  1003: 'æ¶ˆè´¹é‡‘é¢ä¸èƒ½è¶…è¿‡10000å…ƒ',
  1004: 'å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡',
  1005: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•',
  
  // å®¡æ ¸ç›¸å…³é”™è¯¯ (4000-4099)
  4001: 'å‚æ•°é”™è¯¯',
  4002: 'å®¡æ ¸é€šè¿‡æ—¶å¿…é¡»ç¡®è®¤å®é™…æ¶ˆè´¹é‡‘é¢',
  4003: 'å®¡æ ¸è®°å½•ä¸å­˜åœ¨',
  4004: 'è¯¥è®°å½•å·²ç»å®¡æ ¸è¿‡äº†',
  4005: 'æ²¡æœ‰å®¡æ ¸æƒé™',
  
  // æƒé™ç›¸å…³é”™è¯¯ (3000-3099)
  3001: 'éœ€è¦å•†å®¶æƒé™æ‰èƒ½è®¿é—®',
  3002: 'æ‚¨å·²ç»å…·å¤‡å•†å®¶æƒé™',
  3003: 'å•†å®¶ç”³è¯·ä¿¡æ¯ä¸å®Œæ•´'
}
```

---

## ğŸ¯ æ€»ç»“ï¼šv2.1.2çº¯äººå·¥å®¡æ ¸è§„èŒƒä»·å€¼

### âœ… æ ¸å¿ƒä»·å€¼
1. **å®¡æ ¸å‡†ç¡®æ€§**ï¼šäººå·¥å®¡æ ¸ç¡®ä¿æ¶ˆè´¹å‡­è¯çš„çœŸå®æ€§å’Œå‡†ç¡®æ€§
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç®€åŒ–ç”¨æˆ·æ“ä½œï¼Œåªéœ€ä¸Šä¼ å›¾ç‰‡å’Œè¾“å…¥é‡‘é¢
3. **å•†å®¶æ§åˆ¶**ï¼šå•†å®¶å¯ä»¥æ ¹æ®å®é™…æƒ…å†µç¡®è®¤æ¶ˆè´¹é‡‘é¢
4. **ç³»ç»Ÿç¨³å®š**ï¼šç§»é™¤å¤æ‚çš„OCRå’ŒAIç»„ä»¶ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§

### ğŸ”„ ä¸v2.1.1çš„ä¸»è¦å·®å¼‚
1. **ç§»é™¤OCRåŠŸèƒ½**ï¼šä¸å†è¿›è¡Œå›¾ç‰‡æ–‡å­—è¯†åˆ«
2. **ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥**ï¼šç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥æ¶ˆè´¹é‡‘é¢
3. **å•†å®¶ç¡®è®¤é‡‘é¢**ï¼šå•†å®¶å¯ä»¥ä¿®æ­£ç”¨æˆ·è¾“å…¥çš„é‡‘é¢
4. **çº¯äººå·¥å®¡æ ¸**ï¼šå®Œå…¨ä¾é äººå·¥åˆ¤æ–­ï¼Œæ— è‡ªåŠ¨å®¡æ ¸

### ğŸš€ å®æ–½å»ºè®®
1. **æ¸è¿›å¼è¿ç§»**ï¼šé€æ­¥ç§»é™¤OCRç›¸å…³ä»£ç å’Œä¾èµ–
2. **æ•°æ®è¿ç§»**ï¼šè°¨æ…å¤„ç†ç°æœ‰æ•°æ®çš„å­—æ®µå˜æ›´
3. **ç”¨æˆ·åŸ¹è®­**ï¼šæŒ‡å¯¼ç”¨æˆ·é€‚åº”æ–°çš„ä¸Šä¼ æµç¨‹
4. **å•†å®¶åŸ¹è®­**ï¼šåŸ¹è®­å•†å®¶ä½¿ç”¨æ–°çš„å®¡æ ¸ç•Œé¢

**è§„èŒƒå®šä½**ï¼šv2.1.2çº¯äººå·¥å®¡æ ¸æ¨¡å¼æŠ€æœ¯å®ç°æ ‡å‡†  
**é€‚ç”¨èŒƒå›´**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿåç«¯å¼€å‘  
**æ›´æ–°ç­–ç•¥**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ– 

---

## ğŸ“‹ åç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£å®Œæˆæ¸…å•

### âœ… å·²å®Œæˆå†…å®¹ï¼ˆåŸºäºå®é™…ä»£ç éªŒè¯ï¼‰

1. **âœ… å®é™…é¡¹ç›®æŠ€æœ¯æ ˆåˆ†æ** - åŸºäºpackage.jsonå’Œè¿è¡ŒçŠ¶æ€éªŒè¯
   - æ ¸å¿ƒæœåŠ¡ç»„ä»¶ï¼šNode.js + Express + MySQL + Sequelize + WebSocket + JWTï¼ˆâœ…è¿è¡ŒéªŒè¯é€šè¿‡ï¼‰
   - å®‰å…¨é˜²æŠ¤ç»„ä»¶ï¼šHelmet + CORS + é™æµ + åŠ å¯†ï¼ˆâœ…ä¸­é—´ä»¶åŠ è½½å®Œæˆï¼‰
   - æ–‡ä»¶æœåŠ¡ç»„ä»¶ï¼šMulter + Sharp + AWS-SDK(Sealos) + Axiosï¼ˆâœ…å­˜å‚¨æœåŠ¡å°±ç»ªï¼‰
   - å¼€å‘ç›‘æ§ç»„ä»¶ï¼šNodemon + å¥åº·æ£€æŸ¥ + UUID + é”™è¯¯å¤„ç†ï¼ˆâœ…ç›‘æ§æ­£å¸¸ï¼‰

2. **âœ… å®é™…æœåŠ¡æ¶æ„è§„èŒƒ** - åŸºäºapp.jsæ·±åº¦åˆ†æï¼ˆ284è¡Œï¼‰
   - å…¥å£å±‚ï¼šExpressåº”ç”¨åˆå§‹åŒ–ã€ä¸­é—´ä»¶é…ç½®ã€è·¯ç”±æ³¨å†Œ
   - è·¯ç”±å±‚ï¼š6ä¸ªæ ¸å¿ƒæ¨¡å—ï¼ˆauth.js 377è¡Œ/lottery.js 264è¡Œ/exchange.js 353è¡Œ/user.js 237è¡Œ/photo.js 331è¡Œ/merchant.js 545è¡Œï¼‰
   - æœåŠ¡å±‚ï¼š3ä¸ªä¸šåŠ¡æœåŠ¡ï¼ˆlotteryService.js 547è¡Œ/websocket.js 312è¡Œ/sealosStorage.js 303è¡Œï¼‰
   - æ•°æ®å±‚ï¼š6ä¸ªæ•°æ®æ¨¡å‹ï¼ˆUser.js 188è¡Œç­‰ï¼‰
   - ä¸­é—´ä»¶å±‚ï¼šJWTè®¤è¯å’Œé”™è¯¯å¤„ç†

3. **âœ… APIè®¾è®¡è§„èŒƒ** - åŸºäºå®é™…è·¯ç”±æ–‡ä»¶åˆ†æ
   - 6ä¸ªæ ¸å¿ƒAPIæ¨¡å—çš„å®Œæ•´ç«¯ç‚¹å®šä¹‰ï¼ˆ30+ä¸ªæ¥å£ï¼‰
   - ç»Ÿä¸€å“åº”æ ¼å¼è§„èŒƒï¼ˆæˆåŠŸ/é”™è¯¯/å¾®ä¿¡å°ç¨‹åºé€‚é…ï¼‰
   - JWTè®¤è¯æœºåˆ¶æ ‡å‡†ï¼ˆTokenç”Ÿæˆã€éªŒè¯ã€åˆ·æ–°ï¼‰
   - è¯·æ±‚é™æµå’Œå®‰å…¨é…ç½®ï¼ˆå¼€å‘1000æ¬¡/ç”Ÿäº§100æ¬¡ï¼‰

4. **âœ… æ•°æ®è®¿é—®è§„èŒƒ** - åŸºäºSequelize ORM v6.35.1
   - æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼ˆmax:10, timeout:30sï¼‰
   - 6ä¸ªæ ¸å¿ƒæ¨¡å‹å®šä¹‰å’Œå…³è”å…³ç³»
   - äº‹åŠ¡å¤„ç†è§„èŒƒï¼ˆç§¯åˆ†å˜æ›´å®‰å…¨ä¿è¯ï¼‰
   - æ•°æ®åº“å¥åº·æ£€æŸ¥æœºåˆ¶

5. **âœ… WebSocketå®æ—¶é€šä¿¡è§„èŒƒ** - åŸºäºservices/websocket.jsï¼ˆ312è¡Œï¼‰
   - WebSocketæœåŠ¡æ¶æ„æ ‡å‡†ï¼ˆè·¯å¾„/wsï¼Œè¿æ¥ç®¡ç†ï¼‰
   - 4ç§æ¶ˆæ¯ç±»å‹è§„èŒƒï¼ˆç§¯åˆ†æ›´æ–°/æŠ½å¥–ç»“æœ/å®¡æ ¸çŠ¶æ€/åº“å­˜å˜æ›´ï¼‰
   - ç”¨æˆ·è¿æ¥æ˜ å°„å’ŒçŠ¶æ€ç®¡ç†
   - å¾®ä¿¡å°ç¨‹åºWebSocketé€‚é…ï¼ˆwssåè®®å¼ºåˆ¶ï¼‰

6. **âœ… å¾®ä¿¡å°ç¨‹åºå…¼å®¹æ€§è§„èŒƒ** - ä¸“ä¸šå°ç¨‹åºåç«¯é€‚é…
   - 4ç§åŸŸåé…ç½®è¦æ±‚ï¼ˆrequest/socket/upload/downloadï¼‰
   - ç½‘ç»œè¯·æ±‚é€‚é…ï¼ˆHTTPSå¼ºåˆ¶/CORS/è¶…æ—¶30sï¼‰
   - WebSocketè¿æ¥é€‚é…ï¼ˆwssåè®®/Tokenè®¤è¯/é‡è¿ç­–ç•¥ï¼‰
   - æ–‡ä»¶ä¸Šä¼ é€‚é…ï¼ˆ5MBé™åˆ¶/å›¾ç‰‡æ ¼å¼éªŒè¯ï¼‰å’Œé”™è¯¯å¤„ç†

7. **âœ… éƒ¨ç½²è¿ç»´è§„èŒƒ** - ç”Ÿäº§ç¯å¢ƒæ ‡å‡†
   - ç¯å¢ƒå˜é‡é…ç½®æ¸…å•ï¼ˆæ•°æ®åº“/JWT/å­˜å‚¨/å®‰å…¨å¯†é’¥ï¼‰
   - PM2è¿›ç¨‹ç®¡ç†é…ç½®ï¼ˆé›†ç¾¤æ¨¡å¼/å†…å­˜é™åˆ¶500Mï¼‰
   - å¥åº·æ£€æŸ¥é…ç½®ï¼ˆ30ç§’é—´éš”/3æ¬¡å¤±è´¥å‘Šè­¦ï¼‰
   - ç›‘æ§å‘Šè­¦è§„èŒƒï¼ˆå“åº”æ—¶é—´<200ms/å¯ç”¨æ€§99.9%ï¼‰

### ğŸ¯ é¡¹ç›®è¿è¡ŒçŠ¶æ€éªŒè¯ï¼ˆå®æ—¶éªŒè¯ 2025-07-02 00:22ï¼‰

- **âœ… Node.jsæœåŠ¡è¿è¡Œæ­£å¸¸** - è¿›ç¨‹PID 20327ï¼Œå†…å­˜ä½¿ç”¨æ­£å¸¸
- **âœ… HTTPæœåŠ¡ç›‘å¬æ­£å¸¸** - ç«¯å£3000å“åº”æ­£å¸¸ï¼Œå¥åº·æ£€æŸ¥é€šè¿‡
- **âœ… æ•°æ®åº“è¿æ¥å¥åº·** - MySQLè¿æ¥çŠ¶æ€okï¼Œ6ä¸ªæ ¸å¿ƒè¡¨è¿è¡Œä¸­
- **âœ… WebSocketæœåŠ¡è¿è¡Œ** - å®æ—¶é€šä¿¡æœåŠ¡æ­£å¸¸ï¼Œå½“å‰0è¿æ¥
- **âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯** - 5ä¸ªç”¨æˆ·ã€5ä¸ªå•†å“ã€8ä¸ªå¥–å“æ•°æ®å®Œæ•´
- **âœ… å®‰å…¨ç»„ä»¶ç”Ÿæ•ˆ** - JWTè®¤è¯ã€CORSã€é™æµã€å®‰å…¨å¤´å…¨éƒ¨ç”Ÿæ•ˆ

### ğŸ“Š æ–‡æ¡£ç‰¹ç‚¹æ€»ç»“

- **ğŸ”´ åŸºäºå®é™…ä»£ç ** - æ‰€æœ‰è§„èŒƒéƒ½åŸºäºçœŸå®çš„é¡¹ç›®ä»£ç åˆ†æï¼ŒåŒ…å«å…·ä½“è¡Œæ•°
- **ğŸ”´ è¿è¡ŒçŠ¶æ€éªŒè¯** - æŠ€æœ¯æ ˆå’Œé…ç½®éƒ½ç»è¿‡å®é™…è¿è¡ŒéªŒè¯ï¼Œå®æ—¶å¥åº·æ£€æŸ¥
- **ğŸ”´ å¾®ä¿¡å°ç¨‹åºé€‚é…** - ä¸“é—¨é’ˆå¯¹å°ç¨‹åºåç«¯çš„é€‚é…è§„èŒƒï¼ŒåŒ…å«åŸŸåé…ç½®
- **ğŸ”´ WebSocketå®æ—¶é€šä¿¡** - å®Œæ•´çš„å®æ—¶æ•°æ®åŒæ­¥æ–¹æ¡ˆï¼Œ4ç§æ¶ˆæ¯ç±»å‹
- **ğŸ”´ ç”Ÿäº§çº§æ ‡å‡†** - æä¾›ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å’Œç›‘æ§æ ‡å‡†ï¼ŒPM2é›†ç¾¤é…ç½®
- **ğŸ”´ å‰åç«¯å¯¹æ¥** - å®Œæ•´çš„æ¥å£è§„èŒƒå’Œæ•°æ®æ ¼å¼å®šä¹‰ï¼Œç»Ÿä¸€å“åº”æ ¼å¼

### ğŸ”— å…³è”æ–‡æ¡£é“¾æ¥

- **æ¥å£å¯¹æ¥è§„èŒƒæ–‡æ¡£æ ‡å‡†.md** - APIæ¥å£è¯¦ç»†è¯´æ˜å’Œå¯¹æ¥è§„èŒƒ
- **æ•°æ®åº“è®¾è®¡è§„èŒƒæ–‡æ¡£æ ‡å‡†.md** - æ•°æ®åº“è¡¨ç»“æ„å’Œå­—æ®µæ˜ å°„è§„èŒƒ
- **äº§å“åŠŸèƒ½ç»“æ„æè¿°.md** - ä¸šåŠ¡åŠŸèƒ½å’Œäº§å“é€»è¾‘è¯´æ˜

**ä½¿ç”¨æ¨¡å‹**: Claude Sonnet 4  
**å®Œæˆæ—¶é—´**: 2025å¹´07æœˆ02æ—¥ 00:23  
**é¡¹ç›®çŠ¶æ€**: å¥åº·è¿è¡Œä¸­ âœ…  
**æŠ€æœ¯éªŒè¯**: å…¨éƒ¨é€šè¿‡ âœ…

---

## ğŸ“± åäºŒã€å¾®ä¿¡å°ç¨‹åºå…¼å®¹æ€§è§„èŒƒï¼ˆä¸“é¡¹ï¼‰

### 12.1 å¾®ä¿¡å°ç¨‹åºåç«¯é€‚é…æ ‡å‡†

#### 12.1.1 åŸŸåé…ç½®è¦æ±‚
```javascript
// ğŸ”´ å¾®ä¿¡å°ç¨‹åºåå°å¿…é¡»é…ç½®çš„åŸŸåç™½åå•
const WECHAT_MINIPROGRAM_DOMAINS = {
  
  // requeståˆæ³•åŸŸåï¼ˆAPIè¯·æ±‚ï¼‰
  requestDomains: [
            'https://gynjeecyhgvo.sealoshzh.site',  // ä¸»åŸŸå
    'https://api.yourdomain.com'            // APIå­åŸŸåï¼ˆå¯é€‰ï¼‰
  ],
  
  // socketåˆæ³•åŸŸåï¼ˆWebSocketè¿æ¥ï¼‰
  socketDomains: [
            'wss://gynjeecyhgvo.sealoshzh.site'     // ğŸ”´ å¿…é¡»ä½¿ç”¨wss://åè®®
  ],
  
  // uploadFileåˆæ³•åŸŸåï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰
  uploadDomains: [
            'https://gynjeecyhgvo.sealoshzh.site'   // å›¾ç‰‡ä¸Šä¼ API
  ],
  
  // downloadFileåˆæ³•åŸŸåï¼ˆæ–‡ä»¶ä¸‹è½½ï¼‰
  downloadDomains: [
            'https://gynjeecyhgvo.sealoshzh.site',  // é™æ€èµ„æº
    'https://sealos.storage.com'            // Sealoså­˜å‚¨åŸŸå
  ]
}
```

#### 12.1.2 ç½‘ç»œè¯·æ±‚é€‚é…
```javascript
// ğŸ”´ å°ç¨‹åºç½‘ç»œè¯·æ±‚åç«¯é€‚é…é…ç½®
const MINIPROGRAM_NETWORK_CONFIG = {
  
  // HTTPSå¼ºåˆ¶è¦æ±‚
  https: {
    required: true,
    certificateValidation: true,
    minTLSVersion: 'TLSv1.2',
    note: 'å°ç¨‹åºåªæ”¯æŒHTTPSè¯·æ±‚ï¼Œå¼€å‘ç¯å¢ƒå¯ä¸´æ—¶ä½¿ç”¨HTTP'
  },
  
  // CORSé…ç½®
  cors: {
    origin: 'https://servicewechat.com',
    credentials: true,
    allowedMethods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: [
      'Content-Type',
      'Authorization',
      'X-Requested-With'
    ]
  },
  
  // è¯·æ±‚è¶…æ—¶é€‚é…
  timeout: {
    default: 10000,        // é»˜è®¤10ç§’è¶…æ—¶
    upload: 30000,         // ä¸Šä¼ 30ç§’è¶…æ—¶
    download: 60000        // ä¸‹è½½60ç§’è¶…æ—¶
  },
  
  // è¯·æ±‚å¤§å°é™åˆ¶
  limits: {
    requestBody: '10MB',   // è¯·æ±‚ä½“å¤§å°é™åˆ¶
    imageUpload: '5MB',    // å›¾ç‰‡ä¸Šä¼ å¤§å°é™åˆ¶
    responseBody: '50MB'   // å“åº”ä½“å¤§å°é™åˆ¶
  }
}
```

### 12.2 WebSocketå°ç¨‹åºé€‚é…

#### 12.2.1 WebSocketè¿æ¥é…ç½®
```javascript
// ğŸ”´ åŸºäºservices/websocket.jsçš„å°ç¨‹åºWebSocketé€‚é…
const MINIPROGRAM_WEBSOCKET_CONFIG = {
  
  // è¿æ¥åœ°å€é…ç½®
  connection: {
          url: 'wss://gynjeecyhgvo.sealoshzh.site/ws',
    protocols: [],
    timeout: 10000,
    note: 'å°ç¨‹åºWebSocketå¿…é¡»ä½¿ç”¨wss://åè®®'
  },
  
  // Tokenè®¤è¯é€‚é…
  authentication: {
    method: 'query_parameter',
    parameter: 'token',
    example: 'wss://domain.com/ws?token=eyJhbGciOiJIUzI1NiIs...',
    validation: 'JWT TokenéªŒè¯'
  },
  
  // å¿ƒè·³æœºåˆ¶
  heartbeat: {
    interval: 30000,       // 30ç§’å¿ƒè·³
    type: 'ping',
    autoResponse: 'pong',
    maxMissed: 3,          // æœ€å¤§ä¸¢å¤±3æ¬¡å¿ƒè·³
    reconnectDelay: 1000   // é‡è¿å»¶è¿Ÿ1ç§’
  },
  
  // æ¶ˆæ¯æ ¼å¼
  messageFormat: {
    send: {
      type: 'string',      // æ¶ˆæ¯ç±»å‹
      data: 'object',      // æ¶ˆæ¯æ•°æ®
      timestamp: 'number'  // æ—¶é—´æˆ³
    },
    receive: {
      type: 'string',      // æ¶ˆæ¯ç±»å‹
      data: 'object',      // æ¶ˆæ¯æ•°æ®
      timestamp: 'string'  // ISOæ ¼å¼æ—¶é—´
    }
  }
}
```

#### 12.2.2 å°ç¨‹åºç«¯WebSocketå¤„ç†
```javascript
// ğŸ”´ å°ç¨‹åºç«¯WebSocketè¿æ¥ç¤ºä¾‹
const MiniprogramWebSocketHandler = {
  
  // è¿æ¥å»ºç«‹
  connect: function(token) {
    const socketUrl = `wss://gynjeecyhgvo.sealoshzh.site/ws?token=${token}`;
    
    this.socketTask = wx.connectSocket({
      url: socketUrl,
      protocols: [],
      timeout: 10000,
      success: (res) => {
        console.log('WebSocketè¿æ¥æˆåŠŸ', res);
      },
      fail: (err) => {
        console.error('WebSocketè¿æ¥å¤±è´¥', err);
        this.reconnect();
      }
    });
    
    this.bindEvents();
  },
  
  // äº‹ä»¶ç»‘å®š
  bindEvents: function() {
    // è¿æ¥æ‰“å¼€
    this.socketTask.onOpen(() => {
      console.log('WebSocketè¿æ¥å·²æ‰“å¼€');
      this.startHeartbeat();
    });
    
    // æ¥æ”¶æ¶ˆæ¯
    this.socketTask.onMessage((res) => {
      const message = JSON.parse(res.data);
      this.handleMessage(message);
    });
    
    // è¿æ¥å…³é—­
    this.socketTask.onClose(() => {
      console.log('WebSocketè¿æ¥å·²å…³é—­');
      this.stopHeartbeat();
      this.reconnect();
    });
    
    // è¿æ¥é”™è¯¯
    this.socketTask.onError((err) => {
      console.error('WebSocketè¿æ¥é”™è¯¯', err);
    });
  },
  
  // å¿ƒè·³æœºåˆ¶
  startHeartbeat: function() {
    this.heartbeatTimer = setInterval(() => {
      this.send({
        type: 'ping',
        data: { timestamp: Date.now() }
      });
    }, 30000);
  },
  
  // å‘é€æ¶ˆæ¯
  send: function(message) {
    if (this.socketTask) {
      this.socketTask.send({
        data: JSON.stringify(message),
        success: () => {
          console.log('æ¶ˆæ¯å‘é€æˆåŠŸ', message);
        },
        fail: (err) => {
          console.error('æ¶ˆæ¯å‘é€å¤±è´¥', err);
        }
      });
    }
  }
}
```

### 12.3 æ–‡ä»¶ä¸Šä¼ å°ç¨‹åºé€‚é…

#### 12.3.1 å›¾ç‰‡ä¸Šä¼ é€‚é…
```javascript
// ğŸ”´ å°ç¨‹åºå›¾ç‰‡ä¸Šä¼ åç«¯é€‚é…
const MINIPROGRAM_UPLOAD_CONFIG = {
  
  // ä¸Šä¼ é…ç½®
  upload: {
    endpoint: 'POST /api/photo/upload',
    method: 'multipart/form-data',
    maxSize: 5 * 1024 * 1024,  // 5MB
    allowedTypes: ['image/jpeg', 'image/png', 'image/gif'],
    compression: {
      quality: 0.8,
      maxWidth: 1920,
      maxHeight: 1080
    }
  },
  
  // å°ç¨‹åºç«¯ä¸Šä¼ ç¤ºä¾‹
  miniprogramUpload: {
    chooseImage: 'wx.chooseImage()',
    uploadFile: 'wx.uploadFile()',
    headers: {
      'Authorization': 'Bearer ${token}',
      'Content-Type': 'multipart/form-data'
    },
    formData: {
      'amount': 'number',    // æ¶ˆè´¹é‡‘é¢
      'description': 'string' // æ¶ˆè´¹æè¿°
    }
  },
  
  // å“åº”æ ¼å¼
  response: {
    success: {
      code: 0,
      msg: 'success',
      data: {
        upload_id: 'string',
        image_url: 'string',
        file_size: 'number',
        points_awarded: 'number'
      }
    },
    error: {
      code: 'number',
      msg: 'string',
      data: null
    }
  }
}
```

### 12.4 å°ç¨‹åºé”™è¯¯å¤„ç†è§„èŒƒ

#### 12.4.1 ç½‘ç»œé”™è¯¯å¤„ç†
```javascript
// ğŸ”´ å°ç¨‹åºç½‘ç»œé”™è¯¯å¤„ç†æ ‡å‡†
const MINIPROGRAM_ERROR_HANDLING = {
  
  // ç½‘ç»œé”™è¯¯åˆ†ç±»
  networkErrors: {
    timeout: {
      code: 'TIMEOUT',
      message: 'ç½‘ç»œè¯·æ±‚è¶…æ—¶',
      solution: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'
    },
    ssl: {
      code: 'SSL_ERROR',
      message: 'SSLè¯ä¹¦éªŒè¯å¤±è´¥',
      solution: 'è¯·æ£€æŸ¥åŸŸåé…ç½®å’Œè¯ä¹¦æœ‰æ•ˆæ€§'
    },
    cors: {
      code: 'CORS_ERROR',
      message: 'è·¨åŸŸè¯·æ±‚è¢«æ‹’ç»',
      solution: 'è¯·æ£€æŸ¥åç«¯CORSé…ç½®'
    },
    domain: {
      code: 'DOMAIN_ERROR',
      message: 'åŸŸåä¸åœ¨ç™½åå•ä¸­',
      solution: 'è¯·åœ¨å°ç¨‹åºåå°æ·»åŠ åŸŸååˆ°ç™½åå•'
    }
  },
  
  // é”™è¯¯å¤„ç†æµç¨‹
  errorHandler: {
    capture: 'wx.onError()',
    report: 'é”™è¯¯ä¸ŠæŠ¥æœºåˆ¶',
    retry: 'è‡ªåŠ¨é‡è¯•æœºåˆ¶',
    fallback: 'é™çº§å¤„ç†æ–¹æ¡ˆ'
  },
  
  // ç”¨æˆ·æç¤º
  userFeedback: {
    loading: 'wx.showLoading()',
    success: 'wx.showToast()',
    error: 'wx.showModal()',
    network: 'ç½‘ç»œå¼‚å¸¸æç¤º'
  }
}
```

### 12.5 å°ç¨‹åºæ€§èƒ½ä¼˜åŒ–

#### 12.5.1 è¯·æ±‚ä¼˜åŒ–ç­–ç•¥
```javascript
// ğŸ”´ å°ç¨‹åºè¯·æ±‚æ€§èƒ½ä¼˜åŒ–
const MINIPROGRAM_PERFORMANCE_CONFIG = {
  
  // è¯·æ±‚ç¼“å­˜
  cache: {
    userInfo: 300,         // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜5åˆ†é’Ÿ
    lotteryConfig: 60,     // æŠ½å¥–é…ç½®ç¼“å­˜1åˆ†é’Ÿ
    productList: 180,      // å•†å“åˆ—è¡¨ç¼“å­˜3åˆ†é’Ÿ
    statistics: 600        // ç»Ÿè®¡æ•°æ®ç¼“å­˜10åˆ†é’Ÿ
  },
  
  // æ•°æ®é¢„åŠ è½½
  preload: {
    userInfo: 'å°ç¨‹åºå¯åŠ¨æ—¶é¢„åŠ è½½',
    lotteryConfig: 'è¿›å…¥æŠ½å¥–é¡µé¢å‰é¢„åŠ è½½',
    productList: 'è¿›å…¥å•†å“é¡µé¢å‰é¢„åŠ è½½'
  },
  
  // å›¾ç‰‡ä¼˜åŒ–
  imageOptimization: {
    lazyLoad: true,        // å›¾ç‰‡æ‡’åŠ è½½
    compression: 0.8,      // å‹ç¼©è´¨é‡
    webp: true,           // WebPæ ¼å¼æ”¯æŒ
    cdn: 'Sealoså­˜å‚¨CDN'   // CDNåŠ é€Ÿ
  },
  
  // ä»£ç ä¼˜åŒ–
  codeOptimization: {
    subpackages: 'åˆ†åŒ…åŠ è½½',
    onDemand: 'æŒ‰éœ€åŠ è½½',
    treeShaking: 'ä»£ç åˆ†å‰²',
    minification: 'ä»£ç å‹ç¼©'
  }
}
```

### 12.6 å°ç¨‹åºå…¼å®¹æ€§æµ‹è¯•æ¸…å•

#### 12.6.1 æµ‹è¯•éªŒè¯é¡¹ç›®
```javascript
// ğŸ”´ å°ç¨‹åºå…¼å®¹æ€§æµ‹è¯•æ¸…å•
const MINIPROGRAM_TEST_CHECKLIST = {
  
  // ç½‘ç»œè¯·æ±‚æµ‹è¯•
  networkTests: [
    'âœ… HTTPS APIè¯·æ±‚æµ‹è¯•',
    'âœ… WebSocket wss://è¿æ¥æµ‹è¯•',
    'âœ… æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æµ‹è¯•',
    'âœ… å›¾ç‰‡ä¸‹è½½æ˜¾ç¤ºæµ‹è¯•',
    'âœ… ç½‘ç»œè¶…æ—¶å¤„ç†æµ‹è¯•',
    'âœ… ç½‘ç»œé”™è¯¯é‡è¯•æµ‹è¯•'
  ],
  
  // åŸŸåé…ç½®æµ‹è¯•
  domainTests: [
    'âœ… requeståŸŸåç™½åå•éªŒè¯',
    'âœ… socketåŸŸåç™½åå•éªŒè¯',
    'âœ… uploadåŸŸåç™½åå•éªŒè¯',
    'âœ… downloadåŸŸåç™½åå•éªŒè¯'
  ],
  
  // åŠŸèƒ½å…¼å®¹æ€§æµ‹è¯•
  functionalTests: [
    'âœ… ç”¨æˆ·ç™»å½•è®¤è¯æµ‹è¯•',
    'âœ… ç§¯åˆ†æŠ½å¥–åŠŸèƒ½æµ‹è¯•',
    'âœ… å•†å“å…‘æ¢åŠŸèƒ½æµ‹è¯•',
    'âœ… æ‹ç…§ä¸Šä¼ åŠŸèƒ½æµ‹è¯•',
    'âœ… å®æ—¶æ¶ˆæ¯æ¨é€æµ‹è¯•',
    'âœ… æƒé™æ§åˆ¶æµ‹è¯•'
  ],
  
  // æ€§èƒ½æµ‹è¯•
  performanceTests: [
    'âœ… é¡µé¢åŠ è½½é€Ÿåº¦æµ‹è¯•',
    'âœ… å›¾ç‰‡åŠ è½½ä¼˜åŒ–æµ‹è¯•',
    'âœ… å†…å­˜ä½¿ç”¨ç›‘æ§æµ‹è¯•',
    'âœ… ç½‘ç»œè¯·æ±‚ä¼˜åŒ–æµ‹è¯•'
  ]
}
```

---

## ğŸ¯ å¾®ä¿¡å°ç¨‹åºå…¼å®¹æ€§è§„èŒƒæ€»ç»“

### âœ… æ ¸å¿ƒå…¼å®¹æ€§è¦æ±‚
1. **å¼ºåˆ¶HTTPS** - æ‰€æœ‰APIè¯·æ±‚å¿…é¡»ä½¿ç”¨HTTPSåè®®
2. **åŸŸåç™½åå•** - å››ç±»åŸŸåå¿…é¡»åœ¨å°ç¨‹åºåå°é…ç½®
3. **WebSocket wss://** - å®æ—¶é€šä¿¡å¿…é¡»ä½¿ç”¨åŠ å¯†åè®®
4. **æ–‡ä»¶ä¸Šä¼ é™åˆ¶** - å›¾ç‰‡å¤§å°ä¸è¶…è¿‡5MBï¼Œæ”¯æŒä¸»æµæ ¼å¼
5. **ç½‘ç»œè¶…æ—¶å¤„ç†** - è¯·æ±‚è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
6. **é”™è¯¯å¤„ç†æœºåˆ¶** - å®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œç”¨æˆ·æç¤º

### ğŸ”§ åç«¯é€‚é…é‡ç‚¹
1. **CORSé…ç½®** - æ”¯æŒå¾®ä¿¡å°ç¨‹åºçš„è·¨åŸŸè¯·æ±‚
2. **WebSocketè·¯å¾„** - æ˜ç¡®é…ç½®/wsè·¯å¾„å’ŒTokenè®¤è¯
3. **å“åº”æ ¼å¼** - ç»Ÿä¸€çš„code/msg/dataå“åº”æ ¼å¼
4. **å®‰å…¨é…ç½®** - SSLè¯ä¹¦å’ŒHTTPSå¼ºåˆ¶é‡å®šå‘
5. **æ€§èƒ½ä¼˜åŒ–** - è¯·æ±‚ç¼“å­˜å’Œæ•°æ®é¢„åŠ è½½æ”¯æŒ

### ğŸ“‹ è¿ç»´éƒ¨ç½²è¦æ±‚
1. **SSLè¯ä¹¦** - æœ‰æ•ˆçš„HTTPSè¯ä¹¦é…ç½®
2. **åŸŸåè§£æ** - æ­£ç¡®çš„åŸŸåè§£æå’Œè´Ÿè½½å‡è¡¡
3. **é˜²ç«å¢™é…ç½®** - WebSocketç«¯å£å’ŒHTTPç«¯å£å¼€æ”¾
4. **ç›‘æ§å‘Šè­¦** - å°ç¨‹åºè¯·æ±‚æˆåŠŸç‡å’Œå“åº”æ—¶é—´ç›‘æ§
5. **æ—¥å¿—åˆ†æ** - å°ç¨‹åºç«¯é”™è¯¯æ—¥å¿—æ”¶é›†å’Œåˆ†æ

**ä¸“é¡¹è§„èŒƒå®šä½**ï¼šå¾®ä¿¡å°ç¨‹åºåç«¯å…¼å®¹æ€§æŠ€æœ¯æ ‡å‡†  
**é€‚ç”¨èŒƒå›´**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿå°ç¨‹åºç«¯å¯¹æ¥  
**æ›´æ–°ç­–ç•¥**ï¼šéšå¾®ä¿¡å°ç¨‹åºå¹³å°æ›´æ–°åŠæ—¶è°ƒæ•´è§„èŒƒ