<!-- pages/exchange/exchange.wxml - å•†å“å…‘æ¢é¡µé¢æ¨¡æ¿ -->
<view class="exchange-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="user-info">
      <text class="welcome">ğŸ å•†å“å…‘æ¢</text>
      <view class="points-info">
        <text class="points-label">å¯ç”¨ç§¯åˆ†ï¼š</text>
        <text class="points-value">{{totalPoints}}</text>
      </view>
    </view>
    
    <!-- æœç´¢å’Œç­›é€‰åŠŸèƒ½ -->
    <view class="search-filter">
      <view class="search-box">
        <input 
          class="search-input" 
          placeholder="æœç´¢å•†å“åç§°..." 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
        />
        <text class="search-icon">ğŸ”</text>
      </view>
      
      <view class="filter-buttons">
        <button 
          class="filter-btn {{currentFilter === 'all' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-filter="all"
        >
          å…¨éƒ¨
        </button>
        <button 
          class="filter-btn {{currentFilter === 'available' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-filter="available"
        >
          å¯å…‘æ¢
        </button>
        <button 
          class="filter-btn {{currentFilter === 'low-price' ? 'active' : ''}}"
          bindtap="onFilterChange"
          data-filter="low-price"
        >
          ä½ç§¯åˆ†
        </button>
        <button 
          class="advanced-filter-btn {{showAdvancedFilter ? 'active' : ''}}"
          bindtap="onToggleAdvancedFilter"
        >
          é«˜çº§ç­›é€‰ {{showAdvancedFilter ? 'ğŸ”¼' : 'ğŸ”½'}}
        </button>
      </view>
      
      <!-- é«˜çº§ç­›é€‰é¢æ¿ -->
      <view class="advanced-filter-panel" wx:if="{{showAdvancedFilter}}">
        <!-- åˆ†ç±»ç­›é€‰ -->
        <view class="filter-row">
          <text class="filter-label">å•†å“åˆ†ç±»</text>
          <view class="filter-options">
            <button 
              class="option-btn {{categoryFilter === 'all' ? 'active' : ''}}"
              bindtap="onCategoryFilterChange"
              data-category="all"
            >å…¨éƒ¨</button>
            <button 
              class="option-btn {{categoryFilter === 'ä¼˜æƒ åˆ¸' ? 'active' : ''}}"
              bindtap="onCategoryFilterChange"
              data-category="ä¼˜æƒ åˆ¸"
            >ä¼˜æƒ åˆ¸</button>
            <button 
              class="option-btn {{categoryFilter === 'å®ç‰©å•†å“' ? 'active' : ''}}"
              bindtap="onCategoryFilterChange"
              data-category="å®ç‰©å•†å“"
            >å®ç‰©å•†å“</button>
            <button 
              class="option-btn {{categoryFilter === 'è™šæ‹Ÿç‰©å“' ? 'active' : ''}}"
              bindtap="onCategoryFilterChange"
              data-category="è™šæ‹Ÿç‰©å“"
            >è™šæ‹Ÿç‰©å“</button>
          </view>
        </view>
        
        <!-- ç§¯åˆ†èŒƒå›´ç­›é€‰ -->
        <view class="filter-row">
          <text class="filter-label">ç§¯åˆ†èŒƒå›´</text>
          <view class="filter-options">
            <button 
              class="option-btn {{pointsRange === 'all' ? 'active' : ''}}"
              bindtap="onPointsRangeChange"
              data-range="all"
            >å…¨éƒ¨</button>
            <button 
              class="option-btn {{pointsRange === '0-500' ? 'active' : ''}}"
              bindtap="onPointsRangeChange"
              data-range="0-500"
            >0-500åˆ†</button>
            <button 
              class="option-btn {{pointsRange === '500-1000' ? 'active' : ''}}"
              bindtap="onPointsRangeChange"
              data-range="500-1000"
            >500-1000åˆ†</button>
            <button 
              class="option-btn {{pointsRange === '1000-2000' ? 'active' : ''}}"
              bindtap="onPointsRangeChange"
              data-range="1000-2000"
            >1000-2000åˆ†</button>
            <button 
              class="option-btn {{pointsRange === '2000+' ? 'active' : ''}}"
              bindtap="onPointsRangeChange"
              data-range="2000+"
            >2000åˆ†ä»¥ä¸Š</button>
          </view>
        </view>
        
        <!-- åº“å­˜çŠ¶æ€ç­›é€‰ -->
        <view class="filter-row">
          <text class="filter-label">åº“å­˜çŠ¶æ€</text>
          <view class="filter-options">
            <button 
              class="option-btn {{stockFilter === 'all' ? 'active' : ''}}"
              bindtap="onStockFilterChange"
              data-filter="all"
            >å…¨éƒ¨</button>
            <button 
              class="option-btn {{stockFilter === 'in-stock' ? 'active' : ''}}"
              bindtap="onStockFilterChange"
              data-filter="in-stock"
            >åº“å­˜å……è¶³</button>
            <button 
              class="option-btn {{stockFilter === 'low-stock' ? 'active' : ''}}"
              bindtap="onStockFilterChange"
              data-filter="low-stock"
            >åº“å­˜ç´§å¼ </button>
          </view>
        </view>
        
        <!-- æ’åºæ–¹å¼ -->
        <view class="filter-row">
          <text class="filter-label">æ’åºæ–¹å¼</text>
          <view class="filter-options">
            <button 
              class="option-btn {{sortBy === 'default' ? 'active' : ''}}"
              bindtap="onSortByChange"
              data-sort="default"
            >é»˜è®¤</button>
            <button 
              class="option-btn {{sortBy === 'points-asc' ? 'active' : ''}}"
              bindtap="onSortByChange"
              data-sort="points-asc"
            >ç§¯åˆ†å‡åº</button>
            <button 
              class="option-btn {{sortBy === 'points-desc' ? 'active' : ''}}"
              bindtap="onSortByChange"
              data-sort="points-desc"
            >ç§¯åˆ†é™åº</button>
            <button 
              class="option-btn {{sortBy === 'rating-desc' ? 'active' : ''}}"
              bindtap="onSortByChange"
              data-sort="rating-desc"
            >è¯„åˆ†é™åº</button>
            <button 
              class="option-btn {{sortBy === 'stock-desc' ? 'active' : ''}}"
              bindtap="onSortByChange"
              data-sort="stock-desc"
            >åº“å­˜é™åº</button>
          </view>
        </view>
        
        <!-- ç­›é€‰æ“ä½œ -->
        <view class="filter-actions">
          <button class="reset-btn" bindtap="onResetFilters">é‡ç½®ç­›é€‰</button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- å•†å“ç½‘æ ¼ -->
  <view class="products-section" wx:else>
    <view class="section-title">
      <text>ğŸ“¦ {{currentFilter === 'all' ? 'å…¨éƒ¨å•†å“' : (currentFilter === 'available' ? 'å¯å…‘æ¢å•†å“' : 'ä½ç§¯åˆ†å•†å“')}} ({{filteredProducts.length}}/{{products.length}})</text>
      <text class="tips">æŒ‰ç§¯åˆ†æ’åº â€¢ å®æ—¶åº“å­˜åŒæ­¥ â€¢ è°ƒè¯•æ¨¡å¼ï¼šå·²åŠ è½½{{products.length}}ä¸ªå•†å“</text>
    </view>

    <!-- ğŸ”§ è°ƒè¯•ä¿¡æ¯é¢æ¿ - å¸®åŠ©æ’æŸ¥æ˜¾ç¤ºé—®é¢˜ -->
    <view class="debug-info" wx:if="{{products.length > 0}}">
      <text class="debug-text">âœ… å•†å“æ•°æ®æ­£å¸¸ | åŸå§‹æ•°æ®: {{products.length}}ä¸ª | ç­›é€‰å: {{filteredProducts.length}}ä¸ª</text>
    </view>
    <view class="debug-info error" wx:elif="{{!loading}}">
      <text class="debug-text">âš ï¸ æ— å•†å“æ•°æ® | æ£€æŸ¥åç«¯APIè¿”å›</text>
    </view>

    <!-- ä¼˜åŒ–çš„å•†å“ç½‘æ ¼å¸ƒå±€ -->
    <view class="products-grid">
      <view 
        class="product-item {{item.stock <= 0 ? 'sold-out' : ''}} {{totalPoints < item.exchange_points ? 'insufficient-points' : ''}}"
        wx:for="{{filteredProducts}}" 
        wx:key="id"
        bindtap="onProductTap"
        data-product="{{item}}"
      >
        <!-- å•†å“å›¾ç‰‡ -->
        <view class="product-image-container">
          <image 
            class="product-image" 
            src="{{item.image}}" 
            mode="aspectFill"
            bindtap="onPreviewImage"
            binderror="onImageError"
            data-url="{{item.image}}"
            data-index="{{index}}"
          />
          
          <!-- çƒ­é—¨æ ‡ç­¾ -->
          <view class="hot-badge" wx:if="{{item.is_hot}}">
            ğŸ”¥ çƒ­é—¨
          </view>
          
          <!-- åº“å­˜æ ‡ç­¾ -->
          <view class="stock-badge {{item.stock <= 5 ? 'low-stock' : ''}}">
            å‰©ä½™{{item.stock}}
          </view>
          
          <!-- å”®ç½„é®ç½© -->
          <view class="sold-out-overlay" wx:if="{{item.stock <= 0}}">
            <text>å·²å”®ç½„</text>
          </view>
          
          <!-- ç§¯åˆ†ä¸è¶³é®ç½© -->
          <view class="insufficient-overlay" wx:if="{{totalPoints < item.exchange_points && item.stock > 0}}">
            <text>ç§¯åˆ†ä¸è¶³</text>
          </view>
        </view>

        <!-- å•†å“ä¿¡æ¯ -->
        <view class="product-info">
          <view class="product-name">{{item.name}}</view>
          <view class="product-desc">{{item.description}}</view>
          <view class="product-points">
            <text class="points-icon">ğŸ’°</text>
            <text class="points-text">{{item.exchange_points}}ç§¯åˆ†</text>
          </view>
          
          <!-- å•†å“è¯„åˆ† -->
          <view class="product-rating" wx:if="{{item.rating}}">
            <text class="rating-stars">â­â­â­â­â­</text>
            <text class="rating-text">{{item.rating}}</text>
          </view>
        </view>

        <!-- å…‘æ¢æŒ‰é’® -->
        <view class="exchange-btn-container">
          <button 
            class="exchange-btn {{item.stock <= 0 || totalPoints < item.exchange_points ? 'disabled' : ''}}"
            disabled="{{item.stock <= 0 || totalPoints < item.exchange_points}}"
          >
            {{item.stock <= 0 ? 'å·²å”®ç½„' : (totalPoints < item.exchange_points ? 'ç§¯åˆ†ä¸è¶³' : 'ç«‹å³å…‘æ¢')}}
          </button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && filteredProducts.length === 0}}">
      <view class="empty-icon">ğŸ“¦</view>
      <text class="empty-text">{{searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“'}}</text>
      <button class="retry-btn" bindtap="onClearSearch" wx:if="{{searchKeyword}}">
        æ¸…é™¤æœç´¢
      </button>
      <button class="retry-btn" bindtap="onRefreshProducts" wx:else>
        é‡æ–°åŠ è½½
      </button>
    </view>
    
    <!-- åˆ†é¡µå¯¼èˆª -->
    <view class="pagination" wx:if="{{!loading && filteredProducts.length > 0}}">
      <view class="pagination-info">
        <text>ç¬¬ {{currentPage}} é¡µï¼Œå…± {{totalPages}} é¡µ | å…± {{totalProducts}} ä»¶å•†å“</text>
      </view>
      
      <!-- ğŸ”´ ä¿®å¤ï¼šåˆ†é¡µæ§åˆ¶å’Œè·³è½¬åŠŸèƒ½å¼ºåˆ¶åœ¨åŒä¸€è¡Œæ˜¾ç¤º -->
      <view class="pagination-row" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap;">
        <view class="pagination-controls">
          <!-- ä¸Šä¸€é¡µ -->
          <button 
            class="page-btn prev-btn {{currentPage === 1 ? 'disabled' : ''}}"
            bindtap="onPrevPage"
            disabled="{{currentPage === 1}}"
          >
            â† ä¸Šä¸€é¡µ
          </button>
          
          <!-- é¡µç åˆ—è¡¨ -->
          <view class="page-numbers">
            <!-- å½“æ€»é¡µæ•°å°äºç­‰äº7æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç  -->
            <block wx:if="{{totalPages <= 7}}">
              <block wx:for="{{totalPages}}" wx:key="*this">
                <button 
                  class="page-number {{currentPage === (item + 1) ? 'active' : ''}}"
                  bindtap="onPageChange"
                  data-page="{{item + 1}}"
                >{{item + 1}}</button>
              </block>
            </block>
            
            <!-- å½“æ€»é¡µæ•°å¤§äº7æ—¶ï¼Œä½¿ç”¨çœç•¥å·æ˜¾ç¤º -->
            <block wx:else>
              <!-- ç¬¬ä¸€é¡µ -->
              <button 
                class="page-number {{currentPage === 1 ? 'active' : ''}}"
                bindtap="onPageChange"
                data-page="1"
              >1</button>
              
              <!-- å·¦ä¾§çœç•¥å· -->
              <text class="page-ellipsis" wx:if="{{currentPage > 4}}">...</text>
              
              <!-- å½“å‰é¡µé™„è¿‘çš„é¡µç  -->
              <block wx:for="{{totalPages}}" wx:key="*this">
                <button 
                  class="page-number {{currentPage === (item + 1) ? 'active' : ''}}"
                  bindtap="onPageChange"
                  data-page="{{item + 1}}"
                  wx:if="{{(item + 1) > 1 && (item + 1) < totalPages && (item + 1) >= (currentPage - 2) && (item + 1) <= (currentPage + 2)}}"
                >{{item + 1}}</button>
              </block>
              
              <!-- å³ä¾§çœç•¥å· -->
              <text class="page-ellipsis" wx:if="{{currentPage < totalPages - 3}}">...</text>
              
              <!-- æœ€åä¸€é¡µ -->
              <button 
                class="page-number {{currentPage === totalPages ? 'active' : ''}}"
                bindtap="onPageChange"
                data-page="{{totalPages}}"
                wx:if="{{totalPages > 1}}"
              >{{totalPages}}</button>
            </block>
          </view>
          
          <!-- ä¸‹ä¸€é¡µ -->
          <button 
            class="page-btn next-btn {{currentPage === totalPages ? 'disabled' : ''}}"
            bindtap="onNextPage"
            disabled="{{currentPage === totalPages}}"
          >
            ä¸‹ä¸€é¡µ â†’
          </button>
        </view>
        
        <!-- è·³è½¬é¡µé¢ -->
        <view class="page-jump">
          <text>è·³è½¬åˆ°ç¬¬</text>
          <input 
            class="page-input" 
            type="number" 
            placeholder="{{currentPage}}"
            bindinput="onPageInputChange"
            bindconfirm="onPageInputConfirm"
          />
          <text>é¡µ</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å¿«æ·æ“ä½œ -->
  <view class="quick-actions" wx:if="{{!loading}}">
    <button class="action-btn" bindtap="onViewRecords">
      ğŸ“‹ å…‘æ¢è®°å½•
    </button>
    <button class="action-btn" bindtap="onRefreshProducts">
      ğŸ”„ åˆ·æ–°å•†å“
    </button>
    <button class="action-btn" bindtap="onSortByPoints">
      ğŸ“Š æŒ‰ç§¯åˆ†æ’åº
    </button>
  </view>

  <!-- å…‘æ¢ç¡®è®¤å¼¹çª— -->
  <view class="confirm-modal" wx:if="{{showConfirm}}">
    <view class="modal-mask" bindtap="onCancelExchange"></view>
    <view class="modal-content">
      <view class="confirm-header">
        <text class="confirm-title">ç¡®è®¤å…‘æ¢</text>
        <view class="close-btn" bindtap="onCancelExchange">Ã—</view>
      </view>
      
      <view class="product-preview" wx:if="{{selectedProduct}}">
        <image class="preview-image" src="{{selectedProduct.image}}" mode="aspectFill"/>
        <view class="preview-info">
          <text class="preview-name">{{selectedProduct.name}}</text>
          <text class="preview-desc">{{selectedProduct.description}}</text>
          <view class="preview-cost">
            <text class="cost-label">å…‘æ¢æ¶ˆè€—ï¼š</text>
            <text class="cost-points">{{selectedProduct.exchange_points}}ç§¯åˆ†</text>
          </view>
          <view class="remaining-info">
            <text class="remaining-label">å…‘æ¢åå‰©ä½™ï¼š</text>
            <text class="remaining-points">{{totalPoints - selectedProduct.exchange_points}}ç§¯åˆ†</text>
          </view>
        </view>
      </view>

      <view class="confirm-footer">
        <button class="cancel-btn" bindtap="onCancelExchange">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="onConfirmExchange">ç¡®è®¤å…‘æ¢</button>
      </view>
    </view>
  </view>

  <!-- å…‘æ¢ç»“æœå¼¹çª— -->
  <view class="result-modal" wx:if="{{showResult}}">
    <view class="modal-mask" bindtap="onCloseResult"></view>
    <view class="modal-content">
      <view class="result-header">
        <text class="result-title">ğŸ‰ å…‘æ¢æˆåŠŸ</text>
        <view class="close-btn" bindtap="onCloseResult">Ã—</view>
      </view>
      
      <view class="result-content" wx:if="{{resultData}}">
        <view class="success-icon">âœ…</view>
        <text class="success-text">æ­å–œæ‚¨æˆåŠŸå…‘æ¢</text>
        <text class="product-name">{{resultData.product.name}}</text>
        
        <view class="result-details">
          <view class="detail-item">
            <text class="detail-label">è®¢å•ç¼–å·ï¼š</text>
            <text class="detail-value">{{resultData.orderId}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ¶ˆè€—ç§¯åˆ†ï¼š</text>
            <text class="detail-value">-{{resultData.pointsDeducted}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å‰©ä½™ç§¯åˆ†ï¼š</text>
            <text class="detail-value">{{resultData.remainingPoints}}</text>
          </view>
        </view>

        <text class="pickup-notice">ğŸ“ è¯·å‡­ç¼–å·é¢†å–å•†å“</text>
      </view>

      <view class="result-footer">
        <button class="continue-btn" bindtap="onCloseResult">ç»§ç»­å…‘æ¢</button>
        <button class="record-btn" bindtap="onViewRecords">æŸ¥çœ‹è®°å½•</button>
      </view>
    </view>
  </view>

  <!-- è§„åˆ™è¯´æ˜ -->
  <view class="rules-section" wx:if="{{!loading}}">
    <view class="section-title">
      <text>å…‘æ¢è§„åˆ™</text>
    </view>
    <view class="rules-content">
      <view class="rule-item">â€¢ é™é‡å•†å“ï¼Œæ¢å®Œå³æ­¢</view>
      <view class="rule-item">â€¢ åº“å­˜å®æ—¶åŒæ­¥ï¼Œå…ˆåˆ°å…ˆå¾—</view>
              <view class="rule-item">â€¢ å…‘æ¢æˆåŠŸåè¯·å‡­ç¼–å·é¢†å–</view>
      <view class="rule-item">â€¢ ç§¯åˆ†ä¸€ç»å…‘æ¢ä¸å¯é€€å›</view>
    </view>
  </view>
</view> 