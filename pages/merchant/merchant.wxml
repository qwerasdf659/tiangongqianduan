<!--pages/merchant/merchant.wxml-->
<view class="merchant-container">
  <!-- éå•†å®¶ç”¨æˆ· - æƒé™ç”³è¯· -->
  <view class="auth-request" wx:if="{{!isMerchant && !loading}}">
    <view class="auth-card">
      <view class="auth-icon">ğŸª</view>
      <text class="auth-title">ç”³è¯·å•†å®¶æƒé™</text>
      <text class="auth-desc">æˆä¸ºå•†å®¶åï¼Œæ‚¨å¯ä»¥å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨å¹¶ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
      
      <view class="auth-features">
        <view class="feature-item">
          <text class="feature-icon">âœ…</text>
          <text class="feature-text">å®¡æ ¸å°ç¥¨ä¸Šä¼ </text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ’°</text>
          <text class="feature-text">ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“Š</text>
          <text class="feature-text">æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“</text>
          <text class="feature-text">è”ç³»ç”¨æˆ·</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ›ï¸</text>
          <text class="feature-text">å•†å“ç®¡ç†</text>
        </view>
      </view>
      
      <button class="auth-btn" bindtap="onRequestAuth">
        ç”³è¯·å•†å®¶æƒé™
      </button>
    </view>
  </view>

  <!-- å•†å®¶ç®¡ç†ç•Œé¢ -->
  <view class="merchant-main" wx:if="{{isMerchant && !loading}}">
    <!-- æƒé™é”å®šé®ç½© -->
    <view class="permission-lock" wx:if="{{!hasPermission}}">
      <view class="lock-overlay"></view>
      <view class="lock-content">
        <view class="lock-icon">ğŸ”</view>
        <text class="lock-title">å•†å®¶åŠŸèƒ½å·²é”å®š</text>
        <text class="lock-desc">ä¸ºä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å…ˆå®Œæˆèº«ä»½éªŒè¯</text>
        <button class="unlock-btn" bindtap="onUnlockPermission">
          ğŸ”“ è§£é”åŠŸèƒ½
        </button>
        <view class="lock-tips">
          <text>â€¢ æ”¯æŒæ‰‹æœºéªŒè¯ç éªŒè¯</text>
          <text>â€¢ æ”¯æŒè´¦å·å¯†ç éªŒè¯</text>
          <text>â€¢ éªŒè¯æˆåŠŸåè‡ªåŠ¨è§£é”</text>
        </view>
      </view>
    </view>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header {{!hasPermission ? 'locked' : ''}}">
      <view class="user-info">
        <text class="welcome">ğŸª å•†å®¶ç®¡ç†</text>
        <text class="merchant-badge">{{hasPermission ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}}</text>
      </view>
      
      <!-- æƒé™çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <view class="permission-indicator {{hasPermission ? 'verified' : 'locked'}}">
        <text class="indicator-icon">{{hasPermission ? 'ğŸ”“' : 'ğŸ”'}}</text>
        <text class="indicator-text">{{hasPermission ? 'å·²è§£é”' : 'å·²é”å®š'}}</text>
      </view>
    </view>

    <!-- ç®¡ç†é€‰é¡¹å¡ -->
    <view class="tab-bar {{!hasPermission ? 'locked' : ''}}">
      <view 
        class="tab-item {{currentTab === 'review' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="review"
      >
        ğŸ“‹ å®¡æ ¸ç®¡ç†
      </view>
      <view 
        class="tab-item {{currentTab === 'product' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="product"
      >
        ğŸ›ï¸ å•†å“ç®¡ç†
      </view>
    </view>

    <!-- å®¡æ ¸ç®¡ç†é¡µé¢ -->
    <view class="review-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'review'}}">
      <!-- å®¡æ ¸ç»Ÿè®¡ -->
      <view class="statistics-section">
        <view class="section-title">
          <text>ğŸ“Š å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item pending">
            <text class="stat-number">{{statistics.pendingCount}}</text>
            <text class="stat-label">å¾…å®¡æ ¸</text>
          </view>
          <view class="stat-item approved">
            <text class="stat-number">{{statistics.todayApproved}}</text>
            <text class="stat-label">ä»Šæ—¥é€šè¿‡</text>
          </view>
          <view class="stat-item rejected">
            <text class="stat-number">{{statistics.todayRejected}}</text>
            <text class="stat-label">ä»Šæ—¥æ‹’ç»</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{statistics.totalProcessed}}</text>
            <text class="stat-label">ç´¯è®¡å¤„ç†</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œå·¥å…·æ  -->
      <view class="toolbar">
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshData' : 'onLockedTap'}}">
          ğŸ”„ åˆ·æ–°
        </button>
        <button class="tool-btn batch-btn" bindtap="{{hasPermission ? 'onBatchOperation' : 'onLockedTap'}}">
          ğŸ“ æ‰¹é‡æ“ä½œ
        </button>
      </view>

      <!-- å¾…å®¡æ ¸åˆ—è¡¨ -->
      <view class="pending-section">
        <view class="section-title">
          <text>ğŸ“‹ å¾…å®¡æ ¸åˆ—è¡¨ ({{pendingList.length}})</text>
        </view>
        
        <view class="pending-list">
          <view 
            class="pending-item"
            wx:for="{{pendingList}}" 
            wx:key="id"
          >
            <!-- é€‰æ‹©æ¡† -->
            <view class="item-select">
              <checkbox 
                checked="{{item.selected}}"
                bindchange="{{hasPermission ? 'onItemSelect' : 'onLockedTap'}}"
                data-id="{{item.id}}"
              />
            </view>

            <!-- å®¡æ ¸é¡¹å¤´éƒ¨ -->
            <view class="item-header">
              <view class="user-info">
                <text class="user-phone">{{item.user_phone}}</text>
                <text class="user-id">ID: {{item.user_id}}</text>
              </view>
              <view class="upload-time">
                <text class="time-label">ä¸Šä¼ æ—¶é—´</text>
                <text class="time-value">{{item.upload_time}}</text>
              </view>
            </view>

            <!-- å®¡æ ¸å†…å®¹ -->
            <view class="item-content">
              <image 
                class="receipt-image" 
                src="{{item.receipt_image}}" 
                mode="aspectFill"
                bindtap="{{hasPermission ? 'onPreviewImage' : 'onLockedTap'}}"
                data-url="{{item.receipt_image}}"
              />
              <view class="receipt-info">
                <view class="amount-info">
                  <text class="amount-label">æ¶ˆè´¹é‡‘é¢ï¼š</text>
                  <text class="amount-value">Â¥{{item.amount}}</text>
                </view>
                <view class="points-info">
                  <text class="points-label">å»ºè®®ç§¯åˆ†ï¼š</text>
                  <text class="points-value">{{item.suggested_points}}åˆ†</text>
                </view>
                <view class="remarks-info" wx:if="{{item.user_remarks}}">
                  <text class="remarks-label">ç”¨æˆ·å¤‡æ³¨ï¼š</text>
                  <text class="remarks-value">{{item.user_remarks}}</text>
                </view>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="item-actions">
              <button 
                class="action-btn approve-btn"
                bindtap="{{hasPermission ? 'onApprove' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                âœ… é€šè¿‡
              </button>
              <button 
                class="action-btn reject-btn"
                bindtap="{{hasPermission ? 'onReject' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                âŒ æ‹’ç»
              </button>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{pendingList.length === 0}}">
          <view class="empty-icon">ğŸ“</view>
          <text class="empty-text">æš‚æ— å¾…å®¡æ ¸è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- å•†å“ç®¡ç†é¡µé¢ -->
    <view class="product-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'product'}}">
      <!-- å•†å“ç»Ÿè®¡ -->
      <view class="product-statistics">
        <view class="section-title">
          <text>ğŸ›ï¸ å•†å“ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item active">
            <text class="stat-number">{{productStats.activeCount}}</text>
            <text class="stat-label">åœ¨å”®å•†å“</text>
          </view>
          <view class="stat-item offline">
            <text class="stat-number">{{productStats.offlineCount}}</text>
            <text class="stat-label">å·²ä¸‹æ¶</text>
          </view>
          <view class="stat-item low-stock">
            <text class="stat-number">{{productStats.lowStockCount}}</text>
            <text class="stat-label">åº“å­˜ä¸è¶³</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{productStats.totalCount}}</text>
            <text class="stat-label">æ€»è®¡</text>
          </view>
        </view>
      </view>

      <!-- å•†å“æ“ä½œå·¥å…·æ  -->
      <view class="product-toolbar">
        <button class="tool-btn add-btn" bindtap="{{hasPermission ? 'onAddProduct' : 'onLockedTap'}}">
          â• æ–°å¢å•†å“
        </button>
        <button class="tool-btn batch-edit-btn" bindtap="{{hasPermission ? 'onBatchEdit' : 'onLockedTap'}}">
          ğŸ“ æ‰¹é‡ç¼–è¾‘
        </button>
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshProducts' : 'onLockedTap'}}">
          ğŸ”„ åˆ·æ–°
        </button>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="product-list-section">
        <view class="section-title">
          <text>ğŸ“¦ å•†å“åˆ—è¡¨ ({{productList.length}}/20)</text>
        </view>
        
        <view class="product-list">
          <view 
            class="product-item"
            wx:for="{{productList}}" 
            wx:key="id"
          >
            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image-container">
              <image 
                class="product-image" 
                src="{{item.image}}" 
                mode="aspectFill"
              />
              <view class="product-status {{item.status === 'active' ? 'active' : 'offline'}}">
                {{item.status === 'active' ? 'åœ¨å”®' : 'ä¸‹æ¶'}}
              </view>
            </view>

            <!-- å•†å“ä¿¡æ¯ -->
            <view class="product-info">
              <view class="product-name">{{item.name}}</view>
              <view class="product-desc">{{item.description}}</view>
              <view class="product-price">
                <text class="price-icon">ğŸ’°</text>
                <text class="price-text">{{item.exchange_points}}ç§¯åˆ†</text>
              </view>
              <view class="product-stock {{item.stock <= 5 ? 'low-stock' : ''}}">
                <text class="stock-label">åº“å­˜ï¼š</text>
                <text class="stock-value">{{item.stock}}ä»¶</text>
              </view>
            </view>

            <!-- å•†å“æ“ä½œ -->
            <view class="product-actions">
              <button 
                class="product-btn edit-btn"
                bindtap="{{hasPermission ? 'onEditProduct' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                âœï¸ ç¼–è¾‘
              </button>
              <button 
                class="product-btn stock-btn"
                bindtap="{{hasPermission ? 'onAdjustStock' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                ğŸ“¦ è°ƒåº“å­˜
              </button>
              <button 
                class="product-btn toggle-btn {{item.status === 'active' ? 'offline' : 'online'}}"
                bindtap="{{hasPermission ? 'onToggleStatus' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                {{item.status === 'active' ? 'ğŸ“´ ä¸‹æ¶' : 'ğŸ“± ä¸Šæ¶'}}
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™éªŒè¯å¼¹çª— -->
  <auth-modal 
    visible="{{showAuthModal}}"
    title="å•†å®¶åŠŸèƒ½è§£é”"
    isFirstUse="{{isFirstUse}}"
    bind:success="onAuthSuccess"
    bind:cancel="onAuthCancel"
  />

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>