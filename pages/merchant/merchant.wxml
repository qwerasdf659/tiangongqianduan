<!--pages/merchant/merchant.wxml-->
<view class="merchant-container">
  <!-- éå•†å®¶ç”¨æˆ· - æƒé™ç”³è¯· -->
  <view class="auth-request" wx:if="{{!isMerchant && !loading}}">
    <view class="auth-card">
      <view class="auth-icon">ğŸª</view>
      <text class="auth-title">ç”³è¯·å•†å®¶æƒé™</text>
      <text class="auth-desc">æˆä¸ºå•†å®¶åï¼Œæ‚¨å¯ä»¥å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨å¹¶ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
      
      <view class="auth-features">
        <view class="feature-item">
          <text class="feature-icon">âœ…</text>
          <text class="feature-text">å®¡æ ¸å°ç¥¨ä¸Šä¼ </text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ’°</text>
          <text class="feature-text">ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“Š</text>
          <text class="feature-text">æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“</text>
          <text class="feature-text">è”ç³»ç”¨æˆ·</text>
        </view>
      </view>
      
      <button class="auth-btn" bindtap="onRequestAuth">
        ç”³è¯·å•†å®¶æƒé™
      </button>
    </view>
  </view>

  <!-- å•†å®¶ç®¡ç†ç•Œé¢ -->
  <view class="merchant-main" wx:if="{{isMerchant && !loading}}">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header">
      <view class="user-info">
        <text class="welcome">ğŸª å•†å®¶ç®¡ç†</text>
        <text class="merchant-badge">å•†å®¶</text>
      </view>
    </view>

    <!-- å®¡æ ¸ç»Ÿè®¡ -->
    <view class="statistics-section">
      <view class="section-title">
        <text>ğŸ“Š å®¡æ ¸ç»Ÿè®¡</text>
      </view>
      <view class="stats-grid">
        <view class="stat-item pending">
          <text class="stat-number">{{statistics.pendingCount}}</text>
          <text class="stat-label">å¾…å®¡æ ¸</text>
        </view>
        <view class="stat-item approved">
          <text class="stat-number">{{statistics.todayApproved}}</text>
          <text class="stat-label">ä»Šæ—¥é€šè¿‡</text>
        </view>
        <view class="stat-item rejected">
          <text class="stat-number">{{statistics.todayRejected}}</text>
          <text class="stat-label">ä»Šæ—¥æ‹’ç»</text>
        </view>
        <view class="stat-item total">
          <text class="stat-number">{{statistics.totalProcessed}}</text>
          <text class="stat-label">ç´¯è®¡å¤„ç†</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œå·¥å…·æ  -->
    <view class="toolbar">
      <button class="tool-btn refresh-btn" bindtap="refreshData">
        ğŸ”„ åˆ·æ–°
      </button>
      <button class="tool-btn batch-btn" bindtap="onBatchOperation">
        ğŸ“ æ‰¹é‡æ“ä½œ
      </button>
    </view>

    <!-- å¾…å®¡æ ¸åˆ—è¡¨ -->
    <view class="pending-section">
      <view class="section-title">
        <text>ğŸ“‹ å¾…å®¡æ ¸åˆ—è¡¨ ({{pendingList.length}})</text>
      </view>
      
      <view class="pending-list">
        <view 
          class="pending-item"
          wx:for="{{pendingList}}" 
          wx:key="id"
        >
          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <view class="item-header">
            <view class="user-info">
              <text class="user-phone">{{item.user_phone}}</text>
              <text class="user-id">ID: {{item.user_id}}</text>
            </view>
            <view class="upload-time">
              <text class="time-label">ä¸Šä¼ æ—¶é—´</text>
              <text class="time-value">{{item.upload_time}}</text>
            </view>
          </view>

          <!-- å°ç¥¨ä¿¡æ¯ -->
          <view class="item-content">
            <image 
              class="receipt-image" 
              src="{{item.image_url}}" 
              mode="aspectFill"
              bindtap="onPreviewImage"
              data-url="{{item.image_url}}"
            />
            <view class="receipt-info">
              <view class="amount-info">
                <text class="amount-label">æ¶ˆè´¹é‡‘é¢ï¼š</text>
                <text class="amount-value">{{item.amount}}å…ƒ</text>
              </view>
              <view class="points-info">
                <text class="points-label">é¢„è®¡ç§¯åˆ†ï¼š</text>
                <text class="points-value">{{item.expected_points}}åˆ†</text>
              </view>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="item-actions">
            <button 
              class="action-btn contact-btn"
              bindtap="onContactUser"
              data-phone="{{item.user_phone}}"
            >
              ğŸ“ è”ç³»
            </button>
            <button 
              class="action-btn reject-btn"
              bindtap="onStartReview"
              data-item="{{item}}"
              data-action="reject"
            >
              âŒ æ‹’ç»
            </button>
            <button 
              class="action-btn approve-btn"
              bindtap="onStartReview"
              data-item="{{item}}"
              data-action="approve"
            >
              âœ… é€šè¿‡
            </button>
          </view>
        </view>

        <!-- åˆ—è¡¨ä¸ºç©º -->
        <view class="empty-list" wx:if="{{pendingList.length === 0}}">
          <view class="empty-icon">ğŸ“‹</view>
          <text class="empty-text">æš‚æ— å¾…å®¡æ ¸é¡¹ç›®</text>
          <button class="refresh-btn" bindtap="refreshData">åˆ·æ–°æ•°æ®</button>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™ç”³è¯·å¼¹çª— -->
  <view class="auth-modal" wx:if="{{showAuthModal}}">
    <view class="modal-mask" bindtap="onCancelAuth"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·å•†å®¶æƒé™</text>
        <view class="close-btn" bindtap="onCancelAuth">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="confirm-text">
          ç”³è¯·æˆä¸ºå•†å®¶åï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹æƒé™ï¼š
        </view>
        <view class="permission-list">
          <view class="permission-item">â€¢ å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨</view>
          <view class="permission-item">â€¢ å†³å®šç§¯åˆ†å‘æ”¾æ•°é‡</view>
          <view class="permission-item">â€¢ æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡æ•°æ®</view>
          <view class="permission-item">â€¢ è”ç³»ç›¸å…³ç”¨æˆ·</view>
        </view>
        <view class="warning-text">
          è¯·ç¡®ä¿æ‚¨æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†å®¡æ ¸äº‹åŠ¡
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelAuth">å–æ¶ˆ</button>
        <button 
          class="confirm-btn {{authRequesting ? 'loading' : ''}}"
          disabled="{{authRequesting}}"
          bindtap="onConfirmAuth"
        >
          {{authRequesting ? 'ç”³è¯·ä¸­...' : 'ç¡®è®¤ç”³è¯·'}}
        </button>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸æ“ä½œå¼¹çª— -->
  <view class="review-modal" wx:if="{{showReviewModal}}">
    <view class="modal-mask" bindtap="onCancelReview"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">
          {{reviewAction === 'approve' ? 'å®¡æ ¸é€šè¿‡' : 'å®¡æ ¸æ‹’ç»'}}
        </text>
        <view class="close-btn" bindtap="onCancelReview">Ã—</view>
      </view>
      
      <view class="modal-body" wx:if="{{currentReview}}">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="review-info">
          <text class="info-label">ç”¨æˆ·ï¼š</text>
          <text class="info-value">{{currentReview.user_phone}}</text>
        </view>
        <view class="review-info">
          <text class="info-label">é‡‘é¢ï¼š</text>
          <text class="info-value">{{currentReview.amount}}å…ƒ</text>
        </view>

        <!-- å®¡æ ¸é€šè¿‡ - ç§¯åˆ†è¾“å…¥ -->
        <view class="input-section" wx:if="{{reviewAction === 'approve'}}">
          <text class="input-label">å‘æ”¾ç§¯åˆ†ï¼š</text>
          <input 
            class="points-input"
            type="number"
            placeholder="è¯·è¾“å…¥ç§¯åˆ†æ•°é‡"
            value="{{reviewPoints}}"
            bindinput="onPointsInput"
          />
          <text class="input-tips">å»ºè®®ï¼š{{currentReview.expected_points}}åˆ†</text>
        </view>

        <!-- å®¡æ ¸æ‹’ç» - ç†ç”±è¾“å…¥ -->
        <view class="input-section" wx:if="{{reviewAction === 'reject'}}">
          <text class="input-label">æ‹’ç»ç†ç”±ï¼š</text>
          <textarea 
            class="reason-input"
            placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼Œç”¨æˆ·å°†æ”¶åˆ°æ­¤ä¿¡æ¯"
            value="{{reviewReason}}"
            bindinput="onReasonInput"
            maxlength="200"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelReview">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="onConfirmReview">
          ç¡®è®¤{{reviewAction === 'approve' ? 'é€šè¿‡' : 'æ‹’ç»'}}
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>