<!--pages/merchant/merchant.wxml-->
<view class="merchant-container">
  <!-- 非商家用户 - 权限申请 -->
  <view class="auth-request" wx:if="{{!isMerchant && !loading}}">
    <view class="auth-card">
      <view class="auth-icon">🏪</view>
      <text class="auth-title">申请商家权限</text>
      <text class="auth-desc">成为商家后，您可以审核用户上传的小票并管理积分发放</text>
      
      <view class="auth-features">
        <view class="feature-item">
          <text class="feature-icon">✅</text>
          <text class="feature-text">审核小票上传</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">💰</text>
          <text class="feature-text">管理积分发放</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">📊</text>
          <text class="feature-text">查看审核统计</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">📞</text>
          <text class="feature-text">联系用户</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">🛍️</text>
          <text class="feature-text">商品管理</text>
        </view>
      </view>
      
      <button class="auth-btn" bindtap="onRequestAuth">
        申请商家权限
      </button>
    </view>
  </view>

  <!-- 商家管理界面 -->
  <view class="merchant-main" wx:if="{{isMerchant && !loading}}">
    <!-- 权限锁定遮罩 -->
    <view class="permission-lock" wx:if="{{!hasPermission}}">
      <view class="lock-overlay"></view>
      <view class="lock-content">
        <view class="lock-icon">🔐</view>
        <text class="lock-title">商家功能已锁定</text>
        <text class="lock-desc">为保护您的账户安全，请先完成身份验证</text>
        <button class="unlock-btn" bindtap="onUnlockPermission">
          🔓 解锁功能
        </button>
        <view class="lock-tips">
          <text>• 支持手机验证码验证</text>
          <text>• 支持账号密码验证</text>
          <text>• 验证成功后自动解锁</text>
        </view>
      </view>
    </view>

    <!-- 页面头部 -->
    <view class="header {{!hasPermission ? 'locked' : ''}}">
      <view class="user-info">
        <text class="welcome">🏪 商家管理</text>
        <text class="merchant-badge">{{hasPermission ? '已验证' : '未验证'}}</text>
      </view>
      
      <!-- 权限状态指示器 -->
      <view class="permission-indicator {{hasPermission ? 'verified' : 'locked'}}">
        <text class="indicator-icon">{{hasPermission ? '🔓' : '🔐'}}</text>
        <text class="indicator-text">{{hasPermission ? '已解锁' : '已锁定'}}</text>
      </view>
    </view>

    <!-- 管理选项卡 -->
    <view class="tab-bar {{!hasPermission ? 'locked' : ''}}">
      <view 
        class="tab-item {{currentTab === 'review' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="review"
      >
        📋 审核管理
      </view>
      <view 
        class="tab-item {{currentTab === 'product' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="product"
      >
        🛍️ 商品管理
      </view>
    </view>

    <!-- 审核管理页面 -->
    <view class="review-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'review'}}">
      <!-- 审核统计 -->
      <view class="statistics-section">
        <view class="section-title">
          <text>📊 审核统计</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item pending">
            <text class="stat-number">{{statistics.pendingCount}}</text>
            <text class="stat-label">待审核</text>
          </view>
          <view class="stat-item approved">
            <text class="stat-number">{{statistics.todayApproved}}</text>
            <text class="stat-label">今日通过</text>
          </view>
          <view class="stat-item rejected">
            <text class="stat-number">{{statistics.todayRejected}}</text>
            <text class="stat-label">今日拒绝</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{statistics.totalProcessed}}</text>
            <text class="stat-label">累计处理</text>
          </view>
        </view>
      </view>

      <!-- 操作工具栏 -->
      <view class="toolbar">
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshData' : 'onLockedTap'}}">
          🔄 刷新
        </button>
        <button class="tool-btn batch-btn" bindtap="{{hasPermission ? 'onBatchOperation' : 'onLockedTap'}}">
          📝 批量操作
        </button>
      </view>

      <!-- 待审核列表 -->
      <view class="pending-section">
        <view class="section-title">
          <text>📋 待审核列表 ({{pendingList.length}})</text>
        </view>
        
        <view class="pending-list">
          <view 
            class="pending-item"
            wx:for="{{pendingList}}" 
            wx:key="id"
          >
            <!-- 选择框 -->
            <view class="item-select">
              <checkbox 
                checked="{{item.selected}}"
                bindchange="{{hasPermission ? 'onItemSelect' : 'onLockedTap'}}"
                data-id="{{item.id}}"
              />
            </view>

            <!-- 审核项头部 -->
            <view class="item-header">
              <view class="user-info">
                <text class="user-phone">{{item.user_phone}}</text>
                <text class="user-id">ID: {{item.user_id}}</text>
              </view>
              <view class="upload-time">
                <text class="time-label">上传时间</text>
                <text class="time-value">{{item.upload_time}}</text>
              </view>
            </view>

            <!-- 审核内容 -->
            <view class="item-content">
              <image 
                class="receipt-image" 
                src="{{item.receipt_image}}" 
                mode="aspectFill"
                bindtap="{{hasPermission ? 'onPreviewImage' : 'onLockedTap'}}"
                data-url="{{item.receipt_image}}"
              />
              <view class="receipt-info">
                <view class="amount-info">
                  <text class="amount-label">消费金额：</text>
                  <text class="amount-value">¥{{item.amount}}</text>
                </view>
                <view class="points-info">
                  <text class="points-label">建议积分：</text>
                  <text class="points-value">{{item.suggested_points}}分</text>
                </view>
                <view class="remarks-info" wx:if="{{item.user_remarks}}">
                  <text class="remarks-label">用户备注：</text>
                  <text class="remarks-value">{{item.user_remarks}}</text>
                </view>
              </view>
            </view>

            <!-- 操作按钮 -->
            <view class="item-actions">
              <button 
                class="action-btn approve-btn"
                bindtap="{{hasPermission ? 'onApprove' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                ✅ 通过
              </button>
              <button 
                class="action-btn reject-btn"
                bindtap="{{hasPermission ? 'onReject' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                ❌ 拒绝
              </button>
            </view>
          </view>
        </view>

        <!-- 空状态 -->
        <view class="empty-state" wx:if="{{pendingList.length === 0}}">
          <view class="empty-icon">📝</view>
          <text class="empty-text">暂无待审核记录</text>
        </view>
      </view>
    </view>

    <!-- 商品管理页面 -->
    <view class="product-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'product'}}">
      <!-- 商品统计 -->
      <view class="product-statistics">
        <view class="section-title">
          <text>🛍️ 商品统计</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item active">
            <text class="stat-number">{{productStats.activeCount}}</text>
            <text class="stat-label">在售商品</text>
          </view>
          <view class="stat-item offline">
            <text class="stat-number">{{productStats.offlineCount}}</text>
            <text class="stat-label">已下架</text>
          </view>
          <view class="stat-item low-stock">
            <text class="stat-number">{{productStats.lowStockCount}}</text>
            <text class="stat-label">库存不足</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{productStats.totalCount}}</text>
            <text class="stat-label">总计</text>
          </view>
        </view>
      </view>

      <!-- 商品操作工具栏 -->
      <view class="product-toolbar">
        <button class="tool-btn add-btn" bindtap="{{hasPermission ? 'onAddProduct' : 'onLockedTap'}}">
          ➕ 新增商品
        </button>
        <button class="tool-btn batch-edit-btn" bindtap="{{hasPermission ? 'onBatchEdit' : 'onLockedTap'}}">
          📝 批量编辑
        </button>
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshProducts' : 'onLockedTap'}}">
          🔄 刷新
        </button>
      </view>

      <!-- 商品列表 -->
      <view class="product-list-section">
        <view class="section-title">
          <text>📦 商品列表 ({{productList.length}}/20)</text>
        </view>
        
        <view class="product-list">
          <view 
            class="product-item"
            wx:for="{{productList}}" 
            wx:key="id"
          >
            <!-- 商品图片 -->
            <view class="product-image-container">
              <image 
                class="product-image" 
                src="{{item.image}}" 
                mode="aspectFill"
              />
              <view class="product-status {{item.status === 'active' ? 'active' : 'offline'}}">
                {{item.status === 'active' ? '在售' : '下架'}}
              </view>
            </view>

            <!-- 商品信息 -->
            <view class="product-info">
              <view class="product-name">{{item.name}}</view>
              <view class="product-desc">{{item.description}}</view>
              <view class="product-price">
                <text class="price-icon">💰</text>
                <text class="price-text">{{item.exchange_points}}积分</text>
              </view>
              <view class="product-stock {{item.stock <= 5 ? 'low-stock' : ''}}">
                <text class="stock-label">库存：</text>
                <text class="stock-value">{{item.stock}}件</text>
              </view>
            </view>

            <!-- 商品操作 -->
            <view class="product-actions">
              <button 
                class="product-btn edit-btn"
                bindtap="{{hasPermission ? 'onEditProduct' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                ✏️ 编辑
              </button>
              <button 
                class="product-btn stock-btn"
                bindtap="{{hasPermission ? 'onAdjustStock' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                📦 调库存
              </button>
              <button 
                class="product-btn toggle-btn {{item.status === 'active' ? 'offline' : 'online'}}"
                bindtap="{{hasPermission ? 'onToggleStatus' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                {{item.status === 'active' ? '📴 下架' : '📱 上架'}}
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 权限验证弹窗 -->
  <auth-modal 
    visible="{{showAuthModal}}"
    title="商家功能解锁"
    isFirstUse="{{isFirstUse}}"
    bind:success="onAuthSuccess"
    bind:cancel="onAuthCancel"
  />

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">加载中...</text>
    </view>
  </view>
</view>