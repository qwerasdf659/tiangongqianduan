<!--pages/merchant/merchant.wxml-->
<view class="merchant-container">
  <!-- éå•†å®¶ç”¨æˆ· - æƒé™ç”³è¯· -->
  <view class="auth-request" wx:if="{{!isMerchant && !loading}}">
    <view class="auth-card">
      <view class="auth-icon">ğŸª</view>
      <text class="auth-title">ç”³è¯·å•†å®¶æƒé™</text>
      <text class="auth-desc">æˆä¸ºå•†å®¶åï¼Œæ‚¨å¯ä»¥å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨å¹¶ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
      
      <view class="auth-features">
        <view class="feature-item">
          <text class="feature-icon">âœ…</text>
          <text class="feature-text">å®¡æ ¸å°ç¥¨ä¸Šä¼ </text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ’°</text>
          <text class="feature-text">ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“Š</text>
          <text class="feature-text">æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“</text>
          <text class="feature-text">è”ç³»ç”¨æˆ·</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ›ï¸</text>
          <text class="feature-text">å•†å“ç®¡ç†</text>
        </view>
      </view>
      
      <button 
        class="auth-btn"
        bindtap="onRequestAuth"
        disabled="{{authRequesting}}"
      >
        {{authRequesting ? 'ç”³è¯·ä¸­...' : 'ç”³è¯·å•†å®¶æƒé™'}}
      </button>
    </view>
  </view>

  <!-- å•†å®¶ç®¡ç†ç•Œé¢ -->
  <view class="merchant-main" wx:if="{{isMerchant && !loading}}">
    <!-- æƒé™é”å®šé®ç½© -->
    <view class="permission-lock" wx:if="{{!hasPermission}}">
      <view class="lock-overlay"></view>
      <view class="lock-content">
        <view class="lock-icon">ğŸ”</view>
        <text class="lock-title">å•†å®¶åŠŸèƒ½å·²é”å®š</text>
        <text class="lock-desc">ä¸ºä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨ï¼Œè¯·å…ˆå®Œæˆèº«ä»½éªŒè¯</text>
        <button class="unlock-btn" bindtap="onUnlockPermission">
          ğŸ”“ è§£é”åŠŸèƒ½
        </button>
        <view class="lock-tips">
          <text>â€¢ æ”¯æŒæ‰‹æœºéªŒè¯ç éªŒè¯</text>
          <text>â€¢ æ”¯æŒè´¦å·å¯†ç éªŒè¯</text>
          <text>â€¢ éªŒè¯æˆåŠŸåè‡ªåŠ¨è§£é”</text>
        </view>
      </view>
    </view>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header {{!hasPermission ? 'locked' : ''}}">
      <view class="user-info">
        <text class="welcome">ğŸª å•†å®¶ç®¡ç†</text>
        <text class="merchant-badge">{{hasPermission ? 'å·²éªŒè¯' : 'æœªéªŒè¯'}}</text>
      </view>
      
      <!-- æƒé™çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <view class="permission-indicator {{hasPermission ? 'verified' : 'locked'}}">
        <text class="indicator-icon">{{hasPermission ? 'ğŸ”“' : 'ğŸ”'}}</text>
        <text class="indicator-text">{{hasPermission ? 'å·²è§£é”' : 'å·²é”å®š'}}</text>
      </view>
    </view>

    <!-- ç®¡ç†é€‰é¡¹å¡ -->
    <view class="tab-bar {{!hasPermission ? 'locked' : ''}}">
      <view 
        class="tab-item {{currentTab === 'review' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="review"
      >
        ğŸ“‹ å®¡æ ¸ç®¡ç†
      </view>
      <view 
        class="tab-item {{currentTab === 'lottery' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="lottery"
      >
        ğŸ° æŠ½å¥–æ§åˆ¶
      </view>
      <view 
        class="tab-item {{currentTab === 'product' ? 'active' : ''}}"
        bindtap="{{hasPermission ? 'onTabChange' : 'onLockedTap'}}"
        data-tab="product"
      >
        ğŸ›ï¸ å•†å“ç®¡ç†
      </view>
    </view>

    <!-- å®¡æ ¸ç®¡ç†é¡µé¢ -->
    <view class="review-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'review'}}">
      <!-- å®¡æ ¸ç»Ÿè®¡ -->
      <view class="statistics-section">
        <view class="section-title">
          <text>ğŸ“Š å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item pending">
            <text class="stat-number">{{statistics.pendingCount}}</text>
            <text class="stat-label">å¾…å®¡æ ¸</text>
          </view>
          <view class="stat-item approved">
            <text class="stat-number">{{statistics.todayApproved}}</text>
            <text class="stat-label">ä»Šæ—¥é€šè¿‡</text>
          </view>
          <view class="stat-item rejected">
            <text class="stat-number">{{statistics.todayRejected}}</text>
            <text class="stat-label">ä»Šæ—¥æ‹’ç»</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{statistics.totalProcessed}}</text>
            <text class="stat-label">ç´¯è®¡å¤„ç†</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œå·¥å…·æ  -->
      <view class="toolbar">
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshData' : 'onLockedTap'}}">
          ğŸ”„ åˆ·æ–°
        </button>
        <button class="tool-btn batch-btn" bindtap="{{hasPermission ? 'onBatchOperation' : 'onLockedTap'}}">
          ğŸ“ æ‰¹é‡æ“ä½œ
        </button>
        <button class="tool-btn diagnostic-btn" bindtap="onRunDiagnostic">
          ğŸ” è¯Šæ–­
        </button>
      </view>

      <!-- å¾…å®¡æ ¸åˆ—è¡¨ -->
      <view class="pending-section">
        <view class="section-title">
          <text>ğŸ“‹ å¾…å®¡æ ¸åˆ—è¡¨ ({{pendingList.length}})</text>
        </view>
        
        <view class="pending-list">
          <view 
            class="pending-item"
            wx:for="{{pendingList}}" 
            wx:key="id"
          >
            <!-- é€‰æ‹©æ¡† -->
            <view class="item-select">
              <checkbox 
                checked="{{item.selected}}"
                bindchange="{{hasPermission ? 'onItemSelect' : 'onLockedTap'}}"
                data-id="{{item.id}}"
              />
            </view>

            <!-- å®¡æ ¸é¡¹å¤´éƒ¨ -->
            <view class="item-header">
              <view class="user-info">
                <text class="user-phone">{{item.user_phone}}</text>
                <text class="user-id">ID: {{item.user_id}}</text>
              </view>
              <view class="upload-time">
                <text class="time-label">ä¸Šä¼ æ—¶é—´</text>
                <text class="time-value">{{item.upload_time}}</text>
              </view>
            </view>

            <!-- å®¡æ ¸å†…å®¹ -->
            <view class="item-content">
              <image 
                class="receipt-image" 
                src="{{item.receipt_image}}" 
                mode="aspectFill"
                bindtap="{{hasPermission ? 'onPreviewImage' : 'onLockedTap'}}"
                data-url="{{item.receipt_image}}"
              />
              <view class="receipt-info">
                <view class="amount-info">
                  <text class="amount-label">æ¶ˆè´¹é‡‘é¢ï¼š</text>
                  <text class="amount-value">Â¥{{item.amount}}</text>
                </view>
                <view class="points-info">
                  <text class="points-label">å»ºè®®ç§¯åˆ†ï¼š</text>
                  <text class="points-value">{{item.suggested_points}}åˆ†</text>
                </view>
                <view class="remarks-info" wx:if="{{item.user_remarks}}">
                  <text class="remarks-label">ç”¨æˆ·å¤‡æ³¨ï¼š</text>
                  <text class="remarks-value">{{item.user_remarks}}</text>
                </view>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="item-actions">
              <button 
                class="action-btn approve-btn"
                bindtap="{{hasPermission ? 'onApprove' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                âœ… é€šè¿‡
              </button>
              <button 
                class="action-btn reject-btn"
                bindtap="{{hasPermission ? 'onReject' : 'onLockedTap'}}"
                data-item="{{item}}"
              >
                âŒ æ‹’ç»
              </button>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{pendingList.length === 0}}">
          <view class="empty-icon">ğŸ“</view>
          <text class="empty-text">æš‚æ— å¾…å®¡æ ¸è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- ğŸ° æŠ½å¥–æ§åˆ¶é¡µé¢ -->
    <view class="lottery-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'lottery'}}">
      <!-- æŠ½å¥–çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <view class="lottery-status-section">
        <view class="section-title">
          <text>ğŸ¯ æŠ½å¥–ç³»ç»ŸçŠ¶æ€</text>
        </view>
        <view class="status-indicator {{lotteryConfig.isActive ? 'active' : 'maintenance'}}">
          <view class="status-icon">{{lotteryConfig.isActive ? 'ğŸŸ¢' : 'ğŸ”´'}}</view>
          <view class="status-info">
            <text class="status-text">{{lotteryConfig.isActive ? 'æ­£å¸¸è¿è¡Œ' : 'ç»´æŠ¤æš‚åœ'}}</text>
            <text class="status-desc">{{lotteryConfig.isActive ? 'ç”¨æˆ·å¯æ­£å¸¸å‚ä¸æŠ½å¥–' : 'æŠ½å¥–åŠŸèƒ½å·²æš‚åœ'}}</text>
          </view>
          <button 
            class="status-toggle-btn {{lotteryConfig.isActive ? 'pause' : 'resume'}}"
            bindtap="{{hasPermission ? 'onToggleLotteryStatus' : 'onLockedTap'}}"
          >
            {{lotteryConfig.isActive ? 'â¸ï¸ æš‚åœæŠ½å¥–' : 'â–¶ï¸ æ¢å¤æŠ½å¥–'}}
          </button>
        </view>
      </view>

      <!-- æŠ½å¥–æ¦‚ç‡è®¾ç½® -->
      <view class="probability-section">
        <view class="section-title">
          <text>ğŸ² æŠ½å¥–æ¦‚ç‡è®¾ç½®</text>
          <button 
            class="reset-btn"
            bindtap="{{hasPermission ? 'onResetProbabilities' : 'onLockedTap'}}"
          >
            ğŸ”„ é‡ç½®é»˜è®¤
          </button>
        </view>
        
        <view class="probability-grid">
          <view 
            class="probability-item"
            wx:for="{{lotteryConfig.prizes}}" 
            wx:key="id"
          >
            <view class="prize-info">
              <text class="prize-name">{{item.name}}</text>
              <text class="prize-type">{{item.type}}</text>
            </view>
            <view class="probability-control">
              <button 
                class="prob-btn minus"
                bindtap="{{hasPermission ? 'onAdjustProbability' : 'onLockedTap'}}"
                data-prize-id="{{item.id}}"
                data-action="minus"
              >
                âˆ’
              </button>
              <input 
                class="prob-input"
                type="number"
                value="{{item.probability}}"
                bindinput="onProbabilityInput"
                data-prize-id="{{item.id}}"
                disabled="{{!hasPermission}}"
                min="0"
                max="100"
              />
              <text class="prob-unit">%</text>
              <button 
                class="prob-btn plus"
                bindtap="{{hasPermission ? 'onAdjustProbability' : 'onLockedTap'}}"
                data-prize-id="{{item.id}}"
                data-action="plus"
              >
                +
              </button>
            </view>
          </view>
        </view>
        
        <!-- æ¦‚ç‡æ€»å’Œæ£€æŸ¥ -->
        <view class="probability-summary">
          <view class="total-probability {{probabilityTotal === 100 ? 'valid' : 'invalid'}}">
            <text class="total-label">æ€»æ¦‚ç‡ï¼š</text>
            <text class="total-value">{{probabilityTotal}}%</text>
            <text class="total-status">{{probabilityTotal === 100 ? 'âœ… æœ‰æ•ˆ' : 'âŒ å¿…é¡»ç­‰äº100%'}}</text>
          </view>
          <button 
            class="save-probability-btn {{probabilityTotal === 100 ? '' : 'disabled'}}"
            bindtap="{{hasPermission && probabilityTotal === 100 ? 'onSaveProbabilities' : 'onLockedTap'}}"
            disabled="{{probabilityTotal !== 100 || !hasPermission}}"
          >
            ğŸ’¾ ä¿å­˜è®¾ç½®
          </button>
        </view>
      </view>

      <!-- æ´»åŠ¨æš‚åœè®¾ç½® -->
      <view class="maintenance-section">
        <view class="section-title">
          <text>ğŸ”§ æ´»åŠ¨æš‚åœè®¾ç½®</text>
        </view>
        
        <view class="maintenance-config">
          <!-- é¢„è®¾æš‚åœæ—¶é—´æ®µ -->
          <view class="preset-maintenance">
            <text class="config-label">å¿«é€Ÿè®¾ç½®</text>
            <view class="preset-buttons">
              <button 
                class="preset-btn"
                bindtap="{{hasPermission ? 'onPresetMaintenance' : 'onLockedTap'}}"
                data-hours="1"
              >
                1å°æ—¶
              </button>
              <button 
                class="preset-btn"
                bindtap="{{hasPermission ? 'onPresetMaintenance' : 'onLockedTap'}}"
                data-hours="6"
              >
                6å°æ—¶
              </button>
              <button 
                class="preset-btn"
                bindtap="{{hasPermission ? 'onPresetMaintenance' : 'onLockedTap'}}"
                data-hours="24"
              >
                24å°æ—¶
              </button>
            </view>
          </view>

          <!-- è‡ªå®šä¹‰æš‚åœæ—¶é—´ -->
          <view class="custom-maintenance">
            <view class="time-config">
              <view class="time-item">
                <text class="time-label">å¼€å§‹æ—¶é—´</text>
                <picker 
                  mode="multiSelector"
                  range="{{maintenanceTimeRange}}"
                  value="{{maintenanceConfig.startTime}}"
                  bindchange="onMaintenanceStartTimeChange"
                  disabled="{{!hasPermission}}"
                >
                  <view class="time-picker">
                    {{maintenanceConfig.startTimeText || 'é€‰æ‹©å¼€å§‹æ—¶é—´'}}
                  </view>
                </picker>
              </view>
              
              <view class="time-item">
                <text class="time-label">ç»“æŸæ—¶é—´</text>
                <picker 
                  mode="multiSelector"
                  range="{{maintenanceTimeRange}}"
                  value="{{maintenanceConfig.endTime}}"
                  bindchange="onMaintenanceEndTimeChange"
                  disabled="{{!hasPermission}}"
                >
                  <view class="time-picker">
                    {{maintenanceConfig.endTimeText || 'é€‰æ‹©ç»“æŸæ—¶é—´'}}
                  </view>
                </picker>
              </view>
            </view>
            
            <view class="maintenance-reason">
              <text class="reason-label">æš‚åœåŸå› </text>
              <textarea 
                class="reason-input"
                value="{{maintenanceConfig.reason}}"
                placeholder="è¯·è¾“å…¥æš‚åœåŸå› ï¼ˆå¯é€‰ï¼‰"
                bindinput="onMaintenanceReasonInput"
                disabled="{{!hasPermission}}"
                maxlength="100"
              />
            </view>
            
            <button 
              class="schedule-maintenance-btn"
              bindtap="{{hasPermission ? 'onScheduleMaintenance' : 'onLockedTap'}}"
              disabled="{{!hasPermission}}"
            >
              ğŸ“… è®¾ç½®å®šæ—¶æš‚åœ
            </button>
          </view>
        </view>

        <!-- å½“å‰ç»´æŠ¤çŠ¶æ€ -->
        <view class="current-maintenance" wx:if="{{maintenanceConfig.isScheduled}}">
          <view class="maintenance-info">
            <text class="maintenance-title">â° è®¡åˆ’ç»´æŠ¤</text>
            <text class="maintenance-time">
              {{maintenanceConfig.startTimeText}} - {{maintenanceConfig.endTimeText}}
            </text>
            <text class="maintenance-reason-text" wx:if="{{maintenanceConfig.reason}}">
              åŸå› ï¼š{{maintenanceConfig.reason}}
            </text>
          </view>
          <button 
            class="cancel-maintenance-btn"
            bindtap="{{hasPermission ? 'onCancelMaintenance' : 'onLockedTap'}}"
          >
            âŒ å–æ¶ˆç»´æŠ¤
          </button>
        </view>
      </view>

      <!-- æŠ½å¥–ç»Ÿè®¡ -->
      <view class="lottery-statistics">
        <view class="section-title">
          <text>ğŸ“Š æŠ½å¥–ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-number">{{lotteryStats.todayCount}}</text>
            <text class="stat-label">ä»Šæ—¥æŠ½å¥–</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{lotteryStats.totalCount}}</text>
            <text class="stat-label">æ€»æŠ½å¥–æ¬¡æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{lotteryStats.activeUsers}}</text>
            <text class="stat-label">æ´»è·ƒç”¨æˆ·</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{lotteryStats.totalPrizes}}</text>
            <text class="stat-label">å‘æ”¾å¥–å“</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å•†å“ç®¡ç†é¡µé¢ -->
    <view class="product-tab {{!hasPermission ? 'locked' : ''}}" wx:if="{{currentTab === 'product'}}">
      <!-- å•†å“ç»Ÿè®¡ -->
      <view class="product-statistics">
        <view class="section-title">
          <text>ğŸ›ï¸ å•†å“ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item active">
            <text class="stat-number">{{productStats.activeCount}}</text>
            <text class="stat-label">åœ¨å”®å•†å“</text>
          </view>
          <view class="stat-item offline">
            <text class="stat-number">{{productStats.offlineCount}}</text>
            <text class="stat-label">å·²ä¸‹æ¶</text>
          </view>
          <view class="stat-item low-stock">
            <text class="stat-number">{{productStats.lowStockCount}}</text>
            <text class="stat-label">åº“å­˜ä¸è¶³</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{productStats.totalCount}}</text>
            <text class="stat-label">æ€»è®¡</text>
          </view>
        </view>
      </view>

      <!-- å•†å“æ“ä½œå·¥å…·æ  -->
      <view class="product-toolbar">
        <button class="tool-btn add-btn" bindtap="{{hasPermission ? 'onAddProduct' : 'onLockedTap'}}">
          â• æ–°å¢å•†å“
        </button>
        <button class="tool-btn batch-edit-btn" bindtap="{{hasPermission ? 'onBatchEdit' : 'onLockedTap'}}">
          ğŸ“ æ‰¹é‡ç¼–è¾‘
        </button>
        <button class="tool-btn select-all-btn" bindtap="{{hasPermission ? 'onSelectAllProducts' : 'onLockedTap'}}">
          ğŸ“‹ å…¨é€‰
        </button>
        <button class="tool-btn refresh-btn" bindtap="{{hasPermission ? 'refreshProducts' : 'onLockedTap'}}">
          ğŸ”„ åˆ·æ–°
        </button>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="product-list-section">
        <view class="section-title">
          <text>ğŸ“¦ å•†å“åˆ—è¡¨ ({{productList.length}}/20)</text>
        </view>
        
        <view class="product-list">
          <view 
            class="product-item {{item.selected ? 'selected' : ''}}"
            wx:for="{{productList}}" 
            wx:key="id"
          >
            <!-- é€‰æ‹©æ¡† -->
            <view class="product-select">
              <checkbox 
                checked="{{item.selected}}"
                bindchange="{{hasPermission ? 'onProductSelect' : 'onLockedTap'}}"
                data-id="{{item.id}}"
              />
            </view>

            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image-container">
              <image 
                class="product-image" 
                src="{{item.image}}" 
                mode="aspectFill"
              />
              <view class="product-status {{item.status === 'active' ? 'active' : 'offline'}}">
                {{item.status === 'active' ? 'åœ¨å”®' : 'ä¸‹æ¶'}}
              </view>
              <view class="product-hot" wx:if="{{item.is_hot}}">ğŸ”¥</view>
            </view>

            <!-- å•†å“ä¿¡æ¯ -->
            <view class="product-info">
              <view class="product-name">{{item.name}}</view>
              <view class="product-desc">{{item.description}}</view>
              <view class="product-category">{{item.category || 'å®ç‰©å•†å“'}}</view>
              <view class="product-price">
                <text class="price-icon">ğŸ’°</text>
                <text class="price-text">{{item.exchange_points}}ç§¯åˆ†</text>
              </view>
              <view class="product-stock {{item.stock <= 5 ? 'low-stock' : ''}}">
                <text class="stock-label">åº“å­˜ï¼š</text>
                <text class="stock-value">{{item.stock}}ä»¶</text>
              </view>
            </view>

            <!-- å•†å“æ“ä½œ -->
            <view class="product-actions">
              <button 
                class="product-btn edit-btn"
                bindtap="{{hasPermission ? 'onEditProduct' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                âœï¸ ç¼–è¾‘
              </button>
              <button 
                class="product-btn stock-btn"
                bindtap="{{hasPermission ? 'onManageStock' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                ğŸ“¦ è°ƒåº“å­˜
              </button>
              <button 
                class="product-btn toggle-btn {{item.status === 'active' ? 'offline' : 'online'}}"
                bindtap="{{hasPermission ? 'onToggleStatus' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                {{item.status === 'active' ? 'ğŸ“´ ä¸‹æ¶' : 'ğŸ“± ä¸Šæ¶'}}
              </button>
              <button 
                class="product-btn delete-btn"
                bindtap="{{hasPermission ? 'onDeleteProduct' : 'onLockedTap'}}"
                data-product="{{item}}"
              >
                ğŸ—‘ï¸ åˆ é™¤
              </button>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{productList.length === 0}}">
          <view class="empty-icon">ğŸ“¦</view>
          <text class="empty-text">æš‚æ— å•†å“</text>
          <button class="empty-action-btn" bindtap="{{hasPermission ? 'onAddProduct' : 'onLockedTap'}}">
            â• æ–°å¢ç¬¬ä¸€ä¸ªå•†å“
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™éªŒè¯å¼¹çª— -->
  <auth-modal 
    visible="{{showAuthModal}}"
    title="å•†å®¶åŠŸèƒ½è§£é”"
    isFirstUse="{{isFirstUse}}"
    bind:success="onAuthSuccess"
    bind:cancel="onAuthCancel"
  />

  <!-- å•†å“æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <view class="modal-overlay product-modal" wx:if="{{showProductModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{editingProduct ? 'ç¼–è¾‘å•†å“' : 'æ–°å¢å•†å“'}}</text>
        <button class="close-btn" bindtap="onCancelProduct">âœ•</button>
      </view>
      
      <view class="modal-body">
        <scroll-view scroll-y class="form-container">
          <!-- å•†å“åç§° -->
          <view class="form-item">
            <text class="form-label">å•†å“åç§° *</text>
            <input 
              class="form-input"
              value="{{productForm.name}}"
              placeholder="è¯·è¾“å…¥å•†å“åç§°"
              bindinput="onProductNameInput"
              maxlength="50"
            />
          </view>

          <!-- å•†å“æè¿° -->
          <view class="form-item">
            <text class="form-label">å•†å“æè¿° *</text>
            <textarea 
              class="form-textarea"
              value="{{productForm.description}}"
              placeholder="è¯·è¾“å…¥å•†å“æè¿°"
              bindinput="onProductDescInput"
              maxlength="200"
            />
          </view>

          <!-- å•†å“åˆ†ç±» -->
          <view class="form-item">
            <text class="form-label">å•†å“åˆ†ç±»</text>
            <picker 
              range="{{['å®ç‰©å•†å“', 'ä¼˜æƒ åˆ¸', 'è™šæ‹Ÿç‰©å“']}}"
              value="{{productForm.category}}"
              bindchange="onProductCategoryChange"
            >
              <view class="form-input picker-input">
                {{productForm.category || 'é€‰æ‹©åˆ†ç±»'}}
              </view>
            </picker>
          </view>

          <!-- ç§¯åˆ†ä»·æ ¼ -->
          <view class="form-item">
            <text class="form-label">ç§¯åˆ†ä»·æ ¼ *</text>
            <input 
              class="form-input"
              type="number"
              value="{{productForm.exchange_points}}"
              placeholder="è¯·è¾“å…¥å…‘æ¢æ‰€éœ€ç§¯åˆ†"
              bindinput="onProductPointsInput"
            />
          </view>

          <!-- åº“å­˜æ•°é‡ -->
          <view class="form-item">
            <text class="form-label">åº“å­˜æ•°é‡ *</text>
            <input 
              class="form-input"
              type="number"
              value="{{productForm.stock}}"
              placeholder="è¯·è¾“å…¥åº“å­˜æ•°é‡"
              bindinput="onProductStockInput"
            />
          </view>

          <!-- å•†å“å›¾ç‰‡ -->
          <view class="form-item">
            <text class="form-label">å•†å“å›¾ç‰‡</text>
            <view class="image-upload-container">
              <view class="image-preview" wx:if="{{productForm.image}}">
                <image 
                  class="preview-img" 
                  src="{{productForm.image}}" 
                  mode="aspectFill"
                />
                <button class="delete-img-btn" bindtap="onDeleteProductImage">âœ•</button>
              </view>
              <button class="upload-img-btn" bindtap="onUploadProductImage" wx:else>
                ğŸ“· ä¸Šä¼ å›¾ç‰‡
              </button>
            </view>
          </view>

          <!-- æ˜¯å¦çƒ­é—¨ -->
          <view class="form-item">
            <view class="form-switch">
              <text class="form-label">è®¾ä¸ºçƒ­é—¨å•†å“</text>
              <switch 
                checked="{{productForm.is_hot}}"
                bindchange="onProductHotChange"
              />
            </view>
          </view>

          <!-- æ’åºæƒé‡ -->
          <view class="form-item">
            <text class="form-label">æ’åºæƒé‡</text>
            <input 
              class="form-input"
              type="number"
              value="{{productForm.sort_order}}"
              placeholder="æ•°å€¼è¶Šå¤§æ’åºè¶Šé å‰"
              bindinput="onProductSortInput"
            />
          </view>
        </scroll-view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="onCancelProduct">å–æ¶ˆ</button>
        <button 
          class="modal-btn confirm-btn {{productSubmitting ? 'loading' : ''}}"
          bindtap="onConfirmProduct"
          disabled="{{productSubmitting}}"
        >
          {{productSubmitting ? 'ä¿å­˜ä¸­...' : (editingProduct ? 'æ›´æ–°' : 'æ–°å¢')}}
        </button>
      </view>
    </view>
  </view>

  <!-- åº“å­˜ç®¡ç†å¼¹çª— -->
  <view class="modal-overlay stock-modal" wx:if="{{showStockModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åº“å­˜ç®¡ç† - {{currentProduct.name}}</text>
        <button class="close-btn" bindtap="onCancelStock">âœ•</button>
      </view>
      
      <view class="modal-body">
        <view class="stock-info">
          <text class="current-stock">å½“å‰åº“å­˜ï¼š{{currentProduct.stock}}ä»¶</text>
        </view>
        
        <view class="stock-adjustment">
          <text class="adjustment-label">è°ƒæ•´æ•°é‡ï¼š</text>
          <view class="quantity-controls">
            <button class="quantity-btn" bindtap="onQuantityChange" data-change="-10">-10</button>
            <button class="quantity-btn" bindtap="onQuantityChange" data-change="-1">-1</button>
            <input 
              class="quantity-input"
              type="number"
              value="{{stockAdjustment}}"
              bindinput="onStockAdjustmentInput"
            />
            <button class="quantity-btn" bindtap="onQuantityChange" data-change="1">+1</button>
            <button class="quantity-btn" bindtap="onQuantityChange" data-change="10">+10</button>
          </view>
        </view>
        
        <view class="new-stock">
          <text class="new-stock-label">è°ƒæ•´ååº“å­˜ï¼š</text>
          <text class="new-stock-value {{currentProduct.stock + stockAdjustment < 0 ? 'error' : ''}}">
            {{currentProduct.stock + stockAdjustment}}ä»¶
          </text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="onCancelStock">å–æ¶ˆ</button>
        <button class="modal-btn confirm-btn" bindtap="onConfirmStock">ç¡®è®¤è°ƒæ•´</button>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡ç¼–è¾‘å¼¹çª— -->
  <view class="modal-overlay batch-modal" wx:if="{{showBatchEditModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ‰¹é‡ç¼–è¾‘ (å·²é€‰{{selectedProducts.length}}ä¸ªå•†å“)</text>
        <button class="close-btn" bindtap="onCancelBatchEdit">âœ•</button>
      </view>
      
      <view class="modal-body">
        <view class="batch-options">
          <!-- æ‰¹é‡ä¿®æ”¹åˆ†ç±» -->
          <view class="batch-option">
            <view class="option-header">
              <checkbox 
                checked="{{batchEditForm.updateCategory}}"
                bindchange="onBatchCategoryToggle"
              />
              <text class="option-label">ä¿®æ”¹åˆ†ç±»</text>
            </view>
            <picker 
              range="{{['å®ç‰©å•†å“', 'ä¼˜æƒ åˆ¸', 'è™šæ‹Ÿç‰©å“']}}"
              value="{{batchEditForm.category}}"
              bindchange="onBatchCategoryChange"
              disabled="{{!batchEditForm.updateCategory}}"
            >
              <view class="batch-input {{!batchEditForm.updateCategory ? 'disabled' : ''}}">
                {{batchEditForm.category || 'é€‰æ‹©åˆ†ç±»'}}
              </view>
            </picker>
          </view>

          <!-- æ‰¹é‡è°ƒæ•´ç§¯åˆ† -->
          <view class="batch-option">
            <view class="option-header">
              <checkbox 
                checked="{{batchEditForm.updatePoints}}"
                bindchange="onBatchPointsToggle"
              />
              <text class="option-label">è°ƒæ•´ç§¯åˆ†ä»·æ ¼</text>
            </view>
            <view class="adjustment-controls">
              <input 
                class="batch-input {{!batchEditForm.updatePoints ? 'disabled' : ''}}"
                type="number"
                value="{{batchEditForm.pointsAdjustment}}"
                placeholder="è°ƒæ•´æ•°é‡ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰"
                bindinput="onBatchPointsInput"
                disabled="{{!batchEditForm.updatePoints}}"
              />
            </view>
          </view>

          <!-- æ‰¹é‡è°ƒæ•´åº“å­˜ -->
          <view class="batch-option">
            <view class="option-header">
              <checkbox 
                checked="{{batchEditForm.updateStock}}"
                bindchange="onBatchStockToggle"
              />
              <text class="option-label">è°ƒæ•´åº“å­˜</text>
            </view>
            <view class="adjustment-controls">
              <input 
                class="batch-input {{!batchEditForm.updateStock ? 'disabled' : ''}}"
                type="number"
                value="{{batchEditForm.stockAdjustment}}"
                placeholder="è°ƒæ•´æ•°é‡ï¼ˆæ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘ï¼‰"
                bindinput="onBatchStockInput"
                disabled="{{!batchEditForm.updateStock}}"
              />
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="onCancelBatchEdit">å–æ¶ˆ</button>
        <button class="modal-btn confirm-btn" bindtap="onConfirmBatchEdit">åº”ç”¨æ›´æ”¹</button>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸å¼¹çª— -->
  <view class="modal-overlay review-modal" wx:if="{{showReviewModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">
          {{reviewAction === 'approve' ? 'é€šè¿‡å®¡æ ¸' : 'æ‹’ç»å®¡æ ¸'}}
        </text>
        <button class="close-btn" bindtap="onCancelReview">âœ•</button>
      </view>
      
      <view class="modal-body">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="review-user-info">
          <text class="user-phone">{{currentReview.user_phone}}</text>
          <text class="upload-time">{{currentReview.upload_time}}</text>
        </view>
        
        <!-- å°ç¥¨é¢„è§ˆ -->
        <view class="review-image">
          <image 
            class="receipt-preview" 
            src="{{currentReview.image_url}}" 
            mode="aspectFit"
          />
        </view>
        
        <!-- é‡‘é¢ä¿¡æ¯ -->
        <view class="review-amount">
          <text class="amount-text">æ¶ˆè´¹é‡‘é¢ï¼šÂ¥{{currentReview.amount}}</text>
          <text class="expected-points">å»ºè®®ç§¯åˆ†ï¼š{{currentReview.expected_points}}åˆ†</text>
        </view>
        
        <!-- å®¡æ ¸è¡¨å• -->
        <view class="review-form">
          <!-- é€šè¿‡å®¡æ ¸ - ç§¯åˆ†è¾“å…¥ -->
          <view class="form-item" wx:if="{{reviewAction === 'approve'}}">
            <text class="form-label">å®é™…ç»™äºˆç§¯åˆ† *</text>
            <input 
              class="form-input"
              type="number"
              value="{{reviewPoints}}"
              placeholder="è¯·è¾“å…¥å®é™…ç»™äºˆçš„ç§¯åˆ†"
              bindinput="onPointsInput"
            />
          </view>
          
          <!-- æ‹’ç»å®¡æ ¸ - ç†ç”±è¾“å…¥ -->
          <view class="form-item" wx:if="{{reviewAction === 'reject'}}">
            <text class="form-label">æ‹’ç»ç†ç”± *</text>
            <textarea 
              class="form-textarea"
              value="{{reviewReason}}"
              placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±"
              bindinput="onReasonInput"
              maxlength="200"
            />
          </view>
          
          <!-- å¯é€‰å¤‡æ³¨ -->
          <view class="form-item">
            <text class="form-label">å¤‡æ³¨è¯´æ˜</text>
            <textarea 
              class="form-textarea"
              value="{{reviewReason}}"
              placeholder="å¯é€‰çš„å®¡æ ¸å¤‡æ³¨"
              bindinput="onReasonInput"
              maxlength="200"
            />
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel-btn" bindtap="onCancelReview">å–æ¶ˆ</button>
        <button 
          class="modal-btn confirm-btn {{reviewAction === 'approve' ? 'approve' : 'reject'}}"
          bindtap="onConfirmReview"
        >
          {{reviewAction === 'approve' ? 'âœ… ç¡®è®¤é€šè¿‡' : 'âŒ ç¡®è®¤æ‹’ç»'}}
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>