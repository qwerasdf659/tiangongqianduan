<!--pages/merchant/merchant.wxml-->
<view class="merchant-container">
  <!-- éå•†å®¶ç”¨æˆ· - æƒé™ç”³è¯· -->
  <view class="auth-request" wx:if="{{!isMerchant && !loading}}">
    <view class="auth-card">
      <view class="auth-icon">ğŸª</view>
      <text class="auth-title">ç”³è¯·å•†å®¶æƒé™</text>
      <text class="auth-desc">æˆä¸ºå•†å®¶åï¼Œæ‚¨å¯ä»¥å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨å¹¶ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
      
      <view class="auth-features">
        <view class="feature-item">
          <text class="feature-icon">âœ…</text>
          <text class="feature-text">å®¡æ ¸å°ç¥¨ä¸Šä¼ </text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ’°</text>
          <text class="feature-text">ç®¡ç†ç§¯åˆ†å‘æ”¾</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“Š</text>
          <text class="feature-text">æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ“</text>
          <text class="feature-text">è”ç³»ç”¨æˆ·</text>
        </view>
        <view class="feature-item">
          <text class="feature-icon">ğŸ›ï¸</text>
          <text class="feature-text">å•†å“ç®¡ç†</text>
        </view>
      </view>
      
      <button class="auth-btn" bindtap="onRequestAuth">
        ç”³è¯·å•†å®¶æƒé™
      </button>
    </view>
  </view>

  <!-- å•†å®¶ç®¡ç†ç•Œé¢ -->
  <view class="merchant-main" wx:if="{{isMerchant && !loading}}">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="header">
      <view class="user-info">
        <text class="welcome">ğŸª å•†å®¶ç®¡ç†</text>
        <text class="merchant-badge">å•†å®¶</text>
      </view>
    </view>

    <!-- ç®¡ç†é€‰é¡¹å¡ -->
    <view class="tab-bar">
      <view 
        class="tab-item {{currentTab === 'review' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="review"
      >
        ğŸ“‹ å®¡æ ¸ç®¡ç†
      </view>
      <view 
        class="tab-item {{currentTab === 'product' ? 'active' : ''}}"
        bindtap="onTabChange"
        data-tab="product"
      >
        ğŸ›ï¸ å•†å“ç®¡ç†
      </view>
    </view>

    <!-- å®¡æ ¸ç®¡ç†é¡µé¢ -->
    <view class="review-tab" wx:if="{{currentTab === 'review'}}">
      <!-- å®¡æ ¸ç»Ÿè®¡ -->
      <view class="statistics-section">
        <view class="section-title">
          <text>ğŸ“Š å®¡æ ¸ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item pending">
            <text class="stat-number">{{statistics.pendingCount}}</text>
            <text class="stat-label">å¾…å®¡æ ¸</text>
          </view>
          <view class="stat-item approved">
            <text class="stat-number">{{statistics.todayApproved}}</text>
            <text class="stat-label">ä»Šæ—¥é€šè¿‡</text>
          </view>
          <view class="stat-item rejected">
            <text class="stat-number">{{statistics.todayRejected}}</text>
            <text class="stat-label">ä»Šæ—¥æ‹’ç»</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{statistics.totalProcessed}}</text>
            <text class="stat-label">ç´¯è®¡å¤„ç†</text>
          </view>
        </view>
      </view>

      <!-- æ“ä½œå·¥å…·æ  -->
      <view class="toolbar">
        <button class="tool-btn refresh-btn" bindtap="refreshData">
          ğŸ”„ åˆ·æ–°
        </button>
        <button class="tool-btn batch-btn" bindtap="onBatchOperation">
          ğŸ“ æ‰¹é‡æ“ä½œ
        </button>
      </view>

      <!-- å¾…å®¡æ ¸åˆ—è¡¨ -->
      <view class="pending-section">
        <view class="section-title">
          <text>ğŸ“‹ å¾…å®¡æ ¸åˆ—è¡¨ ({{pendingList.length}})</text>
        </view>
        
        <view class="pending-list">
          <view 
            class="pending-item"
            wx:for="{{pendingList}}" 
            wx:key="id"
          >
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <view class="item-header">
              <view class="user-info">
                <text class="user-phone">{{item.user_phone}}</text>
                <text class="user-id">ID: {{item.user_id}}</text>
              </view>
              <view class="upload-time">
                <text class="time-label">ä¸Šä¼ æ—¶é—´</text>
                <text class="time-value">{{item.upload_time}}</text>
              </view>
            </view>

            <!-- å°ç¥¨ä¿¡æ¯ -->
            <view class="item-content">
              <image 
                class="receipt-image" 
                src="{{item.image_url}}" 
                mode="aspectFill"
                bindtap="onPreviewImage"
                data-url="{{item.image_url}}"
              />
              <view class="receipt-info">
                <view class="amount-info">
                  <text class="amount-label">æ¶ˆè´¹é‡‘é¢ï¼š</text>
                  <text class="amount-value">{{item.amount}}å…ƒ</text>
                </view>
                <view class="points-info">
                  <text class="points-label">é¢„è®¡ç§¯åˆ†ï¼š</text>
                  <text class="points-value">{{item.expected_points}}åˆ†</text>
                </view>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="item-actions">
              <button 
                class="action-btn contact-btn"
                bindtap="onContactUser"
                data-phone="{{item.user_phone}}"
              >
                ğŸ“ è”ç³»
              </button>
              <button 
                class="action-btn reject-btn"
                bindtap="onStartReview"
                data-item="{{item}}"
                data-action="reject"
              >
                âŒ æ‹’ç»
              </button>
              <button 
                class="action-btn approve-btn"
                bindtap="onStartReview"
                data-item="{{item}}"
                data-action="approve"
              >
                âœ… é€šè¿‡
              </button>
            </view>
          </view>

          <!-- åˆ—è¡¨ä¸ºç©º -->
          <view class="empty-list" wx:if="{{pendingList.length === 0}}">
            <view class="empty-icon">ğŸ“‹</view>
            <text class="empty-text">æš‚æ— å¾…å®¡æ ¸é¡¹ç›®</text>
            <button class="refresh-btn" bindtap="refreshData">åˆ·æ–°æ•°æ®</button>
          </view>
        </view>
      </view>
    </view>

    <!-- å•†å“ç®¡ç†é¡µé¢ -->
    <view class="product-tab" wx:if="{{currentTab === 'product'}}">
      <!-- å•†å“ç»Ÿè®¡ -->
      <view class="product-statistics">
        <view class="section-title">
          <text>ğŸ›ï¸ å•†å“ç»Ÿè®¡</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item active">
            <text class="stat-number">{{productStats.activeCount}}</text>
            <text class="stat-label">åœ¨å”®å•†å“</text>
          </view>
          <view class="stat-item offline">
            <text class="stat-number">{{productStats.offlineCount}}</text>
            <text class="stat-label">å·²ä¸‹æ¶</text>
          </view>
          <view class="stat-item low-stock">
            <text class="stat-number">{{productStats.lowStockCount}}</text>
            <text class="stat-label">åº“å­˜ä¸è¶³</text>
          </view>
          <view class="stat-item total">
            <text class="stat-number">{{productStats.totalCount}}</text>
            <text class="stat-label">æ€»è®¡</text>
          </view>
        </view>
      </view>

      <!-- å•†å“æ“ä½œå·¥å…·æ  -->
      <view class="product-toolbar">
        <button class="tool-btn add-btn" bindtap="onAddProduct">
          â• æ–°å¢å•†å“
        </button>
        <button class="tool-btn batch-edit-btn" bindtap="onBatchEdit">
          ğŸ“ æ‰¹é‡ç¼–è¾‘
        </button>
        <button class="tool-btn refresh-btn" bindtap="refreshProducts">
          ğŸ”„ åˆ·æ–°
        </button>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="product-list-section">
        <view class="section-title">
          <text>ğŸ“¦ å•†å“åˆ—è¡¨ ({{productList.length}}/20)</text>
        </view>
        
        <view class="product-list">
          <view 
            class="product-item"
            wx:for="{{productList}}" 
            wx:key="id"
          >
            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image-container">
              <image 
                class="product-image" 
                src="{{item.image}}" 
                mode="aspectFill"
              />
              <view class="product-status {{item.status === 'active' ? 'active' : 'offline'}}">
                {{item.status === 'active' ? 'åœ¨å”®' : 'ä¸‹æ¶'}}
              </view>
            </view>

            <!-- å•†å“ä¿¡æ¯ -->
            <view class="product-info">
              <view class="product-name">{{item.name}}</view>
              <view class="product-desc">{{item.description}}</view>
              <view class="product-price">
                <text class="price-icon">ğŸ’°</text>
                <text class="price-text">{{item.exchange_points}}ç§¯åˆ†</text>
              </view>
              <view class="product-stock {{item.stock <= 5 ? 'low-stock' : ''}}">
                <text class="stock-label">åº“å­˜ï¼š</text>
                <text class="stock-value">{{item.stock}}ä»¶</text>
              </view>
            </view>

            <!-- æ“ä½œæŒ‰é’® -->
            <view class="product-actions">
              <button 
                class="product-btn edit-btn"
                bindtap="onEditProduct"
                data-product="{{item}}"
              >
                âœï¸ ç¼–è¾‘
              </button>
              <button 
                class="product-btn stock-btn"
                bindtap="onManageStock"
                data-product="{{item}}"
              >
                ğŸ“¦ åº“å­˜
              </button>
              <button 
                class="product-btn status-btn {{item.status === 'active' ? 'offline' : 'online'}}"
                bindtap="onToggleStatus"
                data-product="{{item}}"
              >
                {{item.status === 'active' ? 'ğŸ”½ ä¸‹æ¶' : 'ğŸ”¼ ä¸Šæ¶'}}
              </button>
              <button 
                class="product-btn delete-btn"
                bindtap="onDeleteProduct"
                data-product="{{item}}"
              >
                ğŸ—‘ï¸ åˆ é™¤
              </button>
            </view>
          </view>

          <!-- å•†å“åˆ—è¡¨ä¸ºç©º -->
          <view class="empty-products" wx:if="{{productList.length === 0}}">
            <view class="empty-icon">ğŸ›ï¸</view>
            <text class="empty-text">æš‚æ— å•†å“</text>
            <button class="add-product-btn" bindtap="onAddProduct">æ·»åŠ ç¬¬ä¸€ä¸ªå•†å“</button>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™ç”³è¯·å¼¹çª— -->
  <view class="auth-modal" wx:if="{{showAuthModal}}">
    <view class="modal-mask" bindtap="onCancelAuth"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·å•†å®¶æƒé™</text>
        <view class="close-btn" bindtap="onCancelAuth">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="confirm-text">
          ç”³è¯·æˆä¸ºå•†å®¶åï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹æƒé™ï¼š
        </view>
        <view class="permission-list">
          <view class="permission-item">â€¢ å®¡æ ¸ç”¨æˆ·ä¸Šä¼ çš„å°ç¥¨</view>
          <view class="permission-item">â€¢ å†³å®šç§¯åˆ†å‘æ”¾æ•°é‡</view>
          <view class="permission-item">â€¢ æŸ¥çœ‹å®¡æ ¸ç»Ÿè®¡æ•°æ®</view>
          <view class="permission-item">â€¢ è”ç³»ç›¸å…³ç”¨æˆ·</view>
        </view>
        <view class="warning-text">
          è¯·ç¡®ä¿æ‚¨æœ‰è¶³å¤Ÿçš„æ—¶é—´å¤„ç†å®¡æ ¸äº‹åŠ¡
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelAuth">å–æ¶ˆ</button>
        <button 
          class="confirm-btn {{authRequesting ? 'loading' : ''}}"
          disabled="{{authRequesting}}"
          bindtap="onConfirmAuth"
        >
          {{authRequesting ? 'ç”³è¯·ä¸­...' : 'ç¡®è®¤ç”³è¯·'}}
        </button>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸æ“ä½œå¼¹çª— -->
  <view class="review-modal" wx:if="{{showReviewModal}}">
    <view class="modal-mask" bindtap="onCancelReview"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">
          {{reviewAction === 'approve' ? 'å®¡æ ¸é€šè¿‡' : 'å®¡æ ¸æ‹’ç»'}}
        </text>
        <view class="close-btn" bindtap="onCancelReview">Ã—</view>
      </view>
      
      <view class="modal-body" wx:if="{{currentReview}}">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="review-info">
          <text class="info-label">ç”¨æˆ·ï¼š</text>
          <text class="info-value">{{currentReview.user_phone}}</text>
        </view>
        <view class="review-info">
          <text class="info-label">é‡‘é¢ï¼š</text>
          <text class="info-value">{{currentReview.amount}}å…ƒ</text>
        </view>

        <!-- å®¡æ ¸é€šè¿‡ - ç§¯åˆ†è¾“å…¥ -->
        <view class="input-section" wx:if="{{reviewAction === 'approve'}}">
          <text class="input-label">å‘æ”¾ç§¯åˆ†ï¼š</text>
          <input 
            class="points-input"
            type="number"
            placeholder="è¯·è¾“å…¥ç§¯åˆ†æ•°é‡"
            value="{{reviewPoints}}"
            bindinput="onPointsInput"
          />
          <text class="input-tips">å»ºè®®ï¼š{{currentReview.expected_points}}åˆ†</text>
        </view>

        <!-- å®¡æ ¸æ‹’ç» - ç†ç”±è¾“å…¥ -->
        <view class="input-section" wx:if="{{reviewAction === 'reject'}}">
          <text class="input-label">æ‹’ç»ç†ç”±ï¼š</text>
          <textarea 
            class="reason-input"
            placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼Œç”¨æˆ·å°†æ”¶åˆ°æ­¤ä¿¡æ¯"
            value="{{reviewReason}}"
            bindinput="onReasonInput"
            maxlength="200"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelReview">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="onConfirmReview">
          ç¡®è®¤{{reviewAction === 'approve' ? 'é€šè¿‡' : 'æ‹’ç»'}}
        </button>
      </view>
    </view>
  </view>

  <!-- æ–°å¢/ç¼–è¾‘å•†å“å¼¹çª— -->
  <view class="product-modal" wx:if="{{showProductModal}}">
    <view class="modal-mask" bindtap="onCancelProduct"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{editingProduct ? 'ç¼–è¾‘å•†å“' : 'æ–°å¢å•†å“'}}</text>
        <view class="close-btn" bindtap="onCancelProduct">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- å•†å“åç§° -->
        <view class="form-item">
          <text class="form-label">å•†å“åç§°ï¼š</text>
          <input 
            class="form-input"
            placeholder="è¯·è¾“å…¥å•†å“åç§°"
            value="{{productForm.name}}"
            bindinput="onProductNameInput"
          />
        </view>

        <!-- å•†å“æè¿° -->
        <view class="form-item">
          <text class="form-label">å•†å“æè¿°ï¼š</text>
          <textarea 
            class="form-textarea"
            placeholder="è¯·è¾“å…¥å•†å“æè¿°"
            value="{{productForm.description}}"
            bindinput="onProductDescInput"
          />
        </view>

        <!-- å…‘æ¢ç§¯åˆ† -->
        <view class="form-item">
          <text class="form-label">å…‘æ¢ç§¯åˆ†ï¼š</text>
          <input 
            class="form-input"
            type="number"
            placeholder="è¯·è¾“å…¥å…‘æ¢æ‰€éœ€ç§¯åˆ†"
            value="{{productForm.exchange_points}}"
            bindinput="onProductPointsInput"
          />
        </view>

        <!-- åº“å­˜æ•°é‡ -->
        <view class="form-item">
          <text class="form-label">åº“å­˜æ•°é‡ï¼š</text>
          <input 
            class="form-input"
            type="number"
            placeholder="è¯·è¾“å…¥åº“å­˜æ•°é‡"
            value="{{productForm.stock}}"
            bindinput="onProductStockInput"
          />
        </view>

        <!-- å•†å“å›¾ç‰‡ -->
        <view class="form-item">
          <text class="form-label">å•†å“å›¾ç‰‡ï¼š</text>
          <view class="image-upload-container">
            <view class="image-preview" wx:if="{{productForm.image}}">
              <image class="preview-img" src="{{productForm.image}}" mode="aspectFill"/>
              <button class="delete-img-btn" bindtap="onDeleteProductImage">åˆ é™¤</button>
            </view>
            <button class="upload-img-btn" wx:else bindtap="onUploadProductImage">
              ğŸ“· ä¸Šä¼ å›¾ç‰‡
            </button>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelProduct">å–æ¶ˆ</button>
        <button 
          class="confirm-btn {{productSubmitting ? 'loading' : ''}}"
          disabled="{{productSubmitting}}"
          bindtap="onConfirmProduct"
        >
          {{productSubmitting ? 'ä¿å­˜ä¸­...' : 'ç¡®è®¤ä¿å­˜'}}
        </button>
      </view>
    </view>
  </view>

  <!-- åº“å­˜ç®¡ç†å¼¹çª— -->
  <view class="stock-modal" wx:if="{{showStockModal}}">
    <view class="modal-mask" bindtap="onCancelStock"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åº“å­˜ç®¡ç†</text>
        <view class="close-btn" bindtap="onCancelStock">Ã—</view>
      </view>
      
      <view class="modal-body" wx:if="{{currentProduct}}">
        <view class="product-info">
          <text class="product-name">{{currentProduct.name}}</text>
          <text class="current-stock">å½“å‰åº“å­˜ï¼š{{currentProduct.stock}}ä»¶</text>
        </view>

        <view class="stock-operations">
          <view class="operation-item">
            <text class="operation-label">è°ƒæ•´æ•°é‡ï¼š</text>
            <view class="quantity-controls">
              <button class="quantity-btn minus" bindtap="onQuantityChange" data-change="-1">-</button>
              <input 
                class="quantity-input"
                type="number"
                value="{{stockAdjustment}}"
                bindinput="onStockAdjustmentInput"
              />
              <button class="quantity-btn plus" bindtap="onQuantityChange" data-change="1">+</button>
            </view>
          </view>

          <view class="operation-item">
            <text class="operation-label">è°ƒæ•´ååº“å­˜ï¼š</text>
            <text class="new-stock">{{currentProduct.stock + stockAdjustment}}ä»¶</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="onCancelStock">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="onConfirmStock">ç¡®è®¤è°ƒæ•´</button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>