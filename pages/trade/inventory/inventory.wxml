<!-- pages/trade/inventory/inventory.wxml - æˆ‘çš„åº“å­˜é¡µé¢æ¨¡æ¿ -->
<view class="inventory-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="user-info">
      <text class="welcome">ğŸ“¦ æˆ‘çš„åº“å­˜</text>
      <view class="points-info">
        <text class="points-label">å½“å‰ç§¯åˆ†ï¼š</text>
        <text class="points-value">{{totalPoints}}</text>
      </view>
    </view>
    
    <!-- åº“å­˜ç»Ÿè®¡ -->
    <view class="stats-bar">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">æ€»è®¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.available}}</text>
        <text class="stat-label">å¯ç”¨</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.for_sale}}</text>
        <text class="stat-label">ä¸Šæ¶ä¸­</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.sold}}</text>
        <text class="stat-label">å·²å”®å‡º</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="search-filter-bar">
    <view class="search-box">
      <icon class="search-icon" type="search" size="16" color="#999" />
      <input 
        class="search-input" 
        placeholder="æœç´¢å•†å“..." 
        value="{{searchKeyword}}" 
        bindinput="onSearchInput"
        confirm-type="search"
      />
      <view class="clear-search" wx:if="{{searchKeyword}}" bindtap="onClearSearch">
        <icon type="clear" size="14" />
      </view>
    </view>
    <view class="edit-button" bindtap="onToggleEditMode">
      <text>{{editMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
    </view>
  </view>

  <!-- çŠ¶æ€ç­›é€‰ -->
  <view class="status-filter">
    <scroll-view class="filter-scroll" scroll-x>
      <view class="filter-list">
        <text 
          class="filter-item {{currentStatus === 'all' ? 'active' : ''}}"
          bindtap="onStatusFilter"
          data-status="all"
        >å…¨éƒ¨</text>
        <text 
          class="filter-item {{currentStatus === 'available' ? 'active' : ''}}"
          bindtap="onStatusFilter"
          data-status="available"
        >å¯ç”¨</text>
        <text 
          class="filter-item {{currentStatus === 'for_sale' ? 'active' : ''}}"
          bindtap="onStatusFilter"
          data-status="for_sale"
        >ä¸Šæ¶ä¸­</text>
        <text 
          class="filter-item {{currentStatus === 'sold' ? 'active' : ''}}"
          bindtap="onStatusFilter"
          data-status="sold"
        >å·²å”®å‡º</text>
        <text 
          class="filter-item {{currentStatus === 'used' ? 'active' : ''}}"
          bindtap="onStatusFilter"
          data-status="used"
        >å·²ä½¿ç”¨</text>
      </view>
    </scroll-view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view class="batch-actions" wx:if="{{editMode}}">
    <view class="select-info">
      <button class="select-all-btn" bindtap="onSelectAll">
        {{selectedItems.length === filteredInventory.length && filteredInventory.length > 0 ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
      <text class="select-count">å·²é€‰æ‹© {{selectedItems.length}} ä»¶</text>
    </view>
    <view class="action-buttons">
      <button class="batch-btn" bindtap="onBatchPublish" disabled="{{selectedItems.length === 0}}">
        æ‰¹é‡å‘å¸ƒ
      </button>
      <button class="batch-btn" bindtap="onBatchUse" disabled="{{selectedItems.length === 0}}">
        æ‰¹é‡ä½¿ç”¨
      </button>
    </view>
  </view>

  <!-- åº“å­˜å•†å“åˆ—è¡¨ -->
  <view class="inventory-list" wx:if="{{!loading}}">
    <view 
      class="inventory-item {{editMode ? 'edit-mode' : ''}}"
      wx:for="{{filteredInventory}}" 
      wx:key="inventory_id"
      bindtap="onInventoryItemTap"
      data-item="{{item}}"
    >
      <!-- ç¼–è¾‘æ¨¡å¼é€‰æ‹©æ¡† -->
      <view class="select-checkbox" wx:if="{{editMode}}" 
            bindtap="onItemSelect" 
            data-id="{{item.inventory_id}}"
            catchtap="">
        <icon 
          type="{{selectedItems.indexOf(item.inventory_id) > -1 ? 'success' : 'circle'}}" 
          size="18" 
          color="{{selectedItems.indexOf(item.inventory_id) > -1 ? '#FF6B35' : '#ccc'}}"
        />
      </view>

      <!-- å•†å“å›¾ç‰‡ -->
      <view class="item-image-wrapper">
        <image 
          class="item-image" 
          src="{{item.commodity.image}}" 
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-url="{{item.commodity.image}}"
          catchtap=""
        />
        <view class="status-badge status-{{item.status}}">
          {{item.status === 'available' ? 'å¯ç”¨' : 
            item.status === 'for_sale' ? 'ä¸Šæ¶ä¸­' : 
            item.status === 'sold' ? 'å·²å”®å‡º' : 'å·²ä½¿ç”¨'}}
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="item-details">
        <view class="item-header">
          <text class="item-name">{{item.commodity.name}}</text>
          <text class="item-category">{{item.commodity.category}}</text>
        </view>
        
        <view class="item-meta">
          <text class="obtained-date">è·å¾—æ—¶é—´ï¼š{{item.obtained_at}}</text>
          <text class="original-points">åŸä»·ï¼š{{item.commodity.exchange_points}}ç§¯åˆ†</text>
        </view>

        <!-- äº¤æ˜“ä¿¡æ¯ï¼ˆå¦‚æœå·²ä¸Šæ¶ï¼‰ -->
        <view class="trade-info" wx:if="{{item.status === 'for_sale' && item.trade_info}}">
          <text class="trade-price">å”®ä»·ï¼š{{item.trade_info.price_points}}ç§¯åˆ†</text>
          <text class="trade-views">{{item.trade_info.view_count}}æ¬¡æµè§ˆ</text>
        </view>

        <!-- å”®å‡ºä¿¡æ¯ -->
        <view class="sold-info" wx:if="{{item.status === 'sold' && item.sold_info}}">
          <text class="sold-price">å·²å”®å‡ºï¼š{{item.sold_info.price_points}}ç§¯åˆ†</text>
          <text class="sold-date">{{item.sold_info.sold_at}}</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="item-actions" wx:if="{{!editMode}}">
        <!-- å¯ç”¨çŠ¶æ€çš„æ“ä½œ -->
        <view wx:if="{{item.status === 'available'}}">
          <button 
            class="action-btn publish-btn"
            bindtap="onPublishTradeTap"
            data-item="{{item}}"
            catchtap=""
          >
            å‘å¸ƒäº¤æ˜“
          </button>
          <button 
            class="action-btn use-btn"
            bindtap="onUseItem"
            data-item="{{item}}"
            catchtap=""
          >
            ä½¿ç”¨
          </button>
        </view>
        
        <!-- ä¸Šæ¶ä¸­çŠ¶æ€çš„æ“ä½œ -->
        <view wx:if="{{item.status === 'for_sale'}}">
          <button 
            class="action-btn market-btn"
            bindtap="onGoToMarket"
            catchtap=""
          >
            æŸ¥çœ‹å¸‚åœº
          </button>
        </view>
        
        <!-- å…¶ä»–çŠ¶æ€æ˜¾ç¤º -->
        <view wx:if="{{item.status === 'sold' || item.status === 'used'}}">
          <text class="status-text">
            {{item.status === 'sold' ? 'å·²å”®å‡º' : 'å·²ä½¿ç”¨'}}
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-item" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
      <view class="loading-image"></view>
      <view class="loading-content">
        <view class="loading-line long"></view>
        <view class="loading-line short"></view>
        <view class="loading-line medium"></view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && filteredInventory.length === 0}}">
    <image src="/images/empty-inventory.png" class="empty-image" />
    <text class="empty-text">æš‚æ— åº“å­˜å•†å“</text>
    <text class="empty-hint">
      {{searchKeyword ? 'è¯•è¯•å…¶ä»–æœç´¢è¯' : 'å¿«å»å…‘æ¢å•†å“ä¸°å¯Œåº“å­˜å§'}}
    </text>
    <button class="empty-action" wx:if="{{!searchKeyword}}" bindtap="onGoToExchange">
      å»å•†å“å…‘æ¢
    </button>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore && !loading}}">
    <view class="load-more-text" wx:if="{{!loadingMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</view>
    <view class="load-more-loading" wx:if="{{loadingMore}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>

<!-- å‘å¸ƒäº¤æ˜“å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showPublishModal}}" bindtap="onCancelPublish">
  <view class="publish-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">å‘å¸ƒäº¤æ˜“</text>
      <icon class="close-icon" type="cancel" bindtap="onCancelPublish" />
    </view>

    <view class="modal-content" wx:if="{{selectedInventory}}">
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="publish-product">
        <image class="product-image" src="{{selectedInventory.commodity.image}}" />
        <view class="product-info">
          <text class="product-name">{{selectedInventory.commodity.name}}</text>
          <text class="product-category">{{selectedInventory.commodity.category}}</text>
          <text class="original-price">åŸä»·ï¼š{{selectedInventory.commodity.exchange_points}}ç§¯åˆ†</text>
        </view>
      </view>

      <!-- ä»·æ ¼è®¾ç½® -->
      <view class="form-section">
        <text class="form-label">å”®ä»·è®¾ç½®</text>
        <view class="price-input-wrapper">
          <input 
            class="price-input"
            type="number"
            placeholder="è¾“å…¥å”®ä»·"
            value="{{publishForm.pricePoints}}"
            bindinput="onPublishFormInput"
            data-field="pricePoints"
          />
          <text class="price-unit">ç§¯åˆ†</text>
        </view>
        <text class="price-hint">å»ºè®®ä»·æ ¼ï¼š{{Math.floor(selectedInventory.commodity.exchange_points * 0.6)}} - {{Math.floor(selectedInventory.commodity.exchange_points * 0.9)}}ç§¯åˆ†</text>
      </view>

      <!-- å•†å“æè¿° -->
      <view class="form-section">
        <text class="form-label">å•†å“æè¿°</text>
        <textarea 
          class="description-input"
          placeholder="æè¿°å•†å“çŠ¶å†µã€ä½¿ç”¨æƒ…å†µç­‰"
          value="{{publishForm.description}}"
          bindinput="onPublishFormInput"
          data-field="description"
          maxlength="200"
        />
        <text class="input-count">{{publishForm.description.length}}/200</text>
      </view>

      <!-- äº¤æ˜“è®¾ç½® -->
      <view class="form-section">
        <view class="setting-item">
          <text class="setting-label">è‡ªåŠ¨æ¥å—äº¤æ˜“</text>
          <switch 
            class="setting-switch"
            checked="{{publishForm.autoAccept}}"
            bindchange="onAutoAcceptSwitch"
          />
        </view>
        <text class="setting-hint">å¼€å¯åä¹°å®¶ä¸‹å•å³è‡ªåŠ¨æˆäº¤</text>
      </view>

      <!-- æœ‰æ•ˆæœŸè®¾ç½® -->
      <view class="form-section">
        <text class="form-label">æœ‰æ•ˆæœŸ</text>
        <view class="expire-options">
          <text 
            class="expire-item {{publishForm.expiresDays === 7 ? 'active' : ''}}"
            bindtap="onExpireDaysChange"
            data-days="7"
          >7å¤©</text>
          <text 
            class="expire-item {{publishForm.expiresDays === 15 ? 'active' : ''}}"
            bindtap="onExpireDaysChange"
            data-days="15"
          >15å¤©</text>
          <text 
            class="expire-item {{publishForm.expiresDays === 30 ? 'active' : ''}}"
            bindtap="onExpireDaysChange"
            data-days="30"
          >30å¤©</text>
        </view>
      </view>
    </view>

    <view class="modal-actions">
      <button class="cancel-btn" bindtap="onCancelPublish">å–æ¶ˆ</button>
      <button class="confirm-btn" bindtap="onConfirmPublish">ç¡®è®¤å‘å¸ƒ</button>
    </view>
  </view>
</view>

<!-- å•†å“è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showDetailModal}}" bindtap="onCloseDetail">
  <view class="detail-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">å•†å“è¯¦æƒ…</text>
      <icon class="close-icon" type="cancel" bindtap="onCloseDetail" />
    </view>

    <scroll-view class="modal-scroll" scroll-y wx:if="{{detailInventory}}">
      <!-- å•†å“å›¾ç‰‡ -->
      <view class="detail-image-wrapper">
        <image 
          class="detail-image" 
          src="{{detailInventory.commodity.image}}" 
          mode="aspectFit"
          bindtap="onPreviewImage"
          data-url="{{detailInventory.commodity.image}}"
        />
        <view class="detail-status-badge status-{{detailInventory.status}}">
          {{detailInventory.status === 'available' ? 'å¯ç”¨' : 
            detailInventory.status === 'for_sale' ? 'ä¸Šæ¶ä¸­' : 
            detailInventory.status === 'sold' ? 'å·²å”®å‡º' : 'å·²ä½¿ç”¨'}}
        </view>
      </view>

      <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-info">
        <text class="detail-name">{{detailInventory.commodity.name}}</text>
        <text class="detail-category">{{detailInventory.commodity.category}}</text>
        <text class="detail-points">åŸä»·ï¼š{{detailInventory.commodity.exchange_points}}ç§¯åˆ†</text>
        <text class="detail-obtained">è·å¾—æ—¶é—´ï¼š{{detailInventory.obtained_at}}</text>
        
        <!-- äº¤æ˜“ä¿¡æ¯ -->
        <view class="detail-trade-info" wx:if="{{detailInventory.trade_info}}">
          <text class="trade-title">äº¤æ˜“ä¿¡æ¯</text>
          <text class="trade-detail">å”®ä»·ï¼š{{detailInventory.trade_info.price_points}}ç§¯åˆ†</text>
          <text class="trade-detail">æµè§ˆï¼š{{detailInventory.trade_info.view_count}}æ¬¡</text>
          <text class="trade-detail">å‘å¸ƒæ—¶é—´ï¼š{{detailInventory.trade_info.listed_at}}</text>
        </view>
      </view>
    </scroll-view>

    <view class="detail-actions" wx:if="{{detailInventory.status === 'available'}}">
      <button 
        class="detail-action-btn"
        bindtap="onPublishTradeTap"
        data-item="{{detailInventory}}"
      >
        å‘å¸ƒäº¤æ˜“
      </button>
      <button 
        class="detail-action-btn use-btn"
        bindtap="onUseItem"
        data-item="{{detailInventory}}"
      >
        ä½¿ç”¨å•†å“
      </button>
    </view>
  </view>
</view> 