<!-- pages/trade/market/market.wxml - äº¤æ˜“å¸‚åœºé¡µé¢æ¨¡æ¿ -->
<view class="market-container">
  <!-- ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º -->
  <view class="points-header">
    <view class="points-info">
      <text class="points-label">æˆ‘çš„ç§¯åˆ†</text>
      <text class="points-value">{{totalPoints}}</text>
    </view>
    <view class="market-stats">
      <text class="stats-text">å¸‚åœºå•†å“ {{marketStats.total_trades}} ä»¶</text>
    </view>
  </view>

  <!-- ğŸ¯ äº¤æ˜“ç©ºé—´å…¥å£å¯¼èˆª -->
  <view class="space-navigation">
    <view class="space-tabs">
      <!-- å¹¸è¿ç©ºé—´ -->
      <view 
        class="space-tab {{currentSpace === 'lucky' ? 'active' : ''}}"
        bindtap="onSpaceChange"
        data-space="lucky"
      >
        <view class="space-icon-container">
          <text class="space-icon">ğŸ€</text>
          <view class="space-glow" wx:if="{{currentSpace === 'lucky'}}"></view>
        </view>
        <view class="space-info">
          <text class="space-title">å¹¸è¿ç©ºé—´</text>
          <text class="space-subtitle">å¹¸è¿å¥½ç‰©Â·ä¸ä½ ç›¸é‡</text>
        </view>
        <view class="space-badge" wx:if="{{luckySpaceStats.new_count > 0}}">
          <text class="badge-text">{{luckySpaceStats.new_count}}</text>
        </view>
      </view>
      
      <!-- è‡»é€‰ç©ºé—´ -->
      <view 
        class="space-tab {{currentSpace === 'premium' ? 'active' : ''}}"
        bindtap="onSpaceChange"
        data-space="premium"
      >
        <view class="space-icon-container">
          <text class="space-icon">ğŸ’</text>
          <view class="space-glow" wx:if="{{currentSpace === 'premium'}}"></view>
        </view>
        <view class="space-info">
          <text class="space-title">è‡»é€‰ç©ºé—´</text>
          <text class="space-subtitle">ç²¾å“æ±‡èšÂ·å“è´¨ä¿éšœ</text>
        </view>
        <view class="space-badge" wx:if="{{premiumSpaceStats.hot_count > 0}}">
          <text class="badge-text">çƒ­</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºé—´çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <view class="space-indicator">
      <view class="indicator-dot {{currentSpace === 'lucky' ? 'active' : ''}}"></view>
      <view class="indicator-dot {{currentSpace === 'premium' ? 'active' : ''}}"></view>
    </view>
    
    <!-- ç©ºé—´æè¿°å’Œç»Ÿè®¡ -->
    <view class="space-description">
      <view class="space-desc-content" wx:if="{{currentSpace === 'lucky'}}">
        <text class="desc-text">ğŸ² å‘ç°æ„å¤–æƒŠå–œï¼Œäº«å—è¶…å€¼ä¼˜æƒ </text>
        <view class="space-stats">
          <text class="stat-item">ğŸ’° å¹³å‡çœ{{luckySpaceStats.avg_discount}}%</text>
          <text class="stat-item">âš¡ {{luckySpaceStats.flash_deals}}ä¸ªé—ªè´­</text>
        </view>
      </view>
      <view class="space-desc-content" wx:if="{{currentSpace === 'premium'}}">
        <text class="desc-text">âœ¨ ä¸¥é€‰å¥½ç‰©ï¼Œå“è´¨ç”Ÿæ´»é¦–é€‰</text>
        <view class="space-stats">
          <text class="stat-item">â­ å¹³å‡{{premiumSpaceStats.avg_rating}}åˆ†å¥½è¯„</text>
          <text class="stat-item">ğŸ”¥ {{premiumSpaceStats.trending_count}}ä¸ªçƒ­é”€</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰æ  -->
  <view class="search-filter-bar">
    <view class="search-box">
      <icon class="search-icon" type="search" size="16" color="#999" />
      <input 
        class="search-input" 
        placeholder="æœç´¢å•†å“..." 
        value="{{searchKeyword}}" 
        bindinput="onSearchInput"
        confirm-type="search"
      />
      <view class="clear-search" wx:if="{{searchKeyword}}" bindtap="onClearSearch">
        <icon type="clear" size="14" />
      </view>
    </view>
    <view class="filter-button" bindtap="onToggleFilter">
      <icon type="{{showFilter ? 'cancel' : 'info'}}" size="16" />
      <text>ç­›é€‰</text>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel" wx:if="{{showFilter}}">
    <!-- åˆ†ç±»ç­›é€‰ -->
    <view class="filter-section">
      <text class="filter-title">å•†å“åˆ†ç±»</text>
      <scroll-view class="category-scroll" scroll-x>
        <view class="category-list">
          <text 
            class="category-item {{currentFilter.category === 'all' ? 'active' : ''}}"
            bindtap="onCategoryFilter"
            data-category="all"
          >å…¨éƒ¨</text>
          <text 
            class="category-item {{currentFilter.category === 'ä¼˜æƒ åˆ¸' ? 'active' : ''}}"
            bindtap="onCategoryFilter"
            data-category="ä¼˜æƒ åˆ¸"
          >ä¼˜æƒ åˆ¸</text>
          <text 
            class="category-item {{currentFilter.category === 'æ•°ç äº§å“' ? 'active' : ''}}"
            bindtap="onCategoryFilter"
            data-category="æ•°ç äº§å“"
          >æ•°ç äº§å“</text>
          <text 
            class="category-item {{currentFilter.category === 'ç”Ÿæ´»ç”¨å“' ? 'active' : ''}}"
            bindtap="onCategoryFilter"
            data-category="ç”Ÿæ´»ç”¨å“"
          >ç”Ÿæ´»ç”¨å“</text>
        </view>
      </scroll-view>
    </view>

    <!-- ä»·æ ¼ç­›é€‰ -->
    <view class="filter-section">
      <text class="filter-title">ä»·æ ¼åŒºé—´</text>
      <view class="price-filter">
        <text 
          class="price-item {{currentFilter.priceMin === 0 && currentFilter.priceMax === 0 ? 'active' : ''}}"
          bindtap="onPriceFilter"
          data-min="0"
          data-max="0"
        >å…¨éƒ¨</text>
        <text 
          class="price-item {{currentFilter.priceMin === 0 && currentFilter.priceMax === 500 ? 'active' : ''}}"
          bindtap="onPriceFilter"
          data-min="0"
          data-max="500"
        >500ä»¥ä¸‹</text>
        <text 
          class="price-item {{currentFilter.priceMin === 500 && currentFilter.priceMax === 1000 ? 'active' : ''}}"
          bindtap="onPriceFilter"
          data-min="500"
          data-max="1000"
        >500-1000</text>
        <text 
          class="price-item {{currentFilter.priceMin === 1000 && currentFilter.priceMax === 0 ? 'active' : ''}}"
          bindtap="onPriceFilter"
          data-min="1000"
          data-max="0"
        >1000ä»¥ä¸Š</text>
      </view>
    </view>

    <!-- æ’åºæ–¹å¼ -->
    <view class="filter-section">
      <text class="filter-title">æ’åºæ–¹å¼</text>
      <view class="sort-filter">
        <text 
          class="sort-item {{currentFilter.sort === 'time_desc' ? 'active' : ''}}"
          bindtap="onSortChange"
          data-sort="time_desc"
        >æœ€æ–°å‘å¸ƒ</text>
        <text 
          class="sort-item {{currentFilter.sort === 'price_asc' ? 'active' : ''}}"
          bindtap="onSortChange"
          data-sort="price_asc"
        >ä»·æ ¼ä»ä½åˆ°é«˜</text>
        <text 
          class="sort-item {{currentFilter.sort === 'price_desc' ? 'active' : ''}}"
          bindtap="onSortChange"
          data-sort="price_desc"
        >ä»·æ ¼ä»é«˜åˆ°ä½</text>
      </view>
    </view>

    <!-- ç­›é€‰æ“ä½œ -->
    <view class="filter-actions">
      <button class="reset-btn" bindtap="onResetFilter">é‡ç½®</button>
      <button class="confirm-btn" bindtap="onToggleFilter">ç¡®å®š</button>
    </view>
  </view>

  <!-- å•†å“åˆ—è¡¨ -->
  <view class="trade-list" wx:if="{{!loading}}">
    <view 
      class="trade-item" 
      wx:for="{{filteredTrades}}" 
      wx:key="trade_id"
      bindtap="onTradeItemTap"
      data-trade="{{item}}"
    >
      <!-- å•†å“å›¾ç‰‡ -->
      <view class="commodity-image-wrapper">
        <image 
          class="commodity-image" 
          src="{{item.commodity.image}}" 
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-url="{{item.commodity.image}}"
          data-urls="{{item.trade_images || [item.commodity.image]}}"
        />
        <view class="discount-badge" wx:if="{{item.price_off_percent > 0}}">
          çœ{{item.price_off_percent}}%
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="commodity-details">
        <view class="commodity-header">
          <text class="commodity-name">{{item.commodity.name}}</text>
          <text class="commodity-category">{{item.commodity.category}}</text>
        </view>
        
        <text class="trade-description">{{item.trade_description}}</text>
        
        <!-- ä»·æ ¼ä¿¡æ¯ -->
        <view class="price-info">
          <view class="current-price">
            <text class="price-symbol">ç§¯åˆ†</text>
            <text class="price-value">{{item.price_points}}</text>
          </view>
          <view class="original-price" wx:if="{{item.commodity.original_points !== item.price_points}}">
            åŸä»· {{item.commodity.original_points}}ç§¯åˆ†
          </view>
        </view>

        <!-- å–å®¶ä¿¡æ¯ -->
        <view class="seller-info">
          <image class="seller-avatar" src="{{item.seller_info.avatar_url}}" />
          <view class="seller-details">
            <text class="seller-name">{{item.seller_info.nickname}}</text>
            <view class="seller-credit">
              <text class="credit-score">â­{{item.seller_info.credit_score}}</text>
              <text class="trade-count">{{item.seller_info.trade_count}}ç¬”äº¤æ˜“</text>
            </view>
          </view>
          <view class="seller-badge" wx:if="{{item.seller_info.success_rate >= 95}}">
            <text>ä¿¡ç”¨ä¼˜ç§€</text>
          </view>
        </view>

        <!-- å•†å“å…ƒä¿¡æ¯ -->
        <view class="trade-meta">
          <text class="list-time">{{item.listed_at}}</text>
          <text class="view-count">{{item.view_count}}æ¬¡æµè§ˆ</text>
          <text class="favorite-count" wx:if="{{item.favorite_count > 0}}">
            â™¥ {{item.favorite_count}}
          </text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="trade-actions">
        <button 
          class="favorite-btn {{item.is_favorite ? 'favorited' : ''}}"
          bindtap="onToggleFavorite"
          data-trade="{{item}}"
        >
          <icon type="{{item.is_favorite ? 'success' : 'info_circle'}}" size="16" />
        </button>
        <button 
          class="buy-btn"
          bindtap="onBuyButtonTap"
          data-trade="{{item}}"
        >
          ç«‹å³è´­ä¹°
        </button>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-item" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
      <view class="loading-image"></view>
      <view class="loading-content">
        <view class="loading-line long"></view>
        <view class="loading-line short"></view>
        <view class="loading-line medium"></view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!loading && filteredTrades.length === 0}}">
    <image src="/images/empty-trade.png" class="empty-image" />
    <text class="empty-text">æš‚æ— äº¤æ˜“å•†å“</text>
    <text class="empty-hint">
      {{searchKeyword ? 'è¯•è¯•å…¶ä»–æœç´¢è¯' : 'å¿«å»åº“å­˜ä¸­å‘å¸ƒå•†å“å§'}}
    </text>
    <button class="empty-action" wx:if="{{!searchKeyword}}" bindtap="onGoToInventory">
      å»æˆ‘çš„åº“å­˜
    </button>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore && !loading}}">
    <view class="load-more-text" wx:if="{{!loadingMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</view>
    <view class="load-more-loading" wx:if="{{loadingMore}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>

<!-- è´­ä¹°ç¡®è®¤å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showPurchaseModal}}" bindtap="onCancelPurchase">
  <view class="purchase-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">ç¡®è®¤è´­ä¹°</text>
      <icon class="close-icon" type="cancel" bindtap="onCancelPurchase" />
    </view>

    <view class="modal-content" wx:if="{{selectedTrade}}">
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="purchase-product">
        <image class="product-image" src="{{selectedTrade.commodity.image}}" />
        <view class="product-info">
          <text class="product-name">{{selectedTrade.commodity.name}}</text>
          <text class="product-description">{{selectedTrade.trade_description}}</text>
          <view class="product-price">
            <text class="price-label">å•ä»·ï¼š</text>
            <text class="price-value">{{selectedTrade.price_points}}ç§¯åˆ†</text>
          </view>
        </view>
      </view>

      <!-- è´­ä¹°æ•°é‡ -->
      <view class="purchase-quantity">
        <text class="quantity-label">è´­ä¹°æ•°é‡ï¼š</text>
        <view class="quantity-controls">
          <button 
            class="quantity-btn"
            bindtap="onQuantityChange"
            data-action="minus"
            disabled="{{purchaseQuantity <= 1}}"
          >-</button>
          <text class="quantity-value">{{purchaseQuantity}}</text>
          <button 
            class="quantity-btn"
            bindtap="onQuantityChange"
            data-action="plus"
            disabled="{{purchaseQuantity >= 10}}"
          >+</button>
        </view>
      </view>

      <!-- ä¹°å®¶ç•™è¨€ -->
      <view class="purchase-message">
        <text class="message-label">ä¹°å®¶ç•™è¨€ï¼š</text>
        <textarea 
          class="message-input"
          placeholder="ç»™å–å®¶ç•™è¨€ï¼ˆå¯é€‰ï¼‰"
          value="{{buyerMessage}}"
          bindinput="onMessageInput"
          maxlength="100"
        />
      </view>

      <!-- è´¹ç”¨æ˜ç»† -->
      <view class="purchase-summary">
        <view class="summary-item">
          <text class="summary-label">å•†å“æ€»ä»·ï¼š</text>
          <text class="summary-value">{{selectedTrade.price_points * purchaseQuantity}}ç§¯åˆ†</text>
        </view>
        <view class="summary-item total">
          <text class="summary-label">éœ€æ”¯ä»˜ï¼š</text>
          <text class="summary-value">{{selectedTrade.price_points * purchaseQuantity}}ç§¯åˆ†</text>
        </view>
        <view class="summary-item balance">
          <text class="summary-label">è´¦æˆ·ä½™é¢ï¼š</text>
          <text class="summary-value">{{totalPoints}}ç§¯åˆ†</text>
        </view>
        <view class="summary-item remaining">
          <text class="summary-label">è´­ä¹°åä½™é¢ï¼š</text>
          <text class="summary-value {{totalPoints - selectedTrade.price_points * purchaseQuantity < 0 ? 'insufficient' : ''}}">
            {{totalPoints - selectedTrade.price_points * purchaseQuantity}}ç§¯åˆ†
          </text>
        </view>
      </view>
    </view>

    <view class="modal-actions">
      <button class="cancel-btn" bindtap="onCancelPurchase">å–æ¶ˆ</button>
      <button 
        class="confirm-btn"
        bindtap="onConfirmPurchase"
        disabled="{{totalPoints < selectedTrade.price_points * purchaseQuantity}}"
      >
        ç¡®è®¤è´­ä¹°
      </button>
    </view>
  </view>
</view>

<!-- å•†å“è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showDetailModal}}" bindtap="onCloseDetail">
  <view class="detail-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">å•†å“è¯¦æƒ…</text>
      <icon class="close-icon" type="cancel" bindtap="onCloseDetail" />
    </view>

    <scroll-view class="modal-scroll" scroll-y wx:if="{{detailTrade}}">
      <!-- å•†å“å›¾ç‰‡ -->
      <view class="detail-images">
        <swiper class="image-swiper" indicator-dots indicator-color="rgba(255,255,255,0.5)" indicator-active-color="#fff">
          <swiper-item>
            <image 
              class="detail-image" 
              src="{{detailTrade.commodity.image}}" 
              mode="aspectFit"
              bindtap="onPreviewImage"
              data-url="{{detailTrade.commodity.image}}"
            />
          </swiper-item>
          <swiper-item wx:for="{{detailTrade.trade_images}}" wx:key="*this">
            <image 
              class="detail-image" 
              src="{{item}}" 
              mode="aspectFit"
              bindtap="onPreviewImage"
              data-url="{{item}}"
            />
          </swiper-item>
        </swiper>
      </view>

      <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-info">
        <text class="detail-name">{{detailTrade.commodity.name}}</text>
        <text class="detail-category">{{detailTrade.commodity.category}}</text>
        <text class="detail-description">{{detailTrade.trade_description}}</text>
        
        <view class="detail-price">
          <text class="current-price">{{detailTrade.price_points}}ç§¯åˆ†</text>
          <text class="original-price" wx:if="{{detailTrade.commodity.original_points !== detailTrade.price_points}}">
            åŸä»· {{detailTrade.commodity.original_points}}ç§¯åˆ†
          </text>
          <view class="discount-tag" wx:if="{{detailTrade.price_off_percent > 0}}">
            çœ{{detailTrade.price_off_percent}}%
          </view>
        </view>
      </view>

      <!-- å–å®¶è¯¦ç»†ä¿¡æ¯ -->
      <view class="detail-seller">
        <view class="seller-header">
          <image class="seller-avatar-large" src="{{detailTrade.seller_info.avatar_url}}" />
          <view class="seller-info-detail">
            <text class="seller-name-large">{{detailTrade.seller_info.nickname}}</text>
            <view class="seller-stats">
              <text class="stat-item">â­ {{detailTrade.seller_info.credit_score}}</text>
              <text class="stat-item">{{detailTrade.seller_info.trade_count}}ç¬”äº¤æ˜“</text>
              <text class="stat-item">{{detailTrade.seller_info.success_rate}}%å¥½è¯„</text>
            </view>
          </view>
          <button class="view-seller-btn" bindtap="onViewSellerInfo" data-seller-id="{{detailTrade.seller_info.user_id}}">
            æŸ¥çœ‹
          </button>
        </view>
      </view>

      <!-- å•†å“è¯¦ç»†å±æ€§ -->
      <view class="detail-attributes">
        <view class="attribute-item">
          <text class="attr-label">å‘å¸ƒæ—¶é—´ï¼š</text>
          <text class="attr-value">{{detailTrade.listed_at}}</text>
        </view>
        <view class="attribute-item">
          <text class="attr-label">æµè§ˆæ¬¡æ•°ï¼š</text>
          <text class="attr-value">{{detailTrade.view_count}}æ¬¡</text>
        </view>
        <view class="attribute-item" wx:if="{{detailTrade.favorite_count > 0}}">
          <text class="attr-label">æ”¶è—æ¬¡æ•°ï¼š</text>
          <text class="attr-value">{{detailTrade.favorite_count}}æ¬¡</text>
        </view>
      </view>
    </scroll-view>

    <view class="detail-actions">
      <button 
        class="detail-favorite-btn {{detailTrade.is_favorite ? 'favorited' : ''}}"
        bindtap="onToggleFavorite"
        data-trade="{{detailTrade}}"
      >
        {{detailTrade.is_favorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}
      </button>
      <button 
        class="detail-buy-btn"
        bindtap="onBuyButtonTap"
        data-trade="{{detailTrade}}"
      >
        ç«‹å³è´­ä¹°
      </button>
    </view>
  </view>
</view> 