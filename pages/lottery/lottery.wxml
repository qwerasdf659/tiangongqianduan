<!-- pages/lottery/lottery.wxml - æŠ½å¥–é¡µé¢æ¨¡æ¿ -->
<view class="lottery-container {{showResult ? 'showing-result' : ''}}" bindtap="onPageTap">
  
  <!-- é¡µé¢å¤´éƒ¨ - ç¡®ä¿å§‹ç»ˆå¯è§ -->
  <view class="header" style="position: relative; z-index: 10;">
    <view class="user-info">
      <text class="welcome">æ¬¢è¿ï¼Œ{{userInfo.phone || userInfo.nickname || 'ç”¨æˆ·'}}</text>
      <view class="points-info">
        <text class="points-label">å½“å‰ç§¯åˆ†ï¼š</text>
        <text class="points-value">{{totalPoints || 0}}</text>
      </view>
    </view>
    <!-- è”ç³»å®¢æœæŒ‰é’® -->
    <button class="header-service-btn" bindtap="onContactService">
      ğŸ“ å®¢æœ
    </button>
  </view>

  <!-- è½¬ç›˜åŒºåŸŸ - ä¼˜åŒ–ï¼šä½¿ç”¨CSSæ§åˆ¶æ˜¾éšï¼Œé¿å…DOMé‡å»º -->
  <view class="wheel-section {{showResult ? 'result-showing' : ''}} {{hideWheel ? 'hidden' : ''}}" style="position: relative;">
    <!-- è½¬ç›˜å®¹å™¨ -->
    <view style="position: relative; width: 260px; height: 260px; margin: 20rpx auto; display: block;">
      <!-- Canvasè½¬ç›˜èƒŒæ™¯ - é™ä½å±‚çº§ -->
      <canvas 
        canvas-id="wheelCanvas" 
        class="wheel-canvas"
        style="position: absolute; top: 0; left: 0; width: 260px; height: 260px; border-radius: 50%; z-index: 1; pointer-events: none;"
      ></canvas>
      
      <!-- ğŸ¯ è½¬ç›˜ä¸­å¤®æŒ‰é’® - ç¡®ä¿åœ¨Canvasä¹‹ä¸Š -->
      <view style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; pointer-events: none;">
        <!-- ä¸­å¤®æŒ‰é’®å®šä½å®¹å™¨ -->
        <view style="position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; margin-left: -40px; margin-top: -40px; z-index: 1000; pointer-events: auto;">
          <view 
            style="width: 80px; height: 80px; background: #FF6B35; color: white; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; text-align: center; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.8); position: relative; z-index: 1001;"
            bindtap="onSingleDraw"
          >
            <text style="color: white; font-size: 12px; font-weight: bold;">{{isDrawing ? 'æŠ½å¥–ä¸­' : 'å¼€å§‹æŠ½å¥–'}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- è½¬ç›˜åŠ è½½æç¤º -->
    <view class="wheel-loading" wx:if="{{!wheelReady}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">è½¬ç›˜åŠ è½½ä¸­...</text>
    </view>

    <!-- æŠ½å¥–ä¸­çš„é®ç½©å±‚ -->
    <view class="drawing-overlay" wx:if="{{isDrawing}}">
      <view class="overlay-content">
        <view class="spinner-large"></view>
        <text class="overlay-text">æŠ½å¥–ä¸­...</text>
      </view>
    </view>
  </view>

  <!-- å¤šè¿æŠ½æŒ‰é’®ç»„ - ä¼˜åŒ–ï¼šä½¿ç”¨CSSæ§åˆ¶æ˜¾éš -->
  <view class="multi-draw-section {{hideWheel ? 'hidden' : ''}}">
    <view class="section-title-small">
      <text>âš¡ è¿æŠ½é€‰é¡¹</text>
    </view>
    <view class="multi-draw-grid">
      <!-- ç¬¬ä¸€è¡Œï¼šä¸‰è¿æŠ½ + äº”è¿æŠ½ -->
      <view class="grid-row">
        <button 
          class="grid-draw-btn triple-btn {{isDrawing ? 'disabled' : ''}}"
          disabled="{{isDrawing}}"
          bindtap="onTripleDraw"
        >
          <view class="btn-content">
            <text class="btn-main-text">ä¸‰è¿æŠ½</text>
            <text class="btn-sub-text">{{(costPoints || 100) * 3}}ç§¯åˆ†</text>
          </view>
        </button>

        <button 
          class="grid-draw-btn five-btn {{isDrawing ? 'disabled' : ''}}"
          disabled="{{isDrawing}}"
          bindtap="onFiveDraw"
        >
          <view class="btn-content">
            <text class="btn-main-text">äº”è¿æŠ½</text>
            <text class="btn-sub-text">{{(costPoints || 100) * 5}}ç§¯åˆ†</text>
          </view>
        </button>
      </view>

      <!-- ç¬¬äºŒè¡Œï¼šåè¿æŠ½ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰ -->
      <view class="grid-row">
        <button 
          class="grid-draw-btn ten-btn special full-width {{isDrawing ? 'disabled' : ''}}"
          disabled="{{isDrawing}}"
          bindtap="onTenDraw"
        >
          <view class="btn-content">
            <text class="btn-main-text">åè¿æŠ½</text>
            <text class="btn-sub-text">{{(costPoints || 100) * 10}}ç§¯åˆ†</text>
            <text class="btn-guarantee">ä¿åº•å¥½ç¤¼</text>
          </view>
        </button>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†ä¸è¶³å¼¹çª— -->
  <view class="points-modal" wx:if="{{showPointsModal}}">
    <view class="modal-mask" bindtap="onClosePointsModal"></view>
    <view class="modal-content">
      <view class="points-header">
        <text class="points-title">ğŸ’° ç§¯åˆ†ä¸è¶³</text>
        <view class="close-btn" bindtap="onClosePointsModal">Ã—</view>
      </view>
      
      <view class="points-content">
        <view class="points-info">
          <text class="points-text">{{pointsModalData.drawType}}éœ€è¦ {{pointsModalData.needPoints}} ç§¯åˆ†</text>
          <text class="points-text">å½“å‰ç§¯åˆ†ï¼š{{pointsModalData.currentPoints}}</text>
          <text class="points-text">è¿˜éœ€è¦ï¼š{{pointsModalData.needPoints - pointsModalData.currentPoints}} ç§¯åˆ†</text>
        </view>
        
        <view class="points-tips">
          <text class="tips-title">ğŸ’¡ è·å–ç§¯åˆ†æ–¹å¼ï¼š</text>
          <text class="tips-item">â€¢ æ‹ç…§ä¸Šä¼ åºŸå“</text>
          <text class="tips-item">â€¢ ç­¾åˆ°è·å¾—ç§¯åˆ†</text>
          <text class="tips-item">â€¢ é‚€è¯·å¥½å‹è·å¾—ç§¯åˆ†</text>
        </view>
      </view>

      <view class="points-footer">
        <button class="points-btn cancel-btn" bindtap="onClosePointsModal">
          ç¨åå†è¯•
        </button>
        <button class="points-btn upload-btn" bindtap="onGoUpload">
          å»ä¸Šä¼ 
        </button>
      </view>
    </view>
  </view>

  <!-- æŠ½å¥–ç»“æœå¼¹çª— -->
  <view class="result-modal" wx:if="{{showResult}}">
    <view class="modal-mask" bindtap="onCloseResult"></view>
    <view class="modal-content">
      <view class="result-header">
        <text class="result-title">ğŸ‰ æŠ½å¥–ç»“æœ</text>
        <view class="close-btn" bindtap="onCloseResult">Ã—</view>
      </view>
      
      <view class="result-list">
        <view 
          class="result-item" 
          wx:for="{{resultData}}" 
          wx:key="prize_id"
        >
          <view class="prize-icon">ğŸ</view>
          <view class="prize-info">
            <text class="prize-name">{{item.display_name}}</text>
            <text class="prize-desc">{{item.display_desc}}</text>
            <text class="prize-extra" wx:if="{{item.points > 0}}">
              +{{item.points}}ç§¯åˆ†
            </text>
          </view>
          <view class="prize-status">
            <text class="status-badge {{item.is_near_miss ? 'near-miss' : 'win'}}">
              {{item.is_near_miss ? 'å·®ä¸€ç‚¹' : 'ä¸­å¥–äº†'}}
            </text>
          </view>
        </view>
      </view>

      <view class="result-footer">
        <text class="remaining-points">å‰©ä½™ç§¯åˆ†ï¼š{{totalPoints}}</text>
        <button class="continue-btn" bindtap="onCloseResult">
          ç»§ç»­æŠ½å¥–
        </button>
      </view>
    </view>
  </view>

  <!-- è§„åˆ™è¯´æ˜ - ç¡®ä¿å§‹ç»ˆå¯è§ -->
  <view class="rules-section" style="position: relative; z-index: 10;" wx:if="{{!showResult}}">
    <view class="section-title">
      <text>ğŸ“‹ æŠ½å¥–è§„åˆ™</text>
    </view>
    <view class="rules-content">
      <!-- ğŸ”´ è§„åˆ™ä»åç«¯é…ç½®åŠ¨æ€è·å– - ç¬¦åˆé¡¹ç›®å®‰å…¨è§„åˆ™ -->
      <view class="rule-item">â€¢ æ¯æ¬¡æŠ½å¥–æ¶ˆè€—{{costPoints || 100}}ç§¯åˆ†</view>
      <view class="rule-item" wx:if="{{lotteryRules.guaranteeRule}}">â€¢ {{lotteryRules.guaranteeRule}}</view>
      <view class="rule-item" wx:if="{{lotteryRules.consumptionRule}}">â€¢ {{lotteryRules.consumptionRule}}</view>
      <view class="rule-item" wx:if="{{lotteryRules.securityRule}}">â€¢ {{lotteryRules.securityRule}}</view>
      <view class="rule-item" wx:if="{{lotteryRules.dailyLimitRule}}">â€¢ {{lotteryRules.dailyLimitRule}}</view>
      <!-- ğŸš§ å¼€å‘é˜¶æ®µï¼šå¦‚æœåç«¯è§„åˆ™æœªé…ç½®ï¼Œæ˜¾ç¤ºåŸºç¡€æç¤º -->
      <view class="rule-item" wx:if="{{!lotteryRules || !lotteryRules.guaranteeRule}}">â€¢ æŠ½å¥–è§„åˆ™åŠ è½½ä¸­...</view>
    </view>
  </view>
  
  <!-- ğŸ”´ è°ƒè¯•ä¿¡æ¯ - å¼€å‘ç¯å¢ƒå¯è§ -->
  <view wx:if="{{false}}" style="position: fixed; bottom: 20rpx; left: 20rpx; background: rgba(0,0,0,0.8); color: white; padding: 20rpx; border-radius: 10rpx; font-size: 20rpx; z-index: 9999;">
    <text>è°ƒè¯•: hideWheel={{hideWheel}}, showResult={{showResult}}</text>
  </view>
</view> 