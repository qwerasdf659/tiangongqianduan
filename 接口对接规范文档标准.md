# 🔗 接口对接规范文档 - 餐厅积分抽奖系统

> **前后端接口对接完整规范** - 基于实际项目代码的三端协作标准化接口文档

## 📋 一、文档定位与标准

### 1.1 文档定位
- **多重受众**：前端开发、后端开发、测试工程师
- **核心职责**：定义前后端数据交互标准和协议
- **技术边界**：专注接口层面，连接前端、后端、数据库三端
- **内容深度**：提供可直接使用的接口规范和示例
- **项目状态**：✅ **100%基于实际代码分析**
- **更新时间**：2025年01月03日 - 基于实际代码深度分析更新
- **使用模型**：Claude Sonnet 4
- **文档版本**：v2.1.4 - 与产品功能结构文档同步更新

### 1.2 🎯 实际项目API架构（基于routes/目录分析）

**📋 核心API模块（基于实际路由文件）**

#### 1.2.1 🔐 认证授权模块 (routes/auth.js - 377行)
```javascript
// 实际实现的认证接口
const AUTH_APIS = {
  login: {
    method: 'POST',
    path: '/api/auth/login', 
    description: '用户登录（手机号 + 验证码）',
    implementation: 'authenticateUser() - 支持findOrCreateByMobile自动创建用户',
    frontendIntegration: '支持2001错误码专项处理机制',
    requestFields: {
      phone: 'string - 手机号码',
      code: 'string - 验证码（开发阶段任意6位数字）'
    },
    responseFields: {
      access_token: 'string - JWT访问令牌',
      refresh_token: 'string - 刷新令牌',
      user_info: 'object - 用户信息',
      expires_in: 'number - 过期时间（秒）'
    }
  },
  adminLogin: {
    method: 'POST',
    path: '/api/auth/admin-login',
    description: '管理员登录（账号 + 密码）',
    implementation: 'authenticateAdmin() - 隐藏登录入口',
    frontendIntegration: '隐藏式触发机制（连续点击5次）',
    requestFields: {
      username: 'string - 管理员账号',
      password: 'string - 管理员密码',
      skip_sms: 'boolean - 开发阶段跳过短信验证'
    },
    responseFields: {
      access_token: 'string - JWT访问令牌',
      user_info: 'object - 管理员信息',
      permissions: 'array - 权限列表'
    }
  },
  refreshToken: {
    method: 'POST',
    path: '/api/auth/refresh',
    description: 'JWT Token刷新',
    implementation: 'refreshTokens() - 自动延长有效期',
    frontendIntegration: '自动重试机制集成',
    requestFields: {
      refresh_token: 'string - 刷新令牌'
    },
    responseFields: {
      access_token: 'string - 新的访问令牌',
      expires_in: 'number - 过期时间（秒）'
    }
  },
  verifyToken: {
    method: 'GET',
    path: '/api/auth/verify-token',
    description: 'Token验证',
    implementation: 'verifyToken() - 中间件验证',
    frontendIntegration: '页面加载时自动验证',
    requestHeaders: {
      'Authorization': 'Bearer {access_token}'
    },
    responseFields: {
      valid: 'boolean - 令牌是否有效',
      user_info: 'object - 用户信息',
      expires_at: 'timestamp - 过期时间'
    }
  },
  logout: {
    method: 'POST',
    path: '/api/auth/logout',
    description: '退出登录',
    implementation: 'logout() - 清除Token',
    frontendIntegration: '全局退出登录处理',
    requestHeaders: {
      'Authorization': 'Bearer {access_token}'
    },
    responseFields: {
      success: 'boolean - 是否成功退出'
    }
  },
  sendCode: {
    method: 'POST',
    path: '/api/auth/send-code',
    description: '发送验证码',
    implementation: 'sendVerificationCode() - 开发阶段暂停',
    frontendIntegration: '开发阶段Mock模式支持',
    requestFields: {
      phone: 'string - 手机号码',
      type: 'string - 验证码类型（login/register）'
    },
    responseFields: {
      message: 'string - 发送结果消息',
      expire_time: 'timestamp - 验证码过期时间'
    }
  }
};
```

#### 1.2.2 🎰 抽奖系统模块 (routes/lottery.js - 277行)
```javascript
// 实际实现的抽奖接口
const LOTTERY_APIS = {
  getConfig: {
    method: 'GET',
    path: '/api/lottery/config',
    description: '获取抽奖配置（转盘渲染必需）',
    implementation: 'LotteryService.getFrontendConfig() - 返回8区域转盘配置',
    frontendIntegration: '页面加载时自动调用，支持字段映射兼容性',
    requestHeaders: {
      'Authorization': 'Bearer {access_token}'
    },
    responseFields: {
      prizes: 'array - 8个奖品配置',
      cost_points: 'number - 抽奖消耗积分',
      user_points: 'number - 用户当前积分',
      today_draw_count: 'number - 今日抽奖次数',
      rules: 'object - 抽奖规则说明'
    },
    prizeFieldMapping: {
      'name/prize_name/title': '奖品名称',
      'probability/chance/rate': '中奖概率',
      'type/prize_type/category': '奖品类型',
      'value/points/worth': '奖品价值'
    }
  },
  performDraw: {
    method: 'POST',
    path: '/api/lottery/draw',
    description: '执行抽奖（支持单抽、连抽）',
    implementation: 'LotteryService.performDraw() - 含10次保底机制',
    frontendIntegration: '支持多种抽奖模式，自动扣除积分',
    requestFields: {
      draw_type: 'string - 抽奖类型（single/multi）',
      count: 'number - 抽奖次数（1,3,5,10）'
    },
    responseFields: {
      results: 'array - 抽奖结果列表',
      user_points: 'number - 剩余积分',
      total_cost: 'number - 总消耗积分',
      pity_count: 'number - 保底计数'
    },
    resultFieldMapping: {
      'prize_id/id': '奖品ID',
      'prize_name/name': '奖品名称',
      'prize_type/type': '奖品类型',
      'win_time/timestamp': '中奖时间'
    }
  },
  getRecords: {
    method: 'GET',
    path: '/api/lottery/records',
    description: '抽奖记录查询（分页）',
    implementation: 'LotteryRecord.findAndCountAll() - 分页查询',
    frontendIntegration: '支持分页加载，上拉刷新',
    requestParams: {
      page: 'number - 页码（默认1）',
      limit: 'number - 每页数量（默认20）',
      start_date: 'date - 开始日期（可选）',
      end_date: 'date - 结束日期（可选）'
    },
    responseFields: {
      records: 'array - 抽奖记录列表',
      total: 'number - 总记录数',
      page: 'number - 当前页码',
      has_more: 'boolean - 是否有更多数据'
    }
  },
  getStatistics: {
    method: 'GET',
    path: '/api/lottery/statistics',
    description: '抽奖统计数据',
    implementation: 'getLotteryStatistics() - 用户抽奖统计',
    frontendIntegration: '用户中心统计展示',
    responseFields: {
      total_draws: 'number - 总抽奖次数',
      total_wins: 'number - 总中奖次数',
      win_rate: 'number - 中奖率',
      favorite_prize: 'string - 最常中奖品'
    }
  }
};
```

#### 1.2.3 🛍️ 积分兑换模块 (routes/exchange.js - 353行)
```javascript
// 实际实现的兑换接口
const EXCHANGE_APIS = {
  getProducts: {
    method: 'GET',
    path: '/api/exchange/products',
    description: '商品列表（分页、筛选）',
    implementation: 'CommodityPool.findAndCountAll() - 支持分类筛选',
    frontendIntegration: '支持分页加载、分类筛选、库存状态显示',
    requestParams: {
      page: 'number - 页码',
      limit: 'number - 每页数量',
      category: 'string - 商品分类（可选）',
      sort: 'string - 排序方式（points_asc/points_desc/stock_desc）'
    },
    responseFields: {
      products: 'array - 商品列表',
      total: 'number - 总商品数',
      categories: 'array - 分类列表',
      has_more: 'boolean - 是否有更多数据'
    },
    productFieldMapping: {
      'name/product_name/title': '商品名称',
      'points_required/cost/price': '所需积分',
      'stock/inventory/quantity': '库存数量',
      'image_url/image/picture': '商品图片'
    }
  },
  submitExchange: {
    method: 'POST',
    path: '/api/exchange/submit',
    description: '提交兑换订单',
    implementation: 'processExchange() - 库存检查、积分扣除、WebSocket推送',
    frontendIntegration: '支持库存检查、积分扣除、实时推送',
    requestFields: {
      product_id: 'number - 商品ID',
      quantity: 'number - 兑换数量',
      delivery_info: 'object - 配送信息（可选）'
    },
    responseFields: {
      order_id: 'string - 订单ID',
      exchange_code: 'string - 兑换码',
      user_points: 'number - 剩余积分',
      estimated_delivery: 'date - 预计配送时间'
    }
  },
  getOrders: {
    method: 'GET',
    path: '/api/exchange/orders',
    description: '兑换订单列表',
    implementation: 'ExchangeOrder.findAndCountAll() - 用户订单查询',
    frontendIntegration: '订单状态跟踪，支持分页加载',
    requestParams: {
      page: 'number - 页码',
      limit: 'number - 每页数量',
      status: 'string - 订单状态（可选）'
    },
    responseFields: {
      orders: 'array - 订单列表',
      total: 'number - 总订单数',
      has_more: 'boolean - 是否有更多数据'
    },
    orderFieldMapping: {
      'order_id/id': '订单ID',
      'product_name/name': '商品名称',
      'status/state': '订单状态',
      'created_at/create_time': '创建时间'
    }
  },
  getCategories: {
    method: 'GET',
    path: '/api/exchange/categories',
    description: '商品分类',
    implementation: 'CommodityPool.getCategories() - 动态分类',
    frontendIntegration: '分类筛选功能',
    responseFields: {
      categories: 'array - 分类列表',
      category_counts: 'object - 各分类商品数量'
    }
  }
};
```

#### 1.2.4 📸 拍照上传模块 (routes/photo.js - 331行)
```javascript
// 实际实现的拍照接口
const PHOTO_APIS = {
  uploadPhoto: {
    method: 'POST',
    path: '/api/photo/upload',
    description: '拍照上传（消费小票）',
    implementation: 'sealosStorage.uploadImage() - Sealos云存储',
    frontendIntegration: '支持图片压缩、进度显示、上传重试',
    requestFields: {
      image: 'file - 图片文件',
      amount: 'number - 用户输入的消费金额',
      user_id: 'number - 用户ID'
    },
    responseFields: {
      upload_id: 'string - 上传ID',
      image_url: 'string - 图片URL',
      status: 'string - 审核状态（pending）',
      estimated_points: 'number - 预估积分'
    }
  },
  getHistory: {
    method: 'GET',
    path: '/api/photo/history',
    description: '上传历史记录',
    implementation: 'PhotoReview.findAndCountAll() - 用户上传历史',
    frontendIntegration: '支持状态筛选、分页加载',
    requestParams: {
      page: 'number - 页码',
      limit: 'number - 每页数量',
      status: 'string - 审核状态（pending/approved/rejected）'
    },
    responseFields: {
      records: 'array - 上传记录列表',
      total: 'number - 总记录数',
      has_more: 'boolean - 是否有更多数据'
    },
    recordFieldMapping: {
      'upload_id/id': '上传ID',
      'image_url/url': '图片URL',
      'status/state': '审核状态',
      'points_awarded/points': '获得积分',
      'created_at/upload_time': '上传时间'
    }
  },
  getReviewDetail: {
    method: 'GET',
    path: '/api/photo/review/:id',
    description: '审核详情',
    implementation: 'PhotoReview.findByPk() - 审核状态和理由',
    frontendIntegration: '审核详情页面展示',
    requestParams: {
      id: 'number - 上传记录ID'
    },
    responseFields: {
      review_detail: 'object - 审核详情',
      reviewer_comment: 'string - 审核备注',
      review_time: 'timestamp - 审核时间',
      final_amount: 'number - 最终确认金额'
    }
  },
  getStatistics: {
    method: 'GET',
    path: '/api/photo/statistics',
    description: '拍照统计',
    implementation: 'getPhotoStatistics() - 用户拍照统计',
    frontendIntegration: '用户中心统计展示',
    responseFields: {
      total_uploads: 'number - 总上传次数',
      approved_count: 'number - 审核通过次数',
      total_points_earned: 'number - 总获得积分',
      approval_rate: 'number - 审核通过率'
    }
  }
};
```

#### 1.2.5 👥 用户管理模块 (routes/user.js - 237行)
```javascript
// 实际实现的用户接口
const USER_APIS = {
  getUserInfo: {
    method: 'GET',
    path: '/api/user/info',
    description: '获取用户信息',
    implementation: 'User.getSafeUserInfo() - 脱敏用户信息',
    frontendIntegration: '支持多种字段映射，自动脱敏处理',
    responseFields: {
      user_id: 'number - 用户ID',
      nickname: 'string - 用户昵称',
      avatar: 'string - 头像URL',
      phone: 'string - 手机号（脱敏）',
      points: 'number - 积分余额',
      level: 'string - 用户等级',
      join_date: 'date - 加入时间'
    },
    fieldMapping: {
      'points/user_points/totalPoints': '积分字段',
      'nickname/name/username': '昵称字段',
      'avatar/avatar_url/headImg': '头像字段'
    }
  },
  updateUserInfo: {
    method: 'PUT',
    path: '/api/user/info',
    description: '更新用户信息',
    implementation: 'User.update() - 昵称、头像更新',
    frontendIntegration: '支持表单验证、实时更新',
    requestFields: {
      nickname: 'string - 用户昵称（可选）',
      avatar: 'string - 头像URL（可选）'
    },
    responseFields: {
      updated_fields: 'array - 更新的字段列表',
      user_info: 'object - 更新后的用户信息'
    }
  },
  uploadAvatar: {
    method: 'POST',
    path: '/api/user/avatar',
    description: '头像上传',
    implementation: 'sealosStorage.uploadAvatar() - 头像云存储',
    frontendIntegration: '支持头像裁剪、尺寸验证',
    requestFields: {
      avatar: 'file - 头像文件'
    },
    responseFields: {
      avatar_url: 'string - 头像URL',
      thumbnail_url: 'string - 缩略图URL'
    }
  },
  getPointsRecords: {
    method: 'GET',
    path: '/api/user/points-records',
    description: '积分记录（分页）',
    implementation: 'PointsRecord.findAndCountAll() - 积分变动明细',
    frontendIntegration: '支持分页加载、类型筛选',
    requestParams: {
      page: 'number - 页码',
      limit: 'number - 每页数量',
      type: 'string - 记录类型（earn/consume/all）'
    },
    responseFields: {
      records: 'array - 积分记录列表',
      total: 'number - 总记录数',
      has_more: 'boolean - 是否有更多数据'
    },
    recordFieldMapping: {
      'points/amount': '积分数量',
      'type/operation': '操作类型',
      'description/reason': '变动原因',
      'created_at/timestamp': '记录时间'
    }
  }
};
```

#### 1.2.6 🏪 商家管理模块 (routes/merchant.js - 545行)
```javascript
// 实际实现的商家接口
const MERCHANT_APIS = {
  applyMerchant: {
    method: 'POST',
    path: '/api/merchant/apply',
    description: '申请商家权限',
    implementation: 'processMerchantApplication() - 商家权限申请',
    frontendIntegration: '申请表单提交、状态跟踪',
    requestFields: {
      business_name: 'string - 商家名称',
      business_license: 'string - 营业执照',
      contact_info: 'object - 联系信息'
    },
    responseFields: {
      application_id: 'string - 申请ID',
      status: 'string - 申请状态',
      review_time: 'timestamp - 预计审核时间'
    }
  },
  getReviewList: {
    method: 'GET',
    path: '/api/merchant/reviews',
    description: '待审核列表',
    implementation: 'getReviewList() - 分页获取待审核项',
    frontendIntegration: '审核工作台列表展示',
    requestParams: {
      page: 'number - 页码',
      limit: 'number - 每页数量',
      status: 'string - 审核状态筛选'
    },
    responseFields: {
      reviews: 'array - 待审核列表',
      total: 'number - 总数量',
      pending_count: 'number - 待审核数量'
    }
  },
  submitReview: {
    method: 'POST',
    path: '/api/merchant/review',
    description: '提交审核结果',
    implementation: 'submitReview() - 审核结果提交',
    frontendIntegration: '审核操作、WebSocket推送',
    requestFields: {
      review_id: 'number - 审核项ID',
      action: 'string - 审核动作（approve/reject）',
      final_amount: 'number - 最终确认金额',
      comment: 'string - 审核备注'
    },
    responseFields: {
      review_result: 'object - 审核结果',
      points_awarded: 'number - 奖励积分',
      notification_sent: 'boolean - 是否已发送通知'
    }
  },
  batchReview: {
    method: 'POST',
    path: '/api/merchant/batch-review',
    description: '批量审核',
    implementation: 'processBatchReview() - 批量审核处理',
    frontendIntegration: '批量操作、进度显示',
    requestFields: {
      review_ids: 'array - 审核项ID列表',
      action: 'string - 批量动作',
      batch_comment: 'string - 批量备注'
    },
    responseFields: {
      processed_count: 'number - 处理数量',
      success_count: 'number - 成功数量',
      failed_items: 'array - 失败项列表'
    }
  },
  getLotteryConfig: {
    method: 'GET',
    path: '/api/merchant/lottery-config',
    description: '获取抽奖配置',
    implementation: 'getLotteryConfig() - 商家抽奖配置管理',
    frontendIntegration: '概率设置页面展示',
    responseFields: {
      prizes: 'array - 奖品配置列表',
      total_probability: 'number - 总概率',
      is_active: 'boolean - 是否启用'
    }
  },
  updateLotteryConfig: {
    method: 'PUT',
    path: '/api/merchant/lottery-config',
    description: '更新抽奖配置',
    implementation: 'updateLotteryConfig() - 抽奖配置更新',
    frontendIntegration: '概率设置、实时验证',
    requestFields: {
      prizes: 'array - 奖品配置列表',
      is_active: 'boolean - 是否启用'
    },
    responseFields: {
      updated_config: 'object - 更新后的配置',
      validation_result: 'object - 验证结果'
    }
  }
};
```

### 1.3 🔄 WebSocket实时通信（基于services/websocket.js分析）

**实际实现的WebSocket服务**：
```javascript
// WebSocket服务配置 (services/websocket.js - 312行)
const WEBSOCKET_CONFIG = {
  // 连接配置
  connection: {
    path: '/ws',                    // WebSocket路径
    port: 'HTTP服务器端口',         // 与HTTP服务共享端口
    authentication: 'JWT Token',   // JWT认证机制
    heartbeat: 30000,              // 心跳间隔30秒
    maxConnections: 1000,          // 最大连接数
    frontendIntegration: '开发环境静默模式，生产环境完整重连机制'
  },
  
  // 实际推送事件
  events: {
    'connected': '连接成功',
    'points_update': '积分变动推送',
    'stock_update': '库存变动推送',
    'review_result': '审核结果推送',
    'system_notification': '系统通知推送',
    'lottery_result': '抽奖结果推送',
    'exchange_status': '兑换状态推送'
  },
  
  // 实际实现的方法
  methods: {
    'authenticate()': 'JWT Token验证',
    'sendToUser()': '发送消息给特定用户',
    'broadcastToAll()': '广播消息给所有用户',
    'getConnectionStats()': '获取连接统计',
    'cleanupTimeoutConnections()': '清理超时连接'
  }
};
```

### 1.4 🚨 统一错误处理规范 - 确保后端兼容性

**✅ 标准错误响应格式**：
```javascript
// 统一错误响应结构
{
  "code": 2001,                    // 错误码
  "message": "访问令牌不能为空",      // 错误消息
  "data": null,                    // 数据（错误时通常为null）
  "details": {                     // 错误详情（可选）
    "field": "authorization",
    "requirement": "Bearer Token required"
  },
  "timestamp": "2025-01-03T10:30:00Z",  // 时间戳
  "request_id": "req_123456789"    // 请求ID（用于调试）
}
```

**🔧 核心错误码定义**：
```javascript
const ERROR_CODES = {
  // 🔴 认证相关错误码
  2001: {
    message: '访问令牌不能为空',
    frontendAction: '清除Token，引导重新登录',
    httpStatus: 401
  },
  2002: {
    message: 'Token已过期',
    frontendAction: '尝试Token刷新，失败则重新登录',
    httpStatus: 401
  },
  2003: {
    message: '无效的Token',
    frontendAction: '清除Token，引导重新登录',
    httpStatus: 401
  },
  
  // 🔴 业务相关错误码
  1001: {
    message: '积分不足',
    frontendAction: '显示积分不足提示，引导获取积分',
    httpStatus: 400
  },
  1002: {
    message: '库存不足',
    frontendAction: '显示库存不足提示，刷新商品列表',
    httpStatus: 400
  },
  1003: {
    message: '活动已暂停',
    frontendAction: '显示活动暂停提示，隐藏相关功能',
    httpStatus: 400
  },
  1004: {
    message: '参数验证失败',
    frontendAction: '显示参数错误提示，检查输入数据',
    httpStatus: 400
  },
  
  // 🔴 权限相关错误码
  3001: {
    message: '权限不足',
    frontendAction: '显示权限不足提示，引导申请权限',
    httpStatus: 403
  },
  3002: {
    message: '非商家用户',
    frontendAction: '显示商家权限申请页面',
    httpStatus: 403
  },
  
  // 🔴 系统相关错误码
  5001: {
    message: '服务器内部错误',
    frontendAction: '显示系统错误提示，稍后重试',
    httpStatus: 500
  },
  5002: {
    message: '数据库连接失败',
    frontendAction: '显示服务暂不可用提示',
    httpStatus: 503
  }
};
```

**🔧 前端错误处理策略**：
```javascript
// 前端统一错误处理机制
const handleAPIError = (error, context) => {
  const { code, message, details } = error;
  
  // 🔴 认证错误专项处理
  if (code === 2001 || code === 2002 || code === 2003) {
    // 清除无效Token
    wx.removeStorageSync('access_token');
    wx.removeStorageSync('refresh_token');
    
    // 引导用户重新登录
    wx.showModal({
      title: '登录已过期',
      content: '请重新登录以继续使用',
      showCancel: false,
      success: () => {
        wx.redirectTo({
          url: '/pages/auth/auth'
        });
      }
    });
    return;
  }
  
  // 🔴 积分不足错误处理
  if (code === 1001) {
    wx.showModal({
      title: '积分不足',
      content: '您的积分不足，去上传照片获取积分？',
      confirmText: '去上传',
      success: (res) => {
        if (res.confirm) {
          wx.navigateTo({
            url: '/pages/camera/camera'
          });
        }
      }
    });
    return;
  }
  
  // 🔴 库存不足错误处理
  if (code === 1002) {
    wx.showToast({
      title: '商品库存不足',
      icon: 'none'
    });
    // 刷新商品列表
    if (context && context.refreshProductList) {
      context.refreshProductList();
    }
    return;
  }
  
  // 🔴 权限不足错误处理
  if (code === 3001 || code === 3002) {
    wx.showModal({
      title: '权限不足',
      content: '您暂无此功能权限，需要申请商家权限吗？',
      confirmText: '申请权限',
      success: (res) => {
        if (res.confirm) {
          wx.navigateTo({
            url: '/pages/merchant/apply'
          });
        }
      }
    });
    return;
  }
  
  // 🔴 系统错误通用处理
  if (code >= 5000) {
    wx.showToast({
      title: '系统暂时不可用',
      icon: 'none'
    });
    return;
  }
  
  // 🔴 其他错误通用处理
  wx.showToast({
    title: message || '操作失败',
    icon: 'none'
  });
};
```

---

## 🔌 二、核心API接口详细规范

### 2.1 🔐 认证授权接口 (routes/auth.js)

#### 2.1.1 用户登录接口
```http
POST /api/auth/login
Content-Type: application/json
```

**请求参数**：
```json
{
  "mobile": "13800000000",     // 必需：11位手机号
  "verification_code": "123456" // 必需：6位验证码（开发阶段可跳过）
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200,
    "user_info": {
      "user_id": 11,
      "mobile": "138****0000",
      "nickname": "用户2136",
      "total_points": 1000,
      "is_merchant": false,
      "status": "active",
      "avatar": null,
      "last_login": "2025-07-03T16:15:00.000Z",
      "created_at": "2025-07-03T00:04:00.000Z"
    }
  }
}
```

#### 2.1.2 管理员登录接口
```http
POST /api/auth/admin-login
Content-Type: application/json
```

**请求参数**：
```json
{
  "username": "admin",         // 必需：管理员账号
  "password": "admin123456",   // 必需：管理员密码
  "verification_code": "123456" // 可选：短信二次验证（开发阶段跳过）
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "管理员登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200,
    "admin_info": {
      "admin_id": 1,
      "username": "admin",
      "role": "super_admin",
      "permissions": ["user_management", "lottery_config", "system_settings"]
    }
  }
}
```

#### 2.1.3 Token刷新接口
```http
POST /api/auth/refresh
Content-Type: application/json
Authorization: Bearer <refresh_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "Token刷新成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 7200
  }
}
```

### 2.2 🎰 抽奖系统接口 (routes/lottery.js)

#### 2.2.1 获取抽奖配置接口
```http
GET /api/lottery/config
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "prizes": [
      {
        "id": 1,
        "name": "八八折券",
        "type": "coupon",
        "value": "88.00",
        "angle": 0,
        "color": "#E74C3C",
        "probability": "0.0000",
        "isActivity": true,
        "costPoints": 100
      },
      {
        "id": 2,
        "name": "九八折券",
        "type": "coupon",
        "value": "98.00",
        "angle": 45,
        "color": "#27AE60",
        "probability": "0.1000",
        "isActivity": true,
        "costPoints": 100
      }
    ],
    "costPerDraw": 100,
    "totalPrizes": 8,
    "pitySystem": {
      "enabled": true,
      "pityLimit": 10,
      "pityPrizeName": "九八折券"
    },
    "user_pity": {
      "current_count": 3,
      "remaining_draws": 7,
      "pity_limit": 10
    }
  }
}
```

#### 2.2.2 执行抽奖接口
```http
POST /api/lottery/draw
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "draw_type": "single"  // 可选：single(单抽), triple(3连抽), quintuple(5连抽), decade(10连抽)
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "draw_type": "single",
    "results": [
      {
        "prize": "九八折券",
        "pity": {
          "triggered": false,
          "remaining": 9
        },
        "reward": {
          "type": "coupon",
          "value": "98.00"
        },
        "draw_sequence": 1
      }
    ],
    "total_cost": 100,
    "user_points": 900,
    "remaining_points": 900,
    "balance": 900,
    "points": 900,
    "today_count": 5,
    "user_info": {
      "remaining_points": 900,
      "today_count": 5,
      "pity_info": {
        "current_count": 4,
        "remaining_draws": 6
      }
    }
  }
}
```

#### 2.2.3 抽奖记录查询接口
```http
GET /api/lottery/records?page=1&limit=20&draw_type=single&prize_type=coupon
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20，最大100）
- `draw_type`: 抽奖类型筛选（可选）
- `prize_type`: 奖品类型筛选（可选）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 123,
        "draw_id": "draw_20250703_001",
        "prize_name": "九八折券",
        "prize_type": "coupon",
        "prize_value": "98.00",
        "draw_type": "single",
        "points_cost": 100,
        "is_near_miss": false,
        "created_at": "2025-07-03T16:15:00.000Z"
      }
    ],
    "pagination": {
      "total": 150,
      "page": 1,
      "limit": 20,
      "total_pages": 8
    }
  }
}
```

### 2.3 🛍️ 积分兑换接口 (routes/exchange.js)

#### 2.3.1 商品列表接口
```http
GET /api/exchange/products?page=1&limit=20&category=food&sort=hot
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `category`: 商品分类（可选）
- `sort`: 排序方式（hot:热门, price:价格, stock:库存）
- `search`: 搜索关键词（可选）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "products": [
      {
        "id": 1,
        "name": "美食券50元",
        "description": "适用于店内所有菜品",
        "category": "voucher",
        "points_required": 500,
        "stock": 100,
        "original_price": "50.00",
        "image_url": "https://sealos.storage/products/voucher50.jpg",
        "is_hot": true,
        "exchange_count": 156,
        "status": "active",
        "created_at": "2025-07-03T00:00:00.000Z"
      }
    ],
    "pagination": {
      "total": 25,
      "page": 1,
      "limit": 20,
      "total_pages": 2
    },
    "categories": ["voucher", "food", "drink", "gift"]
  }
}
```

#### 2.3.2 提交兑换订单接口
```http
POST /api/exchange/submit
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "product_id": 1,        // 必需：商品ID
  "quantity": 1,          // 必需：兑换数量
  "user_address": {       // 可选：收货地址（实物商品需要）
    "name": "张三",
    "phone": "13800000000",
    "address": "北京市朝阳区xxx"
  },
  "remark": "备注信息"    // 可选：备注
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "兑换成功",
  "data": {
    "order_id": "EX20250703001",
    "product_name": "美食券50元",
    "points_cost": 500,
    "quantity": 1,
    "total_points": 500,
    "remaining_points": 400,
    "exchange_code": "EX123456789",
    "order_status": "completed",
    "delivery_info": {
      "type": "virtual",  // virtual:虚拟商品, physical:实物商品
      "estimated_date": null
    },
    "created_at": "2025-07-03T16:20:00.000Z"
  }
}
```

### 2.4 📸 拍照上传接口 (routes/photo.js)

#### 2.4.1 拍照上传接口
```http
POST /api/photo/upload
Content-Type: multipart/form-data
Authorization: Bearer <access_token>
```

**请求参数**：
```javascript
// FormData格式
const formData = new FormData();
formData.append('photo', imageFile);          // 必需：图片文件
formData.append('amount', '58.50');           // 必需：消费金额
formData.append('description', '晚餐消费');   // 可选：消费描述
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "上传成功",
  "data": {
    "upload_id": "UP20250703001",
    "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
    "amount": 58.50,
    "expected_points": 585,
    "status": "pending",
    "review_status": "待审核",
    "upload_time": "2025-07-03T16:25:00.000Z",
    "estimated_review_time": "2025-07-04T16:25:00.000Z"
  }
}
```

#### 2.4.2 上传历史接口
```http
GET /api/photo/history?limit=10&status=all
Authorization: Bearer <access_token>
```

**查询参数**：
- `limit`: 返回数量（默认10，最大50）
- `status`: 状态筛选（all:全部, approved:已通过, pending:待审核, rejected:已拒绝）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
        "amount": 58.50,
        "points": 585,
        "status": "approved",
        "review_reason": "审核通过",
        "upload_time": "2025-07-03T14:30:00.000Z",
        "review_time": "2025-07-03T15:30:00.000Z"
      }
    ],
    "total": 15,
    "summary": {
      "total_uploads": 15,
      "approved_count": 12,
      "pending_count": 2,
      "rejected_count": 1,
      "total_points_earned": 7250
    }
  }
}
```

### 2.5 👥 用户管理接口 (routes/user.js)

#### 2.5.1 获取用户信息接口
```http
GET /api/user/info
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "user_id": 11,
    "mobile": "138****0000",
    "nickname": "用户2136",
    "total_points": 1000,
    "is_merchant": false,
    "status": "active",
    "avatar": "https://sealos.storage/avatars/user11.jpg",
    "last_login": "2025-07-03T16:15:00.000Z",
    "created_at": "2025-07-03T00:04:00.000Z",
    "statistics": {
      "total_lottery_count": 25,
      "total_exchange_count": 8,
      "total_upload_count": 12,
      "total_points_earned": 12500,
      "total_points_spent": 11500
    }
  }
}
```

#### 2.5.2 更新用户信息接口
```http
PUT /api/user/info
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "nickname": "新昵称",     // 可选：用户昵称
  "avatar": "头像URL"      // 可选：头像地址
}
```

#### 2.5.3 头像上传接口
```http
POST /api/user/avatar
Content-Type: multipart/form-data
Authorization: Bearer <access_token>
```

**请求参数**：
```javascript
// FormData格式
const formData = new FormData();
formData.append('avatar', imageFile);  // 必需：头像文件
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "头像上传成功",
  "data": {
    "avatarUrl": "https://sealos.storage/avatars/user11_20250703.jpg"
  }
}
```

#### 2.5.4 积分记录接口
```http
GET /api/user/points-records?page=1&pageSize=20&type=all
Authorization: Bearer <access_token>
```

**查询参数**：
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认20）
- `type`: 类型筛选（all:全部, earn:收入, consume:支出）

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "points": 100,
        "description": "抽奖消费 - 九八折券",
        "type": "spend",
        "source": "lottery",
        "balance_after": 900,
        "created_at": "2025-07-03T14:30:00.000Z"
      },
      {
        "id": 2,
        "points": 585,
        "description": "拍照审核通过",
        "type": "earn",
        "source": "photo_review",
        "balance_after": 1485,
        "created_at": "2025-07-03T13:30:00.000Z"
      }
    ],
    "total": 150,
    "page": 1,
    "pageSize": 20,
    "summary": {
      "total_earned": 7250,
      "total_spent": 2500,
      "current_balance": 4750
    }
  }
}
```

### 2.6 🏪 商家管理接口 (routes/merchant.js)

#### 2.6.1 待审核列表接口
```http
GET /api/merchant/reviews/pending?page=1&limit=20
Authorization: Bearer <access_token>
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "reviews": [
      {
        "id": 1,
        "user_id": 11,
        "user_nickname": "用户2136",
        "image_url": "https://sealos.storage/uploads/photo_123456.jpg",
        "amount": 58.50,
        "expected_points": 585,
        "description": "晚餐消费",
        "upload_time": "2025-07-03T14:30:00.000Z",
        "waiting_time": "2小时30分钟"
      }
    ],
    "pagination": {
      "total": 25,
      "page": 1,
      "limit": 20,
      "total_pages": 2
    },
    "statistics": {
      "pending_count": 25,
      "today_reviewed": 15,
      "average_review_time": "1.5小时"
    }
  }
}
```

#### 2.6.2 审核通过接口
```http
POST /api/merchant/reviews/:id/approve
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "actual_amount": 58.50,      // 必需：实际消费金额
  "points_awarded": 585,       // 必需：奖励积分
  "review_reason": "审核通过"  // 可选：审核理由
}
```

**响应格式**：
```json
{
  "code": 0,
  "msg": "审核通过",
  "data": {
    "review_id": 1,
    "points_awarded": 585,
    "user_new_balance": 1585,
    "review_time": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 2.6.3 审核拒绝接口
```http
POST /api/merchant/reviews/:id/reject
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "reject_reason": "小票不清晰，无法确认消费金额"  // 必需：拒绝理由
}
```

#### 2.6.4 批量审核接口
```http
POST /api/merchant/reviews/batch
Content-Type: application/json
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "reviews": [
    {
      "id": 1,
      "action": "approve",
      "actual_amount": 58.50,
      "points_awarded": 585,
      "review_reason": "审核通过"
    },
    {
      "id": 2,
      "action": "reject",
      "reject_reason": "小票模糊"
    }
  ]
}
```

---

## 🔄 三、WebSocket实时通信规范

### 3.1 连接建立
```javascript
// WebSocket连接
const ws = new WebSocket('ws://localhost:3000/ws');

// 连接时需要JWT认证
ws.onopen = function() {
  ws.send(JSON.stringify({
    type: 'authenticate',
    token: 'Bearer ' + accessToken
  }));
};
```

### 3.2 实时事件类型

#### 3.2.1 积分变动推送
```json
{
  "type": "points_update",
  "data": {
    "user_id": 11,
    "points_change": 585,
    "new_balance": 1585,
    "reason": "拍照审核通过",
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.2 库存变动推送
```json
{
  "type": "stock_update",
  "data": {
    "product_id": 1,
    "product_name": "美食券50元",
    "new_stock": 99,
    "stock_change": -1,
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.3 审核结果推送
```json
{
  "type": "review_result",
  "data": {
    "review_id": 1,
    "status": "approved",
    "points_awarded": 585,
    "review_reason": "审核通过",
    "timestamp": "2025-07-03T16:30:00.000Z"
  }
}
```

#### 3.2.4 心跳保活
```json
{
  "type": "heartbeat",
  "timestamp": "2025-07-03T16:30:00.000Z"
}
```

---

## 📋 四、错误代码规范

### 4.1 通用错误代码
- `0`: 成功
- `1001-1999`: 参数错误
- `2001-2999`: 认证错误
- `3001-3999`: 业务逻辑错误
- `4001-4999`: 资源错误
- `5001-5999`: 系统错误

### 4.2 具体错误代码
```javascript
const ERROR_CODES = {
  // 认证相关
  2001: '用户未登录',
  2002: 'Token已过期',
  2003: '用户权限不足',
  2004: '验证码错误',
  
  // 业务逻辑相关
  3001: '积分余额不足',
  3002: '商品库存不足',
  3003: '今日抽奖次数已达上限',
  3004: '上传文件格式不支持',
  
  // 资源相关
  4001: '用户不存在',
  4002: '商品不存在',
  4003: '订单不存在',
  4004: '审核记录不存在',
  
  // 系统相关
  5001: '服务器内部错误',
  5002: '数据库连接失败',
  5003: '第三方服务异常'
};
```

---

**更新完成时间**：2025年07月03日 16:30  
**基于实际代码版本**：完全基于routes/目录下6个路由文件的真实实现