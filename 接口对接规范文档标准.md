# 🔌 接口对接规范文档 - 编写标准与准则

> **前后端接口对接完整规范** - 三端协作的标准化接口文档

## 📋 一、文档定位与标准

### 1.1 文档定位
- **多重受众**：前端开发、后端开发、测试工程师
- **核心职责**：定义前后端数据交互标准和协议
- **技术边界**：专注接口层面，连接前端、后端、数据库三端
- **内容深度**：提供可直接使用的接口规范和示例

### 1.2 文档结构标准
```
# 前后端接口对接规范
├── 🔌 API接口定义规范
├── 📊 数据格式规范
├── 🔐 认证授权规范
├── ❌ 错误码定义规范
├── 📡 WebSocket通信规范
├── 📁 文件上传规范
├── 🧪 接口测试规范
└── 📖 接口文档维护规范
``` 

## 🔌 二、API接口定义规范

### 2.1 RESTful API设计标准
```javascript
// 🔴 API URL设计规范
const API_URL_STANDARDS = {
  // 基础结构：{domain}/api/{version}/{resource}
  basePattern: 'https://domain.com/api/v1/resource',
  
  // 资源命名：使用复数形式，kebab-case命名
  resourceNaming: {
    users: '/api/v1/users',
    lotteryRecords: '/api/v1/lottery-records',
    exchangeRecords: '/api/v1/exchange-records'
  },
  
  // HTTP方法使用规范
  httpMethods: {
    GET: '获取资源',
    POST: '创建资源',
    PUT: '完整更新资源',
    PATCH: '部分更新资源',
    DELETE: '删除资源'
  }
}

// 🔴 统一响应格式标准
const RESPONSE_FORMAT = {
  // 成功响应格式
  success: {
    code: 0,                    // 业务状态码，0表示成功
    message: 'success',         // 响应消息
    data: {},                   // 响应数据
    timestamp: '2024-12-19T10:30:00Z'  // 时间戳
  },
  
  // 错误响应格式
  error: {
    code: 400,                  // 错误码
    message: 'error message',   // 错误描述
    data: null,                 // 错误时data为null
    timestamp: '2024-12-19T10:30:00Z'
  },
  
  // 分页响应格式
  pagination: {
    code: 0,
    message: 'success',
    data: {
      list: [],                 // 数据列表
      total: 100,               // 总数量
      page: 1,                  // 当前页码
      limit: 20,                // 每页数量
      totalPages: 5,            // 总页数
      hasMore: true             // 是否有更多数据
    },
    timestamp: '2024-12-19T10:30:00Z'
  }
}
```

### 2.2 核心接口定义
```javascript
// 🔴 用户认证模块接口
const AUTH_APIs = {
  // 发送短信验证码
  sendCode: {
    method: 'POST',
    url: '/api/v1/auth/send-code',
    description: '发送手机验证码',
    requestBody: {
      mobile: 'string',         // 手机号，必需，格式：1[3-9]xxxxxxxxx
    },
    responseExample: {
      code: 0,
      message: '验证码发送成功',
      data: {
        expireTime: 300         // 验证码有效期（秒）
      }
    },
    errorCodes: [400, 429, 500]
  },
  
  // 用户登录
  login: {
    method: 'POST',
    url: '/api/v1/auth/login',
    description: '手机号+验证码登录',
    requestBody: {
      mobile: 'string',         // 手机号，必需
      code: 'string'            // 验证码，必需，6位数字
    },
    responseExample: {
      code: 0,
      message: '登录成功',
      data: {
        accessToken: 'eyJ...',  // 访问令牌
        refreshToken: 'eyJ...', // 刷新令牌
        expiresIn: 7200,        // 令牌有效期（秒）
        userInfo: {             // 用户信息
          userId: 123,
          mobile: '138****8000',
          nickname: '用户昵称',
          avatar: 'https://...',
          totalPoints: 1500,
          isMerchant: false
        }
      }
    }
  }
}

// 🔴 抽奖模块接口（基于天工项目）
const LOTTERY_APIs = {
  // 获取抽奖配置
  getConfig: {
    method: 'GET',
    url: '/api/lottery/config',
    description: '获取抽奖转盘配置',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        prizes: [
          {
            prize_id: 1,
            prize_name: "八八折券",
            angle: 0,              // 🔴 Canvas转盘角度(0-315,步长45)
            color: "#FF6B35",      // 🔴 扇形颜色(十六进制)
            probability: 0.05,     // 🔴 中奖概率(0-1)
            prize_type: "coupon",
            prize_value: 0.88
          },
          {
            prize_id: 2,
            prize_name: "九八折券",
            angle: 45,
            color: "#4ECDC4",
            probability: 0.10,
            prize_type: "coupon",
            prize_value: 0.98
          },
          {
            prize_id: 3,
            prize_name: "甜品1份",
            angle: 90,
            color: "#45B7D1",
            probability: 0.30,
            prize_type: "physical",
            prize_value: 15.00
          },
          {
            prize_id: 4,
            prize_name: "青菜1份",
            angle: 135,
            color: "#F39C12",
            probability: 0.30,
            prize_type: "physical",
            prize_value: 12.00
          },
          {
            prize_id: 5,
            prize_name: "虾1份",
            angle: 180,
            color: "#E74C3C",
            probability: 0.05,
            prize_type: "physical",
            prize_value: 25.00
          },
          {
            prize_id: 6,
            prize_name: "花甲1份",
            angle: 225,
            color: "#9B59B6",
            probability: 0.20,
            prize_type: "physical",
            prize_value: 18.00
          },
          {
            prize_id: 7,
            prize_name: "鱿鱼1份",
            angle: 270,
            color: "#1ABC9C",
            probability: 0.05,
            prize_type: "physical",
            prize_value: 22.00
          },
          {
            prize_id: 8,
            prize_name: "生腌拼盘158",
            angle: 315,
            color: "#34495E",
            probability: 0.00,
            prize_type: "physical",
            prize_value: 158.00
          }
        ],
        cost_points: 100,          // 🔴 单次抽奖消耗积分
        daily_limit: 10            // 🔴 每日抽奖次数限制
      }
    }
  },
  
  // 执行抽奖
  draw: {
    method: 'POST',
    url: '/api/lottery/draw',
    description: '执行抽奖操作',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    requestBody: {
      draw_type: 'string',      // 抽奖类型: single, triple, quintuple, decuple
      count: 'number'           // 抽奖次数: 1, 3, 5, 10
    },
    responseExample: {
      code: 0,
      message: '抽奖成功',
      data: {
        results: [
          {
            prize_id: 1,
            prize_name: "八八折券",
            angle: 42.5,           // 🔴 最终停止角度
            is_near_miss: false    // 🔴 是否差点中奖
          }
        ],
        remaining_points: 1400,    // 🔴 剩余积分
        today_draw_count: 3        // 🔴 今日抽奖次数
      }
    }
  }
}

// 🔴 商品兑换模块接口
const EXCHANGE_APIs = {
  // 获取商品列表
  getProducts: {
    method: 'GET',
    url: '/api/exchange/products',
    description: '获取可兑换商品列表',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    queryParams: {
      category: 'string',       // 可选，商品分类
      page: 'number',           // 可选，页码，默认1
      limit: 'number'           // 可选，每页数量，默认20
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        products: [
          {
            commodity_id: 1,
            name: "免费饮品券",
            exchange_points: 500,    // 🔴 兑换所需积分
            stock: 100,             // 🔴 库存数量
            category: "voucher",     // 🔴 商品分类
            is_hot: true,           // 🔴 是否热门
            image_url: "https://...",
            description: "任意饮品免费兑换"
          }
        ],
        total: 50,
        has_more: true
      }
    }
  },
  
  // 商品兑换
  redeem: {
    method: 'POST',
    url: '/api/exchange/redeem',
    description: '兑换商品',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    requestBody: {
      commodity_id: 'number',   // 商品ID，必需
      quantity: 'number'        // 兑换数量，必需，默认1
    },
    responseExample: {
      code: 0,
      message: '兑换成功',
      data: {
        order_id: "EX20241219001",
        commodity_name: "免费饮品券",
        exchange_points: 500,
        quantity: 1,
        total_points: 500,
        remaining_points: 1000,
        exchange_code: "ABC123456",  // 🔴 兑换码
        expire_time: "2024-12-26T23:59:59Z"
      }
    }
  }
}

// 🔴 图片上传模块接口
const PHOTO_APIs = {
  // 图片上传
  upload: {
    method: 'POST',
    url: '/api/photo/upload',
    description: '上传消费小票图片',
    headers: {
      'Authorization': 'Bearer {accessToken}',
      'Content-Type': 'multipart/form-data'
    },
    requestBody: {
      file: 'File',             // 图片文件，必需
      amount: 'number'          // 消费金额，必需
    },
    responseExample: {
      code: 0,
      message: '上传成功',
      data: {
        upload_id: "UP123456789",
        image_url: "https://sealos.../image.jpg",
        amount: 58.50,
        expected_points: 585,     // 预期积分(1元=10积分)
        status: "pending"         // 审核状态
      }
    }
  },
  
  // 上传记录
  getRecords: {
    method: 'GET',
    url: '/api/photo/records',
    description: '获取上传记录',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    queryParams: {
      status: 'string',         // 可选，审核状态: pending, approved, rejected
      page: 'number',
      limit: 'number'
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        records: [
          {
            upload_id: "UP123456789",
            image_url: "https://...",
            amount: 58.50,
            points_awarded: 585,
            review_status: "approved",
            review_reason: "审核通过",
            created_at: "2024-12-19T14:30:00Z",
            reviewed_at: "2024-12-19T15:00:00Z"
          }
        ],
        total: 20,
        has_more: false
      }
    }
  }
}

// 🔴 商家管理模块接口
const MERCHANT_APIs = {
  // 待审核列表
  getPendingReviews: {
    method: 'GET',
    url: '/api/merchant/pending-reviews',
    description: '获取待审核上传列表',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    queryParams: {
      page: 'number',
      limit: 'number'
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        reviews: [
          {
            upload_id: "UP123456789",      // 🔴 上传ID
            user_phone: "138****8000",     // 🔴 用户手机号(脱敏)
            image_url: "图片URL",          // 🔴 图片地址
            amount: 58.50,                 // 🔴 消费金额
            expected_points: 585,          // 🔴 建议积分
            upload_time: "2024-12-19T14:30:00Z",
            status: "pending"              // 🔴 审核状态
          }
        ],
        total: 50,
        has_more: true
      }
    }
  },
  
  // 执行审核
  review: {
    method: 'POST',
    url: '/api/merchant/review',
    description: '审核上传内容',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    requestBody: {
      upload_id: 'string',      // 上传ID，必需
      action: 'string',         // 审核动作: approve, reject
      points: 'number',         // 奖励积分，approve时必需
      reason: 'string'          // 审核原因，可选
    },
    responseExample: {
      code: 0,
      message: '审核成功',
      data: {
        upload_id: "UP123456789",
        action: "approve",
        points_awarded: 585,
        reason: "审核通过"
      }
    }
  }
}

// 🔴 用户中心模块接口
const USER_APIs = {
  // 获取用户信息
  getProfile: {
    method: 'GET',
    url: '/api/user/profile',
    description: '获取用户个人信息',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        user_id: 123,
        mobile: "138****8000",
        nickname: "用户昵称",
        avatar: "https://...",
        total_points: 1500,
        is_merchant: false,
        created_at: "2024-01-01T00:00:00Z"
      }
    }
  },
  
  // 积分变动记录
  getPointsHistory: {
    method: 'GET',
    url: '/api/user/points-history',
    description: '获取积分变动记录',
    headers: {
      'Authorization': 'Bearer {accessToken}'
    },
    queryParams: {
      type: 'string',           // 可选，变动类型: earn, spend, admin
      page: 'number',
      limit: 'number'
    },
    responseExample: {
      code: 0,
      message: '获取成功',
      data: {
        history: [
          {
            history_id: 1,
            points_change: 585,
            change_type: "earn",
            change_reason: "上传小票奖励",
            balance_before: 1000,
            balance_after: 1585,
            created_at: "2024-12-19T15:00:00Z"
          }
        ],
        total: 100,
        has_more: true
      }
    }
  }
}
```

## 📊 三、数据格式规范

### 3.1 前后端字段映射标准
```javascript
// 🔴 字段命名映射规则
const FIELD_MAPPING = {
  // 前端使用 camelCase，后端数据库使用 snake_case
  frontend: 'camelCase',
  backend: 'snake_case',
  
  // 核心业务字段映射表
  userFields: {
    // 前端字段名 -> 后端数据库字段名
    'userId': 'user_id',
    'mobile': 'mobile',
    'nickname': 'nickname',
    'avatar': 'avatar',
    'totalPoints': 'total_points',
    'isMerchant': 'is_merchant',
    'wxOpenid': 'wx_openid',
    'createdAt': 'created_at',
    'updatedAt': 'updated_at'
  },
  
  productFields: {
    'commodityId': 'commodity_id',
    'name': 'name',
    'exchangePoints': 'exchange_points',
    'stock': 'stock',
    'category': 'category',
    'isHot': 'is_hot',
    'status': 'status'
  },
  
  lotteryFields: {
    'prizeId': 'prize_id',
    'prizeName': 'prize_name',
    'prizeType': 'prize_type',
    'prizeValue': 'prize_value',
    'probability': 'probability',
    'angle': 'angle',
    'color': 'color'
  }
}

// 🔴 数据类型转换规范
const DATA_TYPE_CONVERSION = {
  // 数据库 -> 前端
  dbToFrontend: {
    'TINYINT(1)': 'boolean',    // MySQL布尔值转JS布尔值
    'DECIMAL(10,2)': 'number',  // MySQL金额转JS数字
    'TIMESTAMP': 'string',      // MySQL时间转ISO字符串
    'JSON': 'object',           // MySQL JSON转JS对象
    'ENUM': 'string'            // MySQL枚举转JS字符串
  },
  
  // 前端 -> 数据库
  frontendToDb: {
    'boolean': 'TINYINT(1)',
    'number': 'INT/DECIMAL',
    'string': 'VARCHAR/TEXT',
    'object': 'JSON',
    'Date': 'TIMESTAMP'
  }
}
```

### 3.2 数据验证规范
```javascript
// 🔴 请求参数验证标准
const VALIDATION_RULES = {
  // 用户相关验证
  user: {
    mobile: {
      type: 'string',
      pattern: /^1[3-9]\d{9}$/,
      required: true,
      message: '手机号格式不正确'
    },
    nickname: {
      type: 'string',
      minLength: 1,
      maxLength: 50,
      required: false
    },
    points: {
      type: 'number',
      min: 0,
      required: true,
      message: '积分必须为非负整数'
    }
  },
  
  // 分页参数验证
  pagination: {
    page: {
      type: 'number',
      min: 1,
      default: 1
    },
    limit: {
      type: 'number',
      min: 1,
      max: 100,
      default: 20
    }
  },
  
  // 文件上传验证
  file: {
    type: {
      type: 'string',
      enum: ['image/jpeg', 'image/png', 'image/gif'],
      message: '只支持JPG、PNG、GIF格式图片'
    },
    size: {
      type: 'number',
      max: 5 * 1024 * 1024,  // 5MB
      message: '文件大小不能超过5MB'
    }
  }
}
```

## 🔐 四、认证授权规范

### 4.1 JWT Token标准
```javascript
// 🔴 JWT Token结构规范
const JWT_STANDARDS = {
  // Token格式：Header.Payload.Signature
  header: {
    alg: 'HS256',              // 加密算法
    typ: 'JWT'                 // Token类型
  },
  
  // Payload载荷标准
  payload: {
    // 标准声明
    iss: 'restaurant-lottery',  // 签发者
    aud: 'miniprogram',        // 受众
    exp: 1640995200,           // 过期时间戳
    iat: 1640908800,           // 签发时间戳
    
    // 自定义声明
    userId: 123,               // 用户ID
    mobile: '138****8000',     // 脱敏手机号
    isMerchant: false,         // 商家标识
    permissions: ['user']       // 权限列表
  },
  
  // Token使用规范
  usage: {
    accessToken: {
      purpose: '接口访问认证',
      expiresIn: '2h',         // 2小时过期
      usage: 'Bearer {token}'
    },
    refreshToken: {
      purpose: '刷新访问令牌',
      expiresIn: '7d',         // 7天过期
      usage: '仅用于刷新接口'
    }
  }
}

// 🔴 权限验证中间件标准
const PERMISSION_MIDDLEWARE = {
  // 普通用户权限验证
  requireAuth: {
    description: '需要登录认证',
    implementation: '验证Authorization头中的Bearer Token'
  },
  
  // 商家权限验证
  requireMerchant: {
    description: '需要商家权限',
    implementation: '验证Token中的isMerchant字段'
  },
  
  // 管理员权限验证
  requireAdmin: {
    description: '需要管理员权限',
    implementation: '验证Token中的permissions数组'
  }
}
```

### 4.2 接口权限矩阵
```javascript
// 🔴 API权限控制矩阵
const API_PERMISSIONS = {
  // 公开接口（无需认证）
  public: [
    'POST /api/v1/auth/send-code',
    'POST /api/v1/auth/login',
    'GET /api/v1/health'
  ],
  
  // 用户接口（需要登录）
  user: [
    'GET /api/v1/user/profile',
    'PUT /api/v1/user/profile',
    'GET /api/v1/lottery/config',
    'POST /api/v1/lottery/draw',
    'GET /api/v1/exchange/products',
    'POST /api/v1/exchange/redeem'
  ],
  
  // 商家接口（需要商家权限）
  merchant: [
    'GET /api/v1/merchant/pending-reviews',
    'POST /api/v1/merchant/review',
    'GET /api/v1/merchant/statistics'
  ],
  
  // 管理员接口（需要管理员权限）
  admin: [
    'GET /api/v1/admin/users',
    'PUT /api/v1/admin/users/:id',
    'GET /api/v1/admin/system-stats'
  ]
}
```

## ❌ 五、错误码定义规范

### 5.1 统一错误码体系
```javascript
// 🔴 错误码分类标准
const ERROR_CODE_SYSTEM = {
  // 成功码
  SUCCESS: 0,
  
  // 客户端错误 (400-499)
  CLIENT_ERROR: {
    INVALID_PARAMS: 400,       // 参数错误
    UNAUTHORIZED: 401,         // 未授权
    FORBIDDEN: 403,            // 权限不足
    NOT_FOUND: 404,           // 资源不存在
    METHOD_NOT_ALLOWED: 405,   // 方法不允许
    RATE_LIMITED: 429          // 请求频率限制
  },
  
  // 服务器错误 (500-599)
  SERVER_ERROR: {
    INTERNAL_ERROR: 500,       // 内部服务器错误
    BAD_GATEWAY: 502,         // 网关错误
    SERVICE_UNAVAILABLE: 503,  // 服务不可用
    GATEWAY_TIMEOUT: 504       // 网关超时
  },
  
  // 业务错误 (1000-9999)
  BUSINESS_ERROR: {
    // 用户相关 (1000-1099)
    USER_NOT_FOUND: 1001,      // 用户不存在
    USER_ALREADY_EXISTS: 1002, // 用户已存在
    INSUFFICIENT_POINTS: 1003, // 积分不足
    
    // 抽奖相关 (1100-1199)
    LOTTERY_DISABLED: 1101,    // 抽奖功能已关闭
    DAILY_LIMIT_EXCEEDED: 1102,// 每日抽奖次数用尽
    INVALID_PRIZE: 1103,       // 无效奖品
    
    // 商品相关 (1200-1299)
    PRODUCT_NOT_FOUND: 1201,   // 商品不存在
    INSUFFICIENT_STOCK: 1202,  // 库存不足
    PRODUCT_DISABLED: 1203,    // 商品已下架
    
    // 上传相关 (1300-1399)
    UPLOAD_FAILED: 1301,       // 上传失败
    INVALID_FILE_TYPE: 1302,   // 文件类型不支持
    FILE_TOO_LARGE: 1303       // 文件过大
  }
}

// 🔴 错误信息映射表
const ERROR_MESSAGES = {
  // 中文错误信息
  zh: {
    0: '操作成功',
    400: '请求参数错误',
    401: '未授权访问',
    403: '权限不足',
    404: '资源不存在',
    500: '服务器内部错误',
    1001: '用户不存在',
    1002: '用户已存在',
    1003: '积分不足',
    1101: '抽奖功能暂时关闭',
    1102: '今日抽奖次数已用完',
    1201: '商品不存在或已下架',
    1202: '商品库存不足'
  },
  
  // 英文错误信息
  en: {
    0: 'Success',
    400: 'Bad Request',
    401: 'Unauthorized',
    403: 'Forbidden',
    404: 'Not Found',
    500: 'Internal Server Error',
    1001: 'User not found',
    1002: 'User already exists',
    1003: 'Insufficient points'
  }
}
```

### 5.2 错误处理最佳实践
```javascript
// 🔴 前端错误处理标准
const FRONTEND_ERROR_HANDLING = {
  // API错误统一处理
  handleApiError(error) {
    const { code, message } = error
    
    switch (code) {
      case 401:
        // Token过期，跳转登录
        wx.reLaunch({ url: '/pages/auth/auth' })
        break
      case 403:
        // 权限不足
        wx.showModal({
          title: '权限不足',
          content: message,
          showCancel: false
        })
        break
      case 1003:
        // 积分不足
        wx.showModal({
          title: '积分不足',
          content: '您的积分不够，快去上传图片赚积分吧！',
          confirmText: '去上传',
          success: (res) => {
            if (res.confirm) {
              wx.navigateTo({ url: '/pages/camera/camera' })
            }
          }
        })
        break
      default:
        // 通用错误提示
        wx.showToast({
          title: message || '操作失败，请重试',
          icon: 'none'
        })
    }
  }
}
```

## 📡 六、WebSocket通信规范

### 6.1 连接建立标准
```javascript
// 🔴 WebSocket连接规范
const WEBSOCKET_STANDARDS = {
  // 连接URL格式
  connectionUrl: 'wss://domain.com/ws?token={accessToken}&clientType=miniprogram',
  
  // 连接参数
  connectionParams: {
    token: 'string',           // JWT访问令牌
    clientType: 'string',      // 客户端类型：miniprogram/web/admin
    version: 'string'          // 协议版本：v1
  },
  
  // 连接状态
  connectionStates: {
    CONNECTING: 0,             // 连接中
    OPEN: 1,                   // 已连接
    CLOSING: 2,                // 关闭中
    CLOSED: 3                  // 已关闭
  }
}

// 🔴 消息格式标准
const WEBSOCKET_MESSAGE_FORMAT = {
  // 客户端发送消息格式
  clientMessage: {
    type: 'string',            // 消息类型
    id: 'string',              // 消息ID（用于响应匹配）
    data: 'object',            // 消息数据
    timestamp: 'number'        // 时间戳
  },
  
  // 服务端响应消息格式
  serverMessage: {
    type: 'string',            // 消息类型
    id: 'string',              // 对应的请求消息ID
    code: 'number',            // 状态码
    message: 'string',         // 消息描述
    data: 'object',            // 响应数据
    timestamp: 'number'        // 时间戳
  }
}
```

### 6.2 消息类型定义
```javascript
// 🔴 WebSocket消息类型
const WS_MESSAGE_TYPES = {
  // 连接管理
  PING: 'ping',                // 心跳检测
  PONG: 'pong',               // 心跳响应
  
  // 实时通知
  STOCK_UPDATE: 'stock_update',      // 库存更新通知
  POINTS_CHANGE: 'points_change',    // 积分变动通知
  REVIEW_STATUS: 'review_status',    // 审核状态变更
  SYSTEM_NOTICE: 'system_notice',    // 系统通知
  
  // 实时数据同步
  LOTTERY_CONFIG_UPDATE: 'lottery_config_update',  // 抽奖配置更新
  PRODUCT_STATUS_UPDATE: 'product_status_update'   // 商品状态更新
}

// 消息示例
const WS_MESSAGE_EXAMPLES = {
  // 库存更新通知
  stockUpdate: {
    type: 'stock_update',
    data: {
      commodityId: 123,
      stock: 50,              // 最新库存
      status: 'active'        // 商品状态
    },
    timestamp: 1640995200000
  },
  
  // 积分变动通知
  pointsChange: {
    type: 'points_change',
    data: {
      userId: 456,
      change: 100,            // 积分变动量
      balance: 1500,          // 变动后余额
      reason: '上传图片奖励'    // 变动原因
    },
    timestamp: 1640995200000
  }
}
```

## 📁 七、文件上传规范

### 7.1 上传接口标准
```javascript
// 🔴 文件上传接口规范
const FILE_UPLOAD_API = {
  // 上传接口定义
  upload: {
    method: 'POST',
    url: '/api/v1/upload/image',
    description: '上传图片文件',
    headers: {
      'Authorization': 'Bearer {accessToken}',
      'Content-Type': 'multipart/form-data'
    },
    requestBody: {
      file: 'File',            // 文件对象，必需
      category: 'string',      // 文件分类：avatar/receipt/product
      description: 'string'    // 文件描述，可选
    },
    responseExample: {
      code: 0,
      message: '上传成功',
      data: {
        uploadId: 'UP123456789',     // 上传记录ID
        fileUrl: 'https://cdn.example.com/images/abc123.jpg',
        fileSize: 1024576,           // 文件大小（字节）
        fileType: 'image/jpeg',      // 文件类型
        width: 1920,                 // 图片宽度
        height: 1080,                // 图片高度
        uploadTime: '2024-12-19T10:30:00Z'
      }
    }
  },
  
  // 上传限制
  limitations: {
    maxFileSize: 5 * 1024 * 1024,    // 最大5MB
    supportedTypes: [
      'image/jpeg',
      'image/png', 
      'image/gif'
    ],
    maxDimension: 4096,              // 最大尺寸4096px
    minDimension: 100,               // 最小尺寸100px
    dailyUploadLimit: 50             // 每日上传限制50张
  }
}
```

### 7.2 文件处理流程
```javascript
// 🔴 文件上传处理流程
const FILE_UPLOAD_PROCESS = {
  // 前端处理流程
  frontend: [
    '1. 用户选择图片',
    '2. 前端压缩处理',
    '3. 上传前验证（格式、大小）',
    '4. 调用上传接口',
    '5. 显示上传进度',
    '6. 处理上传结果'
  ],
  
  // 后端处理流程
  backend: [
    '1. 接收文件数据',
    '2. 验证文件格式和大小',
    '3. 图片质量检测（可选）',
    '4. 上传到对象存储',
    '5. 生成缩略图（可选）',
    '6. 保存上传记录',
    '7. 返回文件信息'
  ],
  
  // 错误处理
  errorHandling: {
    'file too large': '文件过大，请选择小于5MB的图片',
    'invalid file type': '不支持的文件格式，请选择JPG、PNG或GIF格式',
    'upload failed': '上传失败，请检查网络连接后重试',
    'storage error': '存储服务异常，请稍后重试'
  }
}
```

## 🧪 八、接口测试规范

### 8.1 测试用例标准
```javascript
// 🔴 接口测试用例模板
const API_TEST_TEMPLATE = {
  // 测试用例基本信息
  testCase: {
    id: 'AUTH_LOGIN_001',
    name: '用户登录-正常场景',
    description: '使用正确的手机号和验证码进行登录',
    priority: 'high',
    category: 'auth'
  },
  
  // 测试步骤
  testSteps: [
    {
      step: 1,
      action: '发送POST请求到 /api/v1/auth/login',
      data: {
        mobile: '13800138000',
        code: '123456'
      },
      expectedResult: {
        statusCode: 200,
        responseBody: {
          code: 0,
          message: '登录成功',
          data: {
            accessToken: 'string',
            refreshToken: 'string',
            userInfo: 'object'
          }
        }
      }
    }
  ],
  
  // 断言检查点
  assertions: [
    'Response status code is 200',
    'Response body contains access token',
    'User info is not empty',
    'Token expires time is valid'
  ]
}

// 🔴 边界测试场景
const BOUNDARY_TEST_SCENARIOS = {
  // 参数验证测试
  parameterValidation: [
    '空参数测试',
    '无效格式测试',
    '超长参数测试',
    '特殊字符测试',
    'SQL注入测试'
  ],
  
  // 权限测试
  permissionTest: [
    '未登录访问测试',
    '过期Token测试',
    '无效Token测试',
    '权限不足测试'
  ],
  
  // 性能测试
  performanceTest: [
    '单接口压力测试',
    '并发访问测试',
    '大数据量测试',
    '响应时间测试'
  ]
}
```

### 8.2 自动化测试配置
```javascript
// 🔴 接口自动化测试配置
const AUTOMATION_TEST_CONFIG = {
  // 测试环境配置
  environments: {
    development: {
      baseUrl: 'http://localhost:3000/api/v1',
      timeout: 5000
    },
    testing: {
      baseUrl: 'https://test-api.example.com/api/v1',
      timeout: 10000
    },
    production: {
      baseUrl: 'https://api.example.com/api/v1',
      timeout: 15000
    }
  },
  
  // 测试数据管理
  testData: {
    validUser: {
      mobile: '13800138001',
      code: '123456'
    },
    invalidUser: {
      mobile: '12345678901',
      code: '000000'
    },
    testProducts: [
      { id: 1, name: '测试商品1', points: 100 },
      { id: 2, name: '测试商品2', points: 200 }
    ]
  },
  
  // 报告配置
  reporting: {
    format: ['html', 'json', 'junit'],
    outputDir: './test-reports',
    includeScreenshots: true,
    emailNotification: true
  }
}
```

## 📖 九、接口文档维护规范

### 9.1 文档版本管理
```javascript
// 🔴 API版本管理策略
const API_VERSION_STRATEGY = {
  // 版本号格式：v{major}.{minor}.{patch}
  versionFormat: 'v1.2.3',
  
  // 版本兼容性规则
  compatibility: {
    major: '不兼容变更，需要客户端适配',
    minor: '向下兼容的新增功能',
    patch: '向下兼容的问题修复'
  },
  
  // 版本生命周期
  lifecycle: {
    development: '开发中，接口可能频繁变更',
    stable: '稳定版本，保证向下兼容',
    deprecated: '已废弃，建议迁移到新版本',
    retired: '已停用，不再提供服务'
  },
  
  // 版本支持策略
  supportPolicy: {
    currentVersion: '完整功能支持',
    previousVersion: '6个月维护期',
    olderVersions: '仅安全更新'
  }
}
```

### 9.2 文档质量标准
```javascript
// 🔴 接口文档质量检查清单
const DOC_QUALITY_CHECKLIST = {
  // 内容完整性
  completeness: [
    '✅ 所有接口都有完整描述',
    '✅ 请求参数类型和格式明确',
    '✅ 响应格式和字段说明完整',
    '✅ 错误码和错误信息齐全',
    '✅ 提供完整的请求响应示例'
  ],
  
  // 准确性
  accuracy: [
    '✅ 接口地址和参数与实际实现一致',
    '✅ 示例数据格式正确',
    '✅ 错误码与后端实现匹配',
    '✅ 字段类型定义准确'
  ],
  
  // 可用性
  usability: [
    '✅ 文档结构清晰，易于查找',
    '✅ 提供快速开始指南',
    '✅ 包含常见问题解答',
    '✅ 提供调试工具和测试环境'
  ],
  
  // 维护性
  maintainability: [
    '✅ 建立文档更新机制',
    '✅ 版本变更记录完整',
    '✅ 责任人明确',
    '✅ 定期审核和更新'
  ]
}
```

---

## 🎯 总结：接口对接规范价值

### ✅ 核心价值
1. **协作效率**：统一的接口规范大幅提升前后端协作效率
2. **开发质量**：标准化的数据格式减少集成问题
3. **维护成本**：清晰的文档降低后期维护成本
4. **用户体验**：规范的错误处理提升用户体验

### 🎯 实施建议
1. **契约先行**：接口设计优先于功能实现
2. **自动化测试**：建立完善的接口自动化测试体系
3. **持续集成**：接口变更自动触发文档更新和测试
4. **版本管理**：严格按照版本管理策略执行接口升级

### 📊 成功指标
- **接口稳定性**：接口变更导致的bug数量 < 5%
- **文档准确性**：文档与实际实现一致性 > 95%
- **集成效率**：前后端集成时间缩短 50%
- **测试覆盖率**：核心接口测试覆盖率 > 90%

**文档定位**：前后端协作标准接口规范  
**覆盖范围**：API接口设计、数据格式、通信协议全流程  
**更新策略**：与接口实现同步更新，保持文档的时效性和准确性 