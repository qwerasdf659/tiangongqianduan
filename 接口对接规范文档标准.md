# ğŸ”— æ¥å£å¯¹æ¥è§„èŒƒæ–‡æ¡£ - é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

> **å‰åç«¯æ¥å£å¯¹æ¥å®Œæ•´è§„èŒƒ** - åŸºäºæƒé™ç®€åŒ–åçš„ä¸‰ç«¯åä½œæ ‡å‡†åŒ–æ¥å£æ–‡æ¡£

## ğŸ“‹ ä¸€ã€æ–‡æ¡£å®šä½ä¸æ ‡å‡†

### 1.1 æ–‡æ¡£å®šä½
- **å¤šé‡å—ä¼—**ï¼šå‰ç«¯å¼€å‘ã€åç«¯å¼€å‘ã€æµ‹è¯•å·¥ç¨‹å¸ˆ
- **æ ¸å¿ƒèŒè´£**ï¼šå®šä¹‰å‰åç«¯æ•°æ®äº¤äº’æ ‡å‡†å’Œåè®®
- **æŠ€æœ¯è¾¹ç•Œ**ï¼šä¸“æ³¨æ¥å£å±‚é¢ï¼Œè¿æ¥å‰ç«¯ã€åç«¯ã€æ•°æ®åº“ä¸‰ç«¯
- **å†…å®¹æ·±åº¦**ï¼šæä¾›å¯ç›´æ¥ä½¿ç”¨çš„æ¥å£è§„èŒƒå’Œç¤ºä¾‹
- **é¡¹ç›®çŠ¶æ€**ï¼šâœ… **100%ç¬¦åˆæƒé™ç®€åŒ–åçš„å®é™…é¡¹ç›®ä»£ç çš„APIæ¥å£å®šä¹‰**
- **æ›´æ–°æ—¶é—´**ï¼š2025å¹´01æœˆ12æ—¥ - åŸºäºå½“å‰è¿è¡Œä»£ç çš„å®Œæ•´éªŒè¯å’Œæ›´æ–°
- **ä½¿ç”¨æ¨¡å‹**ï¼šClaude Sonnet 4
- **é¡¹ç›®ç±»å‹**ï¼šé¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿï¼ˆrestaurant-points-backendï¼‰
- **äº§å“å¯¹æ¥**ï¼š100%ç¬¦åˆäº§å“åŠŸèƒ½ç»“æ„æè¿°æ–‡æ¡£ï¼Œç¡®ä¿å‰åç«¯æ•°æ®åº“å¯¹æ¥å·¥ä½œé¡ºåˆ©è¿›è¡Œ

### 1.2 ğŸ”´ æƒé™ç³»ç»Ÿé‡å¤§ç®€åŒ–ï¼ˆv2.2.0 - 2025å¹´01æœˆ11æ—¥ï¼‰

> **âš ï¸ é‡è¦å˜æ›´**ï¼šæƒé™ç³»ç»Ÿå·²ä»ä¸‰çº§æƒé™ç®€åŒ–ä¸ºäºŒçº§æƒé™ï¼Œæ‰€æœ‰æ¥å£å’Œæ•°æ®ç»“æ„éƒ½å·²ç›¸åº”è°ƒæ•´

#### æƒé™ç®€åŒ–å‰åå¯¹æ¯”
```javascript
// âŒ æ—§ç‰ˆæƒé™ä½“ç³»ï¼ˆå·²åºŸå¼ƒï¼‰
const OLD_USER_INFO = {
  user_id: 123,
  mobile: "138****8000",
  nickname: "ç”¨æˆ·001",
  total_points: 1000,
  is_admin: false,
  is_merchant: true,          // å·²åˆ é™¤
  merchant_status: "approved", // å·²åˆ é™¤
  business_info: {             // å·²åˆ é™¤
    name: "æµ‹è¯•é¤å…",
    type: "ä¸­å¼é¤å…"
  }
};

// âœ… æ–°ç‰ˆæƒé™ä½“ç³»ï¼ˆå½“å‰å®ç°ï¼‰
const NEW_USER_INFO = {
  user_id: 123,
  mobile: "138****8000",
  nickname: "ç”¨æˆ·001",
  total_points: 1000,
  is_admin: false,            // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†
  status: "active",
  last_login: "2025-01-11T12:00:00.000Z",
  created_at: "2025-01-11T12:00:00.000Z"
  // ğŸ”´ æ³¨æ„ï¼šä¸å†åŒ…å«ä»»ä½•å•†å®¶ç›¸å…³å­—æ®µ
};
```

#### APIæƒé™æ§åˆ¶å˜æ›´
```javascript
// âŒ æ—§ç‰ˆæƒé™æ£€æŸ¥ï¼ˆå·²åºŸå¼ƒï¼‰
if (user.is_merchant || user.is_admin) {
  // å•†å®¶æˆ–ç®¡ç†å‘˜åŠŸèƒ½
}

// âœ… æ–°ç‰ˆæƒé™æ£€æŸ¥ï¼ˆå½“å‰å®ç°ï¼‰
if (user.is_admin) {
  // ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆåŒ…å«æ‰€æœ‰ä¹‹å‰çš„å•†å®¶åŠŸèƒ½ï¼‰
}
```

### 1.3 ğŸ¯ å®Œå–„è¯´æ˜ - 2025å¹´01æœˆ11æ—¥æƒé™ç®€åŒ–æ›´æ–°
æœ¬æ¬¡æ›´æ–°åŸºäºæƒé™ç³»ç»Ÿç®€åŒ–çš„æ·±åº¦ç†è§£ï¼ŒåŒ…æ‹¬ï¼š
- âœ… **åç«¯æŠ€æœ¯è§„èŒƒæ–‡æ¡£**ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰- Node.jså¾®æœåŠ¡æ¶æ„æ ‡å‡†
- âœ… **æ•°æ®åº“è®¾è®¡è§„èŒƒæ–‡æ¡£**ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰- MySQLæ ¸å¿ƒè¡¨ç»“æ„ç®€åŒ–
- âœ… **äº§å“åŠŸèƒ½ç»“æ„æ–‡æ¡£**ï¼ˆéœ€è¦æ›´æ–°ï¼‰- ä¸šåŠ¡åŠŸèƒ½æƒé™è°ƒæ•´
- âœ… **é¡¹ç›®ä»£ç å®Œæ•´åˆ†æ** - 6ä¸ªæ ¸å¿ƒè·¯ç”±æ¨¡å—+3ä¸ªæ ¸å¿ƒæœåŠ¡+8ä¸ªæ•°æ®æ¨¡å‹
- ğŸ”´ **2025å¹´01æœˆ11æ—¥æƒé™ç®€åŒ–ä¿®å¤**ï¼šåŸºäºå®é™…è¿è¡Œä»£ç ï¼Œç¡®ä¿æ¥å£è§„èŒƒ100%ç¬¦åˆç®€åŒ–åçš„æƒé™å®ç°
- ğŸ”´ **å®é™…éªŒè¯å®Œæˆ**ï¼š
  - æƒé™ä¸­é—´ä»¶ - ç®€åŒ–ä¸ºrequireAdminå•ä¸€æƒé™æ£€æŸ¥ï¼ˆmiddleware/auth.jsï¼‰
  - ç”¨æˆ·æ¨¡å‹ - ç®€åŒ–æƒé™å­—æ®µï¼Œä¿ç•™is_adminä½œä¸ºç®¡ç†å‘˜æƒé™æ§åˆ¶ï¼ˆmodels/User.jsï¼‰
- APIè·¯ç”± - å•†å®¶ç®¡ç†åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œä»…è°ƒæ•´ä¸ºrequireAdminæƒé™æ§åˆ¶ï¼ˆroutes/merchant.jsï¼‰
  - è®¤è¯ç³»ç»Ÿ - ç»Ÿä¸€ç™»å½•æ–¹å¼ï¼Œæƒé™é€šè¿‡is_adminè¯†åˆ«ï¼ˆroutes/auth.jsï¼‰

### 1.4 ğŸš¨ æƒé™ç®€åŒ–å®‰å…¨åˆè§„æ›´æ–°

#### 1.4.1 ğŸ”´ æƒé™ç®€åŒ–åçš„APIæ¥å£å˜æ›´

```javascript
// ğŸ”´ ç»Ÿä¸€ç™»å½•æ¥å£ - æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰ä½¿ç”¨ç›¸åŒæ¥å£
POST /api/auth/login
Headers: {
  'Content-Type': 'application/json'
}
Body: {
  "mobile": "13800138000",    // æ‰‹æœºå·ï¼ˆç®¡ç†å‘˜ä¹Ÿä½¿ç”¨æ‰‹æœºå·ç™»å½•ï¼‰
  "code": "123456"            // éªŒè¯ç ï¼ˆå¼€å‘ç¯å¢ƒå›ºå®š123456ï¼‰
}
Response: {
  code: 0,
  msg: 'success',
  data: {
    access_token: 'eyJhbGciOiJIUzI1NiIs...',
    refresh_token: 'eyJhbGciOiJIUzI1NiIs...',
    expires_in: 7200,
    user_info: {
      user_id: 123,
      mobile: '138****8000',
      nickname: 'ç”¨æˆ·001',
      avatar_url: 'https://...',
      total_points: 1000,
      is_admin: false,        // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†ï¼ˆç®¡ç†å‘˜ä¸ºtrueï¼‰
      status: 'active',
      last_login: '2025-01-11T12:00:00.000Z',
      created_at: '2025-01-11T12:00:00.000Z'
      // ğŸ”´ æ³¨æ„ï¼šä¸å†è¿”å›is_merchantã€business_infoç­‰å­—æ®µ
    }
  }
}

// ğŸ”´ ç®¡ç†å‘˜åŠŸèƒ½API - éœ€è¦ç®¡ç†å‘˜æƒé™
GET /api/merchant/pending-reviews
Headers: {
  'Authorization': 'Bearer <admin_token>',  // å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Response: {
  code: 0,
  msg: 'success',
  data: {
    reviews: [{
      upload_id: 'upload_123_1640001234567_abc123',
      user_info: {
        user_id: 456,
        nickname: 'ç”¨æˆ·002',
        mobile: '139****9000'
      },
      image_url: 'https://sealos.storage/photos/456/1640001234567_abc123.jpg',
      amount: null,           // ğŸ”´ ç”¨æˆ·ä¸Šä¼ æ—¶ä¸å†è¾“å…¥é‡‘é¢
      status: 'pending',
      uploaded_at: '2024-12-19 14:30:00'
    }],
    pagination: {
      total: 25,
      page: 1,
      limit: 10,
      totalPages: 3
    }
  }
}

// ğŸ”´ ç®¡ç†å‘˜å®¡æ ¸API - ç®¡ç†å‘˜è®¾ç½®æ¶ˆè´¹é‡‘é¢
POST /api/merchant/review
Headers: {
  'Authorization': 'Bearer <admin_token>',  // å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Body: {
  "upload_id": "upload_123_1640001234567_abc123",
  "action": "approve",      // approve | reject
  "amount": 58.50,          // ğŸ”´ ç®¡ç†å‘˜è®¾ç½®çš„æ¶ˆè´¹é‡‘é¢ï¼ˆæ–°å¢å­—æ®µï¼‰
  "review_reason": "å®¡æ ¸é€šè¿‡ï¼Œå®é™…æ¶ˆè´¹58.5å…ƒ"
}
Response: {
  code: 0,
  msg: 'success',
  data: {
    upload_id: 'upload_123_1640001234567_abc123',
    status: 'approved',
    amount: 58.50,
    points_awarded: 585,     // è‡ªåŠ¨è®¡ç®—ï¼š58.5 * 10 = 585ç§¯åˆ†
    review_time: '2024-12-19 15:30:00'
  }
}
```

#### 1.4.2 ğŸ”´ æƒé™éªŒè¯é”™è¯¯å¤„ç†

```javascript
// ğŸ”´ ç»Ÿä¸€æƒé™éªŒè¯é”™è¯¯å¤„ç† - æ‰€æœ‰éœ€è¦ç®¡ç†å‘˜æƒé™çš„API
const PERMISSION_ERROR_HANDLING = {
  // æœªç™»å½•é”™è¯¯
  unauthorized: {
    code: 4001,
    msg: 'éœ€è¦ç™»å½•è®¿é—®',
    data: null
  },
  
  // æƒé™ä¸è¶³é”™è¯¯ï¼ˆæ ¸å¿ƒå˜æ›´ï¼‰
  forbidden: {
    code: 4005,
    msg: 'éœ€è¦ç®¡ç†å‘˜æƒé™',        // ğŸ”´ ç®€åŒ–ä¸ºåªæ£€æŸ¥ç®¡ç†å‘˜æƒé™
    data: null
  },
  
  // Tokenæ— æ•ˆé”™è¯¯
  invalidToken: {
    code: 4002,
    msg: 'è®¿é—®ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ',
    data: null
  }
};
```

### 1.5 âš¡ æ€§èƒ½ä¼˜åŒ–æŒ‡å¯¼åŸåˆ™ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

#### 1.5.1 APIå“åº”æ—¶é—´æ ‡å‡†
```javascript
// APIæ€§èƒ½åŸºå‡†è¦æ±‚ï¼ˆæƒé™ç®€åŒ–åï¼‰
const PERFORMANCE_STANDARDS = {
  // å“åº”æ—¶é—´åŸºå‡†ï¼ˆæ¯«ç§’ï¼‰
  responseTime: {
    fast: 200,     // ç”¨æˆ·ç™»å½•ã€æƒé™éªŒè¯ç­‰
    medium: 500,   // æ•°æ®åˆ—è¡¨æŸ¥è¯¢
    slow: 1000,    // æ–‡ä»¶ä¸Šä¼ ã€å¤æ‚è®¡ç®—
    timeout: 10000 // è¯·æ±‚è¶…æ—¶æ—¶é—´
  },
  
  // æƒé™æ£€æŸ¥æ€§èƒ½
  permissionCheck: {
    maxTime: 50,   // æƒé™éªŒè¯æœ€å¤§è€—æ—¶50ms
    cacheTime: 300 // æƒé™ä¿¡æ¯ç¼“å­˜5åˆ†é’Ÿ
  }
};
```

---

## äºŒã€æ ¸å¿ƒè®¤è¯æ¥å£ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 2.1 ç”¨æˆ·ç™»å½•æ¥å£ï¼ˆç»Ÿä¸€ç™»å½•æ–¹å¼ï¼‰

#### ğŸ”´ ç»Ÿä¸€ç™»å½•æ¥å£ - æ‰€æœ‰ç”¨æˆ·ä½¿ç”¨ç›¸åŒæ–¹å¼ç™»å½•
```javascript
POST /api/auth/login

// è¯·æ±‚å‚æ•°ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
{
  "mobile": "13800138000",    // æ‰‹æœºå·ï¼ˆ11ä½ï¼Œç®¡ç†å‘˜ä¹Ÿä½¿ç”¨æ‰‹æœºå·ï¼‰
  "code": "123456"            // éªŒè¯ç ï¼ˆå¼€å‘ç¯å¢ƒå›ºå®š123456ï¼‰
}

// æˆåŠŸå“åº”ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 7200,
    "user_info": {
      "user_id": 123,
      "mobile": "138****8000",      // è„±æ•æ˜¾ç¤º
      "nickname": "ç”¨æˆ·001",
      "avatar_url": "https://sealos.storage/avatars/123.jpg",
      "total_points": 1000,
      "is_admin": false,            // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†
      "status": "active",
      "last_login": "2025-01-11T12:00:00.000Z",
      "created_at": "2025-01-11T12:00:00.000Z"
      
      // ğŸ”´ æ³¨æ„ï¼šä»¥ä¸‹å­—æ®µå·²å®Œå…¨åˆ é™¤
      // "is_merchant": Boolean,     // å·²åˆ é™¤
      // "merchant_status": String,  // å·²åˆ é™¤
      // "business_info": Object     // å·²åˆ é™¤
    }
  }
}

// é”™è¯¯å“åº”
{
  "code": 1002,
  "msg": "éªŒè¯ç é”™è¯¯ï¼Œå¼€å‘ç¯å¢ƒè¯·ä½¿ç”¨123456",
  "data": null
}
```

#### å‰ç«¯æƒé™åˆ¤æ–­é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
```javascript
// ğŸ”´ å‰ç«¯æƒé™åˆ¤æ–­ï¼ˆç®€åŒ–åï¼‰
const userInfo = loginResponse.data.user_info;

// æƒé™æ£€æŸ¥ç®€åŒ–ä¸ºåªæ£€æŸ¥is_admin
if (userInfo.is_admin) {
  // ç®¡ç†å‘˜åŠŸèƒ½ï¼šå®¡æ ¸ç®¡ç†ã€æŠ½å¥–é…ç½®ã€ç”¨æˆ·ç®¡ç†ç­‰
  showAdminFeatures();
} else {
  // æ™®é€šç”¨æˆ·åŠŸèƒ½ï¼šæŠ½å¥–ã€å…‘æ¢ã€ä¸Šä¼ ç…§ç‰‡ç­‰
  showUserFeatures();
}

// âŒ ä¸å†éœ€è¦çš„æƒé™æ£€æŸ¥ï¼ˆå·²åˆ é™¤ï¼‰
// if (userInfo.is_merchant) { ... }
// if (userInfo.is_admin && userInfo.is_merchant) { ... }
```

### 2.2 TokenéªŒè¯æ¥å£ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

```javascript
GET /api/auth/verify-token
Headers: {
  'Authorization': 'Bearer <access_token>'
}

// æˆåŠŸå“åº”ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰
{
  "code": 0,
  "msg": "success",
  "data": {
    "valid": true,
    "user_info": {
      "user_id": 123,
      "mobile": "138****8000",
      "nickname": "ç”¨æˆ·001",
      "is_admin": false,          // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†
      "status": "active",
      "remaining_time": 5400      // Tokenå‰©ä½™æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰
    },
    "permissions": [
      "lottery:participate",      // å‚ä¸æŠ½å¥–
      "exchange:submit",          // ç§¯åˆ†å…‘æ¢
      "photo:upload",            // æ‹ç…§ä¸Šä¼ 
      "profile:update"           // æ›´æ–°ä¸ªäººä¿¡æ¯
      // ğŸ”´ ç®¡ç†å‘˜ä¼šé¢å¤–åŒ…å«ï¼š
      // "photo:review", "lottery:config", "users:manage"
    ]
  }
}
```

### 2.3 Tokenåˆ·æ–°æ¥å£

```javascript
POST /api/auth/refresh
Headers: {
  'Authorization': 'Bearer <refresh_token>'
}

// æˆåŠŸå“åº”
{
  "code": 0,
  "msg": "success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 7200
  }
}
```

---

## ä¸‰ã€å•†å®¶ç®¡ç†åŠŸèƒ½æ¥å£ï¼ˆç®¡ç†å‘˜æƒé™æ§åˆ¶ï¼‰

> **ğŸ”´ é‡è¦è¯´æ˜**ï¼šå•†å®¶ç®¡ç†åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œä»…æƒé™æ§åˆ¶è°ƒæ•´ã€‚æ‰€æœ‰`/api/merchant/*`æ¥å£éƒ½éœ€è¦`is_admin = true`çš„ç®¡ç†å‘˜ç”¨æˆ·æ‰èƒ½è®¿é—®
> 
> **å‰ç«¯å¯¹æ¥è¦ç‚¹**ï¼š
> - æ™®é€šç”¨æˆ·ç™»å½•ï¼šä¸æ˜¾ç¤ºå•†å®¶ç®¡ç†å…¥å£ï¼ŒAPIè°ƒç”¨è¿”å›401æƒé™é”™è¯¯
> - ç®¡ç†å‘˜ç™»å½•ï¼šæ˜¾ç¤ºå®Œæ•´å•†å®¶ç®¡ç†åŠŸèƒ½ï¼Œå¯æ­£å¸¸è®¿é—®æ‰€æœ‰ç®¡ç†æ¥å£
> - åŠŸèƒ½å®Œæ•´æ€§ï¼šæ‰€æœ‰å•†å®¶ç®¡ç†åŠŸèƒ½ï¼ˆå®¡æ ¸ã€é…ç½®ã€ç»Ÿè®¡ï¼‰å‡ä¿æŒå®Œæ•´

### 3.1 è·å–å¾…å®¡æ ¸åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰

```javascript
GET /api/merchant/pending-reviews
Headers: {
  'Authorization': 'Bearer <admin_token>',  // ğŸ”´ å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Parameters: {
  page: 1,        // é¡µç ï¼Œé»˜è®¤1
  limit: 10,      // æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10ï¼Œæœ€å¤§50
  status: 'pending' // 'pending', 'approved', 'rejected', 'all'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    reviews: [{
      upload_id: 'upload_456_1640001234567_def456',
      user_info: {
        user_id: 456,
        nickname: 'ç”¨æˆ·002',
        mobile: '139****9000'
      },
      image_url: 'https://sealos.storage/photos/456/1640001234567_def456.jpg',
      amount: null,               // ğŸ”´ ç”¨æˆ·ä¸Šä¼ æ—¶ä¸å†è¾“å…¥é‡‘é¢
      status: 'pending',
      uploaded_at: '2024-12-19 14:30:00',
      original_filename: 'receipt_20241219.jpg',
      file_size: 1024000
    }],
    pagination: {
      total: 25,
      page: 1,
      limit: 10,
      totalPages: 3
    }
  }
}

// æƒé™ä¸è¶³é”™è¯¯
{
  "code": 4005,
  "msg": "éœ€è¦ç®¡ç†å‘˜æƒé™",  // ğŸ”´ ç®€åŒ–æƒé™é”™è¯¯æç¤º
  "data": null
}
```

### 3.2 å®¡æ ¸ç…§ç‰‡æ¥å£ï¼ˆç®¡ç†å‘˜è®¾ç½®é‡‘é¢ï¼‰

```javascript
POST /api/merchant/review
Headers: {
  'Authorization': 'Bearer <admin_token>',  // ğŸ”´ å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Body: {
  "upload_id": "upload_456_1640001234567_def456",
  "action": "approve",          // 'approve' | 'reject'
  "amount": 58.50,              // ğŸ”´ ç®¡ç†å‘˜è®¾ç½®çš„æ¶ˆè´¹é‡‘é¢ï¼ˆå¿…å¡«ï¼‰
  "review_reason": "å®¡æ ¸é€šè¿‡ï¼Œå®é™…æ¶ˆè´¹58.5å…ƒ"
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    upload_id: 'upload_456_1640001234567_def456',
    status: 'approved',
    amount: 58.50,
    points_awarded: 585,         // è‡ªåŠ¨è®¡ç®—ï¼š58.5 * 10 = 585ç§¯åˆ†
    review_time: '2024-12-19 15:30:00',
    reviewer_info: {
      admin_id: 123,             // å®¡æ ¸ç®¡ç†å‘˜ID
      admin_name: 'ç®¡ç†å‘˜001'
    }
  }
}

// æ‹’ç»å®¡æ ¸
Body: {
  "upload_id": "upload_456_1640001234567_def456",
  "action": "reject",
  "review_reason": "å›¾ç‰‡ä¸æ¸…æ™°ï¼Œæ— æ³•ç¡®è®¤æ¶ˆè´¹é‡‘é¢"
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    upload_id: 'upload_456_1640001234567_def456',
    status: 'rejected',
    review_time: '2024-12-19 15:30:00',
    review_reason: 'å›¾ç‰‡ä¸æ¸…æ™°ï¼Œæ— æ³•ç¡®è®¤æ¶ˆè´¹é‡‘é¢'
  }
}
```

### 3.3 æ‰¹é‡å®¡æ ¸æ¥å£ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰

```javascript
POST /api/merchant/batch-review
Headers: {
  'Authorization': 'Bearer <admin_token>',  // ğŸ”´ å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Body: {
  "reviews": [
    {
      "upload_id": "upload_456_1640001234567_def456",
      "action": "approve",
      "amount": 58.50,
      "review_reason": "å®¡æ ¸é€šè¿‡"
    },
    {
      "upload_id": "upload_789_1640001234567_ghi789",
      "action": "reject",
      "review_reason": "å›¾ç‰‡æ¨¡ç³Š"
    }
  ]
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    success_count: 2,
    failed_count: 0,
    results: [
      {
        upload_id: 'upload_456_1640001234567_def456',
        status: 'approved',
        points_awarded: 585
      },
      {
        upload_id: 'upload_789_1640001234567_ghi789',
        status: 'rejected'
      }
    ]
  }
}
```

### 3.4 ç®¡ç†å‘˜ç»Ÿè®¡æ¥å£

```javascript
GET /api/merchant/statistics
Headers: {
  'Authorization': 'Bearer <admin_token>',  // ğŸ”´ å¿…é¡»æ˜¯ç®¡ç†å‘˜token
  'Content-Type': 'application/json'
}
Parameters: {
  period: 'today'  // 'today', 'week', 'month', 'all'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    review_stats: {
      pending_count: 15,
      approved_count: 89,
      rejected_count: 12,
      total_count: 116
    },
    points_stats: {
      total_awarded: 125600,      // æ€»å¥–åŠ±ç§¯åˆ†
      avg_amount: 45.8,           // å¹³å‡æ¶ˆè´¹é‡‘é¢
      total_amount: 4086.2        // æ€»æ¶ˆè´¹é‡‘é¢
    },
    user_stats: {
      total_users: 156,           // æ€»ç”¨æˆ·æ•°
      active_users: 89,           // æ´»è·ƒç”¨æˆ·æ•°
      admin_users: 3              // ğŸ”´ ç®¡ç†å‘˜ç”¨æˆ·æ•°ï¼ˆç®€åŒ–ç»Ÿè®¡ï¼‰
    },
    time_range: {
      start_date: '2024-12-19',
      end_date: '2024-12-19'
    }
  }
}
```

---

## å››ã€ç”¨æˆ·åŠŸèƒ½æ¥å£ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 4.1 ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
GET /api/user/profile
Headers: {
  'Authorization': 'Bearer <user_token>'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    user_id: 456,
    mobile: '139****9000',
    nickname: 'ç”¨æˆ·002',
    avatar_url: 'https://sealos.storage/avatars/456.jpg',
    total_points: 2500,
    is_admin: false,            // ğŸ”´ å”¯ä¸€æƒé™æ ‡è¯†
    status: 'active',
    last_login: '2025-01-11T10:30:00.000Z',
    created_at: '2024-11-15T08:20:00.000Z',
    login_count: 45,
    
    // ğŸ”´ ç»Ÿè®¡ä¿¡æ¯
    statistics: {
      total_uploads: 12,
      approved_uploads: 9,
      total_earned_points: 5600,
      total_spent_points: 3100,
      lottery_count: 31,
      exchange_count: 8
    }
    
    // ğŸ”´ æ³¨æ„ï¼šä¸å†åŒ…å«å•†å®¶ç›¸å…³ä¿¡æ¯
    // business_info, merchant_statusç­‰å­—æ®µå·²å®Œå…¨åˆ é™¤
  }
}
```

### 4.2 æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ¥å£

```javascript
PUT /api/user/profile
Headers: {
  'Authorization': 'Bearer <user_token>',
  'Content-Type': 'application/json'
}
Body: {
  "nickname": "æ–°æ˜µç§°",
  "avatar_url": "https://sealos.storage/avatars/456_new.jpg"
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    user_id: 456,
    nickname: 'æ–°æ˜µç§°',
    avatar_url: 'https://sealos.storage/avatars/456_new.jpg',
    updated_at: '2025-01-11T12:00:00.000Z'
  }
}
```

### 4.3 ç§¯åˆ†è®°å½•æ¥å£

```javascript
GET /api/user/points/records
Headers: {
  'Authorization': 'Bearer <user_token>'
}
Parameters: {
  page: 1,         // é¡µç ï¼Œé»˜è®¤1
  limit: 20,       // æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
  type: 'all',     // 'all', 'earn', 'spend'
  source: ''       // å¯é€‰ç­›é€‰ï¼š'photo_upload', 'lottery', 'exchange', 'register'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    records: [{
      record_id: 1001,
      points: 585,               // æ­£æ•°ä¸ºè·å¾—ï¼Œè´Ÿæ•°ä¸ºæ¶ˆè´¹
      type: 'earn',              // 'earn' | 'spend'
      source: 'photo_upload',    // ç§¯åˆ†æ¥æº
      description: 'æ‹ç…§ä¸Šä¼ å®¡æ ¸é€šè¿‡å¥–åŠ±',
      balance_after: 3085,       // æ“ä½œåä½™é¢
      related_id: 'upload_456_1640001234567_def456',
      created_at: '2024-12-19 15:30:00'
    }, {
      record_id: 1002,
      points: -100,
      type: 'spend',
      source: 'lottery',
      description: 'å‚ä¸æŠ½å¥–æ¶ˆè´¹',
      balance_after: 2985,
      related_id: 'lottery_single_20241219153200',
      created_at: '2024-12-19 15:32:00'
    }],
    pagination: {
      total: 67,
      page: 1,
      limit: 20,
      totalPages: 4
    },
    statistics: {
      total_earned: 8500,        // æ€»è·å¾—ç§¯åˆ†
      total_spent: 3200,         // æ€»æ¶ˆè´¹ç§¯åˆ†
      current_balance: 2500      // å½“å‰ä½™é¢
    }
  }
}
```

### 4.4 ç”¨æˆ·ç»Ÿè®¡æ¥å£ï¼ˆç»¼åˆç»Ÿè®¡æ•°æ®ï¼‰

#### 4.4.1 ç”¨æˆ·åŸºæœ¬ç»Ÿè®¡æ¥å£

```javascript
GET /api/user/statistics
Headers: {
  'Authorization': 'Bearer <user_token>'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    user_info: {
      user_id: 31,
      nickname: 'ç”¨æˆ·7911',
      status: 'active',
      registration_days: 9
    },
    points_statistics: {
      current_points: 45600,         // å½“å‰ç§¯åˆ†ä½™é¢
      total_earned: 51000,           // æ€»è·å¾—ç§¯åˆ†
      total_spent: 5400,             // æ€»æ¶ˆè´¹ç§¯åˆ†
      earn_by_source: {
        register: 1000,              // æ³¨å†Œè·å¾—
        photo_upload: 50000          // æ‹ç…§ä¸Šä¼ è·å¾—
      },
      spend_by_source: {
        lottery: 5400                // æŠ½å¥–æ¶ˆè´¹
      }
    },
    activity_statistics: {
      today_activities: 10,          // ä»Šæ—¥æ´»åŠ¨æ¬¡æ•°
      total_records: 14,             // æ€»è®°å½•æ•°
      earn_records_count: 4,         // è·å¾—ç§¯åˆ†è®°å½•æ•°
      spend_records_count: 10        // æ¶ˆè´¹ç§¯åˆ†è®°å½•æ•°
    }
  }
}
```

#### 4.4.2 æŠ½å¥–ç»Ÿè®¡æ¥å£

```javascript
GET /api/lottery/statistics
Headers: {
  'Authorization': 'Bearer <user_token>'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    total_draws: 10,               // æ€»æŠ½å¥–æ¬¡æ•°
    total_cost: 5400,              // æ€»æ¶ˆè´¹ç§¯åˆ†
    draw_type_stats: {
      other: {
        count: 10,                 // æŠ½å¥–æ¬¡æ•°
        cost: 5400                 // æ¶ˆè´¹ç§¯åˆ†
      }
    },
    win_rate: 30,                  // ä¸­å¥–ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
    favorite_time: 'æ™šä¸Š',          // æœ€å–œæ¬¢çš„æŠ½å¥–æ—¶é—´
    luckiest_day: 'å‘¨äº”'           // è¿æ°”æœ€å¥½çš„æ—¥å­
  }
}
```

#### 4.4.3 æ‹ç…§ç»Ÿè®¡æ¥å£

```javascript
GET /api/photo/statistics
Headers: {
  'Authorization': 'Bearer <user_token>'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    total_uploads: 6,              // æ€»ä¸Šä¼ æ¬¡æ•°
    approved_uploads: 4,           // å®¡æ ¸é€šè¿‡æ¬¡æ•°
    rejected_uploads: 1,           // å®¡æ ¸æ‹’ç»æ¬¡æ•°
    pending_uploads: 1,            // å¾…å®¡æ ¸æ¬¡æ•°
    approval_rate: 67,             // é€šè¿‡ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
    total_points_earned: 50010,    // æ€»è·å¾—ç§¯åˆ†
    total_amount_uploaded: 4,      // æ€»ä¸Šä¼ é‡‘é¢ï¼ˆå·²åºŸå¼ƒï¼Œå…¼å®¹å­—æ®µï¼‰
    average_points_per_upload: 12503, // å¹³å‡æ¯æ¬¡ä¸Šä¼ è·å¾—ç§¯åˆ†
    monthly_stats: {
      '2025-07': {
        count: 6,                  // å½“æœˆä¸Šä¼ æ¬¡æ•°
        approved: 4,               // å½“æœˆé€šè¿‡æ¬¡æ•°
        points: 50010,             // å½“æœˆè·å¾—ç§¯åˆ†
        amount: 4                  // å½“æœˆä¸Šä¼ é‡‘é¢ï¼ˆå·²åºŸå¼ƒï¼‰
      }
    }
  }
}
```

#### 4.4.4 å‰ç«¯ç»Ÿè®¡æ•°æ®æ•´åˆç¤ºä¾‹

```javascript
// ğŸ”§ å‰ç«¯è°ƒç”¨ä¸‰ä¸ªç»Ÿè®¡æ¥å£å¹¶æ•´åˆæ•°æ®
const getComprehensiveStatistics = async () => {
  try {
    const [userStats, lotteryStats, photoStats] = await Promise.all([
      fetch('/api/user/statistics'),    // ç”¨æˆ·åŸºæœ¬ç»Ÿè®¡
      fetch('/api/lottery/statistics'), // æŠ½å¥–ç»Ÿè®¡
      fetch('/api/photo/statistics')    // æ‹ç…§ç»Ÿè®¡
    ]);
    
    // ğŸ”´ æ•°æ®æ•´åˆå’Œå­—æ®µæ˜ å°„
    return {
      totalLottery: lotteryStats.data?.total_draws || 0,
      totalUpload: photoStats.data?.total_uploads || 0,
      approvedUpload: photoStats.data?.approved_uploads || 0,
      currentPoints: userStats.data?.points_statistics?.current_points || 0,
      thisMonthPoints: userStats.data?.points_statistics?.current_points || 0,
      registrationDays: userStats.data?.user_info?.registration_days || 0
    };
  } catch (error) {
    console.error('ç»Ÿè®¡æ•°æ®è·å–å¤±è´¥:', error);
    return null;
  }
};
```

---

## äº”ã€æ‹ç…§ä¸Šä¼ æ¥å£ï¼ˆç®€åŒ–æµç¨‹ç‰ˆï¼‰

### 5.1 æ‹ç…§ä¸Šä¼ æ¥å£ï¼ˆç”¨æˆ·æ“ä½œç®€åŒ–ï¼‰

```javascript
POST /api/photo/upload
Headers: {
  'Authorization': 'Bearer <user_token>',
  'Content-Type': 'multipart/form-data'
}
Body: FormData {
  photo: File,              // å›¾ç‰‡æ–‡ä»¶ï¼ˆå¿…å¡«ï¼‰
  // ğŸ”´ æ³¨æ„ï¼šä¸å†éœ€è¦amountå­—æ®µï¼Œç”¨æˆ·æ— éœ€è¾“å…¥æ¶ˆè´¹é‡‘é¢
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    upload_id: 'upload_456_1640001234567_def456',
    image_url: 'https://sealos.storage/photos/456/1640001234567_def456.jpg',
    file_size: 1024000,
    original_filename: 'receipt_20241219.jpg',
    status: 'pending',          // ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸
    uploaded_at: '2024-12-19 14:30:00',
    estimated_review_time: '24å°æ—¶å†…'
  }
}

// æ–‡ä»¶è¿‡å¤§é”™è¯¯
{
  "code": 1003,
  "msg": "å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB",
  "data": {
    "max_size": 5242880,       // 5MBé™åˆ¶
    "current_size": 6291456    // å½“å‰æ–‡ä»¶å¤§å°
  }
}
```

### 5.2 ä¸Šä¼ å†å²æ¥å£

```javascript
GET /api/photo/history
Headers: {
  'Authorization': 'Bearer <user_token>'
}
Parameters: {
  page: 1,      // é¡µç ï¼Œé»˜è®¤1
  limit: 10,    // æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10ï¼Œæœ€å¤§50
  status: 'all' // 'all', 'pending', 'approved', 'rejected'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    records: [{
      upload_id: 'upload_456_1640001234567_def456',
      image_url: 'https://sealos.storage/photos/456/1640001234567_def456.jpg',
      amount: 58.50,             // ğŸ”´ ç®¡ç†å‘˜å®¡æ ¸æ—¶è®¾ç½®çš„é‡‘é¢
      status: 'approved',
      uploaded_at: '2024-12-19 14:30:00',
      reviewed_at: '2024-12-19 15:30:00',
      points_awarded: 585,       // è·å¾—çš„ç§¯åˆ†
      review_reason: 'å®¡æ ¸é€šè¿‡ï¼Œå®é™…æ¶ˆè´¹58.5å…ƒ'
    }, {
      upload_id: 'upload_456_1640001234567_ghi789',
      image_url: 'https://sealos.storage/photos/456/1640001234567_ghi789.jpg',
      amount: null,              // å¾…å®¡æ ¸ï¼Œå°šæœªè®¾ç½®é‡‘é¢
      status: 'pending',
      uploaded_at: '2024-12-19 16:00:00',
      points_awarded: 0
    }],
    pagination: {
      total: 12,
      page: 1,
      limit: 10,
      totalPages: 2
    },
    statistics: {
      total_uploads: 12,
      approved_count: 9,
      pending_count: 2,
      rejected_count: 1,
      total_points_earned: 4560   // é€šè¿‡æ‹ç…§è·å¾—çš„æ€»ç§¯åˆ†
    }
  }
}
```

---

## å…­ã€æŠ½å¥–ç³»ç»Ÿæ¥å£

### 6.1 è·å–æŠ½å¥–é…ç½®

```javascript
GET /api/lottery/config
Headers: {
  'Authorization': 'Bearer <user_token>'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    prizes: [{
      prize_id: 1,
      prize_name: 'å…«å…«æŠ˜åˆ¸',
      prize_type: 'coupon',
      prize_value: 0.88,
      angle: 0,                  // è½¬ç›˜è§’åº¦ä½ç½®
      color: '#FF6B6B',          // è½¬ç›˜é¢œè‰²
      probability: 0.05,         // 5%ä¸­å¥–ç‡
      is_activity: false
    }, {
      prize_id: 2,
      prize_name: 'ä¹å…«æŠ˜åˆ¸',
      prize_type: 'coupon',
      prize_value: 0.98,
      angle: 45,
      color: '#4ECDC4',
      probability: 0.10,         // 10%ä¸­å¥–ç‡ï¼ˆä¿åº•å¥–å“ï¼‰
      is_activity: false
    }],
    lottery_config: {
      cost_points: 100,          // æ¯æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†
      daily_limit: 50,           // æ¯æ—¥æŠ½å¥–æ¬¡æ•°é™åˆ¶
      pity_system: {
        enabled: true,
        limit: 10,               // 10æ¬¡ä¿åº•
        prize_id: 2              // ä¿åº•å¥–å“IDï¼ˆä¹å…«æŠ˜åˆ¸ï¼‰
      }
    },
    user_status: {
      current_points: 2500,      // ç”¨æˆ·å½“å‰ç§¯åˆ†
      today_draw_count: 3,       // ä»Šæ—¥å·²æŠ½å¥–æ¬¡æ•°
      pity_count: 7,             // å½“å‰ä¿åº•è®¡æ•°
      remaining_draws: 3         // è·ç¦»ä¿åº•å‰©ä½™æ¬¡æ•°
    }
  }
}
```

### 6.2 æ‰§è¡ŒæŠ½å¥–æ¥å£

```javascript
POST /api/lottery/draw
Headers: {
  'Authorization': 'Bearer <user_token>',
  'Content-Type': 'application/json'
}
Body: {
  "draw_type": "single"        // 'single', 'five', 'ten'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    results: [{
      sequence: 1,               // æŠ½å¥–åºå·
      prize_id: 3,
      prize_name: 'ç”œå“1ä»½',
      prize_type: 'physical',
      prize_value: 15.00,
      stop_angle: 92.5,          // è½¬ç›˜åœæ­¢è§’åº¦
      is_pity: false,            // æ˜¯å¦ä¿åº•è§¦å‘
      points_consumed: 100       // æ¶ˆè€—ç§¯åˆ†
    }],
    lottery_info: {
      batch_id: 'batch_456_20241219153500',
      draw_type: 'single',
      total_cost: 100,           // æ€»æ¶ˆè€—ç§¯åˆ†
      total_results: 1
    },
    user_status: {
      remaining_points: 2400,    // å‰©ä½™ç§¯åˆ†
      pity_count: 8,             // æ›´æ–°åçš„ä¿åº•è®¡æ•°
      remaining_draws: 2,        // è·ç¦»ä¿åº•å‰©ä½™æ¬¡æ•°
      today_draw_count: 4        // æ›´æ–°åçš„ä»Šæ—¥æŠ½å¥–æ¬¡æ•°
    }
  }
}

// ç§¯åˆ†ä¸è¶³é”™è¯¯
{
  "code": 1004,
  "msg": "ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•è¿›è¡ŒæŠ½å¥–",
  "data": {
    "required_points": 100,
    "current_points": 50
  }
}
```

---

## ä¸ƒã€é”™è¯¯å¤„ç†è§„èŒƒï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 7.1 ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

```javascript
// ğŸ”´ æƒé™ç›¸å…³é”™è¯¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
{
  "code": 4005,
  "msg": "éœ€è¦ç®¡ç†å‘˜æƒé™",        // ğŸ”´ ç®€åŒ–æƒé™é”™è¯¯ä¿¡æ¯
  "data": null
}

// é€šç”¨ä¸šåŠ¡é”™è¯¯
{
  "code": 1000,
  "msg": "å‚æ•°é”™è¯¯",
  "data": {
    "field": "mobile",
    "message": "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®"
  }
}

// ç³»ç»Ÿé”™è¯¯
{
  "code": 5000,
  "msg": "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•",
  "data": null
}
```

### 7.2 é”™è¯¯ä»£ç åˆ†ç±»ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

```javascript
const ERROR_CODES = {
  // æˆåŠŸ
  SUCCESS: 0,
  
  // ä¸šåŠ¡é”™è¯¯ 1000-1999
  PARAM_ERROR: 1000,
  MOBILE_FORMAT_ERROR: 1001,
  VERIFY_CODE_ERROR: 1002,
  FILE_TOO_LARGE: 1003,
  INSUFFICIENT_POINTS: 1004,
  
  // è®¤è¯é”™è¯¯ 4000-4999
  UNAUTHORIZED: 4001,
  INVALID_TOKEN: 4002,
  USER_NOT_FOUND: 4003,
  USER_BANNED: 4004,
  ADMIN_REQUIRED: 4005,        // ğŸ”´ ç®€åŒ–æƒé™é”™è¯¯
  
  // ç³»ç»Ÿé”™è¯¯ 5000-5999
  INTERNAL_ERROR: 5000,
  DATABASE_ERROR: 5001,
  THIRD_PARTY_ERROR: 5002
};
```

### 7.3 å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

```javascript
// ğŸ”´ å‰ç«¯æƒé™é”™è¯¯å¤„ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
function handleApiError(error) {
  switch (error.code) {
    case 4001:
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      wx.navigateTo({ url: '/pages/login/login' });
      break;
      
    case 4005:
      // éœ€è¦ç®¡ç†å‘˜æƒé™
      wx.showModal({
        title: 'æƒé™ä¸è¶³',
        content: 'æ­¤åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™',
        showCancel: false
      });
      break;
      
    case 1004:
      // ç§¯åˆ†ä¸è¶³
      wx.showModal({
        title: 'ç§¯åˆ†ä¸è¶³',
        content: `å½“å‰ç§¯åˆ†ï¼š${error.data.current_points}ï¼Œéœ€è¦ï¼š${error.data.required_points}`,
        confirmText: 'å»è·å–ç§¯åˆ†',
        success: (res) => {
          if (res.confirm) {
            wx.navigateTo({ url: '/pages/camera/camera' });
          }
        }
      });
      break;
      
    default:
      wx.showToast({
        title: error.msg || 'æ“ä½œå¤±è´¥',
        icon: 'none'
      });
  }
}
```

---

## å…«ã€WebSocketå®æ—¶é€šä¿¡æ¥å£

### 8.1 WebSocketè¿æ¥

```javascript
// WebSocketè¿æ¥åœ°å€
const WS_URL = 'wss://omqktqrtntnn.sealosbja.site/ws';

// è¿æ¥å‚æ•°
const connectWebSocket = () => {
  wx.connectSocket({
    url: `${WS_URL}?token=${accessToken}`,
    protocols: ['protocol1']
  });
};

// è¿æ¥æˆåŠŸäº‹ä»¶
wx.onSocketOpen(() => {
  console.log('WebSocketè¿æ¥æˆåŠŸ');
});

// æ¥æ”¶æ¶ˆæ¯
wx.onSocketMessage((res) => {
  const message = JSON.parse(res.data);
  handleWebSocketMessage(message);
});
```

### 8.2 WebSocketæ¶ˆæ¯æ ¼å¼

```javascript
// ç§¯åˆ†å˜åŠ¨é€šçŸ¥
{
  "type": "points_update",
  "data": {
    "user_id": 456,
    "points_change": 585,        // ç§¯åˆ†å˜åŠ¨é‡
    "new_balance": 3085,         // æ–°çš„ç§¯åˆ†ä½™é¢
    "source": "photo_upload",    // ç§¯åˆ†æ¥æº
    "description": "æ‹ç…§ä¸Šä¼ å®¡æ ¸é€šè¿‡å¥–åŠ±",
    "timestamp": "2024-12-19T15:30:00.000Z"
  }
}

// å®¡æ ¸ç»“æœé€šçŸ¥
{
  "type": "review_result",
  "data": {
    "upload_id": "upload_456_1640001234567_def456",
    "status": "approved",        // 'approved' | 'rejected'
    "amount": 58.50,             // ç®¡ç†å‘˜è®¾ç½®çš„æ¶ˆè´¹é‡‘é¢
    "points_awarded": 585,       // å¥–åŠ±ç§¯åˆ†
    "review_reason": "å®¡æ ¸é€šè¿‡ï¼Œå®é™…æ¶ˆè´¹58.5å…ƒ",
    "timestamp": "2024-12-19T15:30:00.000Z"
  }
}

// åº“å­˜æ›´æ–°é€šçŸ¥ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
{
  "type": "stock_update",
  "data": {
    "product_id": 101,
    "product_name": "ç¾å‘³åˆ¸50å…ƒ",
    "old_stock": 5,
    "new_stock": 4,
    "operation": "exchange",     // 'exchange' | 'restock' | 'admin_adjust'
    "timestamp": "2024-12-19T15:30:00.000Z"
  }
}
```

---

## å…«ã€å•†å“ç®¡ç†æ¥å£ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰

### 8.1 ğŸ”´ å•†å“ç»Ÿè®¡æ¥å£

> **æƒé™è¦æ±‚**ï¼šç®¡ç†å‘˜æƒé™ï¼ˆ`is_admin = true`ï¼‰

```javascript
// 8.1.1 è·å–å•†å“ç»Ÿè®¡æ•°æ®
GET /api/merchant/product-stats
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    activeCount: 11,      // ä¸Šæ¶å•†å“æ•°é‡
    offlineCount: 0,      // ä¸‹æ¶å•†å“æ•°é‡
    lowStockCount: 0,     // ä½åº“å­˜å•†å“æ•°é‡ï¼ˆåº“å­˜â‰¤5ï¼‰
    totalCount: 11,       // æ€»å•†å“æ•°é‡
    outOfStockCount: 0    // é›¶åº“å­˜å•†å“æ•°é‡
  }
}

// é”™è¯¯å“åº”
Response (æƒé™ä¸è¶³): {
  code: 4005,
  msg: 'éœ€è¦ç®¡ç†å‘˜æƒé™',
  data: null
}
```

### 8.2 ğŸ”´ å•†å“åˆ—è¡¨ç®¡ç†æ¥å£

```javascript
// 8.2.1 è·å–å•†å“åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
GET /api/merchant/products
Parameters: {
  page: 1,              // é¡µç ï¼ˆé»˜è®¤1ï¼‰
  page_size: 20,        // æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼‰
  category: 'all',      // å•†å“åˆ†ç±»ç­›é€‰ï¼ˆ'all' | å…·ä½“åˆ†ç±»åï¼‰
  status: 'all',        // çŠ¶æ€ç­›é€‰ï¼ˆ'all' | 'active' | 'inactive'ï¼‰
  sort_by: 'sort_order', // æ’åºå­—æ®µ
  sort_order: 'ASC'     // æ’åºæ–¹å‘ï¼ˆASC | DESCï¼‰
}
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    products: [{
      commodity_id: 11,
      name: "å°ç±³å……ç”µå®",
      description: "å°ç±³10000mAhç§»åŠ¨ç”µæº",
      category: "æ•°ç äº§å“",
      exchange_points: 1500,
      stock: 30,
      image: "https://...",
      status: "active",
      is_hot: false,
      sort_order: 5,
      rating: 5.0,
      sales_count: 0,
      created_at: "2025-07-05T11:40:11.000Z",
      updated_at: "2025-07-05T11:40:11.000Z"
    }],
    pagination: {
      total: 11,
      page: 1,
      page_size: 20,
      totalPages: 1
    }
  }
}
```

### 8.3 ğŸ”´ å•†å“åˆ›å»ºç®¡ç†æ¥å£

```javascript
// 8.3.1 åˆ›å»ºå•†å“ï¼ˆç®¡ç†å‘˜ï¼‰
POST /api/merchant/products
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}
Body: {
  "name": "ç¾å‘³åˆ¸50å…ƒ",
  "description": "é¤å…é€šç”¨åˆ¸",
  "category": "ä¼˜æƒ åˆ¸",
  "exchange_points": 500,
  "stock": 100,
  "image_url": "https://...",
  "is_hot": false,
  "sort_order": 0
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    commodity_id: 12,
    name: "ç¾å‘³åˆ¸50å…ƒ",
    message: "å•†å“åˆ›å»ºæˆåŠŸ"
  }
}
```

### 8.4 ğŸ”´ å•†å“æ›´æ–°ç®¡ç†æ¥å£

```javascript
// 8.4.1 æ›´æ–°å•†å“ï¼ˆç®¡ç†å‘˜ï¼‰
PUT /api/merchant/products/:id
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}
Body: {
  "name": "ç¾å‘³åˆ¸50å…ƒï¼ˆæ›´æ–°ï¼‰",
  "exchange_points": 550,
  "stock": 150,
  "status": "active"
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    commodity_id: 12,
    message: "å•†å“æ›´æ–°æˆåŠŸ"
  }
}

// 8.4.2 åˆ é™¤å•†å“ï¼ˆè½¯åˆ é™¤ï¼‰
DELETE /api/merchant/products/:id
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    commodity_id: 12,
    message: "å•†å“åˆ é™¤æˆåŠŸ"
  }
}
```

### 8.5 ğŸ”´ æ‰¹é‡æ“ä½œæ¥å£

```javascript
// 8.5.1 æ‰¹é‡æ›´æ–°å•†å“
POST /api/merchant/products/batch-update
Headers: {
  'Authorization': 'Bearer <admin_token>',
  'Content-Type': 'application/json'
}
Body: {
  "products": [{
    "commodity_id": 1,
    "stock": 50,
    "status": "active"
  }, {
    "commodity_id": 2,
    "exchange_points": 600,
    "is_hot": true
  }]
}

Response: {
  code: 0,
  msg: 'success',
  data: {
    success_count: 2,
    failed_count: 0,
    results: [{
      commodity_id: 1,
      success: true,
      message: "æ›´æ–°æˆåŠŸ"
    }, {
      commodity_id: 2,
      success: true,
      message: "æ›´æ–°æˆåŠŸ"
    }]
  }
}
```

### 8.6 ğŸ”´ ä¸ç”¨æˆ·ç«¯å•†å“æ¥å£çš„åŒºåˆ«

```javascript
// ğŸ”´ ç®¡ç†å‘˜å•†å“æ¥å£ vs ç”¨æˆ·ç«¯å•†å“æ¥å£å¯¹æ¯”

// ç®¡ç†å‘˜å•†å“åˆ—è¡¨ï¼ˆç®¡ç†ç«¯ï¼‰
GET /api/merchant/products
// ç‰¹ç‚¹ï¼š
// - éœ€è¦ç®¡ç†å‘˜æƒé™
// - æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€å•†å“ï¼ˆactive/inactiveï¼‰
// - åŒ…å«åº“å­˜ã€é”€é‡ã€æ’åºç­‰ç®¡ç†ä¿¡æ¯
// - æ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰å’Œæ’åº

// ç”¨æˆ·ç«¯å•†å“åˆ—è¡¨ï¼ˆå…‘æ¢é¡µé¢ï¼‰
GET /api/exchange/products
// ç‰¹ç‚¹ï¼š
// - æ™®é€šç”¨æˆ·æƒé™å³å¯
// - åªæ˜¾ç¤ºactiveçŠ¶æ€å•†å“
// - åªæ˜¾ç¤ºç”¨æˆ·éœ€è¦çš„å…‘æ¢ä¿¡æ¯
// - æŒ‰å…‘æ¢çƒ­åº¦å’Œç§¯åˆ†æ’åº
```

---

## ä¹ã€å¼€å‘è°ƒè¯•æŒ‡å—ï¼ˆæƒé™ç®€åŒ–ç‰ˆï¼‰

### 9.1 æƒé™æµ‹è¯•ç”¨ä¾‹

```javascript
// ğŸ”´ æƒé™æµ‹è¯•ç”¨ä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

// æµ‹è¯•ç”¨ä¾‹1ï¼šæ™®é€šç”¨æˆ·ç™»å½•
const testUserLogin = {
  mobile: "13800138001",
  code: "123456",
  expected_is_admin: false
};

// æµ‹è¯•ç”¨ä¾‹2ï¼šç®¡ç†å‘˜ç™»å½•
const testAdminLogin = {
  mobile: "13800138000",       // ç®¡ç†å‘˜æ‰‹æœºå·
  code: "123456",
  expected_is_admin: true
};

// æµ‹è¯•ç”¨ä¾‹3ï¼šæ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
const testUserAccessAdmin = {
  endpoint: "/api/merchant/pending-reviews",
  token: "user_token",
  expected_code: 4005,
  expected_msg: "éœ€è¦ç®¡ç†å‘˜æƒé™"
};

// æµ‹è¯•ç”¨ä¾‹4ï¼šç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆåº”è¯¥æˆåŠŸï¼‰
const testAdminAccessAdmin = {
  endpoint: "/api/merchant/pending-reviews",
  token: "admin_token",
  expected_code: 0
};
```

### 9.2 APIæµ‹è¯•è„šæœ¬

```bash
#!/bin/bash
# ğŸ”´ æƒé™ç®€åŒ–APIæµ‹è¯•è„šæœ¬

BASE_URL="https://omqktqrtntnn.sealosbja.site"

# 1. æ™®é€šç”¨æˆ·ç™»å½•
echo "æµ‹è¯•æ™®é€šç”¨æˆ·ç™»å½•..."
USER_RESPONSE=$(curl -s -X POST "${BASE_URL}/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13800138001","code":"123456"}')

USER_TOKEN=$(echo $USER_RESPONSE | jq -r '.data.access_token')
IS_ADMIN=$(echo $USER_RESPONSE | jq -r '.data.user_info.is_admin')

echo "æ™®é€šç”¨æˆ· is_admin: $IS_ADMIN (é¢„æœŸ: false)"

# 2. ç®¡ç†å‘˜ç™»å½•
echo "æµ‹è¯•ç®¡ç†å‘˜ç™»å½•..."
ADMIN_RESPONSE=$(curl -s -X POST "${BASE_URL}/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"mobile":"13800138000","code":"123456"}')

ADMIN_TOKEN=$(echo $ADMIN_RESPONSE | jq -r '.data.access_token')
ADMIN_IS_ADMIN=$(echo $ADMIN_RESPONSE | jq -r '.data.user_info.is_admin')

echo "ç®¡ç†å‘˜ is_admin: $ADMIN_IS_ADMIN (é¢„æœŸ: true)"

# 3. æµ‹è¯•æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
echo "æµ‹è¯•æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½..."
USER_ADMIN_ACCESS=$(curl -s -X GET "${BASE_URL}/api/merchant/pending-reviews" \
  -H "Authorization: Bearer $USER_TOKEN")

USER_ACCESS_CODE=$(echo $USER_ADMIN_ACCESS | jq -r '.code')
echo "æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½è¿”å›ç : $USER_ACCESS_CODE (é¢„æœŸ: 4005)"

# 4. æµ‹è¯•ç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½ï¼ˆåº”è¯¥æˆåŠŸï¼‰
echo "æµ‹è¯•ç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½..."
ADMIN_ACCESS=$(curl -s -X GET "${BASE_URL}/api/merchant/pending-reviews" \
  -H "Authorization: Bearer $ADMIN_TOKEN")

ADMIN_ACCESS_CODE=$(echo $ADMIN_ACCESS | jq -r '.code')
echo "ç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½è¿”å›ç : $ADMIN_ACCESS_CODE (é¢„æœŸ: 0)"
```

### 9.3 å‰ç«¯æƒé™é€‚é…æ£€æŸ¥æ¸…å•

```javascript
// ğŸ”´ å‰ç«¯æƒé™é€‚é…æ£€æŸ¥æ¸…å•

const FRONTEND_ADAPTATION_CHECKLIST = {
  
  // 1. ç™»å½•é€»è¾‘æ£€æŸ¥
  loginLogic: [
    "âœ… åˆ é™¤ç®¡ç†å‘˜ä¸“ç”¨ç™»å½•é¡µé¢",
    "âœ… ç»Ÿä¸€ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç ç™»å½•",
    "âœ… ç™»å½•æˆåŠŸåæ£€æŸ¥is_adminå­—æ®µåˆ¤æ–­æƒé™",
    "âœ… ç®€åŒ–is_merchantç›¸å…³çš„æƒé™åˆ¤æ–­ï¼Œæ”¹ç”¨is_adminç»Ÿä¸€æ§åˆ¶"
  ],
  
  // 2. ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºæ£€æŸ¥
  userInfoDisplay: [
    "âœ… è°ƒæ•´å•†å®¶ç®¡ç†åŠŸèƒ½æ˜¾ç¤ºæƒé™ï¼Œä»…ç®¡ç†å‘˜å¯è§",
    "âœ… ç®€åŒ–æƒé™çŠ¶æ€æ˜¾ç¤ºï¼Œç»Ÿä¸€ä½¿ç”¨ç®¡ç†å‘˜æƒé™",
    "âœ… ç®€åŒ–ç”¨æˆ·ä¿¡æ¯ä¸ºåŸºç¡€ä¿¡æ¯+ç®¡ç†å‘˜æ ‡è¯†",
    "âœ… æ›´æ–°ç”¨æˆ·æƒé™æ˜¾ç¤ºé€»è¾‘"
  ],
  
  // 3. å¯¼èˆªèœå•æ£€æŸ¥
  navigationMenu: [
    "âœ… è°ƒæ•´å•†å®¶ç®¡ç†èœå•æƒé™ï¼Œæ”¹ä¸ºç®¡ç†å‘˜ä¸“ç”¨",
    "âœ… ç®¡ç†å‘˜èœå•åŒ…å«æ‰€æœ‰ç®¡ç†åŠŸèƒ½",
    "âœ… æ™®é€šç”¨æˆ·èœå•åªæ˜¾ç¤ºåŸºç¡€åŠŸèƒ½",
    "âœ… æƒé™æ§åˆ¶åŸºäºis_adminå­—æ®µ"
  ],
  
  // 4. åŠŸèƒ½é¡µé¢æ£€æŸ¥
  functionalPages: [
    "âœ… ç®€åŒ–æƒé™ç”³è¯·æµç¨‹ï¼Œç”±ç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†",
    "âœ… å•†å®¶ç®¡ç†åŠŸèƒ½ä¿ç•™ï¼Œè°ƒæ•´ä¸ºç®¡ç†å‘˜ä¸“ç”¨è®¿é—®",
    "âœ… æƒé™ä¸è¶³æ—¶æ˜¾ç¤ºç»Ÿä¸€é”™è¯¯æç¤º",
    "âœ… ç®¡ç†å‘˜åŠŸèƒ½å…¥å£åŸºäºis_adminæ§åˆ¶"
  ],
  
  // 5. APIè°ƒç”¨æ£€æŸ¥
  apiCalls: [
    "âœ… è°ƒæ•´å•†å®¶ç®¡ç†APIè°ƒç”¨æƒé™ï¼Œæ”¹ä¸ºç®¡ç†å‘˜æƒé™æ§åˆ¶",
    "âœ… ç®¡ç†å‘˜åŠŸèƒ½APIè°ƒç”¨å‰æ£€æŸ¥æƒé™",
    "âœ… æƒé™é”™è¯¯ç»Ÿä¸€å¤„ç†ä¸º'éœ€è¦ç®¡ç†å‘˜æƒé™'",
    "âœ… ç”¨æˆ·ä¿¡æ¯ä¸å†åŒ…å«å•†å®¶ç›¸å…³å­—æ®µ"
  ]
};
```

---

## åã€æ€»ç»“

### 10.1 æƒé™ç®€åŒ–æ ¸å¿ƒå˜æ›´

1. **æƒé™çº§åˆ«ç®€åŒ–**ï¼šä»ä¸‰çº§æƒé™ï¼ˆç”¨æˆ·/å•†å®¶/ç®¡ç†å‘˜ï¼‰ç®€åŒ–ä¸ºäºŒçº§æƒé™ï¼ˆç”¨æˆ·/ç®¡ç†å‘˜ï¼‰ï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½ç”±ç®¡ç†å‘˜ç»Ÿä¸€è´Ÿè´£
2. **ç™»å½•æ–¹å¼ç»Ÿä¸€**ï¼šæ‰€æœ‰ç”¨æˆ·åŒ…æ‹¬ç®¡ç†å‘˜éƒ½ä½¿ç”¨æ‰‹æœºå·+éªŒè¯ç ç™»å½•
3. **æƒé™å­—æ®µç®€åŒ–**ï¼šåªä¿ç•™`is_admin`ä½œä¸ºå”¯ä¸€æƒé™æ ‡è¯†
4. **APIæ¥å£æƒé™è°ƒæ•´**ï¼šå•†å®¶ç®¡ç†åŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œä»…è°ƒæ•´æƒé™æ§åˆ¶ä¸ºéœ€è¦ç®¡ç†å‘˜æƒé™

### 10.2 å‰ç«¯é€‚é…è¦ç‚¹

1. **æƒé™åˆ¤æ–­æ›´æ–°**ï¼šå°†æ‰€æœ‰å•†å®¶æƒé™æ£€æŸ¥æ”¹ä¸ºç®¡ç†å‘˜æƒé™æ£€æŸ¥
2. **ç”¨æˆ·ä¿¡æ¯é€‚é…**ï¼šç®€åŒ–æƒé™å­—æ®µæ˜¾ç¤ºï¼Œå•†å®¶ç®¡ç†åŠŸèƒ½ç”±ç®¡ç†å‘˜ç»Ÿä¸€æ§åˆ¶
3. **åŠŸèƒ½èœå•è°ƒæ•´**ï¼šå•†å®¶ç®¡ç†åŠŸèƒ½ä¿ç•™ï¼Œä»…è°ƒæ•´ä¸ºç®¡ç†å‘˜ä¸“ç”¨æ˜¾ç¤º
4. **é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼šæƒé™ä¸è¶³ç»Ÿä¸€æç¤º"éœ€è¦ç®¡ç†å‘˜æƒé™"

### 10.3 åç«¯æ¥å£ä¿è¯

1. **æ¥å£è·¯å¾„ä¸å˜**ï¼šä¿æŒç°æœ‰APIè·¯å¾„ï¼Œåªè°ƒæ•´æƒé™éªŒè¯é€»è¾‘
2. **å“åº”æ ¼å¼å…¼å®¹**ï¼šç®€åŒ–æƒé™ç›¸å…³å­—æ®µï¼Œä¿æŒå…¶ä»–å­—æ®µæ ¼å¼ä¸å˜
3. **æƒé™éªŒè¯ä¸¥æ ¼**ï¼šç¡®ä¿ç®¡ç†å‘˜åŠŸèƒ½åªæœ‰`is_admin = true`ç”¨æˆ·æ‰èƒ½è®¿é—®
4. **å‘å‰å…¼å®¹æ€§**ï¼šç¡®ä¿å‰ç«¯å‡çº§è¿‡ç¨‹ä¸­çš„å…¼å®¹æ€§

---

> **æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£ä¸æƒé™ç®€åŒ–åçš„å®é™…ä»£ç ä¿æŒ100%åŒæ­¥
> **ç‰ˆæœ¬æ ‡è¯†**ï¼šv2.2.0 - æƒé™ç®€åŒ–ç‰ˆæœ¬
> **æ›´æ–°æ—¶é—´**ï¼š2025å¹´01æœˆ11æ—¥
> **ä½¿ç”¨æ¨¡å‹**ï¼šClaude Sonnet 4