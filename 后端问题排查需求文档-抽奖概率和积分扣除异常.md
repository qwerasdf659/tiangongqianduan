# 后端问题排查需求文档 - 抽奖概率和积分扣除异常

> **🎯 问题类型**：后端API业务逻辑错误  
> **🚨 紧急程度**：高优先级（影响核心抽奖功能）  
> **📝 创建时间**：2025年1月12日  
> **🤖 诊断模型**：Claude 4 Sonnet  
> **👤 问题账号**：管理员账号 13612227930  

## 📊 一、问题概述

### 1.1 核心问题
管理员账号13612227930在使用抽奖功能时发现两个严重问题：
1. **抽奖概率异常**：每次抽奖都只中"花甲1份"，概率算法疑似失效
2. **积分扣除错误**：十连抽应扣除1000积分，但实际只扣除100积分

### 1.2 影响范围
- **用户体验**：抽奖结果单一，影响用户参与积极性
- **积分系统**：积分扣除错误可能导致系统积分数据混乱
- **商业损失**：错误的积分扣除可能导致经济损失

## 🔍 二、前端验证结果

### 2.1 ✅ 前端代码审查通过
经过完整的前端代码审查，确认前端实现完全正确：

#### 积分计算逻辑验证
```javascript
// pages/lottery/lottery.js 第2038行
const needPoints = costPoints * count  // 100 * 10 = 1000 ✅

// pages/lottery/lottery.js 第1160行  
const needPoints = (this.data.costPoints || 100) * count  // 备用计算也正确 ✅
```

#### API调用参数验证
```javascript
// utils/api.js 第456-464行
draw(drawType = 'single', count = 1) {
  return request({
    url: '/lottery/draw',
    method: 'POST',
    data: { 
      draw_type: drawType,  // "十连抽" ✅
      count: count         // 10 ✅
    },
    needAuth: true
  })
}
```

#### 前端确认弹窗验证
```javascript
// 前端正确显示：即将消耗 1000 积分进行十连抽 ✅
content: `即将消耗 ${needPoints} 积分进行${drawType}\n剩余积分将为 ${totalPoints - needPoints}`
```

### 2.2 🔍 前端请求追踪
- **请求URL**：`POST /api/lottery/draw`
- **请求参数**：`{"draw_type":"十连抽","count":10}`
- **认证头部**：`Authorization: Bearer <valid_token>`
- **参数传递**：前端参数传递完全正确

## 🚨 三、后端问题定位

### 3.1 问题1：抽奖概率算法异常

#### 问题表现
- 连续多次抽奖都只中"花甲1份"
- 应该有8种不同奖品的随机分布
- 疑似概率配置或随机算法失效

#### 需要检查的后端代码
```javascript
// 🔍 请检查以下后端逻辑：

1. 抽奖概率配置表
   - 检查数据库中prizes表的probability字段
   - 确认8个奖品的概率分配是否正确
   - 验证概率总和是否等于100%

2. 随机算法实现
   - 检查抽奖随机数生成算法
   - 验证概率权重计算逻辑
   - 确认随机种子是否正常

3. 奖品选择逻辑
   - 检查根据随机数选择奖品的逻辑
   - 验证概率区间划分是否正确
   - 确认是否有特定用户的特殊处理
```

#### 期望的概率分布（参考产品文档）
| 奖品名称 | 期望概率 | 当前表现 |
|---------|----------|----------|
| 八八折券 | 0% | 未中奖 |
| 九八折券 | 10% | 未中奖 |
| 甜品1份 | 30% | 未中奖 |
| 青菜1份 | 30% | 未中奖 |
| 虾1份 | 5% | 未中奖 |
| **花甲1份** | **20%** | **100%** ❌ |
| 鱿鱼1份 | 5% | 未中奖 |
| 生腌拼盘158 | 0% | 未中奖 |

### 3.2 问题2：积分扣除计算错误

#### 问题表现
- 十连抽应扣除：`100积分/次 × 10次 = 1000积分`
- 实际扣除：`100积分`
- 错误率：扣除不足900积分

#### 需要检查的后端代码
```javascript
// 🔍 请检查以下后端逻辑：

1. 积分扣除计算
   // 应该是这样的逻辑：
   const costPerDraw = 100;  // 每次抽奖成本
   const totalCost = costPerDraw * count;  // 总成本计算
   
   // 检查实际实现是否正确

2. 数据库积分更新
   // 检查积分更新SQL是否正确：
   UPDATE users SET total_points = total_points - ? WHERE user_id = ?
   // 确认参数是 totalCost 而不是 costPerDraw

3. 响应数据返回
   // 检查返回给前端的积分数据：
   {
     "user_info": {
       "remaining_points": 正确的剩余积分
     }
   }
```

## 🛠️ 四、后端排查清单

### 4.1 ⚡ 紧急检查项（立即执行）

#### 数据库检查
```sql
-- 1. 检查奖品概率配置
SELECT prize_id, prize_name, probability FROM lottery_prizes ORDER BY prize_id;

-- 2. 检查用户积分变动记录
SELECT * FROM point_records 
WHERE user_id = (SELECT user_id FROM users WHERE mobile = '13612227930') 
ORDER BY created_at DESC LIMIT 10;

-- 3. 检查抽奖记录
SELECT * FROM lottery_records 
WHERE user_id = (SELECT user_id FROM users WHERE mobile = '13612227930') 
ORDER BY created_at DESC LIMIT 10;
```

#### 服务日志检查
```bash
# 检查抽奖API日志
grep "/lottery/draw" /var/log/app.log | tail -20

# 检查积分计算日志
grep "积分扣除\|points deduct" /var/log/app.log | tail -10
```

### 4.2 🔧 代码审查重点

#### 抽奖概率算法
```javascript
// 🔍 重点检查这些函数：
1. calculateLotteryResult(drawType, count)
2. selectPrizeByProbability(randomValue)
3. getPrizeConfiguration()
4. generateRandomNumber()
```

#### 积分扣除逻辑
```javascript
// 🔍 重点检查这些函数：
1. deductUserPoints(userId, amount)
2. calculateLotteryCost(drawType, count)
3. updateUserBalance(userId, newBalance)
4. recordPointsTransaction(userId, amount, type)
```

### 4.3 🧪 测试验证

#### 概率测试
```javascript
// 建议进行概率分布测试：
for (let i = 0; i < 100; i++) {
  const result = lotteryService.draw('单抽', 1);
  console.log(`第${i+1}次抽奖结果:`, result.prize_name);
}
// 统计各奖品出现频率，验证是否符合预期概率
```

#### 积分计算测试
```javascript
// 建议进行积分计算测试：
const testCases = [
  { drawType: '单抽', count: 1, expected: 100 },
  { drawType: '三连抽', count: 3, expected: 300 },
  { drawType: '五连抽', count: 5, expected: 500 },
  { drawType: '十连抽', count: 10, expected: 1000 }
];

testCases.forEach(test => {
  const cost = calculateLotteryCost(test.drawType, test.count);
  console.log(`${test.drawType} 预期成本: ${test.expected}, 实际计算: ${cost}`);
});
```

## 📋 五、问题修复验证标准

### 5.1 概率问题修复验证
- [ ] 100次单抽测试中，花甲1份出现频率在15%-25%之间
- [ ] 8种奖品都能正常中奖
- [ ] 概率分布符合产品文档要求

### 5.2 积分扣除修复验证
- [ ] 单抽扣除100积分 ✓
- [ ] 三连抽扣除300积分 ✓
- [ ] 五连抽扣除500积分 ✓
- [ ] 十连抽扣除1000积分 ✓

### 5.3 数据一致性验证
- [ ] 积分扣除记录正确保存到数据库
- [ ] 抽奖记录与实际结果一致
- [ ] 用户积分余额计算准确

## 🔗 六、相关技术文档

### 6.1 接口规范参考
- **文档**：`接口对接规范文档标准.md` 第6.2节
- **接口**：`POST /api/lottery/draw`
- **预期返回**：包含正确的积分扣除和随机奖品

### 6.2 产品需求参考
- **文档**：`产品功能结构描述.md` 第2.1节
- **概率要求**：8区域转盘，精确概率控制
- **积分规则**：100积分/次抽奖

## 🚨 七、紧急联系信息

### 7.1 问题影响
- **用户影响**：管理员账号抽奖功能异常
- **系统影响**：积分系统数据准确性受损
- **业务影响**：可能影响其他用户的抽奖体验

### 7.2 修复时间要求
- **预期修复时间**：24小时内
- **测试验证时间**：修复后4小时内完成验证
- **上线时间**：验证通过后立即上线

---

**📝 文档创建者**：前端开发团队  
**🔍 问题诊断**：基于完整前端代码审查  
**📞 联系方式**：通过项目群联系前端团队确认前端状态  
**⏰ 文档创建时间**：2025年1月12日 