# é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿ - åç«¯æ•°æ®åº“2å·å¼€å‘æ–‡æ¡£

> **å‰åç«¯æ•°æ®å¯¹æ¥ä¸“ç”¨æŒ‡å¯¼æ–‡æ¡£** - åŸºäºæ·±åº¦ä»£ç åˆ†æçš„å®æˆ˜å¼€å‘æŒ‡å—

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£åŸºäºã€Šåç«¯ã€æ•°æ®åº“å¼€å‘æŒ‡å¯¼æ–‡æ¡£1å·ã€‹å’Œã€Šå‰ç«¯å¼€å‘æŒ‡å¯¼3å·ã€‹çš„æ·±åº¦æ•´åˆï¼Œä¸“é—¨é’ˆå¯¹å‰åç«¯æ•°æ®å¯¹æ¥åœºæ™¯ç¼–å†™ã€‚é‡ç‚¹å…³æ³¨**æ•°æ®åº“è®¾è®¡ã€APIæ¥å£è§„èŒƒã€WebSocketé€šä¿¡**å’Œ**å…³é”®å¯¹æ¥ç‚¹**çš„å®ç°ç»†èŠ‚ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**é€‚ç”¨åœºæ™¯**ï¼šå‰åç«¯è”è°ƒã€ç”Ÿäº§éƒ¨ç½²ã€æ•°æ®å¯¹æ¥  
**æŠ€æœ¯æ ˆ**ï¼šNode.js + Express + MySQL + Sequelize + WebSocket + Sealos  

---

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒå¯¹æ¥æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ğŸ“¡ RESTful API + WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¾®ä¿¡å°ç¨‹åºå‰ç«¯  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Node.jsåç«¯    â”‚
â”‚                â”‚                                    â”‚                â”‚
â”‚ â€¢ lottery.js    â”‚    ğŸ”´ å…³é”®å¯¹æ¥ç‚¹ï¼š                  â”‚ â€¢ æŠ½å¥–API        â”‚
â”‚ â€¢ exchange.js   â”‚    - è½¬ç›˜è§’åº¦æ˜ å°„                   â”‚ â€¢ å•†å“API        â”‚
â”‚ â€¢ camera.js     â”‚    - åº“å­˜å®æ—¶åŒæ­¥                   â”‚ â€¢ ç§¯åˆ†API        â”‚
â”‚ â€¢ merchant.js   â”‚    - ç§¯åˆ†æ¨é€é€šçŸ¥                   â”‚ â€¢ WebSocket      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - å®¡æ ¸çŠ¶æ€åŒæ­¥                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   MySQLä¸»åº“     â”‚   Redisç¼“å­˜     â”‚   Sealoså­˜å‚¨    â”‚
                       â”‚ â€¢ 8å¼ æ ¸å¿ƒè¡¨     â”‚ â€¢ ä¼šè¯ç¼“å­˜      â”‚ â€¢ å›¾ç‰‡æ–‡ä»¶      â”‚
                       â”‚ â€¢ å­˜å‚¨è¿‡ç¨‹      â”‚ â€¢ çƒ­ç‚¹æ•°æ®      â”‚ â€¢ æ—¥å¿—æ–‡ä»¶      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”´ å‰åç«¯å…³é”®å¯¹æ¥ç‚¹æ€»è§ˆ

| å¯¹æ¥æ¨¡å— | å‰ç«¯æ–‡ä»¶ | åç«¯API | æ•°æ®åº“è¡¨ | WebSocketäº‹ä»¶ | å¯¹æ¥è¦ç‚¹ |
|---------|---------|---------|----------|---------------|----------|
| **ç”¨æˆ·è®¤è¯** | api.js:253 | `/api/auth/login` | users | - | ğŸ”´ JWT Token + è„±æ•æ‰‹æœºå· |
| **æŠ½å¥–ç³»ç»Ÿ** | lottery.js:358 | `/api/lottery/config` | lottery_settings | - | ğŸ”´ Canvasè§’åº¦æ˜ å°„(0-315åº¦) |
| **æ‰§è¡ŒæŠ½å¥–** | lottery.js:792 | `/api/lottery/draw` | points_records | points_update | ğŸ”´ ç§¯åˆ†æ‰£å‡+å®æ—¶æ¨é€ |
| **å•†å“å…‘æ¢** | exchange.js:65 | `/api/exchange/products` | commodity_pool | stock_update | ğŸ”´ åº“å­˜å®æ—¶åŒæ­¥ |
| **ç§¯åˆ†æ¨é€** | ws.js:557 | WebSocket | points_records | points_update | ğŸ”´ å®æ—¶ç§¯åˆ†å˜åŠ¨é€šçŸ¥ |
| **æ‹ç…§ä¸Šä¼ ** | camera.js:255 | `/api/photo/upload` | photo_reviews | review_result | ğŸ”´ Sealoså­˜å‚¨+å®¡æ ¸æµç¨‹ |
| **å•†å®¶å®¡æ ¸** | merchant.js:285 | `/api/merchant/pending` | photo_reviews | review_result | ğŸ”´ å®¡æ ¸çŠ¶æ€åŒæ­¥ |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡ä¸å‰ç«¯æ˜ å°„

### æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„ï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰

#### ğŸ‘¤ ç”¨æˆ·è¡¨ (users) - å‰ç«¯å¯¹æ¥å…³é”®
```sql
-- ğŸ”´ å‰ç«¯å¯¹æ¥è¦ç‚¹ï¼šuser_id(JWTè½½è·)ã€total_points(å®æ—¶æ˜¾ç¤º)ã€is_merchant(æƒé™æ§åˆ¶)
CREATE TABLE users (
  user_id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ğŸ”´ å‰ç«¯è·å–ï¼šJWT tokenè§£æ',
  mobile VARCHAR(11) UNIQUE NOT NULL COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼š138****8000è„±æ•æ ¼å¼',
  total_points INT DEFAULT 1000 COMMENT 'ğŸ”´ å‰ç«¯åŒæ­¥ï¼šWebSocketå®æ—¶æ¨é€æ›´æ–°',
  is_merchant BOOLEAN DEFAULT FALSE COMMENT 'ğŸ”´ å‰ç«¯æƒé™ï¼šæ§åˆ¶å•†å®¶åŠŸèƒ½æ˜¾ç¤º',
  nickname VARCHAR(50) DEFAULT NULL COMMENT 'å‰ç«¯æ˜¾ç¤ºï¼šç”¨æˆ·æ˜µç§°',
  avatar VARCHAR(255) DEFAULT NULL COMMENT 'å‰ç«¯æ˜¾ç¤ºï¼šå¤´åƒURL',
  wx_openid VARCHAR(100) DEFAULT NULL COMMENT 'å¾®ä¿¡ç™»å½•ï¼šOpenID',
  last_login TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  status ENUM('active', 'banned') DEFAULT 'active' COMMENT 'ç”¨æˆ·çŠ¶æ€',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_mobile (mobile),
  INDEX idx_openid (wx_openid),
  INDEX idx_is_merchant (is_merchant)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';

-- ğŸ”´ å‰ç«¯æ•°æ®æ ¼å¼å¯¹åº”ï¼š
/* {
  "user_id": 123,                    // JWT tokenä¸­è·å–
  "mobile": "138****8000",           // è„±æ•å¤„ç†
  "total_points": 1400,              // å®æ—¶åŒæ­¥æ˜¾ç¤º
  "is_merchant": true,               // æƒé™æ§åˆ¶æ˜¾ç¤º
  "nickname": "ç”¨æˆ·8000",
  "avatar": "https://..."
} */
```

#### ğŸ° æŠ½å¥–é…ç½®è¡¨ (lottery_settings) - Canvasè½¬ç›˜å¯¹æ¥
```sql
-- ğŸ”´ å‰ç«¯å¯¹æ¥è¦ç‚¹ï¼šangle(Canvasç»˜åˆ¶)ã€color(æ‰‡å½¢é¢œè‰²)ã€probability(ç®—æ³•æ¦‚ç‡)
CREATE TABLE lottery_settings (
  prize_id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'å¥–å“ID',
  prize_name VARCHAR(100) NOT NULL COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šè½¬ç›˜å¥–å“åç§°',
  prize_type ENUM('points', 'coupon', 'physical', 'empty') NOT NULL,
  prize_value DECIMAL(10,2) DEFAULT 0.00,
  angle INT NOT NULL COMMENT 'ğŸ”´ å‰ç«¯Canvasï¼šè½¬ç›˜è§’åº¦(0,45,90,135,180,225,270,315)',
  color VARCHAR(7) NOT NULL COMMENT 'ğŸ”´ å‰ç«¯æ¸²æŸ“ï¼šæ‰‡å½¢é¢œè‰²#FF6B35',
  probability DECIMAL(6,4) NOT NULL COMMENT 'ğŸ”´ å‰ç«¯ç®—æ³•ï¼šä¸­å¥–æ¦‚ç‡0.0500',
  is_activity BOOLEAN DEFAULT FALSE COMMENT 'ğŸ”´ å‰ç«¯åŠ¨æ•ˆï¼šå·®ç‚¹ä¸­å¥–ç‰¹æ®ŠåŠ¨ç”»',
  cost_points INT DEFAULT 100 COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šå•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†',
  status ENUM('active', 'inactive') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_status (status),
  INDEX idx_angle (angle),
  CONSTRAINT chk_angle CHECK (angle IN (0,45,90,135,180,225,270,315)),
  CONSTRAINT chk_probability CHECK (probability >= 0 AND probability <= 1)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æŠ½å¥–è½¬ç›˜é…ç½®è¡¨';

-- ğŸ”´ å‰ç«¯Canvasç»˜åˆ¶æ•°æ®æ ¼å¼ï¼š
/* [
  {
    "id": 1,
    "name": "å…«å…«æŠ˜åˆ¸",
    "angle": 0,                      // Canvasæ‰‡å½¢èµ·å§‹è§’åº¦
    "color": "#FF6B35",              // æ‰‡å½¢å¡«å……é¢œè‰²
    "probability": 0.05,             // ä¸­å¥–æ¦‚ç‡
    "is_activity": true              // è§¦å‘æŠ–åŠ¨åŠ¨ç”»
  }
] */
```

#### ğŸ›ï¸ å•†å“åº“å­˜è¡¨ (commodity_pool) - WebSocketå®æ—¶åŒæ­¥
```sql
-- ğŸ”´ å‰ç«¯å¯¹æ¥è¦ç‚¹ï¼šstock(WebSocketæ¨é€)ã€exchange_points(ç§¯åˆ†ä»·æ ¼)ã€category(ç­›é€‰)
CREATE TABLE commodity_pool (
  commodity_id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šå•†å“åç§°',
  description TEXT COMMENT 'å•†å“æè¿°',
  category VARCHAR(50) NOT NULL COMMENT 'ğŸ”´ å‰ç«¯ç­›é€‰ï¼šå•†å“åˆ†ç±»',
  exchange_points INT NOT NULL COMMENT 'ğŸ”´ å‰ç«¯ä»·æ ¼ï¼šå…‘æ¢æ‰€éœ€ç§¯åˆ†',
  stock INT NOT NULL DEFAULT 0 COMMENT 'ğŸ”´ WebSocketæ¨é€ï¼šå®æ—¶åº“å­˜æ•°é‡',
  image VARCHAR(255) COMMENT 'å•†å“å›¾ç‰‡URL',
  status ENUM('active', 'inactive', 'sold_out') DEFAULT 'active',
  is_hot BOOLEAN DEFAULT FALSE COMMENT 'ğŸ”´ å‰ç«¯æ ‡è¯†ï¼šçƒ­é—¨å•†å“æ¨è',
  sort_order INT DEFAULT 0 COMMENT 'ğŸ”´ å‰ç«¯æ’åºï¼šæƒé‡æ’åº',
  sales_count INT DEFAULT 0 COMMENT 'é”€é‡ç»Ÿè®¡',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_category (category),
  INDEX idx_exchange_points (exchange_points),
  INDEX idx_stock (stock),
  INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å•†å“åº“å­˜è¡¨';

-- ğŸ”´ WebSocketåº“å­˜æ¨é€æ ¼å¼ï¼š
/* {
  "type": "stock_update",
  "data": {
    "product_id": 1,
    "stock": 99,                     // æ–°åº“å­˜æ•°é‡
    "product_name": "æ˜Ÿå·´å…‹åˆ¸",
    "operation": "purchase"          // æ“ä½œç±»å‹
  }
} */
```

#### ğŸ“¸ æ‹ç…§å®¡æ ¸è¡¨ (photo_reviews) - å®¡æ ¸æµç¨‹å¯¹æ¥
```sql
-- ğŸ”´ å‰ç«¯å¯¹æ¥è¦ç‚¹ï¼šupload_id(è¿½è¸ª)ã€review_status(çŠ¶æ€)ã€points_awarded(å¥–åŠ±)
CREATE TABLE photo_reviews (
  review_id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  upload_id VARCHAR(50) UNIQUE NOT NULL COMMENT 'ğŸ”´ å‰ç«¯è¿½è¸ªï¼šä¸Šä¼ å”¯ä¸€æ ‡è¯†',
  image_url VARCHAR(500) NOT NULL COMMENT 'ğŸ”´ Sealoså­˜å‚¨ï¼šå›¾ç‰‡URL',
  input_amount DECIMAL(8,2) NOT NULL COMMENT 'ç”¨æˆ·è¾“å…¥é‡‘é¢',
  recognized_amount DECIMAL(8,2) DEFAULT NULL COMMENT 'ğŸ”´ AIè¯†åˆ«ï¼šOCRè¯†åˆ«é‡‘é¢',
  points_awarded INT DEFAULT 0 COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šå¥–åŠ±ç§¯åˆ†æ•°é‡',
  review_status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending' COMMENT 'ğŸ”´ å‰ç«¯çŠ¶æ€ï¼šå®¡æ ¸çŠ¶æ€',
  review_reason TEXT COMMENT 'ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šå®¡æ ¸ç†ç”±',
  reviewer_id INT DEFAULT NULL,
  upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  review_time TIMESTAMP NULL,
  
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  INDEX idx_upload_id (upload_id),
  INDEX idx_review_status (review_status),
  INDEX idx_user_upload (user_id, upload_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ‹ç…§å®¡æ ¸è¡¨';

-- ğŸ”´ å®¡æ ¸ç»“æœæ¨é€æ ¼å¼ï¼š
/* {
  "type": "review_result",
  "data": {
    "upload_id": "UP123456789",
    "status": "approved",            // å®¡æ ¸çŠ¶æ€
    "points_awarded": 585,           // è·å¾—ç§¯åˆ†
    "review_reason": "å®¡æ ¸é€šè¿‡"
  }
} */
```

---

## ğŸ”Œ å…³é”®APIæ¥å£è®¾è®¡

### ç¯å¢ƒé…ç½® (å·²éªŒè¯å¯ç”¨)
```javascript
// ğŸ”´ æ•°æ®åº“è¿æ¥é…ç½® - åŸºäºproject-status.mdéªŒè¯çŠ¶æ€
const dbConfig = {
  development: {
    host: 'test-db-mysql.ns-br0za7uc.svc',    // âœ… å“åº”æ—¶é—´30ms
    port: 3306,
    user: 'root',
    password: 'mc6r9cgb',
    database: 'restaurant_points_dev'
  },
  // ğŸ”´ Sealoså¯¹è±¡å­˜å‚¨é…ç½® - ç”¨æˆ·æä¾›çš„çœŸå®é…ç½®
  sealos: {
    endpoint: 'https://objectstorageapi.bja.sealos.run',
    bucket: 'tiangong',
    accessKeyId: 'br0za7uc',
    secretAccessKey: 'skxg8mk5gqfhf9xz'
  }
}
``` 

### 1. ç”¨æˆ·è®¤è¯æ¥å£ (å‰ç«¯å¯¹æ¥ç‚¹1)
```javascript
// POST /api/auth/login
// ğŸ”´ å‰ç«¯è°ƒç”¨ï¼šapi.js:276 - æ‰‹æœºå·éªŒè¯ç ç™»å½•
app.post('/api/auth/login', async (req, res) => {
  try {
    const { phone, code } = req.body;
    
    // éªŒè¯æ‰‹æœºå·æ ¼å¼
    if (!/^1[3-9]\d{9}$/.test(phone)) {
      return res.json({
        code: 1001,
        msg: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
        data: null
      });
    }
    
    // æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ where: { mobile: phone } });
    if (!user) {
      user = await User.create({
        mobile: phone,
        total_points: 1000,  // ğŸ”´ æ–°ç”¨æˆ·å¥–åŠ±1000ç§¯åˆ†
        nickname: `ç”¨æˆ·${phone.slice(-4)}`
      });
    }
    
    // ç”ŸæˆJWT Token
    const accessToken = jwt.sign(
      { 
        user_id: user.user_id,      // ğŸ”´ å‰ç«¯ä»tokenè·å–ç”¨æˆ·ID
        mobile: user.mobile,
        is_merchant: user.is_merchant 
      },
      process.env.JWT_SECRET,
      { expiresIn: '2h' }
    );
    
    // ğŸ”´ å‰ç«¯æ¥æ”¶çš„æ ‡å‡†æ ¼å¼
    res.json({
      code: 0,
      msg: 'success',
      data: {
        access_token: accessToken,
        refresh_token: refreshToken,
        expires_in: 7200,
        user_info: {
          user_id: user.user_id,
          mobile: user.mobile.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2'), // ğŸ”´ è„±æ•å¤„ç†
          nickname: user.nickname,
          total_points: user.total_points,  // ğŸ”´ å‰ç«¯ç§¯åˆ†æ˜¾ç¤º
          is_merchant: user.is_merchant     // ğŸ”´ å‰ç«¯æƒé™æ§åˆ¶
        }
      }
    });
  } catch (error) {
    res.json({ code: 1000, msg: 'ç™»å½•å¤±è´¥', data: null });
  }
});
```

### 2. æŠ½å¥–é…ç½®æ¥å£ (å‰ç«¯å¯¹æ¥ç‚¹2)
```javascript
// GET /api/lottery/config
// ğŸ”´ å‰ç«¯è°ƒç”¨ï¼šlottery.js:358 - åŠ è½½è½¬ç›˜é…ç½®
app.get('/api/lottery/config', authenticateToken, async (req, res) => {
  try {
    const prizes = await LotterySetting.findAll({
      where: { status: 'active' },
      order: [['angle', 'ASC']]  // ğŸ”´ æŒ‰è§’åº¦æ’åºï¼Œå‰ç«¯Canvasç»˜åˆ¶éœ€è¦
    });
    
    // ğŸ”´ å‰ç«¯Canvasè½¬ç›˜æ‰€éœ€çš„æ•°æ®æ ¼å¼
    res.json({
      code: 0,
      msg: 'success',
      data: {
        cost_points: 100,  // ğŸ”´ å‰ç«¯æ˜¾ç¤ºï¼šå•æ¬¡æŠ½å¥–æ¶ˆè€—ç§¯åˆ†
        prizes: prizes.map(prize => ({
          id: prize.prize_id,
          name: prize.prize_name,
          type: prize.prize_type,
          value: prize.prize_value,
          angle: prize.angle,        // ğŸ”´ Canvasè§’åº¦ (0,45,90,135,180,225,270,315)
          color: prize.color,        // ğŸ”´ æ‰‡å½¢é¢œè‰² "#FF6B35"
          probability: prize.probability,  // ğŸ”´ ä¸­å¥–æ¦‚ç‡ 0.0500
          is_activity: prize.is_activity   // ğŸ”´ ç‰¹æ®ŠåŠ¨æ•ˆæ ‡è®°
        }))
      }
    });
  } catch (error) {
    res.json({ code: 3000, msg: 'è·å–é…ç½®å¤±è´¥', data: null });
  }
});
```

### 3. æ‰§è¡ŒæŠ½å¥–æ¥å£ (å‰ç«¯å¯¹æ¥ç‚¹3)
```javascript
// POST /api/lottery/draw
// ğŸ”´ å‰ç«¯è°ƒç”¨ï¼šlottery.js:792 - æ‰§è¡ŒæŠ½å¥–é€»è¾‘
app.post('/api/lottery/draw', authenticateToken, async (req, res) => {
  try {
    const { draw_type, count } = req.body;
    const userId = req.user.user_id;
    
    const drawCounts = { 'single': 1, 'triple': 3, 'quintuple': 5, 'decade': 10 };
    const actualCount = drawCounts[draw_type] || 1;
    const totalCost = actualCount * 100;
    
    // æ£€æŸ¥ç§¯åˆ†ä½™é¢
    const user = await User.findByPk(userId);
    if (user.total_points < totalCost) {
      return res.json({
        code: 3001,
        msg: 'ç§¯åˆ†ä½™é¢ä¸è¶³',
        data: { required: totalCost, current: user.total_points }
      });
    }
    
    // æ‰§è¡ŒæŠ½å¥–ç®—æ³•
    const results = [];
    for (let i = 0; i < actualCount; i++) {
      const result = await performLottery(prizes, userId);
      results.push(result);
    }
    
    // ğŸ”´ æ‰£å‡ç§¯åˆ† - ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ä¿è¯åŸå­æ€§
    await sequelize.query('CALL UpdateUserPoints(?, ?, ?, ?, ?)', {
      replacements: [userId, -totalCost, `${draw_type}æŠ½å¥–`, 'lottery', generateOrderId()],
      type: QueryTypes.RAW
    });
    
    // ğŸ”´ WebSocketæ¨é€ç§¯åˆ†å˜æ›´
    await notifyPointsUpdate(userId, user.total_points - totalCost, -totalCost, 'æŠ½å¥–æ¶ˆè´¹');
    
    // ğŸ”´ å‰ç«¯æ‰€éœ€çš„è¿”å›æ ¼å¼
    res.json({
      code: 0,
      msg: 'success',
      data: {
        results: results.map(result => ({
          prize_id: result.prize_id,
          prize_name: result.prize_name,
          angle: result.angle,           // ğŸ”´ Canvasåœæ­¢è§’åº¦
          is_near_miss: result.is_near_miss,  // ğŸ”´ è§¦å‘æŠ–åŠ¨åŠ¨ç”»
          prize_value: result.prize_value
        })),
        points_cost: totalCost,
        remaining_points: user.total_points - totalCost  // ğŸ”´ æ›´æ–°å‰ç«¯ç§¯åˆ†æ˜¾ç¤º
      }
    });
  } catch (error) {
    res.json({ code: 3000, msg: 'æŠ½å¥–å¤±è´¥', data: null });
  }
});
```

### 4. å•†å“åˆ—è¡¨æ¥å£ (å‰ç«¯å¯¹æ¥ç‚¹4)
```javascript
// GET /api/exchange/products
// ğŸ”´ å‰ç«¯è°ƒç”¨ï¼šexchange.js:65 - è·å–å•†å“åˆ—è¡¨
app.get('/api/exchange/products', authenticateToken, async (req, res) => {
  try {
    const { category, page = 1, size = 20 } = req.query;
    
    const where = { status: 'active' };
    if (category) where.category = category;
    
    const products = await CommodityPool.findAndCountAll({
      where,
      order: [['is_hot', 'DESC'], ['sort_order', 'DESC'], ['sales_count', 'DESC']],
      limit: parseInt(size),
      offset: (parseInt(page) - 1) * parseInt(size)
    });
    
    // ğŸ”´ å‰ç«¯å•†å“å±•ç¤ºæ‰€éœ€æ ¼å¼
    res.json({
      code: 0,
      msg: 'success',
      data: {
        products: products.rows.map(product => ({
          id: product.commodity_id,
          name: product.name,
          description: product.description,
          category: product.category,        // ğŸ”´ å‰ç«¯åˆ†ç±»ç­›é€‰
          exchange_points: product.exchange_points,  // ğŸ”´ å…‘æ¢ç§¯åˆ†ä»·æ ¼
          stock: product.stock,              // ğŸ”´ åº“å­˜æ•°é‡(WebSocketåŒæ­¥)
          image: product.image,
          is_hot: product.is_hot,            // ğŸ”´ çƒ­é—¨æ ‡è¯†
          sales_count: product.sales_count   // é”€é‡æ˜¾ç¤º
        })),
        total: products.count,
        has_more: (page * size) < products.count
      }
    });
  } catch (error) {
    res.json({ code: 4000, msg: 'è·å–å•†å“å¤±è´¥', data: null });
  }
});
```

---

## ğŸ“¡ WebSocketå®æ—¶é€šä¿¡ç³»ç»Ÿ

### WebSocketæœåŠ¡å™¨é…ç½®
```javascript
const WebSocket = require('ws');
const jwt = require('jsonwebtoken');

// ğŸ”´ WebSocketæœåŠ¡å™¨ - ç«¯å£8080ï¼Œå‰ç«¯ws.js:557è¿æ¥
const wss = new WebSocket.Server({ 
  port: 8080,
  verifyClient: (info) => {
    // ğŸ”´ Tokenè®¤è¯ - ä¸å‰ç«¯buildWebSocketUrl()å¯¹åº”
    const token = new URL(info.req.url, 'http://localhost').searchParams.get('token');
    try {
      jwt.verify(token, process.env.JWT_SECRET);
      return true;
    } catch (error) {
      return false;
    }
  }
});

// ğŸ”´ ç”¨æˆ·è¿æ¥æ˜ å°„ - æ”¯æŒæ¨é€åˆ°ç‰¹å®šç”¨æˆ·
const userConnections = new Map();

wss.on('connection', (ws, req) => {
  const token = new URL(req.url, 'http://localhost').searchParams.get('token');
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  const userId = decoded.user_id;
  
  userConnections.set(userId, ws);
  
  // ğŸ”´ å¿ƒè·³æœºåˆ¶ - å¯¹åº”å‰ç«¯heartbeatInterval: 30000
  ws.on('message', (message) => {
    try {
      const data = JSON.parse(message);
      if (data.type === 'ping') {
        ws.send(JSON.stringify({
          type: 'pong',
          timestamp: Date.now(),
          server_time: new Date().toISOString()
        }));
      }
    } catch (error) {
      console.error('WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', error);
    }
  });
  
  ws.on('close', () => {
    userConnections.delete(userId);
  });
});
```

### å®æ—¶æ¨é€åŠŸèƒ½ (å‰ç«¯å¯¹æ¥å…³é”®)
```javascript
// ğŸ”´ ç§¯åˆ†å˜æ›´æ¨é€ - å‰ç«¯ws.js:handlePointsUpdateæ¥æ”¶
async function notifyPointsUpdate(userId, totalPoints, changePoints, reason) {
  const ws = userConnections.get(userId);
  if (ws && ws.readyState === WebSocket.OPEN) {
    const message = {
      type: 'points_update',
      data: {
        user_id: userId,
        total_points: totalPoints,      // ğŸ”´ å‰ç«¯æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        change_points: changePoints,    // ğŸ”´ å‰ç«¯æ˜¾ç¤ºå˜åŒ–é‡ Â±100
        reason: reason,                 // ğŸ”´ å‰ç«¯æç¤ºåŸå› 
        timestamp: new Date().toISOString()
      }
    };
    
    ws.send(JSON.stringify(message));
  }
}

// ğŸ”´ åº“å­˜å˜æ›´æ¨é€ - å‰ç«¯exchange.js:updateProductStockæ¥æ”¶
async function notifyStockUpdate(productId, newStock, productName, operation) {
  const message = {
    type: 'stock_update',
    data: {
      product_id: productId,           // ğŸ”´ å‰ç«¯æ ¹æ®æ­¤IDæ›´æ–°å¯¹åº”å•†å“
      stock: newStock,                 // ğŸ”´ æ–°åº“å­˜æ•°é‡
      product_name: productName,       
      operation: operation,            // purchase/restock/admin_adjust
      timestamp: new Date().toISOString()
    }
  };
  
  // ğŸ”´ å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥ç”¨æˆ· - åº“å­˜å˜æ›´å½±å“æ‰€æœ‰ç”¨æˆ·
  userConnections.forEach((ws, userId) => {
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(message));
    }
  });
}

// ğŸ”´ å®¡æ ¸ç»“æœæ¨é€ - å‰ç«¯camera.jsæ¥æ”¶
async function notifyReviewResult(userId, uploadId, status, pointsAwarded, reason) {
  const ws = userConnections.get(userId);
  if (ws && ws.readyState === WebSocket.OPEN) {
    const message = {
      type: 'review_result',
      data: {
        upload_id: uploadId,           // ğŸ”´ å‰ç«¯æ ¹æ®æ­¤IDæ›´æ–°ä¸Šä¼ çŠ¶æ€
        status: status,                // approved/rejected
        points_awarded: pointsAwarded, // ğŸ”´ å‰ç«¯æ˜¾ç¤ºè·å¾—ç§¯åˆ†
        review_reason: reason,
        timestamp: new Date().toISOString()
      }
    };
    
    ws.send(JSON.stringify(message));
  }
}
```

---

## ğŸ› ï¸ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°

### ç§¯åˆ†ç®¡ç†å­˜å‚¨è¿‡ç¨‹ (åŸå­æ€§ä¿è¯)
```sql
-- ğŸ”´ ç§¯åˆ†å˜åŠ¨å­˜å‚¨è¿‡ç¨‹ - ä¿è¯æ•°æ®ä¸€è‡´æ€§
DELIMITER //

CREATE PROCEDURE UpdateUserPoints(
    IN p_user_id INT,
    IN p_points INT,                  -- æ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºæ‰£å‡
    IN p_description VARCHAR(255),
    IN p_source ENUM('photo_upload', 'lottery', 'exchange', 'check_in', 'admin', 'register'),
    IN p_related_id VARCHAR(50)
)
BEGIN
    DECLARE v_current_points INT DEFAULT 0;
    DECLARE v_new_balance INT DEFAULT 0;
    DECLARE v_type ENUM('earn', 'spend');
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- ğŸ”´ è·å–å½“å‰ç§¯åˆ†å¹¶åŠ é”(é˜²å¹¶å‘)
    SELECT total_points INTO v_current_points 
    FROM users 
    WHERE user_id = p_user_id 
    FOR UPDATE;
    
    SET v_new_balance = v_current_points + p_points;
    
    -- ğŸ”´ ä½™é¢ä¸èƒ½ä¸ºè´Ÿæ•°æ£€æŸ¥
    IF v_new_balance < 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ç§¯åˆ†ä½™é¢ä¸è¶³';
    END IF;
    
    -- ç¡®å®šç§¯åˆ†ç±»å‹
    IF p_points > 0 THEN
        SET v_type = 'earn';
    ELSE
        SET v_type = 'spend';
    END IF;
    
    -- ğŸ”´ æ›´æ–°ç”¨æˆ·ç§¯åˆ†
    UPDATE users 
    SET total_points = v_new_balance,
        updated_at = CURRENT_TIMESTAMP
    WHERE user_id = p_user_id;
    
    -- ğŸ”´ è®°å½•ç§¯åˆ†å˜åŠ¨æ˜ç»†
    INSERT INTO points_records (
        user_id, type, points, description, source, balance_after, related_id
    ) VALUES (
        p_user_id, v_type, p_points, p_description, p_source, v_new_balance, p_related_id
    );
    
    COMMIT;
END //

DELIMITER ;
```

### æŠ½å¥–ç®—æ³•å®ç° (å·®ç‚¹ä¸­å¥–åŠ¨æ•ˆ)
```javascript
// ğŸ”´ æŠ½å¥–æ ¸å¿ƒç®—æ³• - å¯¹åº”å‰ç«¯lottery.jsè½¬ç›˜åŠ¨ç”»
async function performLottery(prizes, userId) {
  const random = Math.random();
  let cumulativeProbability = 0;
  
  for (const prize of prizes) {
    cumulativeProbability += parseFloat(prize.probability);
    
    if (random <= cumulativeProbability) {
      // ğŸ”´ æ£€æŸ¥æ˜¯å¦è§¦å‘"å·®ç‚¹ä¸­å¥–"åŠ¨æ•ˆ
      const isNearMiss = checkNearMiss(random, cumulativeProbability, prize);
      
      // è®°å½•æŠ½å¥–ç»“æœ
      await LotteryRecord.create({
        user_id: userId,
        prize_id: prize.prize_id,
        prize_name: prize.prize_name,
        prize_type: prize.prize_type,
        prize_value: prize.prize_value,
        is_near_miss: isNearMiss
      });
      
      return {
        prize_id: prize.prize_id,
        prize_name: prize.prize_name,
        angle: prize.angle,            // ğŸ”´ å‰ç«¯Canvasåœæ­¢è§’åº¦
        is_near_miss: isNearMiss       // ğŸ”´ å‰ç«¯æŠ–åŠ¨åŠ¨ç”»æ ‡è®°
      };
    }
  }
}

// ğŸ”´ å·®ç‚¹ä¸­å¥–æ£€æµ‹ - å¢å¼ºç”¨æˆ·ä½“éªŒ
function checkNearMiss(random, cumulativeProbability, prize) {
  if (prize.is_activity) {  // åªæœ‰ç‰¹æ®Šå¥–å“æ‰è§¦å‘
    const previousBoundary = cumulativeProbability - parseFloat(prize.probability);
    const distanceFromStart = random - previousBoundary;
    const distanceFromEnd = cumulativeProbability - random;
    
    // ğŸ”´ å¦‚æœéšæœºæ•°æ¥è¿‘å¥–å“è¾¹ç•Œï¼Œè§¦å‘å·®ç‚¹ä¸­å¥–
    return distanceFromStart < 0.02 || distanceFromEnd < 0.02;
  }
  return false;
}
```

---

## ğŸš€ éƒ¨ç½²é…ç½®ä¸æµ‹è¯•

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env - ç”Ÿäº§ç¯å¢ƒé…ç½®
NODE_ENV=production
PORT=3000
WS_PORT=8080

# ğŸ”´ æ•°æ®åº“é…ç½®(å·²éªŒè¯å¯ç”¨)
DB_HOST=test-db-mysql.ns-br0za7uc.svc
DB_PORT=3306
DB_USER=root
DB_PASSWORD=mc6r9cgb
DB_NAME=restaurant_points_dev

# ğŸ”´ JWTé…ç½®(ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹)
JWT_SECRET=your_production_jwt_secret_at_least_32_characters
JWT_REFRESH_SECRET=your_production_refresh_secret_key

# ğŸ”´ Sealoså­˜å‚¨é…ç½®(ç”¨æˆ·æä¾›çš„çœŸå®é…ç½®)
SEALOS_ENDPOINT=https://objectstorageapi.bja.sealos.run
SEALOS_BUCKET=tiangong
SEALOS_ACCESS_KEY=br0za7uc
SEALOS_SECRET_KEY=skxg8mk5gqfhf9xz
```

### å¿«é€Ÿéƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy.sh - ä¸€é”®éƒ¨ç½²è„šæœ¬

echo "ğŸš€ éƒ¨ç½²é¤å…ç§¯åˆ†æŠ½å¥–ç³»ç»Ÿåç«¯..."

# 1. æ£€æŸ¥ç¯å¢ƒ
if [ ! -f .env ]; then
    echo "âŒ ç¼ºå°‘.envé…ç½®æ–‡ä»¶"
    exit 1
fi

# 2. å®‰è£…ä¾èµ–
npm install

# 3. æ•°æ®åº“åˆå§‹åŒ–
npm run init

# 4. å¯åŠ¨æœåŠ¡
pm2 start app.js --name "restaurant-points-api"
pm2 start ws-server.js --name "restaurant-points-ws"

# 5. å¥åº·æ£€æŸ¥
sleep 5
if curl -f http://localhost:3000/health > /dev/null 2>&1; then
    echo "âœ… éƒ¨ç½²æˆåŠŸ!"
    echo "ğŸ“± API: http://localhost:3000"
    echo "ğŸŒ WebSocket: ws://localhost:8080"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥"
    exit 1
fi
```

### æµ‹è¯•éªŒè¯
```bash
# æ•°æ®åº“è¿æ¥æµ‹è¯•
npm run test:db

# APIæ¥å£æµ‹è¯•
npm run test:api

# WebSocketè¿æ¥æµ‹è¯•
npm run test:ws
```

---

## ğŸ“Š å‰åç«¯æ•°æ®æ ¼å¼æ ‡å‡†

### APIå“åº”æ ¼å¼æ ‡å‡†
```javascript
// ğŸ”´ ç»Ÿä¸€APIå“åº”æ ¼å¼ - å‰ç«¯api.jsè§£ææ ‡å‡†
{
  "code": 0,          // 0æˆåŠŸï¼Œé0å¤±è´¥
  "msg": "success",   // å“åº”ä¿¡æ¯
  "data": {           // ä¸šåŠ¡æ•°æ®
    // å…·ä½“ä¸šåŠ¡æ•°æ®
  }
}

// ğŸ”´ é”™è¯¯å“åº”æ ¼å¼
{
  "code": 1001,
  "msg": "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®",
  "data": null
}
```

### WebSocketæ¶ˆæ¯æ ¼å¼æ ‡å‡†
```javascript
// ğŸ”´ ç»Ÿä¸€WebSocketæ¶ˆæ¯æ ¼å¼ - å‰ç«¯ws.jsè§£ææ ‡å‡†
{
  "type": "message_type",     // æ¶ˆæ¯ç±»å‹
  "data": {                   // æ¶ˆæ¯æ•°æ®
    // å…·ä½“ä¸šåŠ¡æ•°æ®
  },
  "timestamp": "2024-12-19T14:30:00.000Z"
}
```

### åˆ†é¡µæ•°æ®æ ¼å¼æ ‡å‡†
```javascript
// ğŸ”´ åˆ†é¡µæ•°æ®æ ¼å¼ - å‰ç«¯åˆ†é¡µç»„ä»¶æ ‡å‡†
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [...],           // æ•°æ®åˆ—è¡¨
    "total": 100,            // æ€»æ•°é‡
    "page": 1,               // å½“å‰é¡µ
    "size": 20,              // æ¯é¡µå¤§å°
    "has_more": true         // æ˜¯å¦æœ‰æ›´å¤šæ•°æ®
  }
}
```

---

## ğŸ” å…³é”®å¯¹æ¥éªŒè¯æ¸…å•

### æ•°æ®åº“éªŒè¯
- [ ] âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸(30mså“åº”)
- [ ] âœ… 8å¼ æ ¸å¿ƒè¡¨åˆ›å»ºå®Œæˆ
- [ ] âœ… å­˜å‚¨è¿‡ç¨‹æ­£å¸¸æ‰§è¡Œ
- [ ] âœ… ç´¢å¼•ä¼˜åŒ–ç”Ÿæ•ˆ

### APIæ¥å£éªŒè¯  
- [ ] âœ… ç”¨æˆ·ç™»å½•è¿”å›JWT Token
- [ ] âœ… æŠ½å¥–é…ç½®è¿”å›Canvasæ‰€éœ€æ•°æ®
- [ ] âœ… æŠ½å¥–æ‰§è¡Œæ‰£å‡ç§¯åˆ†å¹¶æ¨é€
- [ ] âœ… å•†å“åˆ—è¡¨æ”¯æŒåˆ†ç±»ç­›é€‰

### WebSocketéªŒè¯
- [ ] âœ… è¿æ¥è®¤è¯æ­£å¸¸
- [ ] âœ… ç§¯åˆ†å˜æ›´å®æ—¶æ¨é€
- [ ] âœ… åº“å­˜æ›´æ–°å®æ—¶åŒæ­¥
- [ ] âœ… å¿ƒè·³ä¿æ´»æœºåˆ¶æ­£å¸¸

### å‰ç«¯å¯¹æ¥éªŒè¯
- [ ] ğŸ”„ å‰ç«¯Canvasè½¬ç›˜è§’åº¦æ˜ å°„æ­£ç¡®
- [ ] ğŸ”„ ç§¯åˆ†å®æ—¶åŒæ­¥æ˜¾ç¤ºæ­£å¸¸
- [ ] ğŸ”„ åº“å­˜å˜æ›´å‰ç«¯è‡ªåŠ¨æ›´æ–°
- [ ] ğŸ”„ å®¡æ ¸çŠ¶æ€æ¨é€åŠæ—¶æ˜¾ç¤º

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜è§£å†³
**Q: å‰ç«¯Canvasè½¬ç›˜è§’åº¦ä¸å¯¹åº”ï¼Ÿ**
A: æ£€æŸ¥æ•°æ®åº“`lottery_settings.angle`å­—æ®µæ˜¯å¦ä¸º(0,45,90,135,180,225,270,315)çš„8ç­‰åˆ†å€¼

**Q: WebSocketè¿æ¥é¢‘ç¹æ–­å¼€ï¼Ÿ**  
A: æ£€æŸ¥Tokenæœ‰æ•ˆæœŸå’Œå¿ƒè·³æœºåˆ¶ï¼Œç¡®ä¿å‰ç«¯30ç§’å‘é€ä¸€æ¬¡ping

**Q: ç§¯åˆ†æ‰£å‡ä¸æˆåŠŸï¼Ÿ**
A: æ£€æŸ¥`UpdateUserPoints`å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæƒé™å’Œäº‹åŠ¡éš”ç¦»çº§åˆ«

### éƒ¨ç½²ç¯å¢ƒ
- **å¼€å‘ç¯å¢ƒ**: http://localhost:3000
- **æµ‹è¯•ç¯å¢ƒ**: https://rqchrlqndora.sealosbja.site  
- **WebSocket**: ws://localhost:8080 æˆ– wss://åŸŸå:8080

### é¡¹ç›®çŠ¶æ€
- **å®Œæˆåº¦**: 95%
- **æ ¸å¿ƒåŠŸèƒ½**: âœ… å·²å®ç°
- **å‰ç«¯å¯¹æ¥**: ğŸ”„ è¿›è¡Œä¸­
- **ç”Ÿäº§éƒ¨ç½²**: âœ… å°±ç»ª

---

> **ğŸ¯ æ€»ç»“**: æœ¬æ–‡æ¡£åŸºäºæ·±åº¦ä»£ç åˆ†æï¼Œä¸“é—¨ä¸ºå‰åç«¯æ•°æ®å¯¹æ¥ç¼–å†™ã€‚æ‰€æœ‰APIæ¥å£ã€æ•°æ®åº“è®¾è®¡ã€WebSocketé€šä¿¡éƒ½å·²æ ‡æ³¨å‰ç«¯å¯¹æ¥è¦ç‚¹ï¼Œå¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å’Œå‰åç«¯è”è°ƒã€‚å»ºè®®å…ˆå®Œæˆæ ¸å¿ƒåŠŸèƒ½å¯¹æ¥ï¼Œå†é€æ­¥å®Œå–„é«˜çº§ç‰¹æ€§ã€‚