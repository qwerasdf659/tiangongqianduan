// utils/api.js - APIæ¥å£è¯·æ±‚å°è£…
const app = getApp()

/**
 * ğŸ”´ ç»Ÿä¸€ç½‘ç»œè¯·æ±‚å°è£… - ä»…æ”¯æŒçœŸå®åç«¯APIè°ƒç”¨
 * ğŸš¨ ä¸¥ç¦ä½¿ç”¨Mockæ•°æ® - è¿åé¡¹ç›®å®‰å…¨è§„åˆ™
 */
const request = (options) => {
  return new Promise((resolve, reject) => {
    const {
      url,
      method = 'GET',
      data = {},
      needAuth = true,
      showLoading = true,
      retryCount = 0,
      maxRetry = 2,
      timeout = 12000  // ğŸ”§ ä¿®å¤ï¼šè°ƒæ•´é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º12ç§’ï¼Œä¸ç™»å½•é€»è¾‘ä¿æŒä¸€è‡´
    } = options
    const app = getApp()
    
    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿appå·²åˆå§‹åŒ–
    if (!app || !app.globalData) {
      console.error('âŒ Appæœªåˆå§‹åŒ–ï¼Œæ— æ³•å‘èµ·è¯·æ±‚')
      reject({ code: -1, msg: 'åº”ç”¨æœªåˆå§‹åŒ–', data: null })
      return
    }

    // æ˜¾ç¤ºåŠ è½½æ¡†
  if (showLoading) {
    wx.showLoading({
      title: 'åŠ è½½ä¸­...',
      mask: true
    })
  }

  // æ„å»ºè¯·æ±‚å¤´
  const header = {
    'Content-Type': 'application/json'
  }

  // æ·»åŠ è®¤è¯å¤´
  if (needAuth && app.globalData.accessToken) {
    header['Authorization'] = `Bearer ${app.globalData.accessToken}`
    console.log('ğŸ” å·²æ·»åŠ è®¤è¯å¤´éƒ¨:', `Bearer ${app.globalData.accessToken.substring(0, 20)}...`)
  } else if (needAuth && !app.globalData.accessToken) {
    console.warn('âš ï¸ éœ€è¦è®¤è¯ä½†ç¼ºå°‘è®¿é—®ä»¤ç‰Œ!', { 
      needAuth, 
      hasToken: !!app.globalData.accessToken,
      globalData: app.globalData
    })
  }

  // æ„å»ºå®Œæ•´URLåœ°å€
  const fullUrl = app.globalData.baseUrl + url

  console.log('ğŸ“¡ å‘èµ·APIè¯·æ±‚:', { 
    url: fullUrl, 
    method, 
    needAuth, 
    hasAuthHeader: !!header['Authorization'],
    headers: header
  })

  wx.request({
    url: fullUrl,
    method,
    data,
    header,
    timeout: timeout, // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨åŠ¨æ€è¶…æ—¶æ—¶é—´
    success(res) {
      if (showLoading) {
        wx.hideLoading()
      }

      console.log(`ğŸ“¡ APIè¯·æ±‚ ${method} ${url}:`, {
        request: data,
        response: res.data,
        status: res.statusCode
      })

      // ğŸ”´ æ ¹æ®åç«¯æ–‡æ¡£ç»Ÿä¸€é”™è¯¯å¤„ç†
      if (res.statusCode === 200) {
        if (res.data.code === 0) {
          resolve(res.data)
        } else if (res.data.code === 401) {
          // Tokenè¿‡æœŸæˆ–æ— æ•ˆï¼Œå°è¯•åˆ·æ–°
          if (retryCount < maxRetry) {
            app.refreshToken().then(() => {
              // é‡æ–°å‘èµ·è¯·æ±‚
              const newOptions = { ...options, retryCount: retryCount + 1 }
              request(newOptions).then(resolve).catch(reject)
            }).catch(() => {
              app.logout()
              reject(res.data)
            })
          } else {
            app.logout()
            reject(res.data)
          }
        } else if (res.data.code === 2001) {
          // ğŸ”§ å¢å¼ºï¼š2001é”™è¯¯ç çš„æ™ºèƒ½å¤„ç†
          console.error('ğŸš¨ è®¤è¯é”™è¯¯ 2001:', {
            error: 'è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º',
            url: url,
            method: method,
            hasGlobalToken: !!app.globalData.accessToken,
            hasAuthHeader: !!header['Authorization'],
            requestHeaders: header,
            globalData: {
              isLoggedIn: app.globalData.isLoggedIn,
              accessToken: app.globalData.accessToken ? `${app.globalData.accessToken.substring(0, 20)}...` : null,
              userInfo: app.globalData.userInfo
            }
          })
          
          // ğŸ”§ æ–°å¢ï¼šè‡ªåŠ¨Tokenä¿®å¤æœºåˆ¶
          if (retryCount < maxRetry) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°Tokené—®é¢˜ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤...')
            
            try {
              const TokenRepair = require('./token-repair.js')
              TokenRepair.smartRepair().then((repairResult) => {
                if (repairResult.success && repairResult.action !== 'redirect') {
                  console.log('âœ… Tokenä¿®å¤æˆåŠŸï¼Œé‡æ–°å‘èµ·è¯·æ±‚')
                  // é‡æ–°å‘èµ·è¯·æ±‚
                  const newOptions = { ...options, retryCount: retryCount + 1 }
                  request(newOptions).then(resolve).catch(reject)
                  return
                }
              }).catch((repairError) => {
                console.error('âŒ Tokenè‡ªåŠ¨ä¿®å¤å¤±è´¥:', repairError)
              })
            } catch (repairError) {
              console.error('âŒ Tokenè‡ªåŠ¨ä¿®å¤å¤±è´¥:', repairError)
            }
          }
          
          // ğŸ”´ Tokenä¿®å¤å¤±è´¥æˆ–é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ˜¾ç¤ºç”¨æˆ·å‹å¥½æç¤º
          if (showLoading) {
            wx.showModal({
              title: 'ğŸ”‘ ç™»å½•çŠ¶æ€å¼‚å¸¸',
              content: `Tokenå·²è¿‡æœŸæˆ–æ— æ•ˆï¼\n\nğŸ”— APIï¼š${fullUrl}\n\nè§£å†³æ–¹æ¡ˆï¼š\nâ€¢ ç‚¹å‡»"é‡æ–°ç™»å½•"æ¸…ç†ç¼“å­˜\nâ€¢ æˆ–ç¨åé‡è¯•è®©ç³»ç»Ÿè‡ªåŠ¨ä¿®å¤`,
              showCancel: true,
              cancelText: 'ç¨åé‡è¯•',
              confirmText: 'é‡æ–°ç™»å½•',
              confirmColor: '#ff4444',
              success: (modalRes) => {
                if (modalRes.confirm) {
                  // æ¸…ç†æ‰€æœ‰è®¤è¯ä¿¡æ¯å¹¶è·³è½¬ç™»å½•
                  app.globalData.accessToken = null
                  app.globalData.refreshToken = null
                  app.globalData.userInfo = null
                  app.globalData.isLoggedIn = false
                  
                  wx.removeStorageSync('access_token')
                  wx.removeStorageSync('refresh_token')
                  wx.removeStorageSync('user_info')
                  wx.removeStorageSync('token_expire_time')
                  
                  wx.reLaunch({
                    url: '/pages/auth/auth'
                  })
                }
              }
            })
          }
          
          reject({
            code: 2001,
            msg: 'è®¿é—®ä»¤ç‰Œæ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•',
            data: res.data.data || null,
            debug: 'Tokenè¿‡æœŸæˆ–æ— æ•ˆ',
            isBackendError: true,
            needsRelogin: true
          })
        } else {
          // ğŸ”´ å…¶ä»–ä¸šåŠ¡é”™è¯¯ - å¢å¼ºåç«¯æœåŠ¡å¼‚å¸¸æç¤º
          const errorMessage = res.data.msg || res.data.message || 'æ“ä½œå¤±è´¥'
          console.log('ğŸ“ ä¸šåŠ¡é”™è¯¯:', {
            code: res.data.code,
            message: errorMessage,
            url: url,
            method: method
          })
          
          if (showLoading) {
            // ğŸ”´ æ ¹æ®æœ€æ–°æ¥å£å¯¹æ¥è§„èŒƒï¼Œæ˜¾ç¤ºè¯¦ç»†çš„åç«¯æœåŠ¡å¼‚å¸¸ä¿¡æ¯
            wx.showModal({
              title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
              content: `${errorMessage}\n\nğŸ”— APIç«¯ç‚¹ï¼š${fullUrl}\né”™è¯¯ç ï¼š${res.data.code}\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
              showCancel: false,
              confirmText: 'çŸ¥é“äº†',
              confirmColor: '#ff4444'
            })
          }
          
          reject({
            code: res.data.code,
            msg: errorMessage,
            data: res.data.data || null,
            isBackendError: true
          })
        }
      } else {
        // ğŸ”´ HTTPçŠ¶æ€ç é”™è¯¯ - å¢å¼ºåç«¯æœåŠ¡å¼‚å¸¸æç¤º
        let errorMessage = 'ç½‘ç»œé”™è¯¯'
        
        switch (res.statusCode) {
          case 400:
            errorMessage = 'è¯·æ±‚å‚æ•°é”™è¯¯'
            break
          case 403:
            errorMessage = 'æƒé™ä¸è¶³'
            break
          case 404:
            errorMessage = 'æ¥å£ä¸å­˜åœ¨'
            break
          case 500:
            errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
            break
          case 502:
            errorMessage = 'ç½‘å…³é”™è¯¯'
            break
          case 503:
            errorMessage = 'ğŸš¨ åç«¯æœåŠ¡æš‚ä¸å¯ç”¨\n\nå¯èƒ½åŸå› ï¼š\nâ€¢ æœåŠ¡å™¨ç»´æŠ¤ä¸­\nâ€¢ æœåŠ¡å™¨è¿‡è½½\nâ€¢ åç«¯APIæœåŠ¡æœªå¯åŠ¨\n\nè¯·è”ç³»åç«¯ç¨‹åºå‘˜æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼'
            break
          default:
            errorMessage = `ç½‘ç»œé”™è¯¯ ${res.statusCode}`
        }
        
        if (showLoading) {
          // ğŸ”´ æ ¹æ®æœ€æ–°æ¥å£å¯¹æ¥è§„èŒƒï¼Œæ˜¾ç¤ºè¯¦ç»†çš„HTTPé”™è¯¯ä¿¡æ¯
          wx.showModal({
            title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
            content: `${errorMessage}\n\nğŸ”— APIç«¯ç‚¹ï¼š${fullUrl}\nHTTPçŠ¶æ€ç ï¼š${res.statusCode}\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
            showCancel: false,
            confirmText: 'çŸ¥é“äº†',
            confirmColor: '#ff4444'
          })
        }
        
        reject({ 
          code: res.statusCode, 
          msg: errorMessage,
          data: null,
          isBackendError: true,
          httpStatus: res.statusCode
        })
      }
    },
    fail(err) {
      if (showLoading) {
        wx.hideLoading()
      }
      
      // ğŸ”´ ç½‘ç»œé”™è¯¯å¤„ç† - å¢å¼ºåç«¯æœåŠ¡å¼‚å¸¸æç¤º
      const errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥'
      console.error('âŒ ç½‘ç»œé”™è¯¯:', { 
        error: err, 
        url: fullUrl, 
        method: method,
        timeout: timeout
      })
      
      // ğŸ”´ æ ¹æ®æœ€æ–°æ¥å£å¯¹æ¥è§„èŒƒï¼Œæ˜¾ç¤ºè¯¦ç»†çš„ç½‘ç»œé”™è¯¯ä¿¡æ¯
      if (showLoading) {
        wx.showModal({
          title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
          content: `ç½‘ç»œè¿æ¥å¤±è´¥ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${fullUrl}\né”™è¯¯è¯¦æƒ…ï¼š${err.errMsg || 'æœªçŸ¥ç½‘ç»œé”™è¯¯'}\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\nâ€¢ åç«¯APIæœåŠ¡æ˜¯å¦å¯åŠ¨\nâ€¢ æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®`,
          showCancel: false,
          confirmText: 'çŸ¥é“äº†',
          confirmColor: '#ff4444'
        })
      }
      
      reject({ 
        code: -1, 
        msg: errorMessage,
        data: null,
        isNetworkError: true,
        originalError: err
      })
    }
  })
}

/**
 * ğŸš¨ å·²åˆ é™¤çš„è¿è§„å‡½æ•°ï¼ˆä¸¥ç¦ä½¿ç”¨ï¼‰ï¼š
 * âŒ shouldUseMock() - è¿è§„ï¼šMockæ•°æ®åˆ¤æ–­
 * âŒ smartApiCall() - è¿è§„ï¼šMock/çœŸå®APIåˆ‡æ¢  
 * âŒ mockRequest() - è¿è§„ï¼šæ¨¡æ‹Ÿè¯·æ±‚æ•°æ®
 * âŒ generateMockProducts() - è¿è§„ï¼šç”Ÿæˆæ¨¡æ‹Ÿå•†å“
 * 
 * æ‰€æœ‰ä¸šåŠ¡æ•°æ®å¿…é¡»ä»çœŸå®åç«¯APIè·å–ï¼
 */

// ğŸ”´ ç”¨æˆ·è®¤è¯API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const authAPI = {
  /**
   * ğŸ”´ å‘é€éªŒè¯ç  - å¿…é¡»è°ƒç”¨çœŸå®API
   * ğŸš§ å¼€å‘é˜¶æ®µï¼šAPIè¿”å›æˆåŠŸä½†ä¸å®é™…å‘é€çŸ­ä¿¡
   * ğŸ”® ç”Ÿäº§ç¯å¢ƒï¼šè°ƒç”¨çœŸå®çŸ­ä¿¡æœåŠ¡
   * @param {string} phone - æ‰‹æœºå·
   */
  sendCode(phone) {
    return request({
      url: '/auth/send-code',
      method: 'POST',
      data: { 
        phone,
        dev_mode: app.globalData.isDev || false, // ğŸš§ å¼€å‘æ¨¡å¼æ ‡è¯†
        skip_sms: app.globalData.isDev || false  // ğŸš§ å¼€å‘é˜¶æ®µè·³è¿‡çœŸå®çŸ­ä¿¡
      },
      needAuth: false,
      showLoading: true
    })
  },

  /**
   * ğŸ“± ç”¨æˆ·ç™»å½•
   * ğŸš§ å¼€å‘é˜¶æ®µï¼šè·³è¿‡çŸ­ä¿¡éªŒè¯ç ï¼Œä»»æ„6ä½æ•°å­—éƒ½é€šè¿‡éªŒè¯
   * ğŸ”® ç”Ÿäº§ç¯å¢ƒï¼šéªŒè¯çœŸå®çŸ­ä¿¡éªŒè¯ç 
   * @param {string} phone - æ‰‹æœºå·
   * @param {string} code - éªŒè¯ç 
   */
  login(formData) {
    // ğŸ”§ ä¿®å¤ï¼šç»Ÿä¸€å¤„ç†formDataå¯¹è±¡ï¼Œæå–phoneå’Œcode
    const phone = formData.phone || formData.phoneNumber
    const code = formData.code || formData.verificationCode || formData.verify_code
    
    // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ“¡ ç™»å½•APIè°ƒç”¨ - å‚æ•°éªŒè¯:', {
      formData: formData,
      phone: phone,
      code: code,
      phoneType: typeof phone,
      codeType: typeof code,
      phoneLength: phone ? phone.length : 0,
      codeLength: code ? code.length : 0,
      phoneValid: /^1[3-9]\d{9}$/.test(phone),
      codeValid: /^\d{4,6}$/.test(code)
    })
    
    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿å‚æ•°æ ¼å¼æ­£ç¡®
    const requestData = { 
      phone: String(phone).trim(), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²æ ¼å¼
      verify_code: String(code).trim(), // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²æ ¼å¼
      dev_mode: app.globalData.isDev || false,
      skip_sms_verify: app.globalData.isDev || false
    }
    
    console.log('ğŸ“¡ ç™»å½•APIè°ƒç”¨ - è¯·æ±‚æ•°æ®:', requestData)
    
    return request({
      url: '/auth/login',
      method: 'POST',
      data: requestData,
      needAuth: false,
      showLoading: false, // ğŸ”§ ä¿®å¤ï¼šç™»å½•é¡µé¢è‡ªè¡Œæ§åˆ¶loadingçŠ¶æ€
      timeout: 15000,     // ğŸ”§ ä¿®å¤ï¼šå¢åŠ è¶…æ—¶æ—¶é—´åˆ°15ç§’
      maxRetry: 3         // ğŸ”§ ä¿®å¤ï¼šå¢åŠ é‡è¯•æ¬¡æ•°åˆ°3æ¬¡
    }).then((response) => {
      // ğŸ”§ ä¿®å¤ï¼šè¯¦ç»†è®°å½•åç«¯è¿”å›çš„æ•°æ®ç»“æ„
      console.log('ğŸ“¡ ç™»å½•APIå“åº” - å®Œæ•´æ•°æ®ç»“æ„:', {
        response: response,
        responseType: typeof response,
        hasCode: response.hasOwnProperty('code'),
        hasData: response.hasOwnProperty('data'),
        hasMsg: response.hasOwnProperty('msg'),
        code: response.code,
        msg: response.msg,
        data: response.data,
        dataType: typeof response.data,
        dataKeys: response.data ? Object.keys(response.data) : []
      })
      
      // ğŸ”§ ä¿®å¤ï¼šè¿”å›å®Œæ•´çš„å“åº”æ•°æ®ï¼Œè®©è°ƒç”¨è€…å¤„ç†
      return response
    }).catch((error) => {
      console.error('ğŸ“¡ ç™»å½•APIè°ƒç”¨å¤±è´¥:', error)
      throw error
    })
  },

  /**
   * ğŸ” ç®¡ç†å‘˜ç™»å½• - æ–°å¢åŠŸèƒ½
   * ğŸš§ å¼€å‘é˜¶æ®µï¼šè·³è¿‡çŸ­ä¿¡äºŒæ¬¡éªŒè¯
   * ğŸ”® ç”Ÿäº§ç¯å¢ƒï¼šå®Œæ•´çš„è´¦å·å¯†ç +çŸ­ä¿¡äºŒæ¬¡éªŒè¯
   * @param {Object} loginData - ç™»å½•æ•°æ®
   * @param {string} loginData.username - ç®¡ç†å‘˜è´¦å·
   * @param {string} loginData.password - ç™»å½•å¯†ç 
   * @param {boolean} loginData.skip_sms - æ˜¯å¦è·³è¿‡çŸ­ä¿¡éªŒè¯ï¼ˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼‰
   * @param {Object} loginData.device_info - è®¾å¤‡ä¿¡æ¯
   */
  adminLogin(loginData) {
    console.log('ğŸ” ç®¡ç†å‘˜ç™»å½•APIè°ƒç”¨:', {
      username: loginData.username,
      skip_sms: loginData.skip_sms,
      dev_mode: loginData.dev_mode
    })
    
    return request({
      url: '/auth/admin-login',
      method: 'POST',
      data: {
        username: loginData.username,
        password: loginData.password,
        skip_sms: loginData.skip_sms || false,       // ğŸš§ å¼€å‘é˜¶æ®µè·³è¿‡çŸ­ä¿¡éªŒè¯
        dev_mode: loginData.dev_mode || false,       // ğŸš§ å¼€å‘æ¨¡å¼æ ‡è¯†
        device_info: loginData.device_info || {},    // è®¾å¤‡ä¿¡æ¯
        timestamp: Date.now(),                       // æ—¶é—´æˆ³
        client_type: 'miniprogram'                   // å®¢æˆ·ç«¯ç±»å‹
      },
      needAuth: false,
      showLoading: false // ç™»å½•ç•Œé¢è‡ªè¡Œæ§åˆ¶loadingçŠ¶æ€
    })
  },

  /**
   * ğŸ” ç®¡ç†å‘˜çŸ­ä¿¡äºŒæ¬¡éªŒè¯ - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨
   * ğŸš§ å¼€å‘é˜¶æ®µï¼šæ­¤æ¥å£æš‚åœè°ƒç”¨
   * @param {string} admin_token - ä¸´æ—¶ç®¡ç†å‘˜token
   * @param {string} sms_code - çŸ­ä¿¡éªŒè¯ç 
   */
  adminSmsVerify(admin_token, sms_code) {
    return request({
      url: '/auth/admin-sms-verify',
      method: 'POST',
      data: {
        admin_token,
        sms_code,
        timestamp: Date.now()
      },
      needAuth: false,
      showLoading: true
    })
  },

  /**
   * åˆ·æ–°Token
   */
  refresh(refreshToken) {
    return request({
      url: '/auth/refresh',
      method: 'POST',
      data: { refresh_token: refreshToken },
      needAuth: false
    })
  },

  /**
   * éªŒè¯Tokenæœ‰æ•ˆæ€§
   */
  verifyToken() {
    return request({
      url: '/auth/verify-token',
      method: 'GET',
      needAuth: true
    })
  },

  /**
   * ç”¨æˆ·é€€å‡ºç™»å½•
   */
  logout() {
    return request({
      url: '/auth/logout',
      method: 'POST',
      needAuth: true
    })
  }
}

// ğŸ”´ æŠ½å¥–API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const lotteryAPI = {
  // è·å–æŠ½å¥–é…ç½®
  getConfig() {
    return request({
      url: '/lottery/config',
      method: 'GET',
      needAuth: true
    }).catch(error => {
      wx.showModal({
        title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
        content: 'æ— æ³•è·å–æŠ½å¥–é…ç½®ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. åç«¯lotteryæœåŠ¡æœªå¯åŠ¨\n2. /lottery/configæ¥å£å¼‚å¸¸\n\nè¯·ç«‹å³æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€ï¼',
        showCancel: false,
        confirmColor: '#ff4444'
      })
      throw error
    })
  },

  // æ‰§è¡ŒæŠ½å¥–
  draw(drawType = 'single', count = 1) {
    // ğŸ”§ ä¿®å¤ï¼šä¸­æ–‡å‚æ•°è½¬è‹±æ–‡æ˜ å°„ï¼Œåç«¯åªæ”¯æŒè‹±æ–‡å‚æ•°
    const drawTypeMapping = {
      'å•æŠ½': 'single',
      'ä¸‰è¿æŠ½': 'triple', 
      'äº”è¿æŠ½': 'five',
      'åè¿æŠ½': 'ten',
      'single': 'single',
      'triple': 'triple',
      'five': 'five', 
      'ten': 'ten'
    }
    
    const mappedDrawType = drawTypeMapping[drawType] || drawType
    
    console.log('ğŸ”§ æŠ½å¥–å‚æ•°æ˜ å°„:', {
      'åŸå§‹å‚æ•°': drawType,
      'æ˜ å°„åå‚æ•°': mappedDrawType,
      'æŠ½å¥–æ•°é‡': count
    })
    
    return request({
      url: '/lottery/draw',
      method: 'POST',
      data: { draw_type: mappedDrawType, count },
      needAuth: true
    }).catch(error => {
      console.error('ğŸš¨ æŠ½å¥–APIè°ƒç”¨å¤±è´¥:', error)
      
      // ğŸ”§ ä¿®å¤ï¼šåŒºåˆ†ç½‘ç»œé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯ï¼Œé¿å…é‡å¤é”™è¯¯æç¤º
      // åªæœ‰çœŸæ­£çš„ç½‘ç»œé”™è¯¯æ‰æ˜¾ç¤ºé€šç”¨é”™è¯¯æç¤º
      // ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚æ¯æ—¥é™åˆ¶ã€ç§¯åˆ†ä¸è¶³ç­‰ï¼‰ç”±ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†
      
      if (error && typeof error.code === 'number' && error.code >= 1000) {
        // ä¸šåŠ¡é”™è¯¯ç ï¼ˆ1000+ï¼‰ï¼Œä¸æ˜¾ç¤ºé€šç”¨é”™è¯¯ï¼Œç›´æ¥æŠ›å‡ºè®©ä¸šåŠ¡é€»è¾‘å¤„ç†
        console.log('ğŸ“ ä¸šåŠ¡é”™è¯¯ï¼Œç”±ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†:', error)
        throw error
      } else if (error && (error.code === 'NETWORK_ERROR' || error.code < 0 || 
                         (typeof error.code === 'number' && (error.code >= 500 || error.code === 0)))) {
        // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œæ˜¾ç¤ºé€šç”¨é”™è¯¯æç¤º
        wx.showModal({
          title: 'ğŸš¨ ç½‘ç»œè¿æ¥å¼‚å¸¸',
          content: 'ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n2. æœåŠ¡å™¨æš‚æ—¶æ— æ³•è®¿é—®\n3. è¯·æ±‚è¶…æ—¶',
          showCancel: true,
          cancelText: 'ç¨åé‡è¯•',
          confirmText: 'çŸ¥é“äº†',
          confirmColor: '#ff4444'
        })
        throw error
      } else {
        // å…¶ä»–æœªçŸ¥é”™è¯¯ï¼Œæ˜¾ç¤ºé€šç”¨æç¤ºä½†ä¸é˜»æ–­ä¸šåŠ¡æµç¨‹
        console.warn('âš ï¸ æœªçŸ¥é”™è¯¯ç±»å‹ï¼Œç”±ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†:', error)
        throw error
      }
    })
  },

  // è·å–æŠ½å¥–è®°å½•
  getRecords(page = 1, pageSize = 20) {
    return request({
      url: '/lottery/records',
      method: 'GET',
      data: { page, page_size: pageSize },
      needAuth: true
    })
  },

  // è·å–æŠ½å¥–ç»Ÿè®¡
  getStatistics() {
    return request({
      url: '/lottery/statistics',
      method: 'GET',
      needAuth: true
    })
  }
}

// ğŸ”´ å•†å“å…‘æ¢API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const exchangeAPI = {
  // è·å–å•†å“åˆ†ç±»
  getCategories() {
    return request({
      url: '/exchange/categories',
      method: 'GET',
      needAuth: true
    })
  },

  // è·å–å•†å“åˆ—è¡¨
  getProducts(page = 1, pageSize = 20, category = 'all', sort = 'points') {
    return request({
      url: '/exchange/products',
      method: 'GET',
      data: { page, page_size: pageSize, category, sort },
      needAuth: true
    }).catch(error => {
      wx.showModal({
        title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
        content: 'æ— æ³•è·å–å•†å“åˆ—è¡¨ï¼è¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ã€‚',
        showCancel: false
      })
      throw error
    })
  },

  // å…‘æ¢å•†å“
  redeem(productId, quantity = 1) {
    return request({
      url: '/exchange/redeem',
      method: 'POST',
      data: { product_id: productId, quantity },
      needAuth: true
    })
  },

  // è·å–å…‘æ¢è®°å½•
  getRecords(page = 1, pageSize = 20, status = 'all') {
    return request({
      url: '/exchange/records',
      method: 'GET',
      data: { page, page_size: pageSize, status },
      needAuth: true
    })
  },

  // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„getStatisticsæ–¹æ³•
  getStatistics() {
    return request({
      url: '/exchange/statistics',
      method: 'GET',
      needAuth: true
    }).catch(error => {
      console.error('âŒ è·å–å…‘æ¢ç»Ÿè®¡å¤±è´¥:', error)
      
      // ğŸ”´ æ˜¾ç¤ºåç«¯æœåŠ¡å¼‚å¸¸æç¤º
      wx.showModal({
        title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
        content: `æ— æ³•è·å–å…‘æ¢ç»Ÿè®¡æ•°æ®ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${getApp().globalData.baseUrl}/exchange/statistics\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†',
        confirmColor: '#ff4444'
      })
      
      throw error
    })
  }
}

// ğŸ”´ ä¸Šä¼ API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const uploadAPI = {
  // ä¸Šä¼ æ–‡ä»¶
  upload(filePath, userAmount) {
    return new Promise((resolve, reject) => {
      // ğŸ”§ ä¿®å¤ï¼šå‚æ•°éªŒè¯å’Œå¤„ç†
      if (!filePath) {
        const error = { code: 1001, msg: 'æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º' }
        console.error('âŒ ä¸Šä¼ å‚æ•°é”™è¯¯:', error)
        reject(error)
        return
      }
      
      // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿é‡‘é¢å‚æ•°æœ‰æ•ˆ
      const validAmount = userAmount || 1.0
      console.log('ğŸ“¤ ä¸Šä¼ APIè°ƒç”¨å‚æ•°:', {
        filePath: filePath,
        åŸå§‹é‡‘é¢: userAmount,
        å¤„ç†åé‡‘é¢: validAmount,
        é‡‘é¢ç±»å‹: typeof validAmount,
        è½¬ä¸ºå­—ç¬¦ä¸²: validAmount.toString(),
        baseUrl: app.globalData.baseUrl,
        hasToken: !!app.globalData.accessToken
      })
      
      // ğŸ”§ ä¿®å¤ï¼šæ£€æŸ¥å¿…éœ€çš„å…¨å±€é…ç½®
      if (!app.globalData.baseUrl) {
        const error = { code: 1004, msg: 'ç³»ç»Ÿé…ç½®é”™è¯¯ï¼šAPIåœ°å€æœªè®¾ç½®' }
        console.error('âŒ ç³»ç»Ÿé…ç½®é”™è¯¯:', error)
        wx.showModal({
          title: 'ğŸš¨ ç³»ç»Ÿé…ç½®é”™è¯¯',
          content: 'APIåœ°å€æœªè®¾ç½®ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒé…ç½®ï¼',
          showCancel: false
        })
        reject(error)
        return
      }
      
      if (!app.globalData.accessToken) {
        const error = { code: 1005, msg: 'ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•' }
        console.error('âŒ è®¤è¯é”™è¯¯:', error)
        wx.showModal({
          title: 'ğŸš¨ è®¤è¯é”™è¯¯',
          content: 'ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ï¼',
          showCancel: false
        })
        reject(error)
        return
      }
      
      const header = {
        'Authorization': `Bearer ${app.globalData.accessToken}`
      }
      
      // ğŸ”§ ä¿®å¤ï¼šæ„å»ºå®Œæ•´çš„ä¸Šä¼ URL
      const uploadUrl = `${app.globalData.baseUrl}/photo/upload`
      console.log('ğŸ“¤ ä¸Šä¼ URL:', uploadUrl)
      
      wx.uploadFile({
        url: uploadUrl,
        filePath: filePath,
        name: 'photo',
        header: header,
        formData: {
          amount: validAmount.toString()
        },
        success(res) {
          console.log('ğŸ“¤ ä¸Šä¼ APIå“åº”:', res)
          
          // ğŸ”§ ä¿®å¤ï¼šè¯¦ç»†çš„å“åº”å¤„ç†
          if (res.statusCode !== 200) {
            const networkError = { 
              code: res.statusCode, 
              msg: `ç½‘ç»œé”™è¯¯ï¼šHTTP ${res.statusCode}`,
              isNetworkError: true
            }
            console.error('âŒ ç½‘ç»œé”™è¯¯:', networkError)
            wx.showModal({
              title: 'ğŸš¨ ç½‘ç»œé”™è¯¯',
              content: `HTTPçŠ¶æ€ç ï¼š${res.statusCode}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯æ”¯æŒï¼`,
              showCancel: false
            })
            reject(networkError)
            return
          }
          
          try {
            const data = JSON.parse(res.data)
            console.log('ğŸ“¤ è§£æåçš„å“åº”æ•°æ®:', data)
            
            if (data.code === 0) {
              resolve(data)
            } else {
              console.error('âŒ ä¸Šä¼ APIä¸šåŠ¡é”™è¯¯:', data)
              // ğŸ”§ ä¿®å¤ï¼šä¸šåŠ¡é”™è¯¯ä¹Ÿéœ€è¦è¯¦ç»†æç¤º
              const businessError = {
                ...data,
                isBusinessError: true
              }
              reject(businessError)
            }
          } catch (err) {
            console.error('âŒ ä¸Šä¼ APIå“åº”è§£æå¤±è´¥:', err)
            console.error('âŒ åŸå§‹å“åº”æ•°æ®:', res.data)
            
            const parseError = { 
              code: -1, 
              msg: 'å“åº”æ•°æ®è§£æå¤±è´¥',
              originalData: res.data,
              parseError: err.message
            }
            
            wx.showModal({
              title: 'ğŸš¨ æ•°æ®è§£æé”™è¯¯',
              content: `å“åº”æ•°æ®æ ¼å¼å¼‚å¸¸ï¼\n\nåŸå§‹æ•°æ®ï¼š${res.data}\n\nè¯·è”ç³»æŠ€æœ¯æ”¯æŒï¼`,
              showCancel: false
            })
            
            reject(parseError)
          }
        },
        fail(err) {
          console.error('âŒ ä¸Šä¼ APIç½‘ç»œé”™è¯¯:', err)
          
          // ğŸ”§ ä¿®å¤ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„ç½‘ç»œé”™è¯¯
          let errorMessage = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•'
          
          if (err.errMsg) {
            if (err.errMsg.includes('timeout')) {
              errorMessage = 'ç½‘ç»œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
            } else if (err.errMsg.includes('fail')) {
              errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
            } else if (err.errMsg.includes('abort')) {
              errorMessage = 'ä¸Šä¼ è¢«ä¸­æ–­'
            }
          }
          
          wx.showModal({
            title: 'ğŸš¨ ä¸Šä¼ å¤±è´¥',
            content: `${errorMessage}\n\né”™è¯¯è¯¦æƒ…ï¼š${err.errMsg || 'æœªçŸ¥é”™è¯¯'}\n\nä¸Šä¼ åœ°å€ï¼š${uploadUrl}\n\nè¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥\n2. æœåŠ¡å™¨çŠ¶æ€\n3. è”ç³»æŠ€æœ¯æ”¯æŒ`,
            showCancel: false
          })
          
          const networkError = {
            ...err,
            isNetworkError: true,
            uploadUrl: uploadUrl
          }
          
          reject(networkError)
        }
      })
    })
  },

  // è·å–ä¸Šä¼ è®°å½•
  getRecords(page = 1, pageSize = 20, status = 'all') {
    return request({
      url: '/photo/history',
      method: 'GET',
      data: { page, limit: pageSize, status },
      needAuth: true
    })
  },

  // ğŸ”´ æ–°å¢ï¼šè·å–ä¸Šä¼ å†å²è®°å½• - ç¬¦åˆæ¥å£è§„èŒƒv2.1.3
  getHistory(page = 1, pageSize = 10, status = 'all') {
    console.log('ğŸ“¡ è·å–ä¸Šä¼ å†å²è¯·æ±‚:', { page, pageSize, status })
    
    return request({
      url: '/photo/history',
      method: 'GET',
      data: { page, limit: pageSize, status },
      needAuth: true,
      showLoading: false
    }).catch(error => {
      // ğŸ”´ ç¡®ä¿ä¸Šä¼ å†å²APIé”™è¯¯ä¹Ÿæœ‰å®Œæ•´çš„åç«¯æœåŠ¡å¼‚å¸¸æç¤º
      console.error('âŒ è·å–ä¸Šä¼ å†å²å¤±è´¥:', error)
      
      if (!error.isBackendError && !error.isNetworkError) {
        wx.showModal({
          title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
          content: `æ— æ³•è·å–ä¸Šä¼ å†å²ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/photo/history\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
          showCancel: false,
          confirmText: 'çŸ¥é“äº†',
          confirmColor: '#ff4444'
        })
      }
      
      throw error
    })
  },

  // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„getStatisticsæ–¹æ³•
  getStatistics() {
    return request({
      url: '/photo/statistics',
      method: 'GET',
      needAuth: true
    }).catch(error => {
      console.error('âŒ è·å–ä¸Šä¼ ç»Ÿè®¡å¤±è´¥:', error)
      
      // ğŸ”´ æ˜¾ç¤ºåç«¯æœåŠ¡å¼‚å¸¸æç¤º
      wx.showModal({
        title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
        content: `æ— æ³•è·å–ä¸Šä¼ ç»Ÿè®¡æ•°æ®ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${getApp().globalData.baseUrl}/photo/statistics\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†',
        confirmColor: '#ff4444'
      })
      
      throw error
    })
  }
}

// ğŸ”´ ç”¨æˆ·API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const userAPI = {
  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo() {
    return request({
      url: '/user/info',
      method: 'GET',
      needAuth: true
    }).catch(error => {
      wx.showModal({
        title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
        content: 'æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼è¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ã€‚',
        showCancel: false
      })
      throw error
    })
  },

  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  updateUserInfo(userInfo) {
    return request({
      url: '/user/info',
      method: 'PUT',
      data: userInfo,
      needAuth: true
    })
  },

  // è·å–ç”¨æˆ·ç»Ÿè®¡
  getStatistics() {
    return request({
      url: '/user/statistics',
      method: 'GET',
      needAuth: true
    })
  },

  // è·å–ç§¯åˆ†è®°å½• - ğŸ”´ æ›´æ–°æ¥å£è·¯å¾„ç¬¦åˆè§„èŒƒv2.1.3
  getPointsRecords(page = 1, pageSize = 20, type = 'all', source = '') {
    console.log('ğŸ“¡ è·å–ç§¯åˆ†è®°å½•è¯·æ±‚:', { page, pageSize, type, source })
    
    return request({
      url: '/user/points/records',
      method: 'GET',
      data: {
        page,
        limit: pageSize,
        type,
        source
      },
      needAuth: true,
      showLoading: false
    }).catch(error => {
      // ğŸ”´ ç¡®ä¿ç§¯åˆ†è®°å½•APIé”™è¯¯ä¹Ÿæœ‰å®Œæ•´çš„åç«¯æœåŠ¡å¼‚å¸¸æç¤º
      console.error('âŒ è·å–ç§¯åˆ†è®°å½•å¤±è´¥:', error)
      
      if (!error.isBackendError && !error.isNetworkError) {
        wx.showModal({
          title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
          content: `æ— æ³•è·å–ç§¯åˆ†è®°å½•ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/user/points/records\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
          showCancel: false,
          confirmText: 'çŸ¥é“äº†',
          confirmColor: '#ff4444'
        })
      }
      
      throw error
    })
  },

  // ğŸ”´ æ–°å¢ï¼šå¤´åƒä¸Šä¼  - ç¬¦åˆæ¥å£è§„èŒƒv2.1.3
  uploadAvatar(filePath) {
    console.log('ğŸ“¡ ä¸Šä¼ å¤´åƒè¯·æ±‚:', filePath)
    
    return new Promise((resolve, reject) => {
      const header = {
        'Content-Type': 'multipart/form-data'
      }
      
      // æ·»åŠ è®¤è¯å¤´
      if (app.globalData.accessToken) {
        header['Authorization'] = `Bearer ${app.globalData.accessToken}`
      }
      
      wx.uploadFile({
        url: app.globalData.baseUrl + '/user/avatar',
        filePath: filePath,
        name: 'avatar',
        header: header,
        success(res) {
          console.log('ğŸ“¡ å¤´åƒä¸Šä¼ å“åº”:', res)
          
          try {
            const data = JSON.parse(res.data)
            if (data.code === 0) {
              resolve(data)
            } else {
              // ğŸ”´ åç«¯æœåŠ¡å¼‚å¸¸æç¤º
              wx.showModal({
                title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
                content: `å¤´åƒä¸Šä¼ å¤±è´¥ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/user/avatar\né”™è¯¯ä¿¡æ¯ï¼š${data.msg || 'æœªçŸ¥é”™è¯¯'}\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
                showCancel: false,
                confirmText: 'çŸ¥é“äº†',
                confirmColor: '#ff4444'
              })
              reject({
                code: data.code,
                msg: data.msg || 'å¤´åƒä¸Šä¼ å¤±è´¥',
                isBackendError: true
              })
            }
          } catch (parseError) {
            console.error('âŒ è§£æä¸Šä¼ å“åº”å¤±è´¥:', parseError)
            wx.showModal({
              title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
              content: `å¤´åƒä¸Šä¼ å“åº”è§£æå¤±è´¥ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/user/avatar\nå“åº”å†…å®¹ï¼š${res.data}\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
              showCancel: false,
              confirmText: 'çŸ¥é“äº†',
              confirmColor: '#ff4444'
            })
            reject({
              code: -1,
              msg: 'å“åº”è§£æå¤±è´¥',
              isBackendError: true
            })
          }
        },
        fail(err) {
          console.error('âŒ å¤´åƒä¸Šä¼ å¤±è´¥:', err)
          // ğŸ”´ ç½‘ç»œé”™è¯¯æç¤º
          wx.showModal({
            title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
            content: `å¤´åƒä¸Šä¼ å¤±è´¥ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/user/avatar\né”™è¯¯è¯¦æƒ…ï¼š${err.errMsg || 'æœªçŸ¥ç½‘ç»œé”™è¯¯'}\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
            showCancel: false,
            confirmText: 'çŸ¥é“äº†',
            confirmColor: '#ff4444'
          })
          reject({
            code: -1,
            msg: 'å¤´åƒä¸Šä¼ å¤±è´¥',
            isNetworkError: true,
            originalError: err
          })
        }
      })
    })
  },

  // ç­¾åˆ°
  checkIn() {
    return request({
      url: '/user/check-in',
      method: 'POST',
      needAuth: true
    })
  }
}

// ğŸ”´ å•†å®¶API - å¿…é¡»è°ƒç”¨çœŸå®åç«¯æ¥å£
const merchantAPI = {
  // ç”³è¯·å•†å®¶æƒé™
  apply(authInfo = {}) {
    return request({
      url: '/merchant/apply',
      method: 'POST',
      data: authInfo,
      needAuth: true
    })
  },

  // è·å–å•†å®¶ç»Ÿè®¡
  getStatistics() {
    return request({
      url: '/merchant/statistics',
      method: 'GET',
      needAuth: true
    })
  },

  // ğŸ”´ æ–°å¢ï¼šè·å–å•†å“ç»Ÿè®¡ - ç¬¦åˆæ¥å£è§„èŒƒv2.1.3
  getProductStats() {
    console.log('ğŸ“¡ è·å–å•†å“ç»Ÿè®¡è¯·æ±‚')
    
    return request({
      url: '/merchant/product-stats',
      method: 'GET',
      needAuth: true,
      showLoading: false
    }).catch(error => {
      // ğŸ”´ ç¡®ä¿å•†å“ç»Ÿè®¡APIé”™è¯¯ä¹Ÿæœ‰å®Œæ•´çš„åç«¯æœåŠ¡å¼‚å¸¸æç¤º
      console.error('âŒ è·å–å•†å“ç»Ÿè®¡å¤±è´¥:', error)
      
      if (!error.isBackendError && !error.isNetworkError) {
        wx.showModal({
          title: 'ğŸš¨ åç«¯æœåŠ¡å¼‚å¸¸',
          content: `æ— æ³•è·å–å•†å“ç»Ÿè®¡ï¼\n\nğŸ”— APIç«¯ç‚¹ï¼š${app.globalData.baseUrl}/merchant/product-stats\n\nè¯·æ£€æŸ¥åç«¯APIæœåŠ¡çŠ¶æ€ï¼`,
          showCancel: false,
          confirmText: 'çŸ¥é“äº†',
          confirmColor: '#ff4444'
        })
      }
      
      throw error
    })
  },

  // è·å–å¾…å®¡æ ¸ä¸Šä¼ 
  getPendingReviews(page = 1, pageSize = 20) {
    return request({
      url: '/merchant/pending-reviews',
      method: 'GET',
      data: { page, page_size: pageSize },
      needAuth: true
    })
  },

  // å®¡æ ¸ä¸Šä¼ 
  review(uploadId, action, points = 0, reason = '') {
    return request({
      url: '/merchant/review',
      method: 'POST',
      data: { upload_id: uploadId, action, points, reason },
      needAuth: true
    })
  },

  // æ‰¹é‡å®¡æ ¸
  batchReview(uploadIds, action, reason = '') {
    return request({
      url: '/merchant/batch-review',
      method: 'POST',
      data: { upload_ids: uploadIds, action, reason },
      needAuth: true
    })
  },

  // è·å–æŠ½å¥–é…ç½®ï¼ˆå•†å®¶ç®¡ç†ï¼‰
  getLotteryConfig() {
    return request({
      url: '/merchant/lottery-config',
      method: 'GET',
      needAuth: true
    })
  },

  // è·å–æŠ½å¥–ç»Ÿè®¡ï¼ˆå•†å®¶ç®¡ç†ï¼‰
  getLotteryStats() {
    return request({
      url: '/merchant/lottery-stats',
      method: 'GET',
      needAuth: true
    })
  },

  // ä¿å­˜æŠ½å¥–æ¦‚ç‡è®¾ç½®
  saveLotteryProbabilities(prizes) {
    return request({
      url: '/merchant/lottery-probabilities',
      method: 'POST',
      data: { prizes },
      needAuth: true
    })
  },

  // é‡ç½®æŠ½å¥–æ¦‚ç‡
  resetLotteryProbabilities() {
    return request({
      url: '/merchant/reset-lottery-probabilities',
      method: 'POST',
      needAuth: true
    })
  }
}

module.exports = {
  request,
  authAPI,
  lotteryAPI,
  exchangeAPI,
  uploadAPI,
  userAPI,
  merchantAPI
} 